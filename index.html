<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…±è¯†ç¼–å¹´å² - Consensus Chronicle</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%); min-height: 100vh; color: #e8e8e8; }
    .container { max-width: 1000px; margin: 0 auto; padding: 2rem; }
    .hidden { display: none !important; }
    
    .wallet-bar { position: fixed; top: 0; left: 0; right: 0; display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 2rem; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 100; }
    .wallet-bar .logo { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #a78bfa; }
    .wallet-bar .wallet-info { display: flex; align-items: center; gap: 1rem; }
    .wallet-bar .network { padding: 0.3rem 0.8rem; background: rgba(74,222,128,0.2); border-radius: 20px; font-size: 0.8rem; color: #4ade80; }
    .wallet-bar .network.wrong { background: rgba(251,191,36,0.2); color: #fbbf24; }
    .wallet-bar .balance { color: #fbbf24; font-weight: 600; }
    .wallet-bar .address { padding: 0.4rem 0.8rem; background: rgba(167,139,250,0.2); border-radius: 20px; font-family: monospace; font-size: 0.85rem; }
    .connect-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1.2rem; background: linear-gradient(135deg, #f6851b, #e2761b); border: none; border-radius: 20px; color: #fff; font-weight: 600; cursor: pointer; }
    .connect-btn:hover { transform: scale(1.05); }
    .disconnect-btn { padding: 0.4rem 0.8rem; background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.4); border-radius: 20px; color: #ef4444; font-size: 0.8rem; cursor: pointer; }
    
    .contract-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(74,222,128,0.1); border: 1px solid rgba(74,222,128,0.3); border-radius: 8px; font-size: 0.85rem; }
    .contract-badge .dot { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .hero { text-align: center; margin: 4rem 0 2rem; }
    .hero-icon { font-size: 5rem; margin-bottom: 1rem; }
    .hero h1 { font-size: 3rem; font-weight: 800; background: linear-gradient(135deg, #a78bfa, #f472b6, #fb923c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
    .hero .subtitle { color: #8b8b9e; letter-spacing: 0.3em; text-transform: uppercase; margin-bottom: 1rem; }
    .hero .desc { color: #a5a5b8; font-style: italic; }
    
    .player-card { display: flex; align-items: center; justify-content: center; gap: 1.5rem; padding: 1.5rem 2rem; background: rgba(167,139,250,0.1); border: 1px solid rgba(167,139,250,0.3); border-radius: 16px; margin-bottom: 2rem; }
    .player-card .avatar { font-size: 3rem; }
    .player-card .info { text-align: left; }
    .player-card .name { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem; }
    .player-card .stats { display: flex; gap: 1.5rem; }
    .player-card .stat { display: flex; align-items: center; gap: 0.3rem; font-size: 0.9rem; }
    
    .register-form { max-width: 400px; margin: 0 auto 2rem; padding: 2rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; }
    .register-form h3 { margin-bottom: 1rem; color: #c4b5fd; }
    .register-form input { width: 100%; padding: 1rem; margin-bottom: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 1rem; }
    .register-form .avatars { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .register-form .avatar-btn { width: 50px; height: 50px; font-size: 1.8rem; background: rgba(255,255,255,0.05); border: 2px solid transparent; border-radius: 10px; cursor: pointer; }
    .register-form .avatar-btn:hover { background: rgba(255,255,255,0.1); }
    .register-form .avatar-btn.selected { border-color: #a78bfa; background: rgba(167,139,250,0.2); }
    .submit-btn { width: 100%; padding: 1rem; background: linear-gradient(135deg, #a78bfa, #f472b6); border: none; border-radius: 10px; color: #fff; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
    .cost-info { margin-top: 1rem; padding: 0.8rem; background: rgba(74,222,128,0.1); border-radius: 8px; font-size: 0.9rem; color: #4ade80; text-align: center; }
    
    .section-title { font-size: 1.5rem; color: #c4b5fd; margin-bottom: 1.5rem; text-align: center; }
    .themes-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
    .theme-card { display: flex; flex-direction: column; align-items: center; padding: 2rem; background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; cursor: pointer; transition: all 0.3s; }
    .theme-card:hover { transform: translateY(-5px); border-color: rgba(167,139,250,0.5); }
    .theme-card .icon { font-size: 3rem; margin-bottom: 1rem; }
    .theme-card .name { font-size: 1.2rem; font-weight: 600; color: #fff; }
    .theme-card .info { font-size: 0.85rem; color: #6b6b7e; margin-top: 0.5rem; }
    
    .room-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .room-header .back-btn { padding: 0.5rem 1rem; background: transparent; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #a5a5b8; cursor: pointer; }
    .room-header .theme-info { display: flex; align-items: center; gap: 0.5rem; font-size: 1.3rem; }
    .players-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
    .player-slot { display: flex; flex-direction: column; align-items: center; padding: 1.5rem 1rem; border-radius: 12px; position: relative; }
    .player-slot.filled { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); }
    .player-slot.filled.you { background: rgba(167,139,250,0.1); border-color: rgba(167,139,250,0.5); }
    .player-slot.empty { border: 1px dashed rgba(255,255,255,0.1); opacity: 0.4; }
    .player-slot .slot-avatar { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .player-slot .slot-name { font-size: 0.95rem; text-align: center; }
    .player-slot .badge { position: absolute; top: 0.5rem; right: 0.5rem; font-size: 0.6rem; padding: 0.2rem 0.4rem; border-radius: 4px; background: #fbbf24; color: #000; }
    .start-btn { width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #a78bfa, #f472b6); color: #fff; }
    .rules-box { margin-top: 2rem; padding: 1.5rem; background: rgba(255,255,255,0.03); border-radius: 12px; }
    .rules-box h4 { margin-bottom: 1rem; color: #c4b5fd; }
    .rules-box ul { list-style: none; color: #a5a5b8; font-size: 0.9rem; }
    .rules-box ul li { padding: 0.3rem 0; }

    .game-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1); margin-top: 50px; }
    .round-info .label { font-size: 0.9rem; color: #8b8b9e; }
    .round-info .phase { font-size: 1.1rem; font-weight: 600; }
    .progress-dots { display: flex; gap: 0.5rem; }
    .progress-dots .dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(255,255,255,0.2); }
    .progress-dots .dot.completed { background: #4ade80; }
    .progress-dots .dot.current { background: #a78bfa; }
    .timer { font-size: 2.5rem; font-weight: 700; font-family: monospace; color: #a78bfa; }
    .timer.warning { color: #f87171; }
    .score-display .label { font-size: 0.85rem; color: #8b8b9e; }
    .score-display .value { font-size: 1.5rem; font-weight: 700; color: #fbbf24; }
    .game-content { display: flex; gap: 1rem; padding: 1rem; height: calc(100vh - 130px); overflow: hidden; }
    .story-panel { flex: 1; display: flex; flex-direction: column; gap: 1rem; min-width: 0; }
    .story-scroll { flex: 1; background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1rem; overflow-y: auto; }
    .story-scroll h3 { color: #c4b5fd; margin-bottom: 1rem; font-size: 1rem; }
    .story-entry { padding: 0.6rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); line-height: 1.7; }
    .story-entry.opening { color: #c4b5fd; font-style: italic; }
    .story-entry.context { color: #fbbf24; }
    .story-entry .badge { background: rgba(251,191,36,0.2); padding: 0.2rem 0.5rem; border-radius: 4px; margin-right: 0.5rem; }
    .story-entry.choice { color: #4ade80; }
    .story-entry.consequence { color: #a5a5b8; padding-left: 1.5rem; border-left: 2px solid rgba(167,139,250,0.3); }
    .options-panel { background: rgba(255,255,255,0.02); border-radius: 12px; padding: 1rem; }
    .options-panel h4 { text-align: center; margin-bottom: 1rem; color: #fff; }
    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .option-card { padding: 1rem; border-radius: 10px; border: 2px solid; cursor: pointer; transition: all 0.3s; }
    .option-card.option-a { border-color: rgba(239,68,68,0.4); background: rgba(239,68,68,0.1); }
    .option-card.option-b { border-color: rgba(59,130,246,0.4); background: rgba(59,130,246,0.1); }
    .option-card.selected.option-a { border-color: #ef4444; transform: scale(1.02); }
    .option-card.selected.option-b { border-color: #3b82f6; transform: scale(1.02); }
    .option-card .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
    .option-card .label { font-weight: 700; font-size: 1.1rem; }
    .option-card.option-a .label { color: #ef4444; }
    .option-card.option-b .label { color: #3b82f6; }
    .option-card .tag { font-size: 0.75rem; padding: 0.2rem 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px; color: #a5a5b8; }
    .option-card .text { line-height: 1.5; font-size: 0.9rem; }
    .option-card .votes { margin-top: 0.8rem; text-align: center; font-size: 1.2rem; font-weight: 600; color: #fbbf24; }
    .chat-panel { width: 320px; display: flex; flex-direction: column; background: rgba(0,0,0,0.2); border-radius: 12px; overflow: hidden; }
    .players-bar { display: flex; flex-wrap: wrap; gap: 0.4rem; padding: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .player-tag { display: flex; align-items: center; gap: 0.3rem; padding: 0.3rem 0.6rem; background: rgba(255,255,255,0.05); border-radius: 15px; font-size: 0.8rem; }
    .player-tag.voted { background: rgba(74,222,128,0.2); }
    .player-tag .vote { color: #4ade80; font-weight: 700; }
    .messages-list { flex: 1; overflow-y: auto; padding: 0.8rem; }
    .message { margin-bottom: 0.6rem; font-size: 0.85rem; }
    .message.system { color: #a78bfa; font-style: italic; }
    .message.chat { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 0.5rem 0.8rem; }
    .message.chat .header { display: flex; justify-content: space-between; margin-bottom: 0.3rem; }
    .message.chat .sender { color: #fbbf24; font-weight: 600; }
    .message.chat .stance { font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 4px; }
    .message.chat .stance.a { background: rgba(239,68,68,0.3); }
    .message.chat .stance.b { background: rgba(59,130,246,0.3); }
    .chat-input { padding: 0.8rem; border-top: 1px solid rgba(255,255,255,0.05); }
    .chat-input .input-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
    .chat-input input { flex: 1; padding: 0.6rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 0.85rem; }
    .chat-input button { padding: 0.6rem 1rem; background: linear-gradient(135deg, #a78bfa, #f472b6); border: none; border-radius: 8px; color: #fff; font-weight: 600; cursor: pointer; }
    .quick-btns { display: flex; gap: 0.4rem; }
    .quick-btn { padding: 0.3rem 0.6rem; border-radius: 15px; font-size: 0.75rem; cursor: pointer; border: 1px solid; }
    .quick-btn.a { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); color: #ef4444; }
    .quick-btn.b { background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); color: #3b82f6; }
    .quick-btn.neutral { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); color: #a5a5b8; }
    .vote-prompt { padding: 1rem; text-align: center; background: rgba(167,139,250,0.1); }
    .vote-prompt p { color: #fbbf24; font-weight: 600; }
    .end-screen { background: linear-gradient(145deg, rgba(251,191,36,0.1), rgba(167,139,250,0.1)); border-radius: 12px; padding: 2rem; text-align: center; }
    .end-screen h2 { font-size: 1.8rem; margin-bottom: 1.5rem; color: #fbbf24; }
    .rankings { max-width: 400px; margin: 0 auto 1.5rem; }
    .rank-item { display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem; margin-bottom: 0.4rem; background: rgba(255,255,255,0.03); border-radius: 8px; }
    .rank-item.first { background: rgba(251,191,36,0.2); border: 1px solid rgba(251,191,36,0.3); }
    .rank-item .rank { font-weight: 700; width: 1.5rem; color: #fbbf24; }
    .rank-item .avatar { font-size: 1.3rem; }
    .rank-item .name { flex: 1; }
    .rank-item .score { font-weight: 600; color: #a78bfa; }
    .back-btn { padding: 0.8rem 2rem; background: linear-gradient(135deg, #a78bfa, #f472b6); border: none; border-radius: 10px; color: #fff; font-size: 1rem; font-weight: 600; cursor: pointer; }
    .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); padding: 1rem 2rem; background: rgba(0,0,0,0.9); border-radius: 10px; color: #fff; z-index: 1000; }
    .toast.error { border: 1px solid rgba(239,68,68,0.5); }
    .toast.success { border: 1px solid rgba(74,222,128,0.5); }
  </style>
</head>
<body>
  <div class="wallet-bar">
    <div class="logo">ğŸ“œ å…±è¯†ç¼–å¹´å²</div>
    <div class="wallet-info" id="wallet-info">
      <button class="connect-btn" onclick="connectWallet()">ğŸ¦Š è¿æ¥ MetaMask</button>
    </div>
  </div>

  <div id="home-view" class="container">
    <div class="hero">
      <div class="hero-icon">ğŸ“œ</div>
      <h1>å…±è¯†ç¼–å¹´å²</h1>
      <p class="subtitle">Consensus Chronicle</p>
      <p class="desc">å…±è¯†å¦‚ä½•å¡‘é€ å†å²ï¼Ÿä½ çš„é€‰æ‹©å°†æ”¹å†™å‘½è¿ã€‚</p>
    </div>
    
    <div style="text-align: center; margin-bottom: 2rem;">
      <div class="contract-badge">
        <span class="dot"></span>
        <span>åˆçº¦: 0x4F5F...aE186 (GenLayer)</span>
      </div>
    </div>
    
    <div id="not-connected" style="text-align: center; padding: 3rem;">
      <p style="color: #8b8b9e; margin-bottom: 1.5rem;">è¿æ¥é’±åŒ…ï¼Œå¼€å§‹å²è¯—ä¹‹æ—…</p>
      <button class="connect-btn" onclick="connectWallet()" style="font-size: 1.1rem; padding: 1rem 2rem;">ğŸ¦Š è¿æ¥ MetaMask</button>
    </div>
    
    <div id="not-registered" class="hidden">
      <div class="register-form">
        <h3>ğŸ‘¤ åˆ›å»ºè§’è‰²</h3>
        <input type="text" id="reg-name" placeholder="è¾“å…¥åå­—...">
        <p style="color: #8b8b9e; font-size: 0.9rem; margin-bottom: 0.5rem;">é€‰æ‹©å¤´åƒï¼š</p>
        <div class="avatars" id="avatar-selector"></div>
        <button class="submit-btn" onclick="registerPlayer()">ğŸ® å¼€å§‹å†’é™©</button>
        <div class="cost-info">âœ… é’±åŒ…å·²è¿æ¥ï¼Œå¯ä»¥å¼€å§‹æ¸¸æˆ</div>
      </div>
    </div>
    
    <div id="registered" class="hidden">
      <div class="player-card" id="player-card"></div>
      <h2 class="section-title">ğŸ® é€‰æ‹©æ•…äº‹ä¸»é¢˜</h2>
      <div class="themes-grid" id="themes-grid"></div>
    </div>
  </div>

  <div id="room-view" class="container hidden" style="margin-top: 60px;"></div>
  <div id="game-view" class="hidden"></div>

  <script>
    const AVATARS = ['ğŸ®','âš”ï¸','ğŸ§™â€â™€ï¸','ğŸ¹','ğŸ›¡ï¸','ğŸ—¡ï¸','ğŸ”®','ğŸ‘‘','ğŸ‰','ğŸ¦…','ğŸº','ğŸ¦Š'];
    const STORIES = {
      fantasy: { name: 'å¥‡å¹»å†’é™©', icon: 'ğŸ°', opening: 'å¤è€çš„é¢„è¨€ç»ˆäºåº”éªŒâ€”â€”æ²‰ç¡åƒå¹´çš„é»‘é¾™è‹é†’äº†ã€‚ç‹å›½å±åœ¨æ—¦å¤•ï¼Œå›½ç‹ç´§æ€¥å¬é›†äº†å„åœ°è‹±é›„å•†è®®å¯¹ç­–...', rounds: [
        { context: 'é»‘é¾™å¨èƒè¿«åœ¨çœ‰ç«ï¼Œç‹å›½å¿…é¡»åšå‡ºç¬¬ä¸€ä¸ªå…³é”®å†³å®šã€‚', a: { text: 'ç«‹å³é›†ç»“å†›é˜Ÿï¼Œä¸»åŠ¨å‡ºå‡»é¾™å·¢ï¼Œåœ¨å®ƒå®Œå…¨è‹é†’å‰å°†å…¶æ¶ˆç­ã€‚', tag: 'å…ˆå‘åˆ¶äºº' }, b: { text: 'æ´¾é£ä½¿è€…å¯»æ±‚ç²¾çµæ—çš„å¸®åŠ©ï¼Œä»–ä»¬æ›¾åœ¨åƒå¹´å‰å°å°è¿‡é»‘é¾™ã€‚', tag: 'å¯»æ±‚è”ç›Ÿ' } },
        { context: 'ä½ ä»¬çš„å†³å®šäº§ç”Ÿäº†è¿é”ååº”ï¼Œæ–°çš„å±æœºæµ®ç°...', a: { text: 'é‡‡å–æ›´æ¿€è¿›çš„è¡ŒåŠ¨ï¼Œä¸æƒœä¸€åˆ‡ä»£ä»·å®Œæˆç›®æ ‡ã€‚', tag: 'å­¤æ³¨ä¸€æ·' }, b: { text: 'å¯»æ‰¾æŠ˜ä¸­æ–¹æ¡ˆï¼Œåœ¨é£é™©å’Œæ”¶ç›Šä¹‹é—´å–å¾—å¹³è¡¡ã€‚', tag: 'ç¨³ä¸­æ±‚è¿›' } },
        { context: 'å±€åŠ¿æ„ˆå‘ç´§å¼ ï¼Œå„æ–¹åŠ¿åŠ›å¼€å§‹è§’åŠ›...', a: { text: 'ä½¿ç”¨ç¦å¿Œé­”æ³•ï¼Œç‰ºç‰²æ–½æ³•è€…çš„ç”Ÿå‘½æ¥é‡åˆ›é»‘é¾™ã€‚', tag: 'ç‰ºç‰²å°æˆ‘' }, b: { text: 'ä¸‹ä»¤æ’¤é€€ï¼Œä¿å­˜å®åŠ›ï¼Œç­‰å¾…æ›´å¥½çš„æ—¶æœºå†æˆ˜ã€‚', tag: 'ä»¥é€€ä¸ºè¿›' } },
        { context: 'æˆ˜å±€å‡ºç°è½¬æœºï¼Œä½†ä¹Ÿå¸¦æ¥äº†æ–°çš„æŠ‰æ‹©...', a: { text: 'è¶é»‘é¾™ç–—ä¼¤æœŸé—´å‘èµ·æ€»æ”»ï¼Œä¸€ä¸¾å°†å…¶æ¶ˆç­ã€‚', tag: 'ä¹˜èƒœè¿½å‡»' }, b: { text: 'å°è¯•ä¸å—ä¼¤çš„é»‘é¾™æ²Ÿé€šï¼Œå¯»æ‰¾å’Œå¹³å…±å­˜çš„å¯èƒ½ã€‚', tag: 'åŒ–æ•Œä¸ºå‹' } },
        { context: 'æœ€ç»ˆå†³æˆ˜æ¥ä¸´ï¼Œå‘½è¿çš„å¤©å¹³ç­‰å¾…ç€ä½ ä»¬çš„å†³å®š...', a: { text: 'ä¸æƒœä¸€åˆ‡ä»£ä»·æ¶ˆç­é»‘é¾™ï¼Œå“ªæ€•ç‹å›½åŒ–ä¸ºç„¦åœŸã€‚', tag: 'ç‰çŸ³ä¿±ç„š' }, b: { text: 'ä¸é»‘é¾™è¾¾æˆåè®®ï¼Œå…±åŒé¢å¯¹æœªæ¥çš„æŒ‘æˆ˜ã€‚', tag: 'æ¡æ‰‹è¨€å’Œ' } }
      ]},
      scifi: { name: 'ç§‘å¹»æœªæ¥', icon: 'ğŸš€', opening: '2157å¹´ï¼Œç«æ˜Ÿæ®–æ°‘åœ°æ”¶åˆ°æ¥è‡ªæ·±ç©ºçš„ç¥ç§˜ä¿¡å·â€”â€”åœ°çƒå°†åœ¨100å¤©åè¢«å°è¡Œæ˜Ÿæ’å‡»...', rounds: [
        { context: 'æ¶ˆæ¯å…¬å¸ƒåï¼Œæ®–æ°‘åœ°é™·å…¥ææ…Œã€‚é¢†å¯¼å±‚å¿…é¡»ç«‹å³åšå‡ºå†³å®šã€‚', a: { text: 'å¯åŠ¨"æ–¹èˆŸè®¡åˆ’"ï¼Œé€šè¿‡æŠ½ç­¾å†³å®šè°èƒ½ç™»ä¸Šé€ƒç”Ÿé£èˆ¹ã€‚', tag: 'å…¬å¹³æŠ½ç­¾' }, b: { text: 'é›†ä¸­èµ„æºç ”ç©¶ä¿¡å·æ¥æºï¼Œä¹Ÿè®¸é‚£é‡Œæœ‰æ‹¯æ•‘æ‰€æœ‰äººçš„ç­”æ¡ˆã€‚', tag: 'è¿½å¯»å¸Œæœ›' } },
        { context: 'ç¬¬ä¸€ä¸ªå†³å®šçš„åæœå¼€å§‹æ˜¾ç°...', a: { text: 'æˆæƒå®‰ä¿éƒ¨é˜Ÿä½¿ç”¨æ­¦åŠ›ï¼Œç¡®ä¿ç§©åºç¨³å®šã€‚', tag: 'é“è…•é•‡å‹' }, b: { text: 'ä¸å„æ–¹è°ˆåˆ¤ï¼Œä¿®æ”¹è®¡åˆ’è®©æ›´å¤šäººè·å¾—ç”Ÿå­˜æœºä¼šã€‚', tag: 'å¯»æ±‚å…±è¯†' } },
        { context: 'èµ„æºæ—¥ç›Šç´§å¼ ï¼Œç¤¾ä¼šçŸ›ç›¾åŠ å‰§...', a: { text: 'æ¥å—è¶…è½½æ–¹æ¡ˆï¼Œç”¨60%æˆåŠŸç‡æ¢å–æ›´å¤šäººçš„å¸Œæœ›ã€‚', tag: 'å†’é™©æ±‚å…¨' }, b: { text: 'ç»´æŒåŸè®¡åˆ’ï¼Œç¡®ä¿ä¸€åŠäººèƒ½å¤Ÿç¡®å®šå­˜æ´»ã€‚', tag: 'ç¨³å¦¥æ±‚å­˜' } },
        { context: 'æ„å¤–çš„å‘ç°å¸¦æ¥äº†æ–°çš„å¯èƒ½æ€§...', a: { text: 'å°è¯•æ”¹å˜å°è¡Œæ˜Ÿè½¨é“ï¼Œå³ä½¿å¤±è´¥ä¹Ÿå€¼å¾—ä¸€è¯•ã€‚', tag: 'é€†å¤©æ”¹å‘½' }, b: { text: 'æŒ‰åŸè®¡åˆ’æ’¤ç¦»ï¼Œä¸æŠŠæ‰€æœ‰é¸¡è›‹æ”¾åœ¨ä¸€ä¸ªç¯®å­é‡Œã€‚', tag: 'åˆ†æ•£é£é™©' } },
        { context: 'æœ€åçš„æ—¶åˆ»æ¥ä¸´...', a: { text: 'æ”¾æ‰‹ä¸€æï¼Œç”¨å‰©ä½™èƒ½æºå†æ¨ä¸€æ¬¡ã€‚', tag: 'èƒŒæ°´ä¸€æˆ˜' }, b: { text: 'æ¥å—æŸå¤±ï¼Œå¼€å§‹ç¾åé‡å»ºè®¡åˆ’ã€‚', tag: 'åŠ¡å®é¢å¯¹' } }
      ]},
      mystery: { name: 'æ‚¬ç–‘æ¨ç†', icon: 'ğŸ”', opening: 'æš´é£é›¨ä¹‹å¤œï¼Œå¯Œè±ªé™ˆè€çˆ·åœ¨ä¹¦æˆ¿è¢«äººæ¯’æ€ã€‚å¤§é—¨åé”ï¼Œçª—æˆ·å®Œå¥½ã€‚åœ¨åœºæœ‰ï¼šå¤§å„¿å­ã€äºŒå¥³å„¿ã€ç®¡å®¶ã€å¥³ä»†å’Œç¥ç§˜å•†äºº...', rounds: [
        { context: 'è­¦æ–¹å°é”å®…é‚¸ï¼Œä½ ä½œä¸ºä¾¦æ¢å¿…é¡»å¼€å§‹è°ƒæŸ¥ã€‚', a: { text: 'é¦–å…ˆæœæŸ¥æ­»è€…çš„ä¹¦æˆ¿ï¼Œå¯»æ‰¾ç‰©è¯å’Œçº¿ç´¢ã€‚', tag: 'ç‰©è¯ä¼˜å…ˆ' }, b: { text: 'åˆ†åˆ«è¯¢é—®åœ¨åœºæ¯ä¸ªäººï¼Œè§‚å¯Ÿä»–ä»¬çš„ååº”ã€‚', tag: 'å¯Ÿè¨€è§‚è‰²' } },
        { context: 'åˆæ­¥è°ƒæŸ¥æ­ç¤ºäº†ä¸€äº›å‘ç°...', a: { text: 'æ·±å…¥è°ƒæŸ¥é—äº§é—®é¢˜ï¼Œè¿½æŸ¥ç»§æ‰¿æƒã€‚', tag: 'è¿½è¸ªé‡‘é’±' }, b: { text: 'è°ƒæŸ¥ç¥ç§˜å•†äººçš„èº«ä»½ï¼Œä»–å‡ºç°å¤ªå·§åˆã€‚', tag: 'è¿½æŸ¥å¤–äºº' } },
        { context: 'æ›´å¤šç§˜å¯†è¢«æ­å¼€...', a: { text: 'éªŒè¯å¥³ä»†çš„è¯è¯ï¼Œå¥¹å¯èƒ½æ˜¯å…³é”®è¯äººã€‚', tag: 'è´¨ç–‘è¯è¯' }, b: { text: 'è°ƒæŸ¥é™ˆå¹´æ—§æ¡ˆï¼Œè¿‡å»çš„ç§˜å¯†å¯èƒ½æ­ç¤ºçœŸç›¸ã€‚', tag: 'è¿½æº¯è¿‡å»' } },
        { context: 'çœŸç›¸æµ®å‡ºæ°´é¢...', a: { text: 'å¯¹å«Œç–‘äººè¿›è¡Œäº¤å‰å®¡é—®ï¼Œæ‰¾å‡ºè°åœ¨è¯´è°ã€‚', tag: 'æ­£é¢å¯¹è´¨' }, b: { text: 'é‡æ–°æ£€éªŒæ¯’è¯æ¥æºï¼Œå‡¶å™¨èƒ½æŒ‡å‘çœŸå‡¶ã€‚', tag: 'ç§‘å­¦åˆ†æ' } },
        { context: 'æ˜¯æ—¶å€™æ­ç¤ºçœŸç›¸äº†...', a: { text: 'å…¬å¼€æ‰€æœ‰çœŸç›¸ï¼Œè®©æ³•å¾‹æ¥è£å†³ã€‚', tag: 'å…¬æ­£å®¡åˆ¤' }, b: { text: 'ç»™ç›¸å…³äººé€‰æ‹©æœºä¼šï¼Œæœ‰äº›çœŸç›¸ä¸è¯¥å…¬å¼€ã€‚', tag: 'äººæƒ…è€ƒé‡' } }
      ]},
      political: { name: 'å®«å»·æƒè°‹', icon: 'ğŸ‘‘', opening: 'å¤§é½ç‹æœï¼Œè€çš‡å¸é©¾å´©ã€‚é—è¯ä»¤äººè´¹è§£ï¼šçš‡ä½ä¸ä¼ ç»™ä¸‰ä½çš‡å­ä¸­ä»»ä½•ä¸€ä¸ªï¼Œè€Œæ˜¯ç”±"æœ€èƒ½ä»£è¡¨æ°‘å¿ƒè€…"ç»§æ‰¿...', rounds: [
        { context: 'ä½œä¸ºé¦–è¾…ï¼Œä½ å¿…é¡»åœ¨æ··ä¹±ä¸­ç»´æŒå±€é¢ã€‚', a: { text: 'æ”¯æŒå¤ªå­æŒ‰ä¼ ç»Ÿç»§ä½ï¼Œç»´æŠ¤ç¨³å®šã€‚', tag: 'ä¼ ç»Ÿæ­£ç»Ÿ' }, b: { text: 'æè®®ä¸‰ä½çš‡å­å„é™ˆæ”¿çº²ï¼Œç”±ç™¾å®˜å…¬è®®ã€‚', tag: 'å…¬è®®å†³é€‰' } },
        { context: 'å†³å®šå¼•å‘è¿é”ååº”...', a: { text: 'è°ƒåŠ¨å¾¡æ—å†›å¸ƒé˜²ï¼Œåˆ†åŒ–å¯¹æ–¹åŒç›Ÿã€‚', tag: 'åˆ†åŒ–ç“¦è§£' }, b: { text: 'ä¸»åŠ¨æ‰¾å¯¹æ–¹è°ˆåˆ¤ï¼Œå¯»æ‰¾å’Œå¹³è§£å†³ã€‚', tag: 'å’Œè°ˆæ­¢å…µ' } },
        { context: 'å¤–éƒ¨åŠ¿åŠ›å¼€å§‹ä»‹å…¥...', a: { text: 'ç­”åº”æ¡ä»¶ï¼Œå…ˆç¨³ä½å±€é¢ã€‚', tag: 'æƒå®œä¹‹è®¡' }, b: { text: 'æ­éœ²é˜´è°‹ï¼Œè”åˆä¸‰çš‡å­å¯¹æŠ—å¤–æˆšã€‚', tag: 'å›¢ç»“æŠ—æ•Œ' } },
        { context: 'è¾¹ç–†æ€¥æŠ¥ï¼šåŒ—æ–¹æ¸¸ç‰§å¤§å†›å‹å¢ƒã€‚', a: { text: 'ä¸‰çš‡å­äº²å¾åŒ—ç–†ï¼Œå‡»é€€æ•Œå†›è€…ä¸ºæ–°å¸ã€‚', tag: 'ä»¥æˆ˜å®šå¸' }, b: { text: 'å…ˆé€‰æ–°å¸å†åº”å¯¹å¤–æ•Œï¼Œå›½ä¸å¯æ— å›ã€‚', tag: 'å…ˆå†…åå¤–' } },
        { context: 'æœ€ç»ˆå†³å®šå°†å½±å“ç™¾å¹´å›½è¿...', a: { text: 'ä¸‰ä½çš‡å­å…±åŒæ‰§æ”¿ï¼Œå»ºç«‹æ–°åˆ¶åº¦ã€‚', tag: 'æƒåŠ›å…±äº«' }, b: { text: 'æŒ‰å†›åŠŸå¤§å°ï¼Œç”±åŠŸåŠ³æœ€å¤§è€…ç»§ä½ã€‚', tag: 'åŠŸå‹‹å®šä½' } }
      ]}
    };
    
    let S = { address: null, balance: '0', player: null, avatar: AVATARS[0], room: null, players: [], round: 0, phase: 'waiting', timer: 0, story: [], votes: {}, myVote: null, scores: {}, messages: [], currentOptions: null };
    let timerInt = null;
    
    const toast = (m, t='info') => { document.querySelectorAll('.toast').forEach(e=>e.remove()); const d=document.createElement('div'); d.className=`toast ${t}`; d.textContent=m; document.body.appendChild(d); setTimeout(()=>d.remove(),3000); };
    const shortAddr = a => a ? a.slice(0,6)+'...'+a.slice(-4) : '';
    
    async function connectWallet() {
      if (!window.ethereum) return toast('è¯·å®‰è£… MetaMask', 'error');
      try {
        toast('è¿æ¥ä¸­...');
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        S.address = accounts[0];
        try {
          const provider = new ethers.BrowserProvider(window.ethereum);
          const balance = await provider.getBalance(S.address);
          S.balance = parseFloat(ethers.formatEther(balance)).toFixed(4);
        } catch { S.balance = '0'; }
        toast('å·²è¿æ¥ï¼', 'success');
        updateUI();
        showRegister();
      } catch (e) { toast('è¿æ¥å¤±è´¥', 'error'); }
    }
    
    function updateUI() {
      const el = document.getElementById('wallet-info');
      if (S.address) {
        el.innerHTML = `<span class="network">å·²è¿æ¥</span><span class="address">${shortAddr(S.address)}</span><button class="disconnect-btn" onclick="location.reload()">æ–­å¼€</button>`;
        document.getElementById('not-connected').classList.add('hidden');
      } else {
        el.innerHTML = `<button class="connect-btn" onclick="connectWallet()">ğŸ¦Š è¿æ¥ MetaMask</button>`;
      }
    }
    
    function showRegister() {
      document.getElementById('not-registered').classList.remove('hidden');
      document.getElementById('avatar-selector').innerHTML = AVATARS.map(a => `<button class="avatar-btn ${a===S.avatar?'selected':''}" onclick="S.avatar='${a}';document.querySelectorAll('.avatar-btn').forEach(b=>b.classList.toggle('selected',b.textContent==='${a}'))">${a}</button>`).join('');
    }
    
    function registerPlayer() {
      const name = document.getElementById('reg-name').value.trim();
      if (!name) return toast('è¯·è¾“å…¥åå­—', 'error');
      S.player = { name, avatar: S.avatar };
      toast('è§’è‰²åˆ›å»ºæˆåŠŸï¼', 'success');
      document.getElementById('not-registered').classList.add('hidden');
      document.getElementById('registered').classList.remove('hidden');
      document.getElementById('player-card').innerHTML = `<span class="avatar">${S.player.avatar}</span><div class="info"><div class="name">${S.player.name}</div><div class="stats"><span class="stat">ğŸ“ ${shortAddr(S.address)}</span></div></div>`;
      document.getElementById('themes-grid').innerHTML = Object.entries(STORIES).map(([k,v]) => `<div class="theme-card" onclick="createRoom('${k}')"><span class="icon">${v.icon}</span><span class="name">${v.name}</span><span class="info">5è½®æ•…äº‹</span></div>`).join('');
    }
    
    function createRoom(theme) {
      S.room = { id: Date.now(), theme, host: S.address };
      S.players = [{ address: S.address, name: S.player?.name, avatar: S.player?.avatar }];
      document.getElementById('home-view').classList.add('hidden');
      document.getElementById('room-view').classList.remove('hidden');
      const arc = STORIES[theme];
      document.getElementById('room-view').innerHTML = `
        <div class="room-header"><button class="back-btn" onclick="leaveRoom()">â† è¿”å›</button><div class="theme-info"><span>${arc.icon}</span><span>${arc.name}</span></div></div>
        <div><h3 style="color:#8b8b9e;margin-bottom:1rem">ç©å®¶ (1/8)</h3>
        <div class="players-grid"><div class="player-slot filled you"><span class="badge">æˆ¿ä¸»</span><span class="slot-avatar">${S.player.avatar}</span><span class="slot-name">${S.player.name}</span></div>${Array(7).fill('<div class="player-slot empty"><span class="slot-avatar">?</span><span class="slot-name">ç­‰å¾…...</span></div>').join('')}</div></div>
        <button class="start-btn" onclick="startGame()">ğŸ® å¼€å§‹æ¸¸æˆ</button>
        <div class="rules-box"><h4>ğŸ“– è§„åˆ™</h4><ul><li>ğŸ’¬ è¾©è®º90ç§’ â†’ ğŸ—³ï¸ æŠ•ç¥¨30ç§’ â†’ ğŸ“Š ç»“ç®—</li><li>ğŸ† è·èƒœæ–¹+30åˆ†ï¼Œå‘è¨€+10åˆ†</li></ul></div>`;
    }
    
    function leaveRoom() { S.room=null; document.getElementById('room-view').classList.add('hidden'); document.getElementById('home-view').classList.remove('hidden'); }
    
    function startGame() {
      document.getElementById('room-view').classList.add('hidden');
      document.getElementById('game-view').classList.remove('hidden');
      S.round=0; S.phase='waiting'; S.story=[]; S.votes={}; S.myVote=null; S.messages=[]; S.scores={};
      S.players.forEach(p=>S.scores[p.address]={influence:0,debates:0,wins:0});
      const arc=STORIES[S.room.theme];
      S.story.push({text:arc.opening,type:'opening'});
      S.messages.push({type:'system',text:`ğŸ“– ${arc.name}å¼€å§‹!`});
      renderGame();
      setTimeout(()=>startRound(1),2000);
    }
    
    function startRound(r) {
      if(r>5) return endGame();
      S.round=r; S.phase='debate'; S.votes={}; S.myVote=null;
      const arc=STORIES[S.room.theme], rd=arc.rounds[r-1];
      S.story.push({text:rd.context,type:'context',round:r});
      S.currentOptions={a:rd.a,b:rd.b};
      S.messages.push({type:'system',text:`ğŸ“– ç¬¬${r}/5è½® - è¾©è®ºå¼€å§‹`});
      renderGame();
      startTimer(90,()=>startVoting());
    }
    
    function startVoting() { S.phase='vote'; S.messages.push({type:'system',text:'ğŸ—³ï¸ æŠ•ç¥¨!'}); renderGame(); startTimer(30,()=>calcResult()); }
    
    function submitVote(c) { if(S.phase!=='vote'||S.myVote)return; S.myVote=c; S.votes[S.address]=c; S.messages.push({type:'system',text:`ä½ é€‰äº†${c}`}); renderGame(); }
    
    function calcResult() {
      S.phase='result';
      const cnt={A:0,B:0}; Object.values(S.votes).forEach(v=>cnt[v]++);
      if(!S.myVote) { S.myVote=Math.random()>0.5?'A':'B'; S.votes[S.address]=S.myVote; cnt[S.myVote]++; }
      const win=cnt.A>=cnt.B?'A':'B';
      Object.entries(S.votes).forEach(([a,v])=>{ if(v===win&&S.scores[a]) { S.scores[a].influence+=30; S.scores[a].wins++; }});
      const opt=win==='A'?S.currentOptions.a:S.currentOptions.b;
      S.story.push({text:`ã€é€‰æ‹©ã€‘${opt.text}`,type:'choice',winner:win});
      S.story.push({text:'æ•…äº‹å› æ­¤è½¬æŠ˜...',type:'consequence'});
      S.messages.push({type:'system',text:`ğŸ“œ ${win}è·èƒœ!`});
      renderGame();
      if(S.round>=5) setTimeout(()=>endGame(),3000); else setTimeout(()=>startRound(S.round+1),3000);
    }
    
    function endGame() { S.phase='ended'; if(timerInt)clearInterval(timerInt); S.messages.push({type:'system',text:'ğŸ† å®Œæˆ!'}); renderGame(); }
    
    function startTimer(d,cb) { if(timerInt)clearInterval(timerInt); S.timer=d; renderTimer(); timerInt=setInterval(()=>{ S.timer--; renderTimer(); if(S.timer<=0){clearInterval(timerInt);cb();} },1000); }
    function renderTimer() { const el=document.getElementById('timer'); if(!el)return; el.textContent=S.phase==='ended'?'--:--':`${Math.floor(S.timer/60)}:${(S.timer%60).toString().padStart(2,'0')}`; el.className=S.timer<=10?'timer warning':'timer'; }
    
    function sendMessage() { const i=document.getElementById('chat-text'),t=i?.value?.trim(); if(!t||S.phase!=='debate')return; const c=t.includes('A')?'A':t.includes('B')?'B':null; S.messages.push({type:'chat',sender:S.player,text:t,choice:c}); i.value=''; S.scores[S.address].debates+=10; renderGame(); }
    function quickMsg(t) { const i=document.getElementById('chat-text'); i.value=t==='A'?'æˆ‘æ”¯æŒAï¼Œå› ä¸º':t==='B'?'æˆ‘æ”¯æŒBï¼Œå› ä¸º':'æˆ‘è®¤ä¸º'; i.focus(); }
    
    function renderGame() {
      const arc=STORIES[S.room?.theme], ms=S.scores[S.address]||{influence:0,debates:0};
      document.getElementById('game-view').innerHTML = `
        <div class="game-header">
          <div class="round-info"><div class="label">ç¬¬${S.round}/5è½®</div><div class="phase">${S.phase==='debate'?'ğŸ’¬è¾©è®º':S.phase==='vote'?'ğŸ—³ï¸æŠ•ç¥¨':S.phase==='ended'?'ğŸ†ç»“æŸ':'ğŸ“Šç»“ç®—'}</div></div>
          <div class="progress-dots">${[1,2,3,4,5].map(i=>`<div class="dot ${i<S.round?'completed':i===S.round?'current':''}"></div>`).join('')}</div>
          <div class="timer" id="timer">${Math.floor(S.timer/60)}:${(S.timer%60).toString().padStart(2,'0')}</div>
          <div class="score-display"><div class="label">ç§¯åˆ†</div><div class="value">${ms.influence+ms.debates}</div></div>
        </div>
        <div class="game-content">
          <div class="story-panel">
            <div class="story-scroll"><h3>ğŸ“œ ${arc?.name}</h3>${S.story.map(s=>`<div class="story-entry ${s.type}">${s.type==='context'?`<span class="badge">ç¬¬${s.round}è½®</span>`:''}${s.winner?(s.winner==='A'?'ğŸ…°ï¸':'ğŸ…±ï¸'):''}${s.text}</div>`).join('')}</div>
            ${S.phase==='ended'?`<div class="end-screen"><h2>ğŸ† å®Œæˆ!</h2><div class="rankings">${Object.entries(S.scores).sort((a,b)=>(b[1].influence+b[1].debates)-(a[1].influence+a[1].debates)).map(([a,sc],i)=>{const p=S.players.find(x=>x.address===a)||{avatar:'ğŸ‘¤',name:shortAddr(a)};return`<div class="rank-item ${i===0?'first':''}"><span class="rank">#${i+1}</span><span class="avatar">${p.avatar}</span><span class="name">${p.name}</span><span class="score">${sc.influence+sc.debates}</span></div>`;}).join('')}</div><button class="back-btn" onclick="backHome()">è¿”å›</button></div>`
            :`<div class="options-panel"><h4>âš”ï¸ æŠ‰æ‹©</h4><div class="options-grid">
              <div class="option-card option-a ${S.myVote==='A'?'selected':''}" onclick="submitVote('A')"><div class="header"><span class="label">A</span><span class="tag">${S.currentOptions?.a?.tag||''}</span></div><p class="text">${S.currentOptions?.a?.text||''}</p>${S.phase==='vote'?`<div class="votes">${Object.values(S.votes).filter(v=>v==='A').length}ç¥¨</div>`:''}</div>
              <div class="option-card option-b ${S.myVote==='B'?'selected':''}" onclick="submitVote('B')"><div class="header"><span class="label">B</span><span class="tag">${S.currentOptions?.b?.tag||''}</span></div><p class="text">${S.currentOptions?.b?.text||''}</p>${S.phase==='vote'?`<div class="votes">${Object.values(S.votes).filter(v=>v==='B').length}ç¥¨</div>`:''}</div>
            </div></div>`}
          </div>
          <div class="chat-panel">
            <div class="players-bar">${S.players.map(p=>`<div class="player-tag ${S.votes[p.address]?'voted':''}"><span>${p.avatar}</span><span>${(p.name||'').slice(0,4)}</span>${S.votes[p.address]?`<span class="vote">${S.votes[p.address]}</span>`:''}</div>`).join('')}</div>
            <div class="messages-list">${S.messages.map(m=>m.type==='system'?`<div class="message system">${m.text}</div>`:`<div class="message chat"><div class="header"><span class="sender">${m.sender?.avatar||''} ${m.sender?.name||''}</span>${m.choice?`<span class="stance ${m.choice.toLowerCase()}">æ”¯æŒ${m.choice}</span>`:''}</div><div class="content">${m.text}</div></div>`).join('')}</div>
            ${S.phase==='debate'?`<div class="chat-input"><div class="input-row"><input type="text" id="chat-text" placeholder="è¾“å…¥è§‚ç‚¹..." onkeydown="if(event.key==='Enter')sendMessage()"><button onclick="sendMessage()">å‘é€</button></div><div class="quick-btns"><button class="quick-btn a" onclick="quickMsg('A')">ğŸ…°ï¸ A</button><button class="quick-btn b" onclick="quickMsg('B')">ğŸ…±ï¸ B</button><button class="quick-btn neutral" onclick="quickMsg('N')">ğŸ’­</button></div></div>`:S.phase==='vote'&&!S.myVote?`<div class="vote-prompt"><p>â° è¯·é€‰æ‹©!</p></div>`:''}
          </div>
        </div>`;
    }
    
    function backHome() { if(timerInt)clearInterval(timerInt); S.room=null; document.getElementById('game-view').classList.add('hidden'); document.getElementById('home-view').classList.remove('hidden'); }
    
    window.ethereum?.on('accountsChanged',()=>location.reload());
    updateUI();
  </script>
</body>
</html>
