<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…±è¯†ç¼–å¹´å² - Consensus Chronicle</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/msgpack-lite@0.1.26/dist/msgpack.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#0f0f1a 0%,#1a1a2e 50%,#16213e 100%);min-height:100vh;color:#e8e8e8}.top-bar{position:fixed;top:0;left:0;right:0;z-index:1000;display:flex;justify-content:space-between;align-items:center;padding:.8rem 1.5rem;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);border-bottom:1px solid rgba(167,139,250,.2)}.logo{display:flex;align-items:center;gap:.5rem;font-size:1.1rem;font-weight:600}.status-group{display:flex;align-items:center;gap:1rem}.status-badge{padding:.3rem .8rem;border-radius:20px;font-size:.8rem;display:flex;align-items:center;gap:.4rem}.status-badge .dot{width:8px;height:8px;border-radius:50%}.firebase-status{background:rgba(251,146,60,.2);border:1px solid rgba(251,146,60,.4);color:#fb923c}.firebase-status .dot{background:#fb923c}.firebase-status.connected{background:rgba(74,222,128,.2);border-color:rgba(74,222,128,.4);color:#4ade80}.firebase-status.connected .dot{background:#4ade80}.wallet-status{background:rgba(167,139,250,.2);border:1px solid rgba(167,139,250,.4);color:#a78bfa}.wallet-status.connected{background:rgba(74,222,128,.2);border-color:rgba(74,222,128,.4);color:#4ade80}.wallet-address{font-family:monospace;color:#a5a5b8;font-size:.85rem}.btn{padding:.6rem 1.2rem;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all .2s}.btn-primary{background:linear-gradient(135deg,#a78bfa,#f472b6);color:#fff}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(167,139,250,.4)}.btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none}.btn-secondary{background:rgba(255,255,255,.1);color:#e8e8e8;border:1px solid rgba(255,255,255,.2)}.btn-small{padding:.4rem .8rem;font-size:.85rem}.container{max-width:1200px;margin:0 auto;padding:5rem 1.5rem 2rem}.hidden{display:none!important}.toast-container{position:fixed;top:80px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:.5rem}.toast{padding:1rem 1.5rem;border-radius:8px;color:#fff;animation:slideIn .3s ease;max-width:350px}.toast.success{background:linear-gradient(135deg,#059669,#10b981)}.toast.error{background:linear-gradient(135deg,#dc2626,#ef4444)}.toast.info{background:linear-gradient(135deg,#2563eb,#3b82f6)}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}.hero{text-align:center;margin-bottom:3rem}.hero-icon{font-size:5rem;margin-bottom:1rem}.hero h1{font-size:3rem;font-weight:800;background:linear-gradient(135deg,#a78bfa,#f472b6,#fb923c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:.5rem}.hero .subtitle{color:#8b8b9e;letter-spacing:.3em;text-transform:uppercase;margin-bottom:1rem}.hero .desc{color:#a5a5b8;font-style:italic}.tech-badges{display:flex;justify-content:center;gap:1rem;margin-top:1.5rem;flex-wrap:wrap}.tech-badge{display:flex;align-items:center;gap:.5rem;padding:.5rem 1rem;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:20px;font-size:.85rem}.tech-badge.firebase{border-color:rgba(251,146,60,.3);color:#fb923c}.tech-badge.genlayer{border-color:rgba(167,139,250,.3);color:#a78bfa}.setup-section{max-width:500px;margin:2rem auto}.setup-card{padding:2rem;background:rgba(255,255,255,.03);border-radius:16px;border:1px solid rgba(255,255,255,.1);margin-bottom:1.5rem}.setup-card h3{margin-bottom:1rem;color:#c4b5fd;display:flex;align-items:center;gap:.5rem}.setup-card input{width:100%;padding:1rem;margin-bottom:1rem;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#fff;font-size:1rem}.setup-card input:focus{outline:none;border-color:rgba(167,139,250,.5)}.avatar-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:.5rem;margin-bottom:1rem}.avatar-option{padding:.8rem;text-align:center;font-size:1.5rem;background:rgba(255,255,255,.05);border:2px solid transparent;border-radius:8px;cursor:pointer;transition:all .2s}.avatar-option:hover{background:rgba(255,255,255,.1)}.avatar-option.selected{border-color:#a78bfa;background:rgba(167,139,250,.2)}.theme-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-bottom:2rem}.theme-card{display:flex;flex-direction:column;align-items:center;padding:2rem;background:linear-gradient(145deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.1);border-radius:16px;cursor:pointer;transition:all .3s}.theme-card:hover{transform:translateY(-5px);border-color:rgba(167,139,250,.5)}.theme-card .icon{font-size:3rem;margin-bottom:1rem}.theme-card .name{font-size:1.2rem;font-weight:600}.theme-card .desc{font-size:.85rem;color:#6b6b7e;margin-top:.5rem}.room-list{margin-top:2rem}.room-list h3{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;color:#c4b5fd}.room-item{display:flex;align-items:center;gap:1rem;padding:1rem;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.1);border-radius:12px;margin-bottom:.8rem;cursor:pointer;transition:all .2s}.room-item:hover{background:rgba(255,255,255,.05);border-color:rgba(167,139,250,.3)}.room-item .theme-icon{font-size:2rem}.room-item .info{flex:1}.room-item .theme-name{font-weight:600}.room-item .host{font-size:.85rem;color:#8b8b9e}.room-item .players{color:#4ade80;font-weight:600}.no-rooms{text-align:center;padding:2rem;color:#6b6b7e}.loading{display:inline-block;width:20px;height:20px;border:2px solid rgba(167,139,250,.3);border-top-color:#a78bfa;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.room-view{max-width:800px;margin:0 auto}.room-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid rgba(255,255,255,.1)}.player-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:2rem}.player-slot{display:flex;flex-direction:column;align-items:center;padding:1.5rem 1rem;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.1);border-radius:12px;position:relative;transition:all .3s}.player-slot.host{border-color:rgba(251,191,36,.5);background:rgba(251,191,36,.1)}.player-slot.me{border-color:rgba(167,139,250,.5)}.player-slot .avatar{font-size:2.5rem;margin-bottom:.5rem}.player-slot .name{font-size:.95rem;text-align:center}.player-slot .badge{position:absolute;top:.5rem;right:.5rem;font-size:.6rem;padding:.2rem .4rem;border-radius:4px}.badge-host{background:#fbbf24;color:#000}.badge-me{background:#a78bfa;color:#fff}.empty-slot{opacity:.4;border-style:dashed}.game-view{display:flex;flex-direction:column;height:calc(100vh - 60px);padding-top:60px}.game-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;background:rgba(0,0,0,.3);border-bottom:1px solid rgba(255,255,255,.1)}.game-main{flex:1;display:flex;gap:1rem;padding:1rem;overflow:hidden}.story-panel{flex:1;display:flex;flex-direction:column;gap:1rem;min-width:0}.story-scroll{flex:1;background:rgba(255,255,255,.03);border-radius:12px;padding:1rem;overflow-y:auto}.story-scroll h3{color:#c4b5fd;margin-bottom:1rem;font-size:1rem}.story-item{padding:.6rem 0;border-bottom:1px solid rgba(255,255,255,.05);line-height:1.7}.story-item:last-child{border-bottom:none}.story-item.opening{color:#c4b5fd;font-style:italic}.story-item.context{color:#fbbf24}.story-item.choice{color:#4ade80}.story-item.consequence{color:#a5a5b8;padding-left:1.5rem;border-left:2px solid rgba(167,139,250,.3)}.round-badge{background:rgba(251,191,36,.2);padding:.2rem .5rem;border-radius:4px;margin-right:.5rem}.options-panel{background:rgba(255,255,255,.02);border-radius:12px;padding:1rem}.options-panel h4{text-align:center;margin-bottom:1rem}.options-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}.option-card{padding:1rem;border-radius:10px;cursor:pointer;transition:all .3s}.option-card.option-a{border:2px solid rgba(239,68,68,.4);background:rgba(239,68,68,.1)}.option-card.option-b{border:2px solid rgba(59,130,246,.4);background:rgba(59,130,246,.1)}.option-card.selected{transform:scale(1.02)}.option-card.option-a.selected{border-color:#ef4444}.option-card.option-b.selected{border-color:#3b82f6}.option-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem}.option-label{font-weight:700;font-size:1.1rem}.option-label.label-a{color:#ef4444}.option-label.label-b{color:#3b82f6}.option-tag{font-size:.75rem;padding:.2rem .5rem;background:rgba(255,255,255,.1);border-radius:4px;color:#a5a5b8}.option-text{line-height:1.5;font-size:.9rem}.vote-count{margin-top:.8rem;text-align:center;font-size:1.2rem;font-weight:600;color:#fbbf24}.voter-avatars{display:flex;justify-content:center;gap:.3rem;margin-top:.5rem;flex-wrap:wrap}.voter-avatar{font-size:1.2rem}.chat-panel{width:320px;display:flex;flex-direction:column;background:rgba(0,0,0,.2);border-radius:12px;overflow:hidden}.chat-players{display:flex;flex-wrap:wrap;gap:.4rem;padding:.8rem;border-bottom:1px solid rgba(255,255,255,.05)}.chat-player{display:flex;align-items:center;gap:.3rem;padding:.3rem .6rem;background:rgba(255,255,255,.05);border-radius:15px;font-size:.8rem;transition:all .3s}.chat-player.voted{background:rgba(74,222,128,.2);border:1px solid rgba(74,222,128,.4)}.chat-player .vote-badge{color:#4ade80;font-weight:700}.chat-messages{flex:1;overflow-y:auto;padding:.8rem}.chat-msg{margin-bottom:.6rem;font-size:.85rem;animation:fadeIn .3s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.chat-msg.system{color:#a78bfa;font-style:italic;padding:.3rem 0}.chat-msg.player{background:rgba(255,255,255,.03);border-radius:8px;padding:.5rem .8rem}.chat-msg .sender{color:#fbbf24;font-weight:600;margin-bottom:.3rem;display:flex;justify-content:space-between;align-items:center}.chat-msg .stance{font-size:.7rem;padding:.1rem .4rem;border-radius:4px}.chat-msg .stance.stance-a{background:rgba(239,68,68,.3)}.chat-msg .stance.stance-b{background:rgba(59,130,246,.3)}.chat-input{padding:.8rem;border-top:1px solid rgba(255,255,255,.05)}.chat-input-row{display:flex;gap:.5rem;margin-bottom:.5rem}.chat-input input{flex:1;padding:.6rem .8rem;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:#fff;font-size:.85rem}.chat-input input:focus{outline:none;border-color:rgba(167,139,250,.5)}.quick-btns{display:flex;gap:.4rem;flex-wrap:wrap}.quick-btn{padding:.3rem .6rem;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:15px;color:#a5a5b8;font-size:.75rem;cursor:pointer}.quick-btn:hover{background:rgba(255,255,255,.1)}.quick-btn.btn-a{background:rgba(239,68,68,.2);border-color:rgba(239,68,68,.3);color:#ef4444}.quick-btn.btn-b{background:rgba(59,130,246,.2);border-color:rgba(59,130,246,.3);color:#3b82f6}.vote-prompt{padding:1rem;text-align:center;background:rgba(167,139,250,.1)}.vote-prompt p{color:#fbbf24;font-weight:600}.timer{font-size:2.5rem;font-weight:700;font-family:monospace}.timer.warning{color:#f87171;animation:pulse 1s infinite}.timer.normal{color:#a78bfa}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}.progress-dots{display:flex;align-items:center;gap:.5rem}.progress-dot{width:12px;height:12px;border-radius:50%;transition:all .3s}.progress-dot.done{background:#4ade80}.progress-dot.current{background:#a78bfa;box-shadow:0 0 10px rgba(167,139,250,.5)}.progress-dot.pending{background:rgba(255,255,255,.2)}.phase-badge{font-size:1.1rem;font-weight:600}.score-display{text-align:right}.score-label{font-size:.85rem;color:#8b8b9e}.score-value{font-size:1.5rem;font-weight:700;color:#fbbf24}.end-panel{background:linear-gradient(145deg,rgba(251,191,36,.1),rgba(167,139,250,.1));border-radius:12px;padding:2rem;text-align:center}.end-panel h2{font-size:1.8rem;margin-bottom:1.5rem;color:#fbbf24}.ranking-list{max-width:400px;margin:0 auto 1.5rem}.ranking-item{display:flex;align-items:center;gap:.8rem;padding:.8rem;margin-bottom:.4rem;background:rgba(255,255,255,.03);border-radius:8px}.ranking-item.first{background:rgba(251,191,36,.2);border:1px solid rgba(251,191,36,.3)}.ranking-item .rank{font-weight:700;width:1.5rem}.ranking-item .rank.top{color:#fbbf24}.ranking-item .avatar{font-size:1.3rem}.ranking-item .name{flex:1}.ranking-item .points{font-weight:600;color:#a78bfa}.chain-record{margin-top:1rem;padding:1rem;background:rgba(167,139,250,.1);border-radius:8px}.chain-record p{font-size:.9rem;color:#a78bfa}.chain-record a{color:#4ade80;text-decoration:none}
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>
  <div class="top-bar">
    <div class="logo">ğŸ“œ å…±è¯†ç¼–å¹´å²</div>
    <div class="status-group">
      <div class="status-badge firebase-status" id="firebaseStatus"><span class="dot"></span><span>Firebase</span></div>
      <div class="status-badge wallet-status" id="walletStatus"><span>GenLayer</span></div>
      <span class="wallet-address" id="walletAddress"></span>
      <button class="btn btn-small btn-secondary hidden" id="connectWalletBtn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
    </div>
  </div>
  <div class="container" id="homePage">
    <div class="hero">
      <div class="hero-icon">ğŸ“œ</div>
      <h1>å…±è¯†ç¼–å¹´å²</h1>
      <p class="subtitle">CONSENSUS CHRONICLE</p>
      <p class="desc">å…±è¯†å¦‚ä½•å¡‘é€ å†å²ï¼Ÿä½ çš„é€‰æ‹©å°†æ”¹å†™å‘½è¿ã€‚</p>
      <div class="tech-badges">
        <div class="tech-badge firebase">ğŸ”¥ Firebase å®æ—¶åŒæ­¥</div>
        <div class="tech-badge genlayer">â›“ï¸ GenLayer æ°¸ä¹…è®°å½•</div>
      </div>
    </div>
    <div class="setup-section" id="setupSection">
      <div class="setup-card">
        <h3>ğŸ­ åˆ›å»ºä½ çš„è§’è‰²</h3>
        <input type="text" id="playerNameInput" placeholder="è¾“å…¥ä½ çš„åå­—..." maxlength="20">
        <div class="avatar-grid" id="avatarGrid"></div>
        <button class="btn btn-primary" style="width:100%;" onclick="confirmPlayer()">ç¡®è®¤è§’è‰²</button>
      </div>
    </div>
    <div id="mainMenu" class="hidden">
      <div style="text-align:center;margin-bottom:2rem;">
        <div style="display:inline-flex;align-items:center;gap:1rem;padding:1rem 2rem;background:rgba(167,139,250,.1);border:1px solid rgba(167,139,250,.3);border-radius:50px;">
          <span style="font-size:2rem;" id="myAvatar">ğŸ®</span>
          <span style="font-size:1.3rem;font-weight:600;" id="myName"></span>
        </div>
      </div>
      <h2 style="text-align:center;margin-bottom:1.5rem;color:#c4b5fd;">é€‰æ‹©ä¸»é¢˜ï¼Œå¼€å¯å†’é™©</h2>
      <div class="theme-grid" id="themeGrid"></div>
      <div class="room-list">
        <h3>ğŸšª å¯åŠ å…¥çš„æˆ¿é—´<button class="btn btn-small btn-secondary" onclick="refreshRooms()">åˆ·æ–°</button></h3>
        <div id="roomList"><div class="no-rooms"><span class="loading"></span> è¿æ¥ä¸­...</div></div>
      </div>
    </div>
  </div>
  <div id="roomPage" class="container room-view hidden">
    <div class="room-header">
      <button class="btn btn-secondary" onclick="leaveRoom()">â† è¿”å›</button>
      <div style="display:flex;align-items:center;gap:.5rem;font-size:1.3rem;">
        <span id="roomThemeIcon">ğŸ°</span>
        <span id="roomThemeName" style="font-weight:600;"></span>
      </div>
      <span id="roomIdDisplay" style="font-size:.9rem;color:#6b6b7e;font-family:monospace;"></span>
    </div>
    <h3 style="margin-bottom:1rem;color:#8b8b9e;">ç©å®¶ (<span id="playerCount">0</span>/8)</h3>
    <div class="player-grid" id="playerGrid"></div>
    <button id="startGameBtn" class="btn btn-primary hidden" style="width:100%;padding:1rem;font-size:1.2rem;" onclick="startGame()">ğŸ® å¼€å§‹æ¸¸æˆ</button>
    <p id="waitingMsg" style="text-align:center;color:#6b6b7e;margin-top:1rem;"></p>
  </div>
  <div id="gameView" class="game-view hidden">
    <div class="game-header">
      <div>
        <div style="font-size:.9rem;color:#8b8b9e;">ç¬¬ <span id="roundNum">1</span> / 5 è½®</div>
        <div class="phase-badge" id="phaseBadge">ğŸ’¬ è¾©è®ºä¸­</div>
      </div>
      <div class="progress-dots" id="progressDots"></div>
      <div class="timer normal" id="timerDisplay">1:30</div>
      <div class="score-display">
        <div class="score-label">æˆ‘çš„ç§¯åˆ†</div>
        <div class="score-value" id="myScore">0</div>
      </div>
    </div>
    <div class="game-main">
      <div class="story-panel">
        <div class="story-scroll" id="storyScroll"></div>
        <div class="options-panel" id="optionsPanel"></div>
      </div>
      <div class="chat-panel">
        <div class="chat-players" id="chatPlayers"></div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input" id="chatInput"></div>
      </div>
    </div>
  </div>
<script>
// ============================================================
// CONFIG - Replace Firebase config with your own!
// ============================================================
// const CONFIG = {
//   FIREBASE: {
//     apiKey: "AIzaSyDemo-Replace-With-Your-Key",
//     authDomain: "consensus-chronicle.firebaseapp.com",
//     databaseURL: "https://consensus-chronicle-default-rtdb.firebaseio.com",
//     projectId: "consensus-chronicle"
//   },
  // Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBX4tOb30jWKK6aBUsqERQaOAF4CxCfMmQ",
  authDomain: "consensus-chronicle.firebaseapp.com",
  databaseURL: "https://consensus-chronicle-default-rtdb.firebaseio.com",
  projectId: "consensus-chronicle",
  storageBucket: "consensus-chronicle.firebasestorage.app",
  messagingSenderId: "175835565956",
  appId: "1:175835565956:web:80e59789fade3d439757d1",
  measurementId: "G-SDWW95SHCG"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
  GENLAYER: {
    chainId: '0xa2c4',
    rpcUrl: 'https://studio-rpc.genlayer.com',
    contract: '0x4F5F132ba540f1C685B0188D59990302903aE186'
  },
  GAME: { minPlayers: 2, maxPlayers: 8, debateDuration: 90, voteDuration: 30, totalRounds: 5 }
};

// ============================================================
// STORY DATA
// ============================================================
const STORY_ARCS = {
  fantasy: { name: 'å¥‡å¹»å†’é™©', icon: 'ğŸ°', opening: 'å¤è€çš„é¢„è¨€ç»ˆäºåº”éªŒâ€”â€”æ²‰ç¡åƒå¹´çš„é»‘é¾™è‹é†’äº†ã€‚ç‹å›½å±åœ¨æ—¦å¤•ï¼Œå›½ç‹ç´§æ€¥å¬é›†äº†å„åœ°è‹±é›„å•†è®®å¯¹ç­–...', rounds: [
    { context: 'é»‘é¾™çš„å¨èƒè¿«åœ¨çœ‰ç«ï¼Œç‹å›½å¿…é¡»åšå‡ºç¬¬ä¸€ä¸ªå…³é”®å†³å®šã€‚', a: { text: 'ç«‹å³é›†ç»“å†›é˜Ÿï¼Œä¸»åŠ¨å‡ºå‡»é¾™å·¢ã€‚', tag: 'å…ˆå‘åˆ¶äºº', consequence: 'å†›é˜Ÿå‘é¾™å·¢è¿›å‘ï¼ŒæŸå¤±æƒ¨é‡...' }, b: { text: 'æ´¾é£ä½¿è€…å¯»æ±‚ç²¾çµæ—çš„å¸®åŠ©ã€‚', tag: 'å¯»æ±‚è”ç›Ÿ', consequence: 'ä½¿è€…è”ç³»åˆ°ç²¾çµæ—ï¼Œä½†æ¡ä»¶è‹›åˆ»...' }},
    { context: 'å±€åŠ¿ç´§å¼ ï¼Œéœ€è¦åšå‡ºè‰°éš¾æŠ‰æ‹©ã€‚', a: { text: 'é‡‡å–æ¿€è¿›ç­–ç•¥ï¼Œä¸æƒœä»£ä»·ã€‚', tag: 'æ¿€è¿›', consequence: 'ä»£ä»·æƒ¨é‡ï¼Œä½†æœ‰è¿›å±•...' }, b: { text: 'é‡‡å–ç¨³å¦¥ç­–ç•¥ï¼Œä¿å­˜å®åŠ›ã€‚', tag: 'ç¨³å¥', consequence: 'å®åŠ›ä¿å­˜ï¼Œä½†æ—¶æœºæµé€...' }},
    { context: 'å…³é”®æ—¶åˆ»åˆ°æ¥ã€‚', a: { text: 'å­¤æ³¨ä¸€æ·ï¼Œæ”¾æ‰‹ä¸€æã€‚', tag: 'å†’é™©', consequence: 'å‘½è¿çš„å¤©å¹³å¼€å§‹å€¾æ–œ...' }, b: { text: 'è°¨æ…è¡Œäº‹ï¼Œç­‰å¾…æ—¶æœºã€‚', tag: 'è°¨æ…', consequence: 'æ—¶æœºç»ˆäºå‡ºç°...' }},
    { context: 'æœ€ç»ˆå¯¹å†³å‰çš„æŠ‰æ‹©ã€‚', a: { text: 'å‘èµ·æ€»æ”»ï¼Œå†³ä¸€æ­»æˆ˜ã€‚', tag: 'å†³æˆ˜', consequence: 'æœ€ç»ˆä¹‹æˆ˜å¼€å§‹...' }, b: { text: 'å°è¯•è°ˆåˆ¤ï¼Œå¯»æ±‚å’Œå¹³ã€‚', tag: 'å’Œå¹³', consequence: 'æ„å¤–çš„è½¬æœºå‡ºç°...' }},
    { context: 'å‘½è¿çš„æœ€ç»ˆå®¡åˆ¤ã€‚', a: { text: 'ä¸æƒœä¸€åˆ‡ä»£ä»·å–èƒœã€‚', tag: 'æç«¯', ending: 'æƒ¨èƒœï¼ç‹å›½åŒ–ä¸ºåºŸå¢Ÿï¼Œä½†é»‘é¾™è¢«æ¶ˆç­äº†ã€‚' }, b: { text: 'æ¥å—å‘½è¿ï¼Œå¯»æ±‚å…±å­˜ã€‚', tag: 'æ™ºæ…§', ending: 'äººç±»ä¸é»‘é¾™è¾¾æˆç›Ÿçº¦ï¼Œæ–°æ—¶ä»£å¼€å¯ï¼' }}
  ]},
  scifi: { name: 'ç§‘å¹»æœªæ¥', icon: 'ğŸš€', opening: '2157å¹´ï¼Œç«æ˜Ÿæ®–æ°‘åœ°æ”¶åˆ°ç¥ç§˜ä¿¡å·ï¼šåœ°çƒå°†åœ¨100å¤©åè¢«å°è¡Œæ˜Ÿæ’å‡»ã€‚èµ„æºåªå¤Ÿæ•‘ä¸€åŠäºº...', rounds: [
    { context: 'æ¶ˆæ¯å…¬å¸ƒåï¼Œæ®–æ°‘åœ°é™·å…¥ææ…Œã€‚', a: { text: 'å¯åŠ¨æ–¹èˆŸè®¡åˆ’ï¼ŒæŠ½ç­¾å†³å®šã€‚', tag: 'å…¬å¹³', consequence: 'æŠ½ç­¾ç»“æœå¼•å‘æŠ—è®®...' }, b: { text: 'é›†ä¸­èµ„æºç ”ç©¶ä¿¡å·æ¥æºã€‚', tag: 'æ¢ç´¢', consequence: 'å‘ç°ä¿¡å·æ¥è‡ªæœªçŸ¥æ–‡æ˜...' }},
    { context: 'å±€åŠ¿æ¶åŒ–ã€‚', a: { text: 'ä½¿ç”¨æ­¦åŠ›ç»´æŒç§©åºã€‚', tag: 'å¼ºç¡¬', consequence: 'ç§©åºæš‚æ—¶ç¨³å®š...' }, b: { text: 'ä¸å„æ–¹è°ˆåˆ¤ã€‚', tag: 'åå•†', consequence: 'è¾¾æˆåˆæ­¥å…±è¯†...' }},
    { context: 'å…³é”®æŠ€æœ¯çªç ´ã€‚', a: { text: 'å†’é™©é‡‡ç”¨æ–°æ–¹æ¡ˆã€‚', tag: 'å†’é™©', consequence: 'æˆåŠŸç‡ä¸‹é™ï¼Œä½†å¸Œæœ›å¢åŠ ...' }, b: { text: 'åšæŒåŸè®¡åˆ’ã€‚', tag: 'ç¨³å¦¥', consequence: 'è®¡åˆ’æ¨è¿›...' }},
    { context: 'å‘å°„å‰çš„æœ€åå†³å®šã€‚', a: { text: 'å°è¯•æ”¹å˜å°è¡Œæ˜Ÿè½¨é“ã€‚', tag: 'é€†å¤©', consequence: 'èµ„æºæŠ•å…¥æœ€åä¸€æ...' }, b: { text: 'æŒ‰è®¡åˆ’æ’¤ç¦»ã€‚', tag: 'åˆ†æ•£', consequence: 'æ’¤ç¦»å¼€å§‹...' }},
    { context: 'æœ€ç»ˆæ—¶åˆ»ã€‚', a: { text: 'æ”¾æ‰‹ä¸€æã€‚', tag: 'æé™', ending: 'å¥‡è¿¹å‘ç”Ÿï¼å°è¡Œæ˜Ÿåç¦»è½¨é“ï¼Œäººç±»è·æ•‘ï¼' }, b: { text: 'æ¥å—ç°å®ã€‚', tag: 'é‡ç”Ÿ', ending: 'è™½æœ‰æŸå¤±ï¼Œä½†äººç±»æ–‡æ˜å»¶ç»­ã€‚' }}
  ]},
  mystery: { name: 'æ‚¬ç–‘æ¨ç†', icon: 'ğŸ”', opening: 'æš´é£é›¨ä¹‹å¤œï¼Œå¯Œè±ªé™ˆè€çˆ·åœ¨ä¹¦æˆ¿è¢«æ¯’æ€ã€‚å¤§é—¨åé”ï¼Œçª—æˆ·å®Œå¥½ã€‚åœ¨åœºäº”äººï¼Œè°æ˜¯å‡¶æ‰‹ï¼Ÿ', rounds: [
    { context: 'ä½œä¸ºä¾¦æ¢ï¼Œä½ å¿…é¡»å¼€å§‹è°ƒæŸ¥ã€‚', a: { text: 'æœæŸ¥ä¹¦æˆ¿ï¼Œå¯»æ‰¾ç‰©è¯ã€‚', tag: 'ç‰©è¯', consequence: 'å‘ç°åŠå°è¢«çƒ§çš„ä¿¡ä»¶...' }, b: { text: 'è¯¢é—®åœ¨åœºæ¯ä¸ªäººã€‚', tag: 'é—®è¯¢', consequence: 'å‘ç°ç®¡å®¶ç¥è‰²æ…Œå¼ ...' }},
    { context: 'çº¿ç´¢æŒ‡å‘å¤šä¸ªæ–¹å‘ã€‚', a: { text: 'æ·±å…¥è°ƒæŸ¥é—äº§é—®é¢˜ã€‚', tag: 'é‡‘é’±', consequence: 'å‘ç°å¤§å„¿å­æ¬ ä¸‹å·¨å€º...' }, b: { text: 'è°ƒæŸ¥ç¥ç§˜å•†äººã€‚', tag: 'èº«ä»½', consequence: 'å•†äººç«Ÿæ˜¯å¤±æ•£çš„ç§ç”Ÿå­...' }},
    { context: 'å«Œç–‘äººèŒƒå›´ç¼©å°ã€‚', a: { text: 'éªŒè¯ç®¡å®¶çš„è¯è¯ã€‚', tag: 'è´¨ç–‘', consequence: 'è¯è¯å‡ºç°æ¼æ´...' }, b: { text: 'è°ƒæŸ¥é™ˆå¹´æ—§æ¡ˆã€‚', tag: 'è¿‡å»', consequence: '20å¹´å‰çš„ç«ç¾å¦æœ‰éšæƒ…...' }},
    { context: 'çœŸç›¸å³å°†æµ®å‡ºæ°´é¢ã€‚', a: { text: 'å¯¹å«Œç–‘äººäº¤å‰å®¡é—®ã€‚', tag: 'å¯¹è´¨', consequence: 'æƒŠäººç§˜å¯†è¢«æ­å¼€...' }, b: { text: 'é‡æ–°æ£€éªŒæ¯’è¯æ¥æºã€‚', tag: 'ç§‘å­¦', consequence: 'æ¯’è¯æŒ‡å‘ç‰¹å®šäººç‰©...' }},
    { context: 'æœ€ç»ˆå®¡åˆ¤ã€‚', a: { text: 'å…¬å¼€æ‰€æœ‰çœŸç›¸ã€‚', tag: 'æ³•æ²»', ending: 'çœŸç›¸å¤§ç™½ï¼Œæ­£ä¹‰å¾—åˆ°ä¼¸å¼ ã€‚' }, b: { text: 'ç»™äºˆé€‰æ‹©æœºä¼šã€‚', tag: 'ç°è‰²', ending: 'éƒ¨åˆ†çœŸç›¸è¢«åŸ‹è‘¬ï¼Œä½†æ´»ç€çš„äººéƒ½æœ‰äº†æ–°å¼€å§‹ã€‚' }}
  ]},
  political: { name: 'å®«å»·æƒè°‹', icon: 'ğŸ‘‘', opening: 'å¤§é½ç‹æœï¼Œè€çš‡å¸é©¾å´©ã€‚é—è¯ä»¤äººè´¹è§£ï¼šçš‡ä½ä¼ ç»™"æœ€èƒ½ä»£è¡¨æ°‘å¿ƒè€…"ã€‚ä¸‰ä½çš‡å­å„æœ‰æ”¯æŒè€…...', rounds: [
    { context: 'ä½œä¸ºå†…é˜é¦–è¾…ï¼Œä½ å¿…é¡»ç»´æŒå±€é¢ã€‚', a: { text: 'æ”¯æŒå¤ªå­æŒ‰ä¼ ç»Ÿç»§ä½ã€‚', tag: 'æ­£ç»Ÿ', consequence: 'å¤ªå­è·å¾—æ”¯æŒï¼Œä½†äºŒçš‡å­ä¸æ»¡...' }, b: { text: 'æè®®ä¸‰ä½çš‡å­å…¬è®®å†³é€‰ã€‚', tag: 'é©æ–°', consequence: 'æ”¹é©æ´¾æ¬¢å‘¼ï¼Œä¿å®ˆæ´¾åå¯¹...' }},
    { context: 'å®«å»·æš—æµæ¶ŒåŠ¨ã€‚', a: { text: 'è°ƒåŠ¨å¾¡æ—å†›å¸ƒé˜²ã€‚', tag: 'æƒè°‹', consequence: 'è®¡ç­–æš‚æ—¶å¥æ•ˆ...' }, b: { text: 'ä¸»åŠ¨ä¸å¯¹æ‰‹è°ˆåˆ¤ã€‚', tag: 'å’Œè°ˆ', consequence: 'å¯¹æ–¹æå‡ºè‹›åˆ»æ¡ä»¶...' }},
    { context: 'å±æœºå››ä¼ã€‚', a: { text: 'æš‚æ—¶å¦¥åã€‚', tag: 'å¦¥å', consequence: 'å±€åŠ¿æš‚ç¨³...' }, b: { text: 'æ­éœ²é˜´è°‹ã€‚', tag: 'æ­£ä¹‰', consequence: 'ä¸‰ä½çš‡å­ç«™åœ¨ä¸€èµ·...' }},
    { context: 'è¾¹ç–†å‘Šæ€¥ã€‚', a: { text: 'ä¸‰ä½çš‡å­äº²å¾ã€‚', tag: 'æˆ˜åŠŸ', consequence: 'åŒ—ç–†æˆ˜äº‹èƒ¶ç€...' }, b: { text: 'å…ˆé€‰æ–°å¸å†åº”å¯¹å¤–æ•Œã€‚', tag: 'ç¨³é‡', consequence: 'æœè®®å³å°†å¼€å§‹...' }},
    { context: 'æœ€ç»ˆå†³æ–­ã€‚', a: { text: 'å»ºç«‹ä¸‰ç‹è®®æ”¿æ–°åˆ¶åº¦ã€‚', tag: 'å…±äº«', ending: 'å¤§é½è¿›å…¥"ä¸‰ç‹æ—¶ä»£"ï¼Œè¿è½¬è‰¯å¥½ã€‚' }, b: { text: 'æŒ‰å†›åŠŸæ’åºç»§ä½ã€‚', tag: 'å…¬å¹³', ending: 'äºŒçš‡å­å‡­æˆ˜åŠŸç™»åŸºï¼Œå¤§é½ä¸­å…´ã€‚' }}
  ]}
};

const AVATARS = ['ğŸ®', 'âš”ï¸', 'ğŸ›¡ï¸', 'ğŸ”®', 'ğŸ“š', 'ğŸ­', 'ğŸª', 'ğŸ¯', 'ğŸ¹', 'âš¡', 'ğŸŒŸ', 'ğŸ”¥'];

// ============================================================
// STATE
// ============================================================
const state = { firebaseReady: false, db: null, playerId: null, playerName: '', playerAvatar: 'ğŸ®', walletAddress: null, walletConnected: false, currentRoomId: null, isHost: false, gameActive: false };
let roomListListener = null, currentRoomListener = null, gameListener = null;

// ============================================================
// UTILS
// ============================================================
const $ = id => document.getElementById(id);
const show = id => $(id)?.classList.remove('hidden');
const hide = id => $(id)?.classList.add('hidden');
function toast(msg, type = 'info') { const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = msg; $('toastContainer').appendChild(t); setTimeout(() => t.remove(), 4000); }
function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 9); }
function formatTime(s) { return `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`; }

// ============================================================
// FIREBASE
// ============================================================
function initFirebase() {
  try {
    if (firebase.apps.length === 0) firebase.initializeApp(CONFIG.FIREBASE);
    state.db = firebase.database();
    state.firebaseReady = true;
    $('firebaseStatus').classList.add('connected');
    toast('Firebase è¿æ¥æˆåŠŸï¼', 'success');
    listenToRooms();
  } catch (e) { console.error('Firebase init error:', e); toast('Firebase è¿æ¥å¤±è´¥', 'error'); }
}

// ============================================================
// PLAYER
// ============================================================
function initAvatarGrid() {
  $('avatarGrid').innerHTML = AVATARS.map((a, i) => `<div class="avatar-option ${i === 0 ? 'selected' : ''}" onclick="selectAvatar(this,'${a}')">${a}</div>`).join('');
  state.playerAvatar = AVATARS[0];
}
function selectAvatar(el, avatar) { document.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected')); el.classList.add('selected'); state.playerAvatar = avatar; }
function confirmPlayer() {
  const name = $('playerNameInput').value.trim();
  if (!name) { toast('è¯·è¾“å…¥ä½ çš„åå­—ï¼', 'error'); return; }
  state.playerName = name; state.playerId = generateId();
  localStorage.setItem('consensusPlayer', JSON.stringify({ id: state.playerId, name: state.playerName, avatar: state.playerAvatar }));
  $('myAvatar').textContent = state.playerAvatar; $('myName').textContent = state.playerName;
  hide('setupSection'); show('mainMenu'); show('connectWalletBtn'); initThemeGrid(); toast(`æ¬¢è¿ï¼Œ${name}ï¼`, 'success');
}
function loadSavedPlayer() {
  const saved = localStorage.getItem('consensusPlayer');
  if (saved) { const p = JSON.parse(saved); state.playerId = p.id; state.playerName = p.name; state.playerAvatar = p.avatar; $('myAvatar').textContent = state.playerAvatar; $('myName').textContent = state.playerName; hide('setupSection'); show('mainMenu'); show('connectWalletBtn'); initThemeGrid(); return true; }
  return false;
}

// ============================================================
// ROOMS
// ============================================================
function initThemeGrid() { $('themeGrid').innerHTML = Object.entries(STORY_ARCS).map(([k, a]) => `<div class="theme-card" onclick="createRoom('${k}')"><span class="icon">${a.icon}</span><span class="name">${a.name}</span><span class="desc">5è½®å²è¯—æ•…äº‹</span></div>`).join(''); }
function listenToRooms() { if (!state.firebaseReady) return; if (roomListListener) state.db.ref('rooms').off('value', roomListListener); roomListListener = state.db.ref('rooms').on('value', snap => renderRoomList(snap.val() || {})); }
function refreshRooms() { if (!state.firebaseReady) { toast('Firebase æœªè¿æ¥', 'error'); return; } toast('åˆ·æ–°ä¸­...', 'info'); }
function renderRoomList(rooms) {
  const list = $('roomList');
  const available = Object.entries(rooms).filter(([id, r]) => r.status === 'waiting' && Object.keys(r.players || {}).length < CONFIG.GAME.maxPlayers);
  if (!available.length) { list.innerHTML = '<div class="no-rooms">æš‚æ— æˆ¿é—´ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div>'; return; }
  list.innerHTML = available.map(([id, r]) => { const arc = STORY_ARCS[r.theme]; const cnt = Object.keys(r.players || {}).length; return `<div class="room-item" onclick="joinRoom('${id}')"><span class="theme-icon">${arc?.icon || 'ğŸ®'}</span><div class="info"><div class="theme-name">${arc?.name || r.theme}</div><div class="host">æˆ¿ä¸»: ${r.hostName || 'æœªçŸ¥'}</div></div><span class="players">${cnt}/${CONFIG.GAME.maxPlayers}</span><button class="btn btn-primary btn-small">åŠ å…¥</button></div>`; }).join('');
}
async function createRoom(theme) {
  if (!state.firebaseReady) { toast('Firebase æœªè¿æ¥', 'error'); return; }
  const roomId = generateId();
  const roomData = { id: roomId, theme, hostId: state.playerId, hostName: state.playerName, status: 'waiting', createdAt: firebase.database.ServerValue.TIMESTAMP, players: { [state.playerId]: { id: state.playerId, name: state.playerName, avatar: state.playerAvatar, isHost: true, joinedAt: firebase.database.ServerValue.TIMESTAMP } } };
  try { await state.db.ref(`rooms/${roomId}`).set(roomData); state.currentRoomId = roomId; state.isHost = true; toast('æˆ¿é—´åˆ›å»ºæˆåŠŸï¼', 'success'); showRoomPage(); listenToCurrentRoom(); } catch (e) { console.error('Create room error:', e); toast('åˆ›å»ºæˆ¿é—´å¤±è´¥', 'error'); }
}
async function joinRoom(roomId) {
  if (!state.firebaseReady) { toast('Firebase æœªè¿æ¥', 'error'); return; }
  try { await state.db.ref(`rooms/${roomId}/players/${state.playerId}`).set({ id: state.playerId, name: state.playerName, avatar: state.playerAvatar, isHost: false, joinedAt: firebase.database.ServerValue.TIMESTAMP }); state.currentRoomId = roomId; state.isHost = false; toast('åŠ å…¥æˆåŠŸï¼', 'success'); showRoomPage(); listenToCurrentRoom(); } catch (e) { console.error('Join room error:', e); toast('åŠ å…¥æˆ¿é—´å¤±è´¥', 'error'); }
}
function listenToCurrentRoom() {
  if (!state.currentRoomId || !state.firebaseReady) return;
  if (currentRoomListener) state.db.ref(`rooms/${state.currentRoomId}`).off('value', currentRoomListener);
  currentRoomListener = state.db.ref(`rooms/${state.currentRoomId}`).on('value', snap => { const room = snap.val(); if (!room) { toast('æˆ¿é—´å·²å…³é—­', 'info'); goToHome(); return; } if (room.status === 'playing' && !state.gameActive) { startGameView(room); return; } updateRoomUI(room); });
}
function showRoomPage() { hide('homePage'); show('roomPage'); }
function updateRoomUI(room) {
  const arc = STORY_ARCS[room.theme]; $('roomThemeIcon').textContent = arc?.icon || 'ğŸ®'; $('roomThemeName').textContent = arc?.name || room.theme; $('roomIdDisplay').textContent = '#' + room.id.slice(-6);
  const players = Object.values(room.players || {}); $('playerCount').textContent = players.length;
  const grid = $('playerGrid'); const slots = players.map(p => { const isMe = p.id === state.playerId; const isHost = p.id === room.hostId; return `<div class="player-slot ${isHost ? 'host' : ''} ${isMe ? 'me' : ''}"><span class="avatar">${p.avatar}</span><span class="name">${p.name}</span>${isHost ? '<span class="badge badge-host">æˆ¿ä¸»</span>' : ''}${isMe && !isHost ? '<span class="badge badge-me">æˆ‘</span>' : ''}</div>`; });
  for (let i = players.length; i < CONFIG.GAME.maxPlayers; i++) slots.push(`<div class="player-slot empty-slot"><span class="avatar">?</span><span class="name">ç­‰å¾…ä¸­...</span></div>`);
  grid.innerHTML = slots.join('');
  const canStart = players.length >= CONFIG.GAME.minPlayers;
  if (room.hostId === state.playerId) { show('startGameBtn'); $('startGameBtn').disabled = !canStart; $('startGameBtn').textContent = canStart ? 'ğŸ® å¼€å§‹æ¸¸æˆ' : `ç­‰å¾…ç©å®¶ (${players.length}/${CONFIG.GAME.minPlayers})`; $('waitingMsg').textContent = ''; } else { hide('startGameBtn'); $('waitingMsg').textContent = 'ç­‰å¾…æˆ¿ä¸»å¼€å§‹æ¸¸æˆ...'; }
}
async function leaveRoom() {
  if (!state.currentRoomId || !state.firebaseReady) { goToHome(); return; }
  try { await state.db.ref(`rooms/${state.currentRoomId}/players/${state.playerId}`).remove(); if (state.isHost) { const snap = await state.db.ref(`rooms/${state.currentRoomId}/players`).once('value'); const remaining = snap.val(); if (!remaining || !Object.keys(remaining).length) { await state.db.ref(`rooms/${state.currentRoomId}`).remove(); } else { const newHostId = Object.keys(remaining)[0]; await state.db.ref(`rooms/${state.currentRoomId}/hostId`).set(newHostId); await state.db.ref(`rooms/${state.currentRoomId}/players/${newHostId}/isHost`).set(true); } } } catch (e) { console.error('Leave room error:', e); }
  if (currentRoomListener) { state.db.ref(`rooms/${state.currentRoomId}`).off('value', currentRoomListener); currentRoomListener = null; }
  state.currentRoomId = null; state.isHost = false; goToHome();
}
function goToHome() { hide('roomPage'); hide('gameView'); show('homePage'); state.gameActive = false; }

// ============================================================
// GAME
// ============================================================
async function startGame() {
  if (!state.isHost || !state.currentRoomId) return;
  const snap = await state.db.ref(`rooms/${state.currentRoomId}/players`).once('value'); const players = snap.val() || {};
  if (Object.keys(players).length < CONFIG.GAME.minPlayers) { toast('ç©å®¶ä¸è¶³', 'error'); return; }
  const roomSnap = await state.db.ref(`rooms/${state.currentRoomId}`).once('value'); const room = roomSnap.val(); const arc = STORY_ARCS[room.theme];
  const gameData = { round: 1, phase: 'debate', story: [{ text: arc.opening, type: 'opening', round: 0 }], path: [], votes: {}, messages: [], scores: {}, timerEnd: Date.now() + CONFIG.GAME.debateDuration * 1000, options: arc.rounds[0] };
  Object.keys(players).forEach(pid => { gameData.scores[pid] = { influence: 0, debates: 0, wins: 0 }; });
  try { await state.db.ref(`rooms/${state.currentRoomId}/game`).set(gameData); await state.db.ref(`rooms/${state.currentRoomId}/status`).set('playing'); } catch (e) { console.error('Start game error:', e); toast('å¯åŠ¨æ¸¸æˆå¤±è´¥', 'error'); }
}
function startGameView(room) { state.gameActive = true; hide('homePage'); hide('roomPage'); show('gameView'); listenToGame(); }
function listenToGame() { if (!state.currentRoomId || !state.firebaseReady) return; if (gameListener) state.db.ref(`rooms/${state.currentRoomId}`).off('value', gameListener); gameListener = state.db.ref(`rooms/${state.currentRoomId}`).on('value', snap => { const room = snap.val(); if (!room || !room.game) return; updateGameUI(room); if (room.game.timerEnd) updateTimer(room); }); }
function updateGameUI(room) {
  const game = room.game; const arc = STORY_ARCS[room.theme]; const players = room.players || {};
  $('roundNum').textContent = game.round;
  $('phaseBadge').textContent = game.phase === 'debate' ? 'ğŸ’¬ è¾©è®ºä¸­' : game.phase === 'vote' ? 'ğŸ—³ï¸ æŠ•ç¥¨ä¸­' : game.phase === 'result' ? 'ğŸ“Š ç»“ç®—ä¸­' : 'ğŸ† å·²ç»“æŸ';
  $('progressDots').innerHTML = [1,2,3,4,5].map(n => `<div class="progress-dot ${n < game.round ? 'done' : n === game.round ? 'current' : 'pending'}"></div>`).join('');
  const myScore = game.scores?.[state.playerId] || { influence: 0, debates: 0 }; $('myScore').textContent = myScore.influence + myScore.debates;
  const storyScroll = $('storyScroll'); storyScroll.innerHTML = `<h3>ğŸ“œ ${arc.name} - æ•…äº‹è¿›ç¨‹</h3>` + (game.story || []).map(s => `<div class="story-item ${s.type}">${s.type === 'context' ? `<span class="round-badge">ç¬¬${s.round}è½®</span>` : ''}${s.type === 'choice' ? `${s.winner === 'A' ? 'ğŸ…°ï¸' : 'ğŸ…±ï¸'} ` : ''}${s.text}</div>`).join(''); storyScroll.scrollTop = storyScroll.scrollHeight;
  renderOptionsPanel(game, players); renderChatPanel(game, players);
}
function renderOptionsPanel(game, players) {
  const panel = $('optionsPanel');
  if (game.phase === 'ended') { const rankings = Object.entries(game.scores || {}).map(([id, s]) => ({ player: players[id], total: (s.influence || 0) + (s.debates || 0) })).sort((a, b) => b.total - a.total); panel.innerHTML = `<div class="end-panel"><h2>ğŸ† ç¼–å¹´å²å®Œæˆï¼</h2><div class="ranking-list">${rankings.map((r, i) => `<div class="ranking-item ${i === 0 ? 'first' : ''}"><span class="rank ${i < 3 ? 'top' : ''}">#${i + 1}</span><span class="avatar">${r.player?.avatar || 'ğŸ®'}</span><span class="name">${r.player?.name || 'æœªçŸ¥'}</span><span class="points">${r.total} pts</span></div>`).join('')}</div><div class="chain-record" id="chainRecord"><p>â³ æ­£åœ¨è®°å½•åˆ°åŒºå—é“¾...</p></div><button class="btn btn-primary" style="margin-top:1rem;" onclick="returnToLobby()">è¿”å›å¤§å…</button></div>`; return; }
  if (!game.options) { panel.innerHTML = ''; return; }
  const votes = game.votes || {}; const myVote = votes[state.playerId]; const votesA = Object.entries(votes).filter(([id, v]) => v === 'A'); const votesB = Object.entries(votes).filter(([id, v]) => v === 'B');
  panel.innerHTML = `<h4>âš”ï¸ æœ¬è½®æŠ‰æ‹©</h4><div class="options-grid"><div class="option-card option-a ${myVote === 'A' ? 'selected' : ''}" onclick="submitVote('A')"><div class="option-header"><span class="option-label label-a">é€‰é¡¹ A</span><span class="option-tag">${game.options.a?.tag || ''}</span></div><p class="option-text">${game.options.a?.text || ''}</p>${game.phase === 'vote' ? `<div class="vote-count">${votesA.length} ç¥¨</div><div class="voter-avatars">${votesA.map(([id]) => `<span class="voter-avatar">${players[id]?.avatar || 'ğŸ®'}</span>`).join('')}</div>` : ''}</div><div class="option-card option-b ${myVote === 'B' ? 'selected' : ''}" onclick="submitVote('B')"><div class="option-header"><span class="option-label label-b">é€‰é¡¹ B</span><span class="option-tag">${game.options.b?.tag || ''}</span></div><p class="option-text">${game.options.b?.text || ''}</p>${game.phase === 'vote' ? `<div class="vote-count">${votesB.length} ç¥¨</div><div class="voter-avatars">${votesB.map(([id]) => `<span class="voter-avatar">${players[id]?.avatar || 'ğŸ®'}</span>`).join('')}</div>` : ''}</div></div>`;
}
function renderChatPanel(game, players) {
  const votes = game.votes || {}; $('chatPlayers').innerHTML = Object.values(players).map(p => `<div class="chat-player ${votes[p.id] ? 'voted' : ''}"><span>${p.avatar}</span><span style="max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${p.name}</span>${votes[p.id] ? `<span class="vote-badge">${votes[p.id]}</span>` : ''}</div>`).join('');
  const messagesEl = $('chatMessages'); messagesEl.innerHTML = (game.messages || []).map(msg => msg.type === 'system' ? `<div class="chat-msg system">${msg.text}</div>` : `<div class="chat-msg player"><div class="sender">${msg.avatar || 'ğŸ®'} ${msg.name || 'åŒ¿å'}${msg.choice ? `<span class="stance stance-${msg.choice.toLowerCase()}">æ”¯æŒ${msg.choice}</span>` : ''}</div><div>${msg.text}</div></div>`).join(''); messagesEl.scrollTop = messagesEl.scrollHeight;
  const chatInput = $('chatInput'); if (game.phase === 'debate') { chatInput.innerHTML = `<div class="chat-input-row"><input type="text" id="chatInputField" placeholder="è¾“å…¥ä½ çš„è§‚ç‚¹..." onkeydown="if(event.key==='Enter')sendMessage()"><button class="btn btn-primary btn-small" onclick="sendMessage()">å‘é€</button></div><div class="quick-btns"><button class="quick-btn btn-a" onclick="setQuickMsg('æˆ‘æ”¯æŒé€‰é¡¹Aï¼Œå› ä¸º')">ğŸ…°ï¸ æ”¯æŒA</button><button class="quick-btn btn-b" onclick="setQuickMsg('æˆ‘æ”¯æŒé€‰é¡¹Bï¼Œå› ä¸º')">ğŸ…±ï¸ æ”¯æŒB</button></div>`; } else if (game.phase === 'vote' && !votes[state.playerId]) { chatInput.innerHTML = `<div class="vote-prompt"><p>â° è¯·ç‚¹å‡»å·¦ä¾§é€‰é¡¹è¿›è¡ŒæŠ•ç¥¨ï¼</p></div>`; } else { chatInput.innerHTML = ''; }
}
function updateTimer(room) { const game = room.game; const now = Date.now(); const remaining = Math.max(0, Math.floor((game.timerEnd - now) / 1000)); const timerEl = $('timerDisplay'); timerEl.textContent = formatTime(remaining); timerEl.className = `timer ${remaining <= 10 ? 'warning' : 'normal'}`; if (remaining === 0 && state.isHost) handlePhaseEnd(room); }
async function handlePhaseEnd(room) {
  const game = room.game; const arc = STORY_ARCS[room.theme];
  if (game.phase === 'debate') { await state.db.ref(`rooms/${state.currentRoomId}/game`).update({ phase: 'vote', timerEnd: Date.now() + CONFIG.GAME.voteDuration * 1000 }); await addSystemMessage('ğŸ—³ï¸ æŠ•ç¥¨é˜¶æ®µå¼€å§‹ï¼è¯·é€‰æ‹©ä½ æ”¯æŒçš„é€‰é¡¹'); }
  else if (game.phase === 'vote') {
    const votes = game.votes || {}; const voteCount = { A: 0, B: 0 }; Object.values(votes).forEach(v => { if (v) voteCount[v]++; }); const winner = voteCount.A >= voteCount.B ? 'A' : 'B'; const opt = winner === 'A' ? game.options.a : game.options.b; const consequence = opt.consequence || opt.ending || '';
    const newScores = { ...game.scores }; Object.entries(votes).forEach(([id, v]) => { if (v === winner && newScores[id]) { newScores[id].influence = (newScores[id].influence || 0) + 30; newScores[id].wins = (newScores[id].wins || 0) + 1; } });
    const newStory = [...(game.story || [])]; newStory.push({ text: `ã€ä¼—äººé€‰æ‹©ã€‘${opt.text}`, type: 'choice', round: game.round, winner }); newStory.push({ text: consequence, type: 'consequence', round: game.round }); const newPath = [...(game.path || []), winner];
    if (game.round >= CONFIG.GAME.totalRounds) { await state.db.ref(`rooms/${state.currentRoomId}/game`).update({ phase: 'ended', story: newStory, path: newPath, scores: newScores, timerEnd: null }); await addSystemMessage('ğŸ† ç¼–å¹´å²å®Œæˆï¼'); recordToGenLayer(room, newScores); }
    else { const nextRound = game.round + 1; const nextOptions = arc.rounds[nextRound - 1]; newStory.push({ text: nextOptions.context, type: 'context', round: nextRound }); await state.db.ref(`rooms/${state.currentRoomId}/game`).update({ round: nextRound, phase: 'debate', story: newStory, path: newPath, scores: newScores, votes: {}, options: nextOptions, timerEnd: Date.now() + CONFIG.GAME.debateDuration * 1000 }); await addSystemMessage(`ğŸ“– ç¬¬ ${nextRound}/${CONFIG.GAME.totalRounds} è½® - è¾©è®ºé˜¶æ®µå¼€å§‹`); }
  }
}
async function submitVote(choice) { if (!state.currentRoomId || !state.firebaseReady) return; const snap = await state.db.ref(`rooms/${state.currentRoomId}/game`).once('value'); const game = snap.val(); if (game.phase !== 'vote' || game.votes?.[state.playerId]) return; await state.db.ref(`rooms/${state.currentRoomId}/game/votes/${state.playerId}`).set(choice); await addSystemMessage(`${state.playerName} å·²æŠ•ç¥¨`); }
async function sendMessage() { const input = $('chatInputField'); if (!input || !input.value.trim()) return; const text = input.value.trim(); const choice = text.includes('A') || text.includes('é€‰é¡¹A') ? 'A' : text.includes('B') || text.includes('é€‰é¡¹B') ? 'B' : null; await state.db.ref(`rooms/${state.currentRoomId}/game/messages`).push({ type: 'chat', playerId: state.playerId, name: state.playerName, avatar: state.playerAvatar, text, choice, time: Date.now() }); const currentScore = await state.db.ref(`rooms/${state.currentRoomId}/game/scores/${state.playerId}/debates`).once('value'); await state.db.ref(`rooms/${state.currentRoomId}/game/scores/${state.playerId}/debates`).set((currentScore.val() || 0) + 5); input.value = ''; }
async function addSystemMessage(text) { await state.db.ref(`rooms/${state.currentRoomId}/game/messages`).push({ type: 'system', text, time: Date.now() }); }
function setQuickMsg(text) { const input = $('chatInputField'); if (input) input.value = text; }
async function returnToLobby() { if (state.isHost && state.currentRoomId) await state.db.ref(`rooms/${state.currentRoomId}`).remove(); if (gameListener) { state.db.ref(`rooms/${state.currentRoomId}`).off('value', gameListener); gameListener = null; } state.currentRoomId = null; state.isHost = false; state.gameActive = false; goToHome(); }

// ============================================================
// GENLAYER (End of game recording)
// ============================================================
async function connectWallet() {
  if (!window.ethereum) { toast('è¯·å®‰è£… MetaMask é’±åŒ…', 'error'); return; }
  try { const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' }); if (!accounts.length) throw new Error('No accounts'); state.walletAddress = accounts[0]; try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CONFIG.GENLAYER.chainId }] }); } catch (e) { if (e.code === 4902) { await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: CONFIG.GENLAYER.chainId, chainName: 'GenLayer Testnet', rpcUrls: [CONFIG.GENLAYER.rpcUrl], nativeCurrency: { name: 'GEN', symbol: 'GEN', decimals: 18 } }] }); } } state.walletConnected = true; $('walletStatus').classList.add('connected'); $('walletAddress').textContent = state.walletAddress.slice(0, 6) + '...' + state.walletAddress.slice(-4); hide('connectWalletBtn'); toast('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success'); } catch (e) { console.error('Wallet connect error:', e); toast('è¿æ¥é’±åŒ…å¤±è´¥', 'error'); }
}
function encodeGenLayerCalldata(method, args = []) { const data = msgpack.encode({ method, args }); return '0x' + Array.from(new Uint8Array(data)).map(b => b.toString(16).padStart(2, '0')).join(''); }
async function recordToGenLayer(room, scores) {
  if (!state.walletConnected) { console.log('Wallet not connected, skipping chain record'); updateChainRecordUI(false, 'Wallet not connected'); return; }
  try { const summary = { theme: room.theme, players: Object.keys(room.players).length, winner: Object.entries(scores).sort((a, b) => (b[1].influence + b[1].debates) - (a[1].influence + a[1].debates))[0], path: room.game.path, timestamp: Date.now() }; const calldata = encodeGenLayerCalldata('record_game', [room.id, room.theme, JSON.stringify(summary)]); const txHash = await window.ethereum.request({ method: 'eth_sendTransaction', params: [{ from: state.walletAddress, to: CONFIG.GENLAYER.contract, data: calldata, gas: '0x7A120', value: '0x0' }] }); console.log('GenLayer TX:', txHash); updateChainRecordUI(true, txHash); } catch (e) { console.error('GenLayer record error:', e); updateChainRecordUI(false, e.message); }
}
function updateChainRecordUI(success, info) { const el = $('chainRecord'); if (!el) return; if (success) { el.innerHTML = `<p>âœ… å·²è®°å½•åˆ° GenLayer åŒºå—é“¾</p><p style="font-size:.8rem;margin-top:.5rem;">TX: <a href="https://studio.genlayer.com" target="_blank">${info.slice(0, 20)}...</a></p>`; } else { el.innerHTML = `<p style="color:#f87171;">âš ï¸ åŒºå—é“¾è®°å½•å¤±è´¥: ${info}</p>`; } }

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  initAvatarGrid(); loadSavedPlayer(); initFirebase();
  if (window.ethereum) { window.ethereum.on('accountsChanged', accounts => { if (accounts.length === 0) { state.walletConnected = false; $('walletStatus').classList.remove('connected'); $('walletAddress').textContent = ''; show('connectWalletBtn'); } }); }
  setInterval(() => { if (state.gameActive && state.currentRoomId) { state.db?.ref(`rooms/${state.currentRoomId}`).once('value').then(snap => { const room = snap.val(); if (room?.game?.timerEnd) updateTimer(room); }); } }, 1000);
});
</script>
</body>
</html>
