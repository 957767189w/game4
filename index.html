<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…±è¯†ç¼–å¹´å² - Consensus Chronicle</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh; 
      color: #e8e8e8;
    }
    
    /* é’±åŒ…æ  */
    .wallet-bar {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.8rem 2rem;
      background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(167,139,250,0.3);
    }
    .wallet-bar .logo { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: #a78bfa; }
    .wallet-bar .info { display: flex; align-items: center; gap: 1.5rem; }
    .wallet-bar .network { padding: 0.3rem 0.8rem; background: rgba(74,222,128,0.2); border: 1px solid rgba(74,222,128,0.5); border-radius: 20px; font-size: 0.8rem; color: #4ade80; }
    .wallet-bar .balance { color: #fbbf24; font-weight: 600; }
    .wallet-bar .address { font-family: monospace; color: #a5a5b8; font-size: 0.85rem; }
    
    .btn {
      padding: 0.6rem 1.2rem; border: none; border-radius: 8px;
      font-weight: 600; cursor: pointer; transition: all 0.3s;
    }
    .btn-primary { background: linear-gradient(135deg, #a78bfa, #f472b6); color: #fff; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(167,139,250,0.4); }
    .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); }
    .btn-danger { background: rgba(239,68,68,0.2); color: #f87171; border: 1px solid rgba(239,68,68,0.3); }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 5rem 2rem 2rem; }
    
    /* é¦–é¡µ */
    .hero { text-align: center; margin-bottom: 3rem; }
    .hero-icon { font-size: 5rem; margin-bottom: 1rem; }
    .hero-title { 
      font-size: 3rem; font-weight: 800; margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #a78bfa, #f472b6, #fb923c);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .hero-subtitle { color: #8b8b9e; letter-spacing: 0.3em; text-transform: uppercase; margin-bottom: 1rem; }
    .hero-desc { color: #a5a5b8; font-style: italic; }
    
    .contract-badge {
      display: inline-flex; align-items: center; gap: 0.5rem;
      padding: 0.5rem 1rem; margin: 1rem 0;
      background: rgba(74,222,128,0.1); border: 1px solid rgba(74,222,128,0.3);
      border-radius: 20px; font-family: monospace; font-size: 0.8rem; color: #4ade80;
    }
    .contract-badge::before { content: ''; width: 8px; height: 8px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    /* è¿æ¥é’±åŒ… */
    .connect-section { text-align: center; padding: 3rem; }
    .metamask-btn {
      display: inline-flex; align-items: center; gap: 1rem;
      padding: 1rem 2rem; font-size: 1.2rem;
      background: linear-gradient(135deg, #f6851b, #e2761b);
      border: none; border-radius: 12px; color: #fff;
      font-weight: 700; cursor: pointer; transition: all 0.3s;
    }
    .metamask-btn:hover { transform: scale(1.05); box-shadow: 0 10px 30px rgba(246,133,27,0.4); }
    .metamask-btn img { width: 32px; height: 32px; }
    
    /* ç©å®¶ä¿¡æ¯ */
    .player-card {
      display: flex; align-items: center; gap: 1rem;
      padding: 1rem 2rem; margin: 2rem auto;
      max-width: 500px;
      background: rgba(167,139,250,0.1); border: 1px solid rgba(167,139,250,0.3);
      border-radius: 50px;
    }
    .player-card .avatar { font-size: 2.5rem; }
    .player-card .name { font-size: 1.3rem; font-weight: 600; flex: 1; }
    .player-card .stats { display: flex; gap: 1.5rem; }
    .player-card .stat { text-align: center; }
    .player-card .stat-value { font-weight: 700; font-size: 1.1rem; }
    .player-card .stat-label { font-size: 0.75rem; color: #8b8b9e; }
    
    /* æ³¨å†Œè¡¨å• */
    .register-form {
      max-width: 500px; margin: 2rem auto;
      padding: 2rem; background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1); border-radius: 16px;
    }
    .register-form h3 { text-align: center; margin-bottom: 1.5rem; color: #c4b5fd; }
    .register-form input {
      width: 100%; padding: 1rem; margin-bottom: 1rem;
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px; color: #fff; font-size: 1rem; outline: none;
    }
    .register-form input:focus { border-color: rgba(167,139,250,0.5); }
    .avatar-grid {
      display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem; margin-bottom: 1rem;
    }
    .avatar-option {
      padding: 0.8rem; font-size: 1.5rem; text-align: center;
      background: rgba(255,255,255,0.03); border: 2px solid transparent;
      border-radius: 8px; cursor: pointer; transition: all 0.3s;
    }
    .avatar-option:hover { background: rgba(255,255,255,0.08); }
    .avatar-option.selected { border-color: #a78bfa; background: rgba(167,139,250,0.2); }
    .fee-note { text-align: center; color: #fbbf24; font-size: 0.9rem; margin-bottom: 1rem; }
    
    /* ä¸»é¢˜é€‰æ‹© */
    .theme-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem; margin: 2rem 0;
    }
    .theme-card {
      display: flex; flex-direction: column; align-items: center;
      padding: 2rem; background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.1); border-radius: 16px;
      cursor: pointer; transition: all 0.3s;
    }
    .theme-card:hover { transform: translateY(-5px); border-color: rgba(167,139,250,0.5); }
    .theme-card .icon { font-size: 3rem; margin-bottom: 1rem; }
    .theme-card .name { font-size: 1.2rem; font-weight: 600; }
    .theme-card .desc { font-size: 0.85rem; color: #6b6b7e; margin-top: 0.5rem; }
    
    /* æˆ¿é—´åˆ—è¡¨ */
    .room-list { margin: 2rem 0; }
    .room-list h3 { margin-bottom: 1rem; color: #c4b5fd; display: flex; align-items: center; gap: 0.5rem; }
    .room-item {
      display: flex; align-items: center; gap: 1rem;
      padding: 1rem 1.5rem; margin-bottom: 0.5rem;
      background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; cursor: pointer; transition: all 0.3s;
    }
    .room-item:hover { background: rgba(255,255,255,0.06); border-color: rgba(167,139,250,0.3); }
    .room-item .theme-icon { font-size: 2rem; }
    .room-item .info { flex: 1; }
    .room-item .theme-name { font-weight: 600; }
    .room-item .host { font-size: 0.85rem; color: #8b8b9e; }
    .room-item .players { color: #4ade80; font-weight: 600; }
    .no-rooms { text-align: center; padding: 3rem; color: #6b6b7e; }
    
    /* æˆ¿é—´è§†å›¾ */
    .room-view { max-width: 800px; margin: 0 auto; }
    .room-header {
      display: flex; justify-content: space-between; align-items: center;
      padding-bottom: 1rem; margin-bottom: 2rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .player-grid {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;
    }
    .player-slot {
      display: flex; flex-direction: column; align-items: center;
      padding: 1.5rem 1rem; background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
    }
    .player-slot.filled { border-color: rgba(167,139,250,0.5); background: rgba(167,139,250,0.1); }
    .player-slot.empty { border-style: dashed; opacity: 0.5; }
    .player-slot .avatar { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .player-slot .name { font-size: 0.95rem; }
    .player-slot .badge { 
      font-size: 0.65rem; padding: 0.2rem 0.4rem; 
      border-radius: 4px; margin-top: 0.3rem;
    }
    .player-slot .host-badge { background: #fbbf24; color: #000; }
    .player-slot .ai-badge { background: #3b82f6; color: #fff; }
    
    /* æ¸¸æˆè§†å›¾ */
    .game-view { display: flex; flex-direction: column; height: calc(100vh - 60px); padding-top: 60px; }
    .game-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem 2rem; background: rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .round-info .label { font-size: 0.9rem; color: #8b8b9e; }
    .round-info .phase { font-size: 1.1rem; font-weight: 600; }
    .progress-dots { display: flex; gap: 0.5rem; }
    .progress-dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(255,255,255,0.2); }
    .progress-dot.done { background: #4ade80; }
    .progress-dot.current { background: #a78bfa; }
    .timer { font-size: 2.5rem; font-weight: 700; font-family: monospace; color: #a78bfa; }
    .timer.warning { color: #f87171; }
    .my-score .label { font-size: 0.85rem; color: #8b8b9e; }
    .my-score .value { font-size: 1.5rem; font-weight: 700; color: #fbbf24; }
    
    .game-main { flex: 1; display: flex; gap: 1rem; padding: 1rem; overflow: hidden; }
    
    .story-panel { flex: 1; display: flex; flex-direction: column; gap: 1rem; min-width: 0; }
    .story-scroll {
      flex: 1; background: rgba(255,255,255,0.03); border-radius: 12px;
      padding: 1rem; overflow-y: auto;
    }
    .story-scroll h3 { color: #c4b5fd; margin-bottom: 1rem; font-size: 1rem; }
    .story-entry { padding: 0.6rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); line-height: 1.7; }
    .story-entry:last-child { border-bottom: none; }
    .story-entry.opening { color: #c4b5fd; font-style: italic; }
    .story-entry.context { color: #fbbf24; }
    .story-entry .round-tag { 
      display: inline-block; padding: 0.2rem 0.5rem; margin-right: 0.5rem;
      background: rgba(251,191,36,0.2); border-radius: 4px;
    }
    .story-entry.choice { color: #4ade80; }
    .story-entry.consequence { color: #a5a5b8; padding-left: 1.5rem; border-left: 2px solid rgba(167,139,250,0.3); }
    
    .options-panel {
      background: rgba(255,255,255,0.02); border-radius: 12px; padding: 1rem;
    }
    .options-panel h4 { text-align: center; margin-bottom: 1rem; }
    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .option-card {
      padding: 1rem; border-radius: 10px; cursor: pointer; transition: all 0.3s;
    }
    .option-card.option-a { border: 2px solid rgba(239,68,68,0.4); background: rgba(239,68,68,0.1); }
    .option-card.option-a:hover, .option-card.option-a.selected { border-color: #ef4444; transform: scale(1.02); }
    .option-card.option-b { border: 2px solid rgba(59,130,246,0.4); background: rgba(59,130,246,0.1); }
    .option-card.option-b:hover, .option-card.option-b.selected { border-color: #3b82f6; transform: scale(1.02); }
    .option-card .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
    .option-card .label { font-weight: 700; font-size: 1.1rem; }
    .option-card.option-a .label { color: #ef4444; }
    .option-card.option-b .label { color: #3b82f6; }
    .option-card .tag { font-size: 0.75rem; padding: 0.2rem 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px; color: #a5a5b8; }
    .option-card .text { font-size: 0.9rem; line-height: 1.5; }
    .option-card .votes { margin-top: 0.8rem; text-align: center; font-size: 1.2rem; font-weight: 600; color: #fbbf24; }
    
    .chat-panel {
      width: 320px; display: flex; flex-direction: column;
      background: rgba(0,0,0,0.2); border-radius: 12px; overflow: hidden;
    }
    .chat-players {
      display: flex; flex-wrap: wrap; gap: 0.4rem;
      padding: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .chat-player {
      display: flex; align-items: center; gap: 0.3rem;
      padding: 0.3rem 0.6rem; background: rgba(255,255,255,0.05);
      border-radius: 15px; font-size: 0.8rem;
    }
    .chat-player.voted { background: rgba(74,222,128,0.2); border: 1px solid rgba(74,222,128,0.4); }
    .chat-player .vote { color: #4ade80; font-weight: 700; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 0.8rem; }
    .chat-msg { margin-bottom: 0.6rem; font-size: 0.85rem; }
    .chat-msg.system { color: #a78bfa; font-style: italic; padding: 0.3rem 0; }
    .chat-msg.chat { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 0.5rem 0.8rem; }
    .chat-msg .sender { color: #fbbf24; font-weight: 600; margin-bottom: 0.3rem; display: flex; justify-content: space-between; }
    .chat-msg .choice-tag { font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 4px; }
    .chat-msg .choice-tag.a { background: rgba(239,68,68,0.3); }
    .chat-msg .choice-tag.b { background: rgba(59,130,246,0.3); }
    .chat-input {
      padding: 0.8rem; border-top: 1px solid rgba(255,255,255,0.05);
    }
    .chat-input-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
    .chat-input input {
      flex: 1; padding: 0.6rem 0.8rem;
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px; color: #fff; font-size: 0.85rem; outline: none;
    }
    .chat-input input:focus { border-color: rgba(167,139,250,0.5); }
    .quick-btns { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    .quick-btn {
      padding: 0.3rem 0.6rem; font-size: 0.75rem;
      border-radius: 15px; cursor: pointer; border: 1px solid;
    }
    .quick-btn.a { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); color: #ef4444; }
    .quick-btn.b { background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); color: #3b82f6; }
    .quick-btn.neutral { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); color: #a5a5b8; }
    
    .vote-prompt {
      padding: 1rem; text-align: center;
      background: rgba(167,139,250,0.1);
      color: #fbbf24; font-weight: 600;
    }
    
    /* ç»“æŸé¢æ¿ */
    .end-panel {
      background: linear-gradient(145deg, rgba(251,191,36,0.1), rgba(167,139,250,0.1));
      border-radius: 12px; padding: 2rem; text-align: center;
    }
    .end-panel h2 { font-size: 1.8rem; margin-bottom: 1.5rem; color: #fbbf24; }
    .rankings { max-width: 400px; margin: 0 auto 1.5rem; }
    .rank-item {
      display: flex; align-items: center; gap: 0.8rem;
      padding: 0.8rem; margin-bottom: 0.4rem;
      background: rgba(255,255,255,0.03); border-radius: 8px;
    }
    .rank-item.first { background: rgba(251,191,36,0.2); border: 1px solid rgba(251,191,36,0.3); }
    .rank-item .rank { font-weight: 700; width: 1.5rem; }
    .rank-item.first .rank, .rank-item:nth-child(2) .rank, .rank-item:nth-child(3) .rank { color: #fbbf24; }
    .rank-item .avatar { font-size: 1.3rem; }
    .rank-item .name { flex: 1; }
    .rank-item .score { font-weight: 600; color: #a78bfa; }
    
    /* Toast */
    .toast-container { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); z-index: 2000; }
    .toast {
      padding: 1rem 2rem; margin-top: 0.5rem;
      background: rgba(0,0,0,0.9); border-radius: 8px;
      color: #fff; font-size: 0.9rem;
      animation: slideUp 0.3s ease;
    }
    .toast.success { border-left: 4px solid #4ade80; }
    .toast.error { border-left: 4px solid #f87171; }
    .toast.info { border-left: 4px solid #a78bfa; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Loading */
    .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- é’±åŒ…æ  -->
  <div class="wallet-bar">
    <div class="logo">ğŸ“œ å…±è¯†ç¼–å¹´å²</div>
    <div class="info" id="walletInfo">
      <span id="networkBadge" class="network hidden">GenLayer Testnet</span>
      <span id="balanceDisplay" class="balance hidden"></span>
      <span id="addressDisplay" class="address hidden"></span>
      <button id="disconnectBtn" class="btn btn-danger hidden" onclick="disconnect()">æ–­å¼€</button>
    </div>
  </div>

  <!-- Toastå®¹å™¨ -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- ä¸»å®¹å™¨ -->
  <div class="container" id="mainContainer">
    <!-- é¦–é¡µ -->
    <div id="homePage">
      <div class="hero">
        <div class="hero-icon">ğŸ“œ</div>
        <h1 class="hero-title">å…±è¯†ç¼–å¹´å²</h1>
        <p class="hero-subtitle">Consensus Chronicle</p>
        <p class="hero-desc">å…±è¯†å¦‚ä½•å¡‘é€ å†å²ï¼Ÿä½ çš„é€‰æ‹©å°†æ”¹å†™å‘½è¿ã€‚</p>
        <div class="contract-badge">
          <span>åˆçº¦: 0x4F5F...aE186</span>
        </div>
      </div>

      <!-- è¿æ¥é’±åŒ… -->
      <div id="connectSection" class="connect-section">
        <button class="metamask-btn" onclick="connectWallet()">
          <svg width="32" height="32" viewBox="0 0 318.6 318.6"><style>.st0{fill:#e4761b}.st1{fill:#d7c1b3}.st2{fill:#f6851b}</style><path class="st0" d="M274.1 35.5l-99.5 73.9 18.4-43.6z"/><path d="M44.4 35.5l98.7 74.6-17.5-44.3zM238.3 206.8l-26.5 40.6 56.7 15.6 16.3-55.3zM33.9 207.7l16.2 55.3 56.7-15.6-26.5-40.6z" fill="#763d16"/><path class="st0" d="M103.6 138.2l-15.8 23.9 56.3 2.5-2-60.5zM215 138.2l-39.1-35 -1.3 61.4 56.2-2.5zM106.8 247.4l33.8-16.5-29.2-22.8zM177.9 230.9l33.9 16.5-4.7-39.3z"/><path d="M211.8 247.4l-33.9-16.5 2.7 22.1-.3 9.3zM106.8 247.4l31.5 14.9-.2-9.3 2.5-22.1z" fill="#d7c1b3"/><path d="M138.8 193.5l-28.2-8.3 19.9-9.1zM179.7 193.5l8.3-17.4 20 9.1z" fill="#233447"/><path class="st2" d="M106.8 247.4l4.8-40.6-31.3.9zM206.9 206.8l4.8 40.6 26.5-39.7zM230.8 162.1l-56.2 2.5 5.2 28.9 8.3-17.4 20 9.1zM110.6 185.2l20-9.1 8.2 17.4 5.3-28.9-56.3-2.5z"/><path d="M87.8 162.1l23.6 46-.8-22.9zM207.1 185.2l-1 22.9 23.7-46zM144.1 164.6l-5.3 28.9 6.6 34.1 1.5-44.9zM174.6 164.6l-2.7 18 1.2 45 6.7-34.1z" fill="#cd6116"/><path class="st2" d="M179.8 193.5l-6.7 34.1 4.8 3.3 29.2-22.8 1-22.9zM110.6 185.2l.8 22.9 29.2 22.8 4.8-3.3-6.6-34.1z"/><path d="M180.3 262.3l.3-9.3-2.5-2.2h-37.7l-2.3 2.2.2 9.3-31.5-14.9 11 9 22.3 15.5h38.3l22.4-15.5 11-9z" fill="#c0ad9e"/><path d="M177.9 230.9l-4.8-3.3h-27.7l-4.8 3.3-2.5 22.1 2.3-2.2h37.7l2.5 2.2z" fill="#161616"/><path d="M278.3 114.2l8.5-40.8-12.7-37.9-96.2 71.4 37 31.3 52.3 15.3 11.6-13.5-5-3.6 8-7.3-6.2-4.8 8-6.1zM31.8 73.4l8.5 40.8-5.4 4 8 6.1-6.1 4.8 8 7.3-5 3.6 11.5 13.5 52.3-15.3 37-31.3-96.2-71.4z" fill="#763d16"/><path class="st2" d="M267.2 153.5l-52.3-15.3 15.9 23.9-23.7 46 31.2-.4h46.5zM103.6 138.2l-52.3 15.3-17.4 54.2h46.4l31.1.4-23.6-46zM174.6 164.6l3.3-57.7 15.2-41.1h-67.5l15 41.1 3.5 57.7 1.2 18.2.1 44.8h27.7l.2-44.8z"/></svg>
          è¿æ¥ MetaMask
        </button>
        <p style="margin-top: 1rem; color: #6b6b7e; font-size: 0.9rem;">éœ€è¦å®‰è£… MetaMask é’±åŒ…</p>
      </div>

      <!-- ç©å®¶å¡ç‰‡ -->
      <div id="playerCard" class="player-card hidden">
        <span class="avatar" id="playerAvatar">ğŸ®</span>
        <span class="name" id="playerName"></span>
        <div class="stats">
          <div class="stat">
            <div class="stat-value" id="playerBalance" style="color: #4ade80;">0 GEN</div>
            <div class="stat-label">ä½™é¢</div>
          </div>
          <div class="stat">
            <div class="stat-value" style="color: #fbbf24;">1000</div>
            <div class="stat-label">ç»éªŒ</div>
          </div>
        </div>
      </div>

      <!-- æ³¨å†Œè¡¨å• -->
      <div id="registerForm" class="register-form hidden">
        <h3>ğŸ­ åˆ›å»ºä½ çš„è§’è‰²</h3>
        <input type="text" id="registerName" placeholder="è¾“å…¥ä½ çš„åå­—..." maxlength="20">
        <div class="avatar-grid" id="avatarGrid"></div>
        <div class="fee-note">âš¡ æ³¨å†Œè´¹ç”¨: 0 GEN (éœ€MetaMaskç¡®è®¤)</div>
        <button class="btn btn-primary" style="width: 100%;" onclick="registerPlayer()">ç¡®è®¤æ³¨å†Œ</button>
      </div>

      <!-- ä¸»é¢˜é€‰æ‹© -->
      <div id="themeSection" class="hidden">
        <h2 style="text-align: center; margin-bottom: 1.5rem; color: #c4b5fd;">é€‰æ‹©ä¸»é¢˜ï¼Œå¼€å¯å†’é™©</h2>
        <div class="theme-grid" id="themeGrid"></div>
        
        <!-- æˆ¿é—´åˆ—è¡¨ -->
        <div class="room-list">
          <h3>ğŸšª å¯åŠ å…¥çš„æˆ¿é—´ <button class="btn btn-secondary" style="margin-left: auto; padding: 0.3rem 0.8rem; font-size: 0.8rem;" onclick="loadRooms()">åˆ·æ–°</button></h3>
          <div id="roomList"><div class="no-rooms">åŠ è½½ä¸­...</div></div>
        </div>
      </div>
    </div>

    <!-- æˆ¿é—´é¡µé¢ -->
    <div id="roomPage" class="room-view hidden">
      <div class="room-header">
        <button class="btn btn-secondary" onclick="leaveRoom()">â† è¿”å›</button>
        <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 1.3rem;">
          <span id="roomThemeIcon">ğŸ°</span>
          <span id="roomThemeName" style="font-weight: 600;"></span>
        </div>
        <span id="roomId" style="font-size: 0.9rem; color: #6b6b7e; font-family: monospace;"></span>
      </div>

      <h3 style="margin-bottom: 1rem; color: #8b8b9e;">ç©å®¶ (<span id="playerCount">0</span>/8)</h3>
      <div class="player-grid" id="playerGrid"></div>

      <button id="startGameBtn" class="btn btn-primary hidden" style="width: 100%; padding: 1rem; font-size: 1.2rem;" onclick="startGame()">
        ğŸ® å¼€å§‹æ¸¸æˆ
      </button>
      <p id="waitingMsg" style="text-align: center; color: #6b6b7e; margin-top: 1rem;"></p>

      <!-- æ¸¸æˆè¯´æ˜ -->
      <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(255,255,255,0.03); border-radius: 12px;">
        <h4 style="margin-bottom: 1rem; color: #c4b5fd;">ğŸ“– æ¸¸æˆæµç¨‹</h4>
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
          <div style="text-align: center; padding: 0.5rem; background: rgba(167,139,250,0.1); border-radius: 8px;">
            <div style="font-size: 1.2rem; font-weight: 700; color: #a78bfa;">ç¬¬1è½®</div>
            <div style="font-size: 0.7rem; color: #8b8b9e;">è¾©è®ºâ†’æŠ•ç¥¨</div>
          </div>
          <div style="text-align: center; padding: 0.5rem; background: rgba(167,139,250,0.1); border-radius: 8px;">
            <div style="font-size: 1.2rem; font-weight: 700; color: #a78bfa;">ç¬¬2è½®</div>
            <div style="font-size: 0.7rem; color: #8b8b9e;">è¾©è®ºâ†’æŠ•ç¥¨</div>
          </div>
          <div style="text-align: center; padding: 0.5rem; background: rgba(167,139,250,0.1); border-radius: 8px;">
            <div style="font-size: 1.2rem; font-weight: 700; color: #a78bfa;">ç¬¬3è½®</div>
            <div style="font-size: 0.7rem; color: #8b8b9e;">è¾©è®ºâ†’æŠ•ç¥¨</div>
          </div>
          <div style="text-align: center; padding: 0.5rem; background: rgba(167,139,250,0.1); border-radius: 8px;">
            <div style="font-size: 1.2rem; font-weight: 700; color: #a78bfa;">ç¬¬4è½®</div>
            <div style="font-size: 0.7rem; color: #8b8b9e;">è¾©è®ºâ†’æŠ•ç¥¨</div>
          </div>
          <div style="text-align: center; padding: 0.5rem; background: rgba(167,139,250,0.1); border-radius: 8px;">
            <div style="font-size: 1.2rem; font-weight: 700; color: #a78bfa;">ç¬¬5è½®</div>
            <div style="font-size: 0.7rem; color: #8b8b9e;">è¾©è®ºâ†’æŠ•ç¥¨</div>
          </div>
        </div>
        <ul style="list-style: none; color: #a5a5b8; font-size: 0.9rem;">
          <li style="padding: 0.3rem 0;">ğŸ’¬ <b>è¾©è®ºé˜¶æ®µ</b>: è¾“å…¥ä½ çš„è§‚ç‚¹ï¼Œè¯´æœå…¶ä»–ç©å®¶</li>
          <li style="padding: 0.3rem 0;">ğŸ—³ï¸ <b>æŠ•ç¥¨é˜¶æ®µ</b>: é€‰æ‹©ä½ æ”¯æŒçš„é€‰é¡¹</li>
          <li style="padding: 0.3rem 0;">ğŸ“œ <b>æ•…äº‹å»¶ç»­</b>: è·èƒœé€‰é¡¹å†³å®šæ•…äº‹èµ°å‘</li>
          <li style="padding: 0.3rem 0;">ğŸ† <b>æ’è¡Œæ¦œ</b>: æ ¹æ®è¾©è®ºå’ŒæŠ•ç¥¨è·å¾—ç§¯åˆ†</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- æ¸¸æˆè§†å›¾ -->
  <div id="gameView" class="game-view hidden">
    <div class="game-header">
      <div class="round-info">
        <div class="label">ç¬¬ <span id="currentRound">1</span> / 5 è½®</div>
        <div class="phase" id="phaseDisplay">ğŸ’¬ è¾©è®ºä¸­</div>
      </div>
      <div class="progress-dots" id="progressDots"></div>
      <div class="timer" id="timerDisplay">1:30</div>
      <div class="my-score">
        <div class="label">æˆ‘çš„ç§¯åˆ†</div>
        <div class="value" id="myScoreDisplay">0</div>
      </div>
    </div>

    <div class="game-main">
      <div class="story-panel">
        <div class="story-scroll" id="storyScroll">
          <h3>ğŸ“œ <span id="gameThemeName">å¥‡å¹»å†’é™©</span> - æ•…äº‹è¿›ç¨‹</h3>
          <div id="storyContent"></div>
        </div>

        <div class="options-panel" id="optionsPanel">
          <h4>âš”ï¸ æœ¬è½®æŠ‰æ‹©</h4>
          <div class="options-grid">
            <div class="option-card option-a" id="optionA" onclick="selectOption('A')">
              <div class="header">
                <span class="label">é€‰é¡¹ A</span>
                <span class="tag" id="tagA"></span>
              </div>
              <p class="text" id="textA"></p>
              <div class="votes hidden" id="votesA">0 ç¥¨</div>
            </div>
            <div class="option-card option-b" id="optionB" onclick="selectOption('B')">
              <div class="header">
                <span class="label">é€‰é¡¹ B</span>
                <span class="tag" id="tagB"></span>
              </div>
              <p class="text" id="textB"></p>
              <div class="votes hidden" id="votesB">0 ç¥¨</div>
            </div>
          </div>
        </div>

        <div class="end-panel hidden" id="endPanel">
          <h2>ğŸ† ç¼–å¹´å²å®Œæˆï¼</h2>
          <div class="rankings" id="rankings"></div>
          <button class="btn btn-primary" onclick="backToLobby()">è¿”å›å¤§å…</button>
        </div>
      </div>

      <div class="chat-panel">
        <div class="chat-players" id="chatPlayers"></div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input" id="chatInput">
          <div class="chat-input-row">
            <input type="text" id="messageInput" placeholder="è¾“å…¥ä½ çš„è§‚ç‚¹..." onkeydown="if(event.key==='Enter')sendMessage()">
            <button class="btn btn-primary" onclick="sendMessage()">å‘é€</button>
          </div>
          <div class="quick-btns">
            <button class="quick-btn a" onclick="quickMsg('A')">ğŸ…°ï¸ æ”¯æŒA</button>
            <button class="quick-btn b" onclick="quickMsg('B')">ğŸ…±ï¸ æ”¯æŒB</button>
            <button class="quick-btn neutral" onclick="quickMsg('N')">ğŸ’­ è§‚ç‚¹</button>
          </div>
        </div>
        <div class="vote-prompt hidden" id="votePrompt">â° è¯·åœ¨å·¦ä¾§é€‰æ‹©ä½ æ”¯æŒçš„é€‰é¡¹ï¼</div>
      </div>
    </div>
  </div>

<script>
// ========== é…ç½® ==========
const CONFIG = {
  CHAIN_ID: '0xa2c4', // 41668
  CHAIN_ID_DEC: 41668,
  RPC_URL: 'https://studio-rpc.genlayer.com',
  CHAIN_NAME: 'GenLayer Testnet',
  EXPLORER: 'https://studio-explorer.genlayer.com',
  SYMBOL: 'GEN',
  CONTRACT: '0x4F5F132ba540f1C685B0188D59990302903aE186',
  ROOM_SIZE: { min: 2, max: 8 },
  DEBATE_DURATION: 90,
  VOTE_DURATION: 30,
  TOTAL_ROUNDS: 5,
};

const CONTRACT_ABI = [
  "function register_player(string memory name, string memory avatar) public payable",
  "function create_room(string memory theme) public payable returns (uint256)",
  "function join_room(uint256 roomId) public payable",
  "function start_game(uint256 roomId) public",
  "function vote(uint256 roomId, string memory choice) public",
  "function get_player(address player) public view returns (string memory)",
  "function get_room(uint256 roomId) public view returns (string memory)",
  "function list_rooms() public view returns (string memory)"
];

// ========== æ•…äº‹ç³»ç»Ÿ ==========
const STORY_ARCS = {
  fantasy: {
    name: 'å¥‡å¹»å†’é™©', icon: 'ğŸ°',
    opening: 'å¤è€çš„é¢„è¨€ç»ˆäºåº”éªŒâ€”â€”æ²‰ç¡åƒå¹´çš„é»‘é¾™è‹é†’äº†ã€‚ç‹å›½å±åœ¨æ—¦å¤•ï¼Œå›½ç‹ç´§æ€¥å¬é›†äº†å„åœ°è‹±é›„å•†è®®å¯¹ç­–...',
    rounds: [
      {
        context: 'é»‘é¾™çš„å¨èƒè¿«åœ¨çœ‰ç«ï¼Œç‹å›½å¿…é¡»åšå‡ºç¬¬ä¸€ä¸ªå…³é”®å†³å®šã€‚',
        a: { text: 'ç«‹å³é›†ç»“å†›é˜Ÿï¼Œä¸»åŠ¨å‡ºå‡»é¾™å·¢ï¼Œåœ¨å®ƒå®Œå…¨è‹é†’å‰å°†å…¶æ¶ˆç­ã€‚', tag: 'å…ˆå‘åˆ¶äººÂ·æ¿€è¿›', consequence: 'ç‹å›½å†›é˜Ÿå‘é¾™å·¢è¿›å‘ï¼Œä½†é€”ä¸­é­é‡äº†é¾™çš„çˆªç‰™ï¼ŒæŸå¤±æƒ¨é‡...' },
        b: { text: 'æ´¾é£ä½¿è€…å¯»æ±‚ç²¾çµæ—çš„å¸®åŠ©ï¼Œä»–ä»¬æ›¾åœ¨åƒå¹´å‰å°å°è¿‡é»‘é¾™ã€‚', tag: 'å¯»æ±‚è”ç›ŸÂ·ç¨³å¥', consequence: 'ä½¿è€…æˆåŠŸè”ç³»åˆ°äº†ç²¾çµæ—ï¼Œä½†ä»–ä»¬æå‡ºäº†è‹›åˆ»çš„æ¡ä»¶...' },
      },
      {
        contextA: 'å†›é˜ŸæŸå¤±æƒ¨é‡ï¼Œä½†å·²é€¼è¿‘é¾™å·¢ã€‚æ­¤æ—¶æ¢å­æ¥æŠ¥ï¼šé¾™å·¢å†…å‘ç°äº†é¾™è›‹ã€‚',
        contextB: 'ç²¾çµæ—è¦æ±‚äººç±»äº¤å‡ºåœ£å‰‘ä½œä¸ºä¿¡ä»»çš„è¯æ˜ï¼Œå¦åˆ™ä¸äºˆæ´åŠ©ã€‚',
        a: { text: 'æ‘§æ¯é¾™è›‹ï¼Œå½»åº•æ–­ç»é»‘é¾™ä¸€æ—çš„è¡€è„‰ï¼Œæ°¸é™¤åæ‚£ã€‚', tag: 'æ–©è‰é™¤æ ¹Â·æ®‹é…·', consequenceFromA: 'é¾™è›‹è¢«æ¯ï¼Œé»‘é¾™ç‹‚æ€’ï¼Œæˆ˜æ–—æ›´åŠ æƒ¨çƒˆ...', consequenceFromB: 'æ‹’ç»äº¤å‡ºåœ£å‰‘åï¼Œäººç±»å†³å®šç‹¬è‡ªé¢å¯¹é»‘é¾™ï¼Œæ‘§æ¯äº†é¾™è›‹...' },
        b: { text: 'ä¿ç•™é¾™è›‹ï¼Œæˆ–è®¸å¯ä»¥ç”¨å®ƒä¸é»‘é¾™è°ˆåˆ¤ï¼Œæˆ–åŸ¹å…»ä¸€æ¡å‹å–„çš„é¾™ã€‚', tag: 'ç•™æœ‰ä½™åœ°Â·å†’é™©', consequenceFromA: 'é¾™è›‹è¢«ç§˜å¯†ä¿æŠ¤èµ·æ¥ï¼Œä½†æ¶ˆæ¯æ³„éœ²å¼•å‘äº†å†…éƒ¨åˆ†è£‚...', consequenceFromB: 'äº¤å‡ºåœ£å‰‘æ¢å–ç²¾çµæ´åŠ©ï¼ŒåŒæ—¶ä¿æŠ¤äº†é¾™è›‹...' },
      },
      {
        contextAA: 'é»‘é¾™åœ¨ç‹‚æ€’ä¸­å±•ç°å‡ºæ¯å¤©ç­åœ°çš„åŠ›é‡ï¼Œå†›é˜Ÿå³å°†å…¨å†›è¦†æ²¡ã€‚',
        contextAB: 'å†…éƒ¨åˆ†è£‚å¯¼è‡´å†›å¿ƒæ¶£æ•£ï¼Œæœ‰äººä¸»å¼ æŠ•é™ï¼Œæœ‰äººåšæŒæˆ˜æ–—ã€‚',
        contextBA: 'ç‹¬è‡ªä½œæˆ˜çš„äººç±»å†›é˜Ÿåœ¨æ²¡æœ‰ç²¾çµé­”æ³•çš„æ”¯æŒä¸‹é™·å…¥è‹¦æˆ˜ã€‚',
        contextBB: 'ç²¾çµå†›é˜ŸæŠµè¾¾ï¼Œä½†ä»–ä»¬å¯¹é¾™è›‹çš„å­˜åœ¨æ„Ÿåˆ°ä¸æ»¡ï¼Œå¨èƒæ’¤å†›ã€‚',
        a: { text: 'ä½¿ç”¨ç¦å¿Œé­”æ³•ï¼Œç‰ºç‰²æ–½æ³•è€…çš„ç”Ÿå‘½æ¥é‡åˆ›é»‘é¾™ã€‚', tag: 'ç‰ºç‰²å°æˆ‘Â·æ‚²å£®', consequence: 'ç¦å¿Œé­”æ³•ç”Ÿæ•ˆï¼Œé»‘é¾™é‡ä¼¤å è½ï¼Œä½†ä»£ä»·æ˜¯æƒ¨é‡çš„...' },
        b: { text: 'ä¸‹ä»¤æ’¤é€€ï¼Œä¿å­˜å®åŠ›ï¼Œç­‰å¾…æ›´å¥½çš„æ—¶æœºå†æˆ˜ã€‚', tag: 'ä»¥é€€ä¸ºè¿›Â·å¿è€', consequence: 'å†›é˜Ÿæ’¤é€€åˆ°å®‰å…¨åœ°å¸¦ï¼Œä½†é»‘é¾™è¶æœºæ‘§æ¯äº†æ•°ä¸ªæ‘åº„...' },
      },
      {
        contextA: 'é»‘é¾™é‡ä¼¤åé€€å›å·¢ç©´ç–—ä¼¤ï¼Œä½†å®ƒçš„æ„¤æ€’ä½¿å¾—æ•´ä¸ªåŒºåŸŸéƒ½ç¬¼ç½©åœ¨æ­»äº¡æ°”æ¯ä¸­ã€‚',
        contextB: 'æ’¤é€€åï¼Œç‹å›½å¼€å§‹åæ€ç­–ç•¥ï¼Œæ°‘é—´å‡ºç°äº†å„ç§å£°éŸ³å’ŒåŠ¿åŠ›ã€‚',
        a: { text: 'è¶é»‘é¾™ç–—ä¼¤æœŸé—´å‘èµ·æ€»æ”»ï¼Œä¸€ä¸¾å°†å…¶æ¶ˆç­ã€‚', tag: 'ä¹˜èƒœè¿½å‡»Â·å†³ç»', consequence: 'æ€»æ”»å¼€å§‹ï¼Œè¿™å°†æ˜¯å†³å®šç‹å›½å‘½è¿çš„æœ€åä¸€æˆ˜...' },
        b: { text: 'å°è¯•ä¸å—ä¼¤çš„é»‘é¾™æ²Ÿé€šï¼Œå¯»æ‰¾å’Œå¹³å…±å­˜çš„å¯èƒ½ã€‚', tag: 'åŒ–æ•Œä¸ºå‹Â·ç†æƒ³', consequence: 'ä½¿è€…å†’æ­»æ¥è¿‘é»‘é¾™ï¼Œå‡ºä¹æ„æ–™åœ°ï¼Œé»‘é¾™æ„¿æ„å¯¹è¯...' },
      },
      {
        contextA: 'æœ€ç»ˆå†³æˆ˜ä¸­ï¼ŒåŒæ–¹éƒ½ä»˜å‡ºäº†æƒ¨é‡ä»£ä»·ï¼Œèƒœè´Ÿå³å°†æ­æ™“ã€‚',
        contextB: 'é»‘é¾™é€éœ²å®ƒè‹é†’æ˜¯å› ä¸ºæ„Ÿå—åˆ°äº†æ›´å¤§çš„å¨èƒâ€”â€”æ¥è‡ªæ·±æ¸Šçš„é‚ªç¥å³å°†é™ä¸´ã€‚',
        a: { text: 'ä¸æƒœä¸€åˆ‡ä»£ä»·æ¶ˆç­é»‘é¾™ï¼Œå“ªæ€•ç‹å›½åŒ–ä¸ºç„¦åœŸä¹Ÿåœ¨æ‰€ä¸æƒœã€‚', tag: 'ç‰çŸ³ä¿±ç„šÂ·æç«¯', ending: 'é»‘é¾™è¢«æ¶ˆç­ï¼Œä½†ç‹å›½ä¹Ÿå‡ ä¹åŒ–ä¸ºåºŸå¢Ÿã€‚å¹¸å­˜è€…å¼€å§‹äº†æ¼«é•¿çš„é‡å»ºä¹‹è·¯ï¼Œå†å²å°†é“­è®°è¿™åœºæƒ¨èƒœã€‚' },
        b: { text: 'æ¥å—å‘½è¿çš„å®‰æ’ï¼Œä¸é»‘é¾™è¾¾æˆåè®®ï¼Œå…±åŒé¢å¯¹æœªæ¥çš„æŒ‘æˆ˜ã€‚', tag: 'æ¡æ‰‹è¨€å’ŒÂ·æ™ºæ…§', ending: 'äººç±»ä¸é»‘é¾™è¾¾æˆäº†å‰æ‰€æœªæœ‰çš„ç›Ÿçº¦ï¼Œå…±åŒå®ˆæŠ¤è¿™ç‰‡å¤§é™†ã€‚ä¸€ä¸ªæ–°çš„æ—¶ä»£å°±æ­¤å¼€å¯ã€‚' },
      },
    ],
  },
  scifi: {
    name: 'ç§‘å¹»æœªæ¥', icon: 'ğŸš€',
    opening: '2157å¹´ï¼Œç«æ˜Ÿæ®–æ°‘åœ°"æ–°å¸Œæœ›"æ”¶åˆ°äº†ä¸€æ®µæ¥è‡ªæ·±ç©ºçš„ç¥ç§˜ä¿¡å·ã€‚ç§‘å­¦å®¶ä»¬ç ´è¯‘åå‘ç°ï¼šè¿™æ˜¯ä¸€ä¸ªè­¦å‘Šâ€”â€”åœ°çƒå°†åœ¨100å¤©åè¢«å°è¡Œæ˜Ÿæ’å‡»ã€‚ç„¶è€Œï¼Œæ®–æ°‘åœ°çš„èµ„æºåªå¤Ÿæ•‘ä¸€åŠäºº...',
    rounds: [
      {
        context: 'æ¶ˆæ¯å…¬å¸ƒåï¼Œæ®–æ°‘åœ°é™·å…¥ææ…Œã€‚é¢†å¯¼å±‚å¿…é¡»ç«‹å³åšå‡ºå†³å®šã€‚',
        a: { text: 'ç«‹å³å¯åŠ¨"æ–¹èˆŸè®¡åˆ’"ï¼Œé€šè¿‡æŠ½ç­¾å†³å®šè°èƒ½ç™»ä¸Šé€ƒç”Ÿé£èˆ¹ã€‚', tag: 'å…¬å¹³æŠ½ç­¾Â·å†·é…·', consequence: 'æŠ½ç­¾ç»“æœå…¬å¸ƒï¼Œè½é€‰è€…å¼€å§‹ç»æœ›åœ°æŠ—è®®ï¼Œå®‰ä¿éƒ¨é˜Ÿè¢«è¿«ä»‹å…¥...' },
        b: { text: 'é›†ä¸­æ‰€æœ‰èµ„æºç ”ç©¶ä¿¡å·æ¥æºï¼Œä¹Ÿè®¸é‚£é‡Œæœ‰æ‹¯æ•‘æ‰€æœ‰äººçš„ç­”æ¡ˆã€‚', tag: 'è¿½å¯»å¸Œæœ›Â·å†’é™©', consequence: 'ç ”ç©¶å›¢é˜Ÿå‘ç°ä¿¡å·æ¥è‡ªä¸€ä¸ªæœªçŸ¥æ–‡æ˜ï¼Œä»–ä»¬ä¼¼ä¹åœ¨é‚€è¯·äººç±»...' },
      },
      {
        contextA: 'æŠ—è®®æ¼”å˜ä¸ºæš´åŠ¨ï¼Œéƒ¨åˆ†è½é€‰è€…å é¢†äº†é£èˆ¹å‘å°„åŒºã€‚',
        contextB: 'æ·±å…¥åˆ†æä¿¡å·åï¼Œå‘ç°é‚£ä¸ªæ–‡æ˜åœ¨é‚€è¯·äººç±»å»ä¸€ä¸ªé¥è¿œçš„æ˜Ÿç³»ï¼Œä½†æ—…ç¨‹éœ€è¦500å¹´ã€‚',
        a: { text: 'æˆæƒå®‰ä¿éƒ¨é˜Ÿä½¿ç”¨æ­¦åŠ›ï¼Œç¡®ä¿æ–¹èˆŸè®¡åˆ’æŒ‰æ—¶æ‰§è¡Œã€‚', tag: 'é“è…•é•‡å‹Â·æ•ˆç‡', consequenceFromA: 'æš´åŠ¨è¢«é•‡å‹ï¼Œä½†è®¸å¤šäººåœ¨å†²çªä¸­ä¸§ç”Ÿï¼Œå¹¸å­˜è€…å¿ƒå­˜æ€¨æ¨...', consequenceFromB: 'æ”¾å¼ƒä¸å¤–æ˜Ÿæ–‡æ˜è”ç³»ï¼Œä¸“æ³¨äºç°æœ‰çš„é€ƒç”Ÿè®¡åˆ’...' },
        b: { text: 'ä¸æŠ—è®®è€…è°ˆåˆ¤ï¼Œå°è¯•ä¿®æ”¹è®¡åˆ’è®©æ›´å¤šäººè·å¾—ç”Ÿå­˜æœºä¼šã€‚', tag: 'å¯»æ±‚å…±è¯†Â·äººé“', consequenceFromA: 'è°ˆåˆ¤å–å¾—è¿›å±•ï¼Œå·¥ç¨‹å¸ˆæå‡ºå¯ä»¥è¶…è½½é£èˆ¹ï¼Œä½†é£é™©æå¤§...', consequenceFromB: 'å†³å®šæ´¾é£å…ˆé£é˜Ÿå“åº”é‚€è¯·ï¼Œå…¶ä½™äººè¿›å…¥å†·å†»ç¡çœ ç­‰å¾…...' },
      },
      {
        contextAA: 'é£èˆ¹è¶…è½½ä¼šå¯¼è‡´æˆåŠŸç‡ä»95%é™åˆ°60%ï¼Œä½†èƒ½å¤šæ•‘30%çš„äººã€‚',
        contextAB: 'å…ˆé£é˜Ÿå‡ºå‘åå¤±å»è”ç³»ï¼Œå‰©ä½™èµ„æºåªå¤Ÿç»´æŒ60å¤©ã€‚',
        contextBA: 'éƒ¨åˆ†æ¿€è¿›åˆ†å­ä¸æ¥å—è°ˆåˆ¤ç»“æœï¼Œå¯†è°‹ç ´åé£èˆ¹ã€‚',
        contextBB: 'å†·å†»ç¡çœ æŠ€æœ¯å°šæœªå®Œå–„ï¼Œæœ‰30%çš„å¤±è´¥ç‡ã€‚',
        a: { text: 'æ¥å—è¶…è½½æ–¹æ¡ˆï¼Œç”¨60%çš„æˆåŠŸç‡æ¢å–æ›´å¤šäººçš„å¸Œæœ›ã€‚', tag: 'å†’é™©æ±‚å…¨Â·èµŒåš', consequence: 'è¶…è½½æ–¹æ¡ˆå¯åŠ¨ï¼Œæ‰€æœ‰äººéƒ½åœ¨ç¥ˆç¥·å¥‡è¿¹å‘ç”Ÿ...' },
        b: { text: 'ç»´æŒåŸè®¡åˆ’ï¼Œç¡®ä¿è‡³å°‘ä¸€åŠäººèƒ½å¤Ÿç¡®å®šå­˜æ´»ã€‚', tag: 'ç¨³å¦¥æ±‚å­˜Â·ç°å®', consequence: 'åŸè®¡åˆ’ç»§ç»­æ‰§è¡Œï¼Œä½†ç¤¾ä¼šçš„è£‚ç—•å·²æ— æ³•å¼¥åˆ...' },
      },
      {
        contextA: 'é£èˆ¹èµ·é£å‰ï¼ŒAIç³»ç»Ÿæ£€æµ‹åˆ°ä¸€ä¸ªæƒŠäººçš„å¯èƒ½æ€§ï¼šå°è¡Œæ˜Ÿçš„è½¨é“å¯ä»¥è¢«äººä¸ºæ”¹å˜ã€‚',
        contextB: 'å‘å°„å‡†å¤‡å®Œæˆæ—¶ï¼Œå…ˆé£é˜Ÿçªç„¶ä¼ æ¥æ¶ˆæ¯ï¼šå¤–æ˜Ÿæ–‡æ˜å¯ä»¥æä¾›æŠ€æœ¯æ‘§æ¯å°è¡Œæ˜Ÿï¼Œä½†éœ€è¦äººç±»æ”¾å¼ƒæ­¦å™¨ã€‚',
        a: { text: 'å°è¯•æ”¹å˜å°è¡Œæ˜Ÿè½¨é“ï¼Œå³ä½¿å¤±è´¥ä¹Ÿå€¼å¾—ä¸€è¯•ã€‚', tag: 'é€†å¤©æ”¹å‘½Â·è‹±é›„', consequence: 'å…¨æ®–æ°‘åœ°çš„èƒ½æºè¢«é›†ä¸­ç”¨äºè¿™ä¸ªå¤§èƒ†çš„è®¡åˆ’...' },
        b: { text: 'æŒ‰åŸè®¡åˆ’æ’¤ç¦»ï¼Œä¸è¦æŠŠæ‰€æœ‰é¸¡è›‹æ”¾åœ¨ä¸€ä¸ªç¯®å­é‡Œã€‚', tag: 'åˆ†æ•£é£é™©Â·è°¨æ…', consequence: 'é£èˆ¹å¼€å§‹æ’¤ç¦»ï¼Œä½†ç•™ä¸‹çš„äººæ²¡æœ‰æ”¾å¼ƒå¸Œæœ›...' },
      },
      {
        contextA: 'æ”¹å˜è½¨é“çš„å°è¯•æ¶ˆè€—äº†80%çš„èƒ½æºï¼Œå°è¡Œæ˜Ÿåç§»äº†ï¼Œä½†ä¸å¤Ÿâ€”â€”å®ƒä»ä¼šæ“¦è¿‡åœ°çƒå¤§æ°”å±‚ï¼Œé€ æˆå·¨å¤§ç¾éš¾ã€‚',
        contextB: 'å¤–æ˜Ÿæ–‡æ˜çš„æŠ€æœ¯ç¡®å®æœ‰æ•ˆï¼Œä½†ä»–ä»¬è¦æ±‚äººç±»å¿…é¡»å…ˆé”€æ¯æ‰€æœ‰æ ¸æ­¦å™¨ä½œä¸º"å…¥ä¼šè´¹"ã€‚',
        a: { text: 'æ”¾æ‰‹ä¸€æï¼Œç”¨å‰©ä½™èƒ½æºå†æ¨ä¸€æ¬¡ï¼Œè¦ä¹ˆå…¨èµ¢ï¼Œè¦ä¹ˆå…¨è¾“ã€‚', tag: 'èƒŒæ°´ä¸€æˆ˜Â·æé™', ending: 'å¥‡è¿¹å‘ç”Ÿäº†ï¼å°è¡Œæ˜Ÿåœ¨æœ€åä¸€åˆ»åç¦»äº†æ’å‡»è½¨é“ã€‚äººç±»ç”¨å‹‡æ°”å’Œå›¢ç»“æˆ˜èƒœäº†å‘½è¿ï¼Œè¿™ä¸€å¤©è¢«æ°¸è¿œé“­è®°ä¸º"æ–°å¸Œæœ›æ—¥"ã€‚' },
        b: { text: 'æ¥å—éƒ¨åˆ†æŸå¤±ï¼Œå¼€å§‹ç¾åé‡å»ºè®¡åˆ’ï¼Œäººç±»å°†æµ´ç«é‡ç”Ÿã€‚', tag: 'åŠ¡å®é¢å¯¹Â·é‡ç”Ÿ', ending: 'å°è¡Œæ˜Ÿæ“¦è¿‡åœ°çƒï¼Œé€ æˆäº†ä¸¥é‡ä½†éæ¯ç­æ€§çš„ç¾éš¾ã€‚å¹¸å­˜çš„äººç±»å¼€å§‹äº†è‰°éš¾çš„é‡å»ºï¼Œä½†ä»–ä»¬çŸ¥é“ï¼Œåªè¦äººç±»è¿˜åœ¨ï¼Œå¸Œæœ›å°±åœ¨ã€‚' },
      },
    ],
  },
  mystery: {
    name: 'æ‚¬ç–‘æ¨ç†', icon: 'ğŸ”',
    opening: 'æš´é£é›¨ä¹‹å¤œï¼Œå¯Œè±ªé™ˆå®¶çš„å®¶ä¸»é™ˆè€çˆ·åœ¨ä¹¦æˆ¿è¢«äººæ¯’æ€ã€‚å¤§é—¨ä»å†…åé”ï¼Œçª—æˆ·å®Œå¥½æ— æŸã€‚åœ¨åœºçš„æœ‰ï¼šå¤§å„¿å­é™ˆæ˜ã€äºŒå¥³å„¿é™ˆæœˆã€ç®¡å®¶è€å¼ ã€å¥³ä»†å°èŠ³ï¼Œä»¥åŠåˆšåˆ°è®¿çš„ç¥ç§˜å•†äººæå…ˆç”Ÿã€‚æ¯ä¸ªäººä¼¼ä¹éƒ½æœ‰å«Œç–‘ï¼Œæ¯ä¸ªäººéƒ½æœ‰ç§˜å¯†...',
    rounds: [
      {
        context: 'è­¦æ–¹å°é”äº†å®…é‚¸ï¼Œæ‰€æœ‰äººéƒ½ä¸èƒ½ç¦»å¼€ã€‚ä½œä¸ºè¢«é‚€è¯·æ¥çš„ä¾¦æ¢ï¼Œä½ å¿…é¡»å¼€å§‹è°ƒæŸ¥ã€‚',
        a: { text: 'é¦–å…ˆæœæŸ¥æ­»è€…çš„ä¹¦æˆ¿ï¼Œå¯»æ‰¾ç‰©è¯å’Œçº¿ç´¢ã€‚', tag: 'ç‰©è¯ä¼˜å…ˆÂ·ç³»ç»Ÿ', consequence: 'åœ¨ä¹¦æˆ¿å‘ç°äº†ä¸€å°è¢«çƒ§æ¯ä¸€åŠçš„ä¿¡ä»¶ï¼Œéšçº¦å¯è§"èƒŒå›"å’Œ"é—äº§"å­—æ ·...' },
        b: { text: 'åˆ†åˆ«è¯¢é—®åœ¨åœºæ¯ä¸ªäººï¼Œè§‚å¯Ÿä»–ä»¬çš„ååº”å’Œæ¼æ´ã€‚', tag: 'å¯Ÿè¨€è§‚è‰²Â·ç›´è§‰', consequence: 'è¯¢é—®ä¸­å‘ç°ç®¡å®¶è€å¼ ç¥è‰²æ…Œå¼ ï¼Œè€Œé™ˆæœˆæåˆ°çˆ¶äº²æœ€è¿‘æ”¶åˆ°è¿‡å¨èƒä¿¡...' },
      },
      {
        contextA: 'ä¿¡ä»¶æ˜¾ç¤ºé™ˆè€çˆ·æ›¾æ‰“ç®—æ›´æ”¹é—å˜±ï¼Œå‰¥å¤ºæŸäººçš„ç»§æ‰¿æƒã€‚',
        contextB: 'è¿›ä¸€æ­¥è°ƒæŸ¥å‘ç°ï¼Œå¨èƒä¿¡æ¥è‡ªä¸€ä¸ªç¥ç§˜ç»„ç»‡ï¼Œè€Œæå…ˆç”Ÿä¼¼ä¹ä¸è¿™ä¸ªç»„ç»‡æœ‰å…³è”ã€‚',
        a: { text: 'æ·±å…¥è°ƒæŸ¥é—äº§é—®é¢˜ï¼Œè¿½æŸ¥è°æ˜¯è¢«å‰¥å¤ºç»§æ‰¿æƒçš„äººã€‚', tag: 'è¿½è¸ªé‡‘é’±Â·ç°å®', consequenceFromA: 'å‘ç°é™ˆæ˜æ¬ ä¸‹å·¨é¢èµŒå€ºï¼Œè€Œé™ˆæœˆä¸€ç›´åœ¨ç§˜å¯†èµ„åŠ©ä¸€ä¸ªæ…ˆå–„æœºæ„...', consequenceFromB: 'è°ƒæŸ¥æ˜¾ç¤ºé™ˆè€çˆ·æœ€è¿‘è½¬ç§»äº†å¤§ç¬”èµ„äº§ï¼Œä½†å»å‘ä¸æ˜...' },
        b: { text: 'è°ƒæŸ¥æå…ˆç”Ÿçš„èº«ä»½å’Œæ¥å†ï¼Œä»–çš„å‡ºç°å¤ªè¿‡å·§åˆã€‚', tag: 'è¿½æŸ¥å¤–äººÂ·æ€€ç–‘', consequenceFromA: 'æå…ˆç”Ÿçš„èº«ä»½è¢«æ­éœ²ï¼šä»–æ˜¯é™ˆè€çˆ·å¤±æ•£å¤šå¹´çš„ç§ç”Ÿå­...', consequenceFromB: 'æå…ˆç”Ÿæ‰¿è®¤è‡ªå·±æ˜¯æ¥è°ˆç”Ÿæ„çš„ï¼Œä½†ä»–å¸¦æ¥äº†ä¸€ä¸ªæƒŠäººçš„ç§˜å¯†...' },
      },
      {
        contextAA: 'é™ˆæ˜æœ‰åŠ¨æœºï¼Œä½†ä»–æœ‰ä¸åœ¨åœºè¯æ˜â€”â€”å¥³ä»†å°èŠ³å¯ä»¥ä½œè¯ã€‚',
        contextAB: 'èµ„äº§è½¬ç§»çš„ç›®çš„åœ°æ˜¯ä¸€ä¸ªæµ·å¤–è´¦æˆ·ï¼Œæˆ·ä¸»åå­—è¢«åŠ å¯†ã€‚',
        contextBA: 'ç§ç”Ÿå­çš„å‡ºç°æ„å‘³ç€é—äº§å°†è¢«é‡æ–°åˆ†é…ï¼Œæ‰€æœ‰åˆæ³•ç»§æ‰¿äººéƒ½æœ‰äº†åŠ¨æœºã€‚',
        contextBB: 'æå…ˆç”Ÿé€éœ²é™ˆè€çˆ·ç”Ÿå‰ä¸€ç›´åœ¨è°ƒæŸ¥ä¸€æ¡©é™ˆå¹´æ—§æ¡ˆâ€”â€”ä¸€èµ·è¢«æ©ç›–çš„è°‹æ€ã€‚',
        a: { text: 'éªŒè¯å°èŠ³çš„è¯è¯ï¼Œå¥¹å¯èƒ½æ˜¯å…³é”®è¯äººï¼Œä¹Ÿå¯èƒ½æ˜¯åŒè°‹ã€‚', tag: 'è´¨ç–‘è¯è¯Â·ç»†è‡´', consequence: 'å‹åŠ›ä¹‹ä¸‹ï¼Œå°èŠ³å´©æºƒäº†ï¼Œæ‰¿è®¤é™ˆæ˜æ›¾å¨èƒå¥¹ä½œä¼ªè¯...' },
        b: { text: 'è°ƒæŸ¥é™ˆå¹´æ—§æ¡ˆï¼Œä¹Ÿè®¸è¿‡å»çš„ç§˜å¯†èƒ½æ­ç¤ºç°åœ¨çš„çœŸç›¸ã€‚', tag: 'è¿½æº¯è¿‡å»Â·è€å¿ƒ', consequence: 'æ—§æ¡ˆçš„çº¿ç´¢æŒ‡å‘20å¹´å‰çš„ä¸€åœºç«ç¾ï¼Œé™ˆè€çˆ·çš„åŸé…å¦»å­åœ¨é‚£åœºç«ç¾ä¸­èº«äº¡...' },
      },
      {
        contextA: 'ä¼ªè¯è¢«æˆ³ç©¿åï¼Œé™ˆæ˜çš„ä¸åœ¨åœºè¯æ˜å¤±æ•ˆã€‚ä½†ä»–åšç§°è‡ªå·±æ˜¯æ— è¾œçš„ï¼Œå¹¶æŒ‡æ§é™ˆæœˆæ‰æ˜¯å‡¶æ‰‹ã€‚',
        contextB: 'è°ƒæŸ¥å‘ç°ï¼Œé‚£åœºç«ç¾å¹¶éæ„å¤–ï¼Œè€Œæ˜¯äººä¸ºçºµç«ã€‚æ›´æƒŠäººçš„æ˜¯ï¼Œé™ˆè€çˆ·å¯èƒ½çŸ¥é“çœŸå‡¶æ˜¯è°ã€‚',
        a: { text: 'å¯¹é™ˆæ˜å’Œé™ˆæœˆè¿›è¡Œäº¤å‰å®¡é—®ï¼Œæ‰¾å‡ºè°åœ¨è¯´è°ã€‚', tag: 'æ­£é¢å¯¹è´¨Â·æ¿€çƒˆ', consequence: 'å®¡é—®ä¸­ï¼Œä¸€ä¸ªæƒŠå¤©ç§˜å¯†è¢«æ­å¼€ï¼šé™ˆæœˆä¸æ˜¯é™ˆè€çˆ·çš„äº²ç”Ÿå¥³å„¿...' },
        b: { text: 'é‡æ–°æ£€éªŒæ¯’è¯æ¥æºï¼Œå‡¶å™¨å¾€å¾€èƒ½æŒ‡å‘çœŸå‡¶ã€‚', tag: 'ç§‘å­¦åˆ†æÂ·ä¸¥è°¨', consequence: 'æ¯’è¯æˆåˆ†åˆ†ææ˜¾ç¤ºï¼Œè¿™ç§æ¯’è¯åªèƒ½ä»ä¸€ç§ç¨€æœ‰æ¤ç‰©ä¸­æå–ï¼Œè€Œç®¡å®¶è€å¼ çš„æˆ¿é—´é‡Œç§ç€è¿™ç§æ¤ç‰©...' },
      },
      {
        contextA: 'é™ˆæœˆçš„èº«ä¸–ç§˜å¯†æ­å¼€åï¼ŒçœŸç›¸é€æ¸æµ®å‡ºæ°´é¢ï¼šå¥¹æ˜¯20å¹´å‰ç«ç¾ä¸­"æ­»å»"çš„é‚£ä¸ªäººçš„å¥³å„¿ï¼Œè¢«é™ˆè€çˆ·ç§˜å¯†æ”¶å…»ã€‚',
        contextB: 'æ‰€æœ‰è¯æ®éƒ½æŒ‡å‘ç®¡å®¶è€å¼ ï¼Œä½†ä»–åœ¨è¢«å®¡é—®æ—¶çªç„¶å¿ƒè„ç—…å‘ä½œï¼Œç•™ä¸‹ä¸€å¥è¯ï¼š"çœŸç›¸...åœ¨èŠ±å›­çš„è€æ§æ ‘ä¸‹..."',
        a: { text: 'å…¬å¼€æ‰€æœ‰çœŸç›¸ï¼Œè®©æ³•å¾‹æ¥è£å†³ï¼Œæ— è®ºç»“æœå¦‚ä½•ã€‚', tag: 'å…¬æ­£å®¡åˆ¤Â·æ³•æ²»', ending: 'çœŸç›¸å¤§ç™½ï¼šç®¡å®¶è€å¼ æ˜¯20å¹´å‰é™ˆè€çˆ·åŸé…çš„æƒ…äººï¼Œç«ç¾æ˜¯ä»–ä»¬ä¸€èµ·ç­–åˆ’çš„ã€‚é™ˆè€çˆ·å‘ç°çœŸç›¸åæ‰“ç®—æ­å‘ä»–ï¼Œäºæ˜¯è€å¼ ç—›ä¸‹æ€æ‰‹ã€‚é™ˆæœˆå¾—çŸ¥è‡ªå·±çš„èº«ä¸–åé€‰æ‹©åŸè°…ï¼Œå¹¶ç”¨ç»§æ‰¿çš„é—äº§æˆç«‹äº†åŸºé‡‘ä¼šï¼Œå¸®åŠ©é‚£äº›åƒå¥¹ä¸€æ ·å¤±å»å®¶åº­çš„å­©å­ã€‚' },
        b: { text: 'ç»™ç›¸å…³äººä¸€ä¸ªé€‰æ‹©çš„æœºä¼šï¼Œæœ‰äº›çœŸç›¸ä¹Ÿè®¸ä¸è¯¥è¢«å…¬å¼€ã€‚', tag: 'äººæƒ…è€ƒé‡Â·ç°è‰²', ending: 'ä½ é€‰æ‹©äº†ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆï¼šè€å¼ çš„ç½ªè¡Œè¢«ä½è°ƒå¤„ç†ï¼Œå¯¹å¤–å®£å¸ƒé™ˆè€çˆ·æ­»äºæ„å¤–ã€‚é™ˆæ˜æˆ’æ‰äº†èµŒåšï¼Œé™ˆæœˆç»§ç»­å¥¹çš„æ…ˆå–„äº‹ä¸šï¼Œæå…ˆç”Ÿå¸¦ç€çˆ¶äº²çš„é—ç‰©ç¦»å¼€ã€‚æœ‰äº›çœŸç›¸è¢«æ°¸è¿œåŸ‹è‘¬ï¼Œä½†æ´»ç€çš„äººéƒ½æœ‰äº†æ–°çš„å¼€å§‹ã€‚' },
      },
    ],
  },
  political: {
    name: 'å®«å»·æƒè°‹', icon: 'ğŸ‘‘',
    opening: 'å¤§é½ç‹æœï¼Œæ°¸å®‰ä¸‰åå¹´ã€‚è€çš‡å¸é©¾å´©çš„æ¶ˆæ¯éœ‡æƒŠæœé‡ã€‚é—è¯ä¸­å´å‡ºç°äº†ä»¤äººè´¹è§£çš„å†…å®¹ï¼šçš‡ä½ä¸ä¼ ç»™ä¸‰ä½æˆå¹´çš‡å­ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œè€Œæ˜¯ç”±"æœ€èƒ½ä»£è¡¨æ°‘å¿ƒè€…"ç»§æ‰¿ã€‚ä¸€æ—¶é—´ï¼Œæœå ‚æš—æµæ¶ŒåŠ¨ï¼Œå„æ–¹åŠ¿åŠ›è ¢è ¢æ¬²åŠ¨...',
    rounds: [
      {
        context: 'ä½œä¸ºå…ˆå¸ä¿¡ä»»çš„å†…é˜é¦–è¾…ï¼Œä½ å¿…é¡»åœ¨æ··ä¹±ä¸­ç»´æŒå±€é¢ã€‚ä¸‰ä½çš‡å­å„æœ‰æ”¯æŒè€…ï¼šå¤ªå­ä»åšä½†æ‡¦å¼±ï¼ŒäºŒçš‡å­ç²¾æ˜ä½†æ®‹å¿ï¼Œä¸‰çš‡å­å¹´è½»ä½†é”æ„æ”¹é©ã€‚',
        a: { text: 'æ”¯æŒå¤ªå­æŒ‰ä¼ ç»Ÿç»§ä½ï¼Œç»´æŠ¤å«¡é•¿å­ç»§æ‰¿åˆ¶åº¦çš„ç¨³å®šã€‚', tag: 'ä¼ ç»Ÿæ­£ç»ŸÂ·ä¿å®ˆ', consequence: 'å¤ªå­è·å¾—ä½ çš„æ”¯æŒåä¿¡å¿ƒå¤§å¢ï¼Œä½†äºŒçš‡å­çš„æ”¯æŒè€…å¼€å§‹æš—ä¸­è”ç»œå†›æ–¹...' },
        b: { text: 'æè®®ä¸‰ä½çš‡å­å„é™ˆæ–½æ”¿çº²é¢†ï¼Œç”±ç™¾å®˜å…¬è®®å†³å®šäººé€‰ã€‚', tag: 'å…¬è®®å†³é€‰Â·é©æ–°', consequence: 'è¿™ä¸ªæè®®å¼•å‘è½©ç„¶å¤§æ³¢ï¼Œæ”¹é©æ´¾æ¬¢å‘¼ï¼Œä¿å®ˆæ´¾å¼ºçƒˆåå¯¹...' },
      },
      {
        contextA: 'äºŒçš‡å­å‹¾ç»“è¾¹ç–†å°†å†›ï¼Œå¯†è°‹èµ·å…µ"æ¸…å›ä¾§"ï¼Œå±€åŠ¿éª¤ç„¶ç´§å¼ ã€‚',
        contextB: 'å…¬è®®ä¹‹å‰ï¼Œæœ‰äººæ­å‘ä¸‰çš‡å­ä¸å¤–é‚¦ä½¿èŠ‚æœ‰ç§˜å¯†å¾€æ¥ï¼Œæ¶‰å«Œå›å›½ã€‚',
        a: { text: 'ç´§æ€¥è°ƒåŠ¨å¾¡æ—å†›å¸ƒé˜²ï¼ŒåŒæ—¶æ´¾å¯†ä½¿åˆ†åŒ–äºŒçš‡å­çš„åŒç›Ÿã€‚', tag: 'åˆ†åŒ–ç“¦è§£Â·æƒè°‹', consequenceFromA: 'ä½ çš„è®¡ç­–æˆåŠŸæ‹–å»¶äº†äºŒçš‡å­çš„è¡ŒåŠ¨ï¼Œä½†ä»–å¼€å§‹æ€€ç–‘å†…éƒ¨æœ‰äººèƒŒå›...', consequenceFromB: 'ä½ åˆ©ç”¨è¿™ä¸ªæœºä¼šæ‰“å‹ä¸‰çš‡å­ï¼Œä½†è°ƒæŸ¥æ˜¾ç¤ºæ­å‘ä¿¡å¯èƒ½æ˜¯ä¼ªé€ çš„...' },
        b: { text: 'ä¸»åŠ¨æ‰¾äºŒçš‡å­è°ˆåˆ¤ï¼Œäº†è§£ä»–çš„è¯‰æ±‚ï¼Œå¯»æ‰¾å’Œå¹³è§£å†³çš„å¯èƒ½ã€‚', tag: 'å’Œè°ˆæ­¢å…µÂ·å†’é™©', consequenceFromA: 'äºŒçš‡å­æå‡ºæ¡ä»¶ï¼šä»–è¦å¤ªå­çš„ä½ç½®ï¼Œä½†æ‰¿è¯ºå–„å¾…å…„å¼Ÿ...', consequenceFromB: 'æ­å‘äº‹ä»¶ä½¿ä¸‰çš‡å­é™·å…¥å›°å¢ƒï¼Œä½ å†³å®šäº²è‡ªè°ƒæŸ¥çœŸç›¸...' },
      },
      {
        contextAA: 'äºŒçš‡å­çš„ç›Ÿå‹è¢«æˆåŠŸç­–åï¼Œä½†å¯¹æ–¹è¦æ±‚äº‹æˆä¹‹åå°ä¾¯æ‹œç›¸ã€‚',
        contextAB: 'è°ƒæŸ¥æ˜¾ç¤ºæ­å‘ä¿¡å‡ºè‡ªå¤ªåçš„äº²ä¿¡ï¼Œç›®çš„æ˜¯æ‰¶æŒå¥¹çš„å¤–ç”¥ä¸Šä½ã€‚',
        contextBA: 'äºŒçš‡å­çš„æ¡ä»¶ä»¤äººéš¾ä»¥æ¥å—ï¼Œä½†ä»–æ‰‹æ¡é‡å…µï¼Œæ‹’ç»å¯èƒ½å¯¼è‡´å†…æˆ˜ã€‚',
        contextBB: 'å¤ªåå¼€å§‹å…¬å¼€å¹²æ”¿ï¼Œä»¥å…ˆå¸é—å­€çš„èº«ä»½è¦æ±‚"å‚å¸˜å¬æ”¿"ã€‚',
        a: { text: 'ç­”åº”å°ä¾¯çš„æ¡ä»¶ï¼Œä¸¤å®³ç›¸æƒå–å…¶è½»ï¼Œå…ˆç¨³ä½å±€é¢ã€‚', tag: 'æƒå®œä¹‹è®¡Â·å¦¥å', consequence: 'å±€åŠ¿æš‚æ—¶ç¨³å®šï¼Œä½†ä½ çŸ¥é“è¿™åªæ˜¯å¼€å§‹ï¼Œæ›´å¤§çš„é£æš´è¿˜åœ¨åé¢...' },
        b: { text: 'æ­éœ²å¤ªåçš„é˜´è°‹ï¼Œè”åˆä¸‰ä½çš‡å­å…±åŒå¯¹æŠ—å¤–æˆšä¸“æƒã€‚', tag: 'å›¢ç»“æŠ—æ•ŒÂ·æ­£ä¹‰', consequence: 'ä½ çš„æ­éœ²è®©æœå ‚éœ‡åŠ¨ï¼Œä¸‰ä½çš‡å­ç ´å¤©è’åœ°ç«™åœ¨äº†ä¸€èµ·...' },
      },
      {
        contextA: 'å„æ–¹åŠ¿åŠ›æš‚æ—¶å¹³è¡¡ï¼Œä½†å‚¨ä½ä¹‹äº‰ä»æ‚¬è€Œæœªå†³ã€‚è¿™æ—¶è¾¹ç–†ä¼ æ¥æ€¥æŠ¥ï¼šåŒ—æ–¹æ¸¸ç‰§æ°‘æ—å¤§å†›å‹å¢ƒã€‚',
        contextB: 'å¤ªåè¢«è½¯ç¦ï¼Œå¤–æˆšåŠ¿åŠ›ç“¦è§£ã€‚ä½†åœ¨æ•´ç†å¤ªåå¯å®«æ—¶ï¼Œå‘ç°äº†å…ˆå¸çš„å¦ä¸€ä»½é—è¯...',
        a: { text: 'å»ºè®®ä¸‰ä½çš‡å­äº²å¾åŒ—ç–†ï¼Œè°èƒ½å‡»é€€æ•Œå†›è°å°±æ˜¯æ–°å¸ã€‚', tag: 'ä»¥æˆ˜å®šå¸Â·é­„åŠ›', consequence: 'ä¸‰ä½çš‡å­ç‡å†›åŒ—ä¸Šï¼Œè¿™åœºæˆ˜äº‰å°†å†³å®šå¤§é½çš„æœªæ¥...' },
        b: { text: 'æè®®å…ˆé€‰å‡ºæ–°å¸å†åº”å¯¹å¤–æ•Œï¼Œå›½ä¸å¯ä¸€æ—¥æ— å›ã€‚', tag: 'å…ˆå†…åå¤–Â·ç¨³é‡', consequence: 'åœ¨ä½ çš„ä¸»æŒä¸‹ï¼Œä¸€åœºå†³å®šæ€§çš„æœè®®å³å°†å¼€å§‹...' },
      },
      {
        contextA: 'åŒ—ç–†æˆ˜äº‹èƒ¶ç€ï¼Œå¤ªå­ä»å¾·æŠšæ°‘ï¼ŒäºŒçš‡å­å‹‡çŒ›ä½œæˆ˜ï¼Œä¸‰çš‡å­åå‹¤è°ƒåº¦æœ‰æ–¹ã€‚ä¸‰äººå„æœ‰åŠŸåŠ³ï¼Œéš¾åˆ†é«˜ä¸‹ã€‚',
        contextB: 'å…ˆå¸çš„çœŸæ­£é—è¯è¢«æ‰¾åˆ°ï¼Œä¸Šé¢å†™ç€ï¼šçš‡ä½ä¼ ç»™"èƒ½è®©ä¸‰ä¸ªå„¿å­å’Œç¦å…±å¤„è€…"ã€‚è¿™ä¸ªäºº...ç«Ÿç„¶æ˜¯ä½ ã€‚',
        a: { text: 'å»ºè®®ä¸‰ä½çš‡å­å…±åŒæ‰§æ”¿ï¼Œå»ºç«‹"ä¸‰ç‹è®®æ”¿"çš„æ–°åˆ¶åº¦ã€‚', tag: 'æƒåŠ›å…±äº«Â·å¼€åˆ›', ending: 'å¤§é½ç‹æœè¿›å…¥äº†å‰æ‰€æœªæœ‰çš„"ä¸‰ç‹æ—¶ä»£"ã€‚å¤ªå­ä¸»å†…æ”¿ï¼ŒäºŒçš‡å­æŒå†›äº‹ï¼Œä¸‰çš‡å­è´Ÿè´£æ”¹é©ã€‚è™½ç„¶äº‰åµä¸æ–­ï¼Œä½†åœ¨ä½ çš„è°ƒå’Œä¸‹ï¼Œè¿™ä¸ªåˆ¶åº¦ç«Ÿç„¶è¿è½¬äº†èµ·æ¥ã€‚äºŒåå¹´åï¼Œä½ åœ¨å›å¿†å½•ä¸­å†™é“ï¼š"æœ€å¥½çš„åˆ¶åº¦ä¸æ˜¯å®Œç¾çš„åˆ¶åº¦ï¼Œè€Œæ˜¯èƒ½è‡ªæˆ‘çº é”™çš„åˆ¶åº¦ã€‚"' },
        b: { text: 'æŒ‰å†›åŠŸå¤§å°æ’åºï¼Œç”±åŠŸåŠ³æœ€å¤§è€…ç»§æ‰¿çš‡ä½ã€‚', tag: 'åŠŸå‹‹å®šä½Â·å…¬å¹³', ending: 'äºŒçš‡å­å‡­å€Ÿæˆ˜åŠŸç™»åŸºï¼Œä½†ä»–æ²¡æœ‰è¾œè´Ÿä¿¡ä»»ã€‚åœ¨ä½æœŸé—´åŒ—å‡»æ¸¸ç‰§ã€å†…ä¿®æ”¿æ²»ï¼Œå¤§é½è¿æ¥äº†ä¸­å…´ã€‚ä¸‰çš‡å­è¢«å°ä¸ºæ”¹é©ç‰¹ä½¿ï¼Œå¤ªå­ä¸»ç®¡ç¤¼éƒ¨æ•™åŒ–ã€‚ä½ ä»¥ä¸ƒåé«˜é¾„è¾å®˜å½’éšæ—¶ï¼Œæ–°å¸äº²è‡ªé€è¡Œåé‡Œï¼Œè¯´ï¼š"æ²¡æœ‰é¦–è¾…å¤§äººï¼Œå°±æ²¡æœ‰ä»Šæ—¥çš„å¤§é½ã€‚"' },
      },
    ],
  },
};

const AVATARS = ['ğŸ®', 'âš”ï¸', 'ğŸ›¡ï¸', 'ğŸ”®', 'ğŸ“š', 'ğŸ­', 'ğŸª', 'ğŸ¯', 'ğŸ¹', 'âš¡', 'ğŸŒŸ', 'ğŸ”¥'];

const AI_PLAYERS = [
  { id: 'ai_1', name: 'æ™ºè€…Â·è‰¾ä¸', avatar: 'ğŸ§™â€â™€ï¸', isAI: true, style: 'analytical' },
  { id: 'ai_2', name: 'å‹‡è€…Â·å‡¯æ©', avatar: 'âš”ï¸', isAI: true, style: 'bold' },
  { id: 'ai_3', name: 'å­¦è€…Â·è¯ºäºš', avatar: 'ğŸ“š', isAI: true, style: 'cautious' },
];

// ========== çŠ¶æ€ ==========
let state = {
  provider: null, signer: null, contract: null,
  address: '', balance: '0',
};

let player = { name: '', avatar: 'ğŸ®', registered: false };
let room = { id: null, theme: '', players: [], host: '' };
let game = {
  round: 0, phase: 'waiting', timer: 0,
  story: [], storyPath: [], options: { a: null, b: null },
  votes: {}, myVote: null, scores: {}, messages: [],
};
let timerInterval = null;

// ========== UIå·¥å…· ==========
function toast(msg, type = 'info') {
  const container = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  container.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

function show(id) { document.getElementById(id)?.classList.remove('hidden'); }
function hide(id) { document.getElementById(id)?.classList.add('hidden'); }

function formatTime(s) {
  return `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;
}

// ========== å·¥å…·å‡½æ•° ==========
async function retryTransaction(txFn, maxRetries = 3) {
  let lastError;
  for (let i = 0; i < maxRetries; i++) {
    try {
      if (i > 0) {
        toast(`é‡è¯•ä¸­ (${i}/${maxRetries})...`, 'info');
        await new Promise(r => setTimeout(r, 2000)); // ç­‰å¾…2ç§’å†é‡è¯•
      }
      return await txFn();
    } catch (err) {
      lastError = err;
      console.warn(`å°è¯• ${i + 1} å¤±è´¥:`, err);
      // å¦‚æœæ˜¯ç”¨æˆ·å–æ¶ˆï¼Œä¸é‡è¯•
      if (err.code === 4001 || err.code === 'ACTION_REJECTED') {
        throw err;
      }
      // å¦‚æœä¸æ˜¯RPCé”™è¯¯ï¼Œä¸é‡è¯•
      if (!err.message?.includes('RPC') && err.code !== -32002 && err.code !== 'UNKNOWN_ERROR') {
        throw err;
      }
    }
  }
  throw lastError;
}

// ========== é’±åŒ…è¿æ¥ ==========
async function connectWallet() {
  if (typeof window.ethereum === 'undefined') {
    toast('è¯·å…ˆå®‰è£… MetaMask é’±åŒ…ï¼', 'error');
    window.open('https://metamask.io/download/', '_blank');
    return;
  }

  try {
    toast('æ­£åœ¨è¿æ¥MetaMask...', 'info');
    
    // è¯·æ±‚è´¦æˆ·
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    state.address = accounts[0];

    // åˆ‡æ¢åˆ°GenLayerç½‘ç»œ
    try {
      await window.ethereum.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: CONFIG.CHAIN_ID }],
      });
    } catch (switchError) {
      if (switchError.code === 4902 || switchError.code === -32603) {
        try {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: CONFIG.CHAIN_ID,
              chainName: CONFIG.CHAIN_NAME,
              nativeCurrency: { name: 'GEN', symbol: 'GEN', decimals: 18 },
              rpcUrls: [CONFIG.RPC_URL],
              blockExplorerUrls: [CONFIG.EXPLORER],
            }],
          });
        } catch (addError) {
          toast('è¯·æ‰‹åŠ¨æ·»åŠ GenLayerç½‘ç»œ', 'error');
          return;
        }
      } else if (switchError.code === 4001) {
        toast('ç”¨æˆ·å–æ¶ˆäº†ç½‘ç»œåˆ‡æ¢', 'error');
        return;
      }
    }

    // åˆå§‹åŒ–ethers
    state.provider = new ethers.BrowserProvider(window.ethereum);
    state.signer = await state.provider.getSigner();
    state.contract = new ethers.Contract(CONFIG.CONTRACT, CONTRACT_ABI, state.signer);

    // è·å–ä½™é¢
    try {
      const balance = await state.provider.getBalance(state.address);
      state.balance = ethers.formatEther(balance);
    } catch (balanceErr) {
      console.warn('è·å–ä½™é¢å¤±è´¥:', balanceErr);
      state.balance = '0';
    }

    // æ›´æ–°UI
    document.getElementById('networkBadge').classList.remove('hidden');
    document.getElementById('balanceDisplay').textContent = `${parseFloat(state.balance).toFixed(4)} GEN`;
    document.getElementById('balanceDisplay').classList.remove('hidden');
    document.getElementById('addressDisplay').textContent = `${state.address.slice(0,6)}...${state.address.slice(-4)}`;
    document.getElementById('addressDisplay').classList.remove('hidden');
    document.getElementById('disconnectBtn').classList.remove('hidden');

    hide('connectSection');
    toast('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');

    // æ£€æŸ¥ç©å®¶æ˜¯å¦å·²æ³¨å†Œ
    await checkPlayerStatus();

  } catch (err) {
    console.error('è¿æ¥å¤±è´¥:', err);
    if (err.code === 4001) {
      toast('ç”¨æˆ·å–æ¶ˆäº†è¿æ¥è¯·æ±‚', 'error');
    } else {
      toast('è¿æ¥å¤±è´¥: ' + (err.message || 'è¯·é‡è¯•'), 'error');
    }
  }
}

async function checkPlayerStatus() {
  console.log('=== checkPlayerStatus å¼€å§‹ ===');
  console.log('å½“å‰çŠ¶æ€:', { 
    contract: !!state.contract, 
    signer: !!state.signer, 
    address: state.address 
  });
  
  try {
    let result;
    for (let i = 0; i < 3; i++) {
      try {
        console.log(`å°è¯•è·å–ç©å®¶ä¿¡æ¯ (${i+1}/3)...`);
        result = await state.contract.get_player(state.address);
        console.log('è·å–ç»“æœ:', result);
        break;
      } catch (e) {
        console.warn(`ç¬¬${i+1}æ¬¡è·å–å¤±è´¥:`, e.message);
        if (i < 2) {
          await new Promise(r => setTimeout(r, 1500));
        } else {
          throw e;
        }
      }
    }
    
    if (result && result !== '{}' && result !== 'null' && result !== '') {
      try {
        const data = JSON.parse(result);
        console.log('è§£æçš„ç©å®¶æ•°æ®:', data);
        if (data.name) {
          player.name = data.name;
          player.avatar = data.avatar || 'ğŸ®';
          player.registered = true;
          showPlayerCard();
          showThemeSection();
          loadRooms();
          console.log('ç©å®¶å·²æ³¨å†Œï¼Œè·³è¿‡æ³¨å†Œè¡¨å•');
          return;
        }
      } catch (parseErr) {
        console.warn('è§£æç©å®¶æ•°æ®å¤±è´¥:', parseErr);
      }
    }
  } catch (e) {
    console.warn('æ£€æŸ¥ç©å®¶çŠ¶æ€å¤±è´¥:', e);
  }
  
  // æ˜¾ç¤ºæ³¨å†Œè¡¨å•
  console.log('æ˜¾ç¤ºæ³¨å†Œè¡¨å•');
  show('registerForm');
  initAvatarGrid();
}

function initAvatarGrid() {
  const grid = document.getElementById('avatarGrid');
  grid.innerHTML = AVATARS.map((a, i) => 
    `<div class="avatar-option ${i === 0 ? 'selected' : ''}" onclick="selectAvatar(this, '${a}')">${a}</div>`
  ).join('');
  player.avatar = AVATARS[0];
}

function selectAvatar(el, avatar) {
  document.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  player.avatar = avatar;
}

async function registerPlayer() {
  console.log('=== registerPlayer å¼€å§‹ ===');
  
  const nameInput = document.getElementById('registerName');
  if (!nameInput) {
    console.error('æ‰¾ä¸åˆ°åå­—è¾“å…¥æ¡†');
    toast('é¡µé¢é”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
    return;
  }
  
  const name = nameInput.value.trim();
  console.log('è¾“å…¥çš„åå­—:', name);
  
  if (!name) {
    toast('è¯·è¾“å…¥åå­—ï¼', 'error');
    return;
  }

  // æ£€æŸ¥åˆçº¦æ˜¯å¦åˆå§‹åŒ–ï¼Œå¦‚æœæ²¡æœ‰å°è¯•è‡ªåŠ¨é‡è¿
  console.log('æ£€æŸ¥çŠ¶æ€:', { 
    hasContract: !!state.contract, 
    hasSigner: !!state.signer,
    address: state.address 
  });
  
  if (!state.contract || !state.signer) {
    console.warn('åˆçº¦æœªåˆå§‹åŒ–ï¼Œå°è¯•è‡ªåŠ¨é‡è¿...');
    toast('æ­£åœ¨é‡æ–°è¿æ¥åˆçº¦...', 'info');
    
    try {
      if (!window.ethereum) {
        toast('MetaMaskæœªå®‰è£…ï¼Œè¯·å®‰è£…ååˆ·æ–°é¡µé¢', 'error');
        return;
      }
      
      state.provider = new ethers.BrowserProvider(window.ethereum);
      state.signer = await state.provider.getSigner();
      state.address = await state.signer.getAddress();
      state.contract = new ethers.Contract(CONFIG.CONTRACT, CONTRACT_ABI, state.signer);
      
      console.log('è‡ªåŠ¨é‡è¿æˆåŠŸ:', state.contract.target);
      toast('é‡æ–°è¿æ¥æˆåŠŸï¼', 'success');
    } catch (reconnectErr) {
      console.error('è‡ªåŠ¨é‡è¿å¤±è´¥:', reconnectErr);
      toast('åˆçº¦è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°è¿æ¥é’±åŒ…', 'error');
      return;
    }
  }

  // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
  const btn = document.querySelector('#registerForm button');
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'æ³¨å†Œä¸­...';
  }

  try {
    toast('æ­£åœ¨æ³¨å†Œï¼Œè¯·åœ¨MetaMaskä¸­ç¡®è®¤äº¤æ˜“...', 'info');
    console.log('å‡†å¤‡è°ƒç”¨åˆçº¦:', { 
      name, 
      avatar: player.avatar, 
      contractAddress: state.contract.target 
    });
    
    // è°ƒç”¨åˆçº¦ - å¸¦é‡è¯•æœºåˆ¶
    let tx;
    let lastError;
    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        console.log(`å°è¯•å‘é€äº¤æ˜“ (${attempt}/3)...`);
        tx = await state.contract.register_player(name, player.avatar, { value: 0 });
        console.log('äº¤æ˜“å·²å‘é€:', tx.hash);
        break;
      } catch (e) {
        lastError = e;
        console.error(`ç¬¬${attempt}æ¬¡å°è¯•å¤±è´¥:`, e);
        
        // ç”¨æˆ·å–æ¶ˆä¸é‡è¯•
        if (e.code === 4001 || e.code === 'ACTION_REJECTED') {
          throw e;
        }
        
        // RPCé”™è¯¯é‡è¯•
        if (attempt < 3 && (e.code === -32002 || e.code === 'UNKNOWN_ERROR' || 
            e.code === -32603 || e.message?.includes('RPC'))) {
          toast(`ç½‘ç»œé”™è¯¯ï¼Œé‡è¯•ä¸­ (${attempt}/3)...`, 'info');
          await new Promise(r => setTimeout(r, 2000));
        } else if (attempt >= 3) {
          throw e;
        } else {
          throw e;
        }
      }
    }
    
    if (!tx) {
      throw lastError || new Error('äº¤æ˜“å‘é€å¤±è´¥');
    }
    
    toast('äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
    const receipt = await tx.wait();
    console.log('äº¤æ˜“å·²ç¡®è®¤:', receipt);
    
    player.name = name;
    player.registered = true;
    
    hide('registerForm');
    showPlayerCard();
    showThemeSection();
    loadRooms();
    
    toast('æ³¨å†ŒæˆåŠŸï¼äº¤æ˜“å·²ä¸Šé“¾', 'success');
  } catch (err) {
    console.error('=== æ³¨å†Œå¤±è´¥è¯¦æƒ… ===');
    console.error('é”™è¯¯å¯¹è±¡:', err);
    console.error('é”™è¯¯ä»£ç :', err.code);
    console.error('é”™è¯¯æ¶ˆæ¯:', err.message);
    console.error('é”™è¯¯åŸå› :', err.reason);
    console.error('å®Œæ•´é”™è¯¯:', JSON.stringify(err, Object.getOwnPropertyNames(err)));
    
    if (err.code === 4001 || err.code === 'ACTION_REJECTED') {
      toast('ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“', 'error');
    } else if (err.code === 'CALL_EXCEPTION') {
      toast('åˆçº¦è°ƒç”¨å¤±è´¥: ' + (err.reason || err.revert || 'è¯·æ£€æŸ¥åˆçº¦'), 'error');
    } else if (err.code === 'INSUFFICIENT_FUNDS') {
      toast('ä½™é¢ä¸è¶³', 'error');
    } else if (err.code === -32002) {
      toast('è¯·åœ¨MetaMaskä¸­å¤„ç†å¾…å¤„ç†çš„è¯·æ±‚', 'error');
    } else if (err.message?.includes('RPC') || err.code === 'UNKNOWN_ERROR' || err.code === -32603) {
      toast('RPCç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    } else {
      toast('æ³¨å†Œå¤±è´¥: ' + (err.shortMessage || err.reason || err.message || 'è¯·é‡è¯•'), 'error');
    }
  } finally {
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'ç¡®è®¤æ³¨å†Œ';
    }
  }
}

function showPlayerCard() {
  document.getElementById('playerAvatar').textContent = player.avatar;
  document.getElementById('playerName').textContent = player.name;
  document.getElementById('playerBalance').textContent = `${parseFloat(state.balance).toFixed(4)} GEN`;
  show('playerCard');
}

function showThemeSection() {
  const grid = document.getElementById('themeGrid');
  grid.innerHTML = Object.entries(STORY_ARCS).map(([key, arc]) => `
    <div class="theme-card" onclick="createRoom('${key}')">
      <span class="icon">${arc.icon}</span>
      <span class="name">${arc.name}</span>
      <span class="desc">5è½®å²è¯—æ•…äº‹</span>
      <span style="font-size: 0.75rem; color: #fbbf24; margin-top: 0.5rem;">åˆ›å»ºæˆ¿é—´: 0 GEN</span>
    </div>
  `).join('');
  show('themeSection');
}

async function loadRooms() {
  const list = document.getElementById('roomList');
  list.innerHTML = '<div class="no-rooms"><span class="loading"></span> æ­£åœ¨ä»é“¾ä¸ŠåŠ è½½æˆ¿é—´...</div>';
  
  try {
    let result;
    for (let i = 0; i < 3; i++) {
      try {
        result = await state.contract.list_rooms();
        break;
      } catch (e) {
        if (i < 2) {
          await new Promise(r => setTimeout(r, 1500));
        } else {
          throw e;
        }
      }
    }
    
    let rooms = [];
    try {
      rooms = JSON.parse(result || '[]');
    } catch (parseErr) {
      console.warn('è§£ææˆ¿é—´åˆ—è¡¨å¤±è´¥:', parseErr);
    }
    
    if (!rooms || rooms.length === 0) {
      list.innerHTML = '<div class="no-rooms">æš‚æ— æˆ¿é—´ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div>';
      return;
    }
    
    list.innerHTML = rooms.map(r => `
      <div class="room-item" onclick="joinRoom(${r.id})">
        <span class="theme-icon">${STORY_ARCS[r.theme]?.icon || 'ğŸ®'}</span>
        <div class="info">
          <div class="theme-name">${STORY_ARCS[r.theme]?.name || r.theme}</div>
          <div class="host">æˆ¿ä¸»: ${r.host_name || r.host?.slice(0,8)}</div>
        </div>
        <span class="players">${r.player_count || 1}/${CONFIG.ROOM_SIZE.max}</span>
        <button class="btn btn-primary" style="padding: 0.4rem 1rem;">åŠ å…¥(0 GEN)</button>
      </div>
    `).join('');
  } catch (err) {
    console.error('åŠ è½½æˆ¿é—´å¤±è´¥:', err);
    list.innerHTML = '<div class="no-rooms">âš ï¸ ç½‘ç»œç¹å¿™ï¼Œ<a href="javascript:loadRooms()" style="color:#a78bfa;">ç‚¹å‡»é‡è¯•</a></div>';
  }
}

async function createRoom(theme) {
  if (!state.contract || !state.signer) {
    toast('é’±åŒ…æœªè¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
    return;
  }

  try {
    toast('æ­£åœ¨åˆ›å»ºæˆ¿é—´ï¼Œè¯·åœ¨MetaMaskä¸­ç¡®è®¤äº¤æ˜“...', 'info');
    console.log('åˆ›å»ºæˆ¿é—´:', { theme, contract: state.contract.target });
    
    const tx = await state.contract.create_room(theme, { value: 0 });
    console.log('äº¤æ˜“å·²å‘é€:', tx.hash);
    
    toast('äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
    const receipt = await tx.wait();
    console.log('äº¤æ˜“å·²ç¡®è®¤:', receipt);
    
    // å°è¯•ä»äº‹ä»¶è·å–æˆ¿é—´ID
    let roomId = Date.now();
    if (receipt.logs && receipt.logs.length > 0) {
      try {
        roomId = parseInt(receipt.logs[0].topics[1], 16);
      } catch (e) {}
    }
    
    room.id = roomId;
    room.theme = theme;
    room.host = state.address;
    room.players = [{ id: state.address, name: player.name, avatar: player.avatar, isHost: true }];
    
    toast('æˆ¿é—´åˆ›å»ºæˆåŠŸï¼äº¤æ˜“å·²ä¸Šé“¾', 'success');
    showRoomPage();
    
    // æ·»åŠ AIç©å®¶
    setTimeout(addAIPlayers, 1000);
  } catch (err) {
    console.error('åˆ›å»ºæˆ¿é—´å¤±è´¥è¯¦æƒ…:', err);
    console.error('é”™è¯¯ä»£ç :', err.code);
    if (err.code === 4001 || err.code === 'ACTION_REJECTED') {
      toast('ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“', 'error');
    } else if (err.code === 'CALL_EXCEPTION') {
      toast('åˆçº¦è°ƒç”¨å¤±è´¥: ' + (err.reason || 'è¯·æ£€æŸ¥åˆçº¦'), 'error');
    } else if (err.message?.includes('RPC') || err.code === 'UNKNOWN_ERROR') {
      toast('RPCç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    } else {
      toast('åˆ›å»ºå¤±è´¥: ' + (err.shortMessage || err.message || 'è¯·é‡è¯•'), 'error');
    }
  }
}

async function joinRoom(roomId) {
  if (!state.contract || !state.signer) {
    toast('é’±åŒ…æœªè¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
    return;
  }

  try {
    toast('æ­£åœ¨åŠ å…¥æˆ¿é—´ï¼Œè¯·åœ¨MetaMaskä¸­ç¡®è®¤äº¤æ˜“...', 'info');
    console.log('åŠ å…¥æˆ¿é—´:', { roomId, contract: state.contract.target });
    
    const tx = await state.contract.join_room(roomId, { value: 0 });
    console.log('äº¤æ˜“å·²å‘é€:', tx.hash);
    
    toast('äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
    await tx.wait();
    
    // è·å–æˆ¿é—´ä¿¡æ¯
    let roomData = { theme: 'fantasy', host: '', players: [] };
    try {
      const result = await state.contract.get_room(roomId);
      roomData = JSON.parse(result);
    } catch (e) {
      console.warn('è·å–æˆ¿é—´ä¿¡æ¯å¤±è´¥:', e);
    }
    
    room.id = roomId;
    room.theme = roomData.theme || 'fantasy';
    room.host = roomData.host || '';
    room.players = roomData.players || [];
    
    // ç¡®ä¿è‡ªå·±åœ¨ç©å®¶åˆ—è¡¨ä¸­
    if (!room.players.find(p => p.id === state.address)) {
      room.players.push({ id: state.address, name: player.name, avatar: player.avatar });
    }
    
    toast('åŠ å…¥æˆåŠŸï¼äº¤æ˜“å·²ä¸Šé“¾', 'success');
    showRoomPage();
  } catch (err) {
    console.error('åŠ å…¥æˆ¿é—´å¤±è´¥è¯¦æƒ…:', err);
    console.error('é”™è¯¯ä»£ç :', err.code);
    if (err.code === 4001 || err.code === 'ACTION_REJECTED') {
      toast('ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“', 'error');
    } else if (err.code === 'CALL_EXCEPTION') {
      toast('åˆçº¦è°ƒç”¨å¤±è´¥: ' + (err.reason || 'è¯·æ£€æŸ¥åˆçº¦'), 'error');
    } else if (err.message?.includes('RPC') || err.code === 'UNKNOWN_ERROR') {
      toast('RPCç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    } else {
      toast('åŠ å…¥å¤±è´¥: ' + (err.shortMessage || err.message || 'è¯·é‡è¯•'), 'error');
    }
  }
}

function addAIPlayers() {
  const shuffled = [...AI_PLAYERS].sort(() => Math.random() - 0.5);
  const count = Math.floor(Math.random() * 2) + 2; // 2-3ä¸ªAI
  
  shuffled.slice(0, count).forEach((ai, i) => {
    setTimeout(() => {
      if (room.players.length < CONFIG.ROOM_SIZE.max) {
        room.players.push(ai);
        updatePlayerGrid();
        addSystemMessage(`${ai.avatar} ${ai.name} åŠ å…¥äº†æˆ¿é—´`);
      }
    }, (i + 1) * 800);
  });
}

function showRoomPage() {
  hide('homePage');
  show('roomPage');
  
  const arc = STORY_ARCS[room.theme];
  document.getElementById('roomThemeIcon').textContent = arc?.icon || 'ğŸ®';
  document.getElementById('roomThemeName').textContent = arc?.name || room.theme;
  document.getElementById('roomId').textContent = `#${room.id}`;
  
  updatePlayerGrid();
  updateStartButton();
}

function updatePlayerGrid() {
  const grid = document.getElementById('playerGrid');
  const slots = [];
  
  for (let i = 0; i < CONFIG.ROOM_SIZE.max; i++) {
    const p = room.players[i];
    if (p) {
      slots.push(`
        <div class="player-slot filled">
          <span class="avatar">${p.avatar}</span>
          <span class="name">${p.name}</span>
          ${p.isHost || p.id === room.host ? '<span class="badge host-badge">æˆ¿ä¸»</span>' : ''}
          ${p.isAI ? '<span class="badge ai-badge">AI</span>' : ''}
        </div>
      `);
    } else {
      slots.push(`
        <div class="player-slot empty">
          <span class="avatar">?</span>
          <span class="name">ç­‰å¾…ä¸­...</span>
        </div>
      `);
    }
  }
  
  grid.innerHTML = slots.join('');
  document.getElementById('playerCount').textContent = room.players.length;
  updateStartButton();
}

function updateStartButton() {
  const isHost = room.host === state.address || room.players[0]?.id === state.address;
  const canStart = room.players.length >= CONFIG.ROOM_SIZE.min;
  
  if (isHost) {
    show('startGameBtn');
    document.getElementById('startGameBtn').disabled = !canStart;
    document.getElementById('startGameBtn').textContent = canStart ? 'ğŸ® å¼€å§‹æ¸¸æˆ' : `ç­‰å¾…æ›´å¤šç©å®¶ (${room.players.length}/${CONFIG.ROOM_SIZE.min})`;
    document.getElementById('waitingMsg').textContent = '';
  } else {
    hide('startGameBtn');
    document.getElementById('waitingMsg').textContent = 'ç­‰å¾…æˆ¿ä¸»å¼€å§‹æ¸¸æˆ...';
  }
}

function leaveRoom() {
  room = { id: null, theme: '', players: [], host: '' };
  hide('roomPage');
  show('homePage');
  loadRooms();
}

async function startGame() {
  if (room.players.length < CONFIG.ROOM_SIZE.min) {
    toast(`è‡³å°‘éœ€è¦ ${CONFIG.ROOM_SIZE.min} åç©å®¶ï¼`, 'error');
    return;
  }
  
  try {
    toast('æ­£åœ¨å¼€å§‹æ¸¸æˆ...', 'info');
    
    // è°ƒç”¨åˆçº¦å¼€å§‹æ¸¸æˆ
    const tx = await retryTransaction(async () => {
      return await state.contract.start_game(room.id);
    });
    await tx.wait();
    
    // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
    game.round = 0;
    game.phase = 'waiting';
    game.story = [];
    game.storyPath = [];
    game.votes = {};
    game.myVote = null;
    game.messages = [];
    game.scores = {};
    
    room.players.forEach(p => {
      game.scores[p.id] = { influence: 0, debates: 0, wins: 0 };
    });
    
    // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
    hide('roomPage');
    show('gameView');
    document.getElementById('mainContainer').classList.add('hidden');
    
    // æ˜¾ç¤ºå¼€åœºæ•…äº‹
    const arc = STORY_ARCS[room.theme];
    document.getElementById('gameThemeName').textContent = arc.name;
    game.story.push({ text: arc.opening, type: 'opening', round: 0 });
    updateStoryDisplay();
    
    addSystemMessage(`ğŸ“– ${arc.name}å¼€å§‹äº†ï¼`);
    
    // å¼€å§‹ç¬¬ä¸€è½®
    setTimeout(() => startRound(1), 2000);
    
  } catch (err) {
    console.error('å¼€å§‹æ¸¸æˆå¤±è´¥:', err);
    if (err.code === 4001 || err.code === 'ACTION_REJECTED') {
      toast('ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“', 'error');
    } else if (err.message?.includes('RPC') || err.code === 'UNKNOWN_ERROR') {
      toast('ç½‘ç»œç¹å¿™ï¼Œè¯·ç¨åé‡è¯•', 'error');
    } else {
      toast('å¼€å§‹å¤±è´¥: ' + (err.reason || err.message || 'è¯·é‡è¯•'), 'error');
    }
  }
}

function startRound(r) {
  if (r > CONFIG.TOTAL_ROUNDS) {
    endGame();
    return;
  }
  
  game.round = r;
  game.phase = 'debate';
  game.votes = {};
  game.myVote = null;
  
  // è·å–å½“å‰è½®æ¬¡æ•°æ®
  const roundData = getCurrentRoundData(r);
  if (!roundData) {
    endGame();
    return;
  }
  
  // æ·»åŠ èƒŒæ™¯åˆ°æ•…äº‹
  game.story.push({ text: roundData.context, type: 'context', round: r });
  game.options = { a: roundData.a, b: roundData.b };
  
  updateStoryDisplay();
  updateOptionsDisplay();
  updateGameHeader();
  
  addSystemMessage(`ğŸ“– ç¬¬ ${r}/${CONFIG.TOTAL_ROUNDS} è½® - è¾©è®ºé˜¶æ®µå¼€å§‹`);
  
  // å¼€å§‹è®¡æ—¶
  game.timer = CONFIG.DEBATE_DURATION;
  startTimer(() => startVoting());
  
  // AIè¾©è®º
  simulateAIDebate();
  
  show('chatInput');
  hide('votePrompt');
}

function getCurrentRoundData(roundNum) {
  const arc = STORY_ARCS[room.theme];
  const roundData = arc.rounds[roundNum - 1];
  
  if (!roundData) return null;
  
  let context = roundData.context;
  
  // æ ¹æ®ä¹‹å‰çš„é€‰æ‹©è·¯å¾„ç¡®å®šä¸Šä¸‹æ–‡
  if (roundNum > 1 && game.storyPath.length > 0) {
    const pathKey = game.storyPath.slice(-2).join('');
    const contextKey = `context${pathKey}`;
    if (roundData[contextKey]) {
      context = roundData[contextKey];
    } else {
      const lastChoice = game.storyPath[game.storyPath.length - 1];
      const singleContextKey = `context${lastChoice}`;
      if (roundData[singleContextKey]) {
        context = roundData[singleContextKey];
      }
    }
  }
  
  return { ...roundData, context };
}

function startVoting() {
  game.phase = 'vote';
  game.timer = CONFIG.VOTE_DURATION;
  
  updateGameHeader();
  addSystemMessage('ğŸ—³ï¸ æŠ•ç¥¨é˜¶æ®µå¼€å§‹ï¼è¯·é€‰æ‹©ä½ æ”¯æŒçš„é€‰é¡¹');
  
  hide('chatInput');
  if (!game.myVote) show('votePrompt');
  
  // æ˜¾ç¤ºæŠ•ç¥¨æ•°
  document.getElementById('votesA').classList.remove('hidden');
  document.getElementById('votesB').classList.remove('hidden');
  
  // AIæŠ•ç¥¨
  room.players.filter(p => p.isAI).forEach((ai, i) => {
    setTimeout(() => {
      const choice = Math.random() > 0.5 ? 'A' : 'B';
      game.votes[ai.id] = choice;
      updateVoteDisplay();
      updateChatPlayers();
    }, (i + 1) * 1500);
  });
  
  startTimer(() => calculateResult());
}

async function selectOption(choice) {
  if (game.phase !== 'vote' || game.myVote) return;
  
  game.myVote = choice;
  game.votes[state.address] = choice;
  
  document.getElementById('optionA').classList.toggle('selected', choice === 'A');
  document.getElementById('optionB').classList.toggle('selected', choice === 'B');
  
  hide('votePrompt');
  updateVoteDisplay();
  updateChatPlayers();
  addSystemMessage(`ä½ æŠ•ç¥¨ç»™äº†é€‰é¡¹ ${choice}`);
  
  // å‘é€åˆ°åˆçº¦ï¼ˆä¸Šé“¾ï¼‰
  try {
    const tx = await retryTransaction(async () => {
      return await state.contract.vote(room.id, choice);
    });
    await tx.wait();
    addSystemMessage(`æŠ•ç¥¨å·²ä¸Šé“¾ç¡®è®¤ï¼`);
  } catch (e) {
    console.warn('æŠ•ç¥¨ä¸Šé“¾å¤±è´¥:', e);
    addSystemMessage(`æŠ•ç¥¨ä¸Šé“¾å¤±è´¥ï¼Œä½†æœ¬åœ°å·²è®°å½•`);
  }
}

function calculateResult() {
  game.phase = 'result';
  clearInterval(timerInterval);
  
  const voteCount = { A: 0, B: 0 };
  Object.values(game.votes).forEach(v => { if (v) voteCount[v]++; });
  
  const total = voteCount.A + voteCount.B;
  const winner = total === 0 ? (Math.random() > 0.5 ? 'A' : 'B') : 
                 (voteCount.A >= voteCount.B ? 'A' : 'B');
  
  // æ›´æ–°åˆ†æ•°
  Object.entries(game.votes).forEach(([id, v]) => {
    if (v === winner && game.scores[id]) {
      game.scores[id].influence = (game.scores[id].influence || 0) + 30;
      game.scores[id].wins = (game.scores[id].wins || 0) + 1;
    }
  });
  
  // æ›´æ–°æ•…äº‹è·¯å¾„
  game.storyPath.push(winner);
  
  // è·å–ç»“æœæ–‡æœ¬
  const winOpt = winner === 'A' ? game.options.a : game.options.b;
  const consequence = getConsequence(game.round, winner);
  
  // æ·»åŠ åˆ°æ•…äº‹
  game.story.push({ text: `ã€ä¼—äººé€‰æ‹©ã€‘${winOpt?.text}`, type: 'choice', round: game.round, winner });
  game.story.push({ text: consequence, type: 'consequence', round: game.round });
  
  updateStoryDisplay();
  updateMyScore();
  
  addSystemMessage(`ğŸ“œ é€‰é¡¹ ${winner} è·èƒœï¼(${voteCount[winner]}ç¥¨ vs ${voteCount[winner === 'A' ? 'B' : 'A']}ç¥¨)`);
  
  // ä¸‹ä¸€è½®æˆ–ç»“æŸ
  if (game.round >= CONFIG.TOTAL_ROUNDS) {
    setTimeout(endGame, 3000);
  } else {
    setTimeout(() => startRound(game.round + 1), 4000);
  }
}

function getConsequence(roundNum, choice) {
  const arc = STORY_ARCS[room.theme];
  const roundData = arc.rounds[roundNum - 1];
  
  if (!roundData) return '';
  
  const option = choice === 'A' ? roundData.a : roundData.b;
  
  // æ£€æŸ¥æ˜¯å¦æœ‰åŸºäºè·¯å¾„çš„ç‰¹æ®Šç»“æœ
  if (game.storyPath.length > 0) {
    const lastChoice = game.storyPath[game.storyPath.length - 1];
    const consequenceKey = `consequenceFrom${lastChoice}`;
    if (option[consequenceKey]) {
      return option[consequenceKey];
    }
  }
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€è½®ï¼ˆæœ‰ç»“å±€ï¼‰
  if (roundNum === CONFIG.TOTAL_ROUNDS && option.ending) {
    return option.ending;
  }
  
  return option.consequence || '';
}

function endGame() {
  game.phase = 'ended';
  clearInterval(timerInterval);
  
  hide('optionsPanel');
  show('endPanel');
  
  // æ˜¾ç¤ºæ’å
  const rankings = Object.entries(game.scores)
    .map(([id, score]) => ({
      player: room.players.find(p => p.id === id),
      total: (score.influence || 0) + (score.debates || 0)
    }))
    .sort((a, b) => b.total - a.total);
  
  document.getElementById('rankings').innerHTML = rankings.map((rank, i) => `
    <div class="rank-item ${i === 0 ? 'first' : ''}">
      <span class="rank">#${i + 1}</span>
      <span class="avatar">${rank.player?.avatar}</span>
      <span class="name">${rank.player?.name}</span>
      <span class="score">${rank.total} pts</span>
    </div>
  `).join('');
  
  addSystemMessage('ğŸ† ç¼–å¹´å²å®Œæˆï¼');
}

function backToLobby() {
  hide('gameView');
  document.getElementById('mainContainer').classList.remove('hidden');
  show('homePage');
  hide('roomPage');
  
  room = { id: null, theme: '', players: [], host: '' };
  game = {
    round: 0, phase: 'waiting', timer: 0,
    story: [], storyPath: [], options: { a: null, b: null },
    votes: {}, myVote: null, scores: {}, messages: [],
  };
  
  loadRooms();
}

// ========== UIæ›´æ–°å‡½æ•° ==========
function updateStoryDisplay() {
  const content = document.getElementById('storyContent');
  content.innerHTML = game.story.map(s => {
    if (s.type === 'opening') {
      return `<div class="story-entry opening">${s.text}</div>`;
    } else if (s.type === 'context') {
      return `<div class="story-entry context"><span class="round-tag">ç¬¬${s.round}è½®</span>${s.text}</div>`;
    } else if (s.type === 'choice') {
      return `<div class="story-entry choice">${s.winner === 'A' ? 'ğŸ…°ï¸' : 'ğŸ…±ï¸'} ${s.text}</div>`;
    } else if (s.type === 'consequence') {
      return `<div class="story-entry consequence">${s.text}</div>`;
    }
    return '';
  }).join('');
  
  content.scrollTop = content.scrollHeight;
}

function updateOptionsDisplay() {
  if (!game.options.a || !game.options.b) return;
  
  document.getElementById('tagA').textContent = game.options.a.tag;
  document.getElementById('textA').textContent = game.options.a.text;
  document.getElementById('tagB').textContent = game.options.b.tag;
  document.getElementById('textB').textContent = game.options.b.text;
  
  document.getElementById('votesA').classList.add('hidden');
  document.getElementById('votesB').classList.add('hidden');
  document.getElementById('optionA').classList.remove('selected');
  document.getElementById('optionB').classList.remove('selected');
  
  show('optionsPanel');
  hide('endPanel');
}

function updateVoteDisplay() {
  const countA = Object.values(game.votes).filter(v => v === 'A').length;
  const countB = Object.values(game.votes).filter(v => v === 'B').length;
  document.getElementById('votesA').textContent = `${countA} ç¥¨`;
  document.getElementById('votesB').textContent = `${countB} ç¥¨`;
}

function updateGameHeader() {
  document.getElementById('currentRound').textContent = game.round;
  
  const phaseText = {
    debate: 'ğŸ’¬ è¾©è®ºä¸­',
    vote: 'ğŸ—³ï¸ æŠ•ç¥¨ä¸­',
    result: 'ğŸ“Š ç»“ç®—ä¸­',
    ended: 'ğŸ† å·²ç»“æŸ'
  };
  document.getElementById('phaseDisplay').textContent = phaseText[game.phase] || '';
  
  // è¿›åº¦ç‚¹
  const dots = document.getElementById('progressDots');
  dots.innerHTML = [1,2,3,4,5].map(n => 
    `<div class="progress-dot ${n < game.round ? 'done' : n === game.round ? 'current' : ''}"></div>`
  ).join('');
}

function updateMyScore() {
  const myScore = game.scores[state.address] || { influence: 0, debates: 0 };
  document.getElementById('myScoreDisplay').textContent = (myScore.influence || 0) + (myScore.debates || 0);
}

function updateChatPlayers() {
  document.getElementById('chatPlayers').innerHTML = room.players.map(p => `
    <div class="chat-player ${game.votes[p.id] ? 'voted' : ''}">
      <span>${p.avatar}</span>
      <span style="max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${p.name}</span>
      ${game.votes[p.id] ? `<span class="vote">${game.votes[p.id]}</span>` : ''}
    </div>
  `).join('');
}

function startTimer(onComplete) {
  clearInterval(timerInterval);
  const timerEl = document.getElementById('timerDisplay');
  
  timerInterval = setInterval(() => {
    game.timer--;
    timerEl.textContent = formatTime(game.timer);
    timerEl.classList.toggle('warning', game.timer <= 10);
    
    if (game.timer <= 0) {
      clearInterval(timerInterval);
      onComplete();
    }
  }, 1000);
  
  timerEl.textContent = formatTime(game.timer);
}

// ========== èŠå¤©ç³»ç»Ÿ ==========
function addSystemMessage(text) {
  game.messages.push({ id: Date.now(), type: 'system', text });
  updateChatMessages();
}

function addChatMessage(sender, text, choice = null) {
  game.messages.push({ id: Date.now(), type: 'chat', sender, text, choice });
  updateChatMessages();
}

function updateChatMessages() {
  const container = document.getElementById('chatMessages');
  container.innerHTML = game.messages.slice(-50).map(msg => {
    if (msg.type === 'system') {
      return `<div class="chat-msg system">${msg.text}</div>`;
    }
    return `
      <div class="chat-msg chat">
        <div class="sender">
          <span>${msg.sender?.avatar} ${msg.sender?.name}</span>
          ${msg.choice ? `<span class="choice-tag ${msg.choice.toLowerCase()}">${msg.choice}</span>` : ''}
        </div>
        <div>${msg.text}</div>
      </div>
    `;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

function sendMessage() {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if (!text || game.phase !== 'debate') return;
  
  const choice = text.includes('A') || text.includes('é€‰é¡¹A') ? 'A' : 
                 text.includes('B') || text.includes('é€‰é¡¹B') ? 'B' : null;
  
  addChatMessage({ name: player.name, avatar: player.avatar }, text, choice);
  input.value = '';
  
  // å¢åŠ è¾©è®ºåˆ†
  if (game.scores[state.address]) {
    game.scores[state.address].debates = (game.scores[state.address].debates || 0) + 10;
    updateMyScore();
  }
}

function quickMsg(type) {
  const input = document.getElementById('messageInput');
  if (type === 'A') input.value = 'æˆ‘æ”¯æŒé€‰é¡¹Aï¼Œå› ä¸º';
  else if (type === 'B') input.value = 'æˆ‘æ”¯æŒé€‰é¡¹Bï¼Œå› ä¸º';
  else input.value = 'æˆ‘è®¤ä¸ºæˆ‘ä»¬åº”è¯¥è€ƒè™‘';
  input.focus();
}

function simulateAIDebate() {
  const debates = {
    analytical: { A: ['ä»é€»è¾‘ä¸Šåˆ†æï¼Œé€‰é¡¹Açš„æˆåŠŸç‡æ›´é«˜', 'æ•°æ®è¡¨æ˜ï¼Œæœæ–­è¡ŒåŠ¨å¾€å¾€æ•ˆæœæ›´å¥½'], B: ['ä»”ç»†åˆ†æåï¼ŒBçš„é•¿æœŸæ”¶ç›Šæ›´å¤§', 'ç»¼åˆè€ƒé‡ï¼ŒBæ˜¯æ›´ç¨³å¦¥çš„æ–¹æ¡ˆ'] },
    bold: { A: ['å‹‡è€…ä¸æƒ§ï¼Aæ‰æ˜¯çœŸæ­£çš„è‹±é›„ä¹‹é€‰', 'æœæ–­å‡ºå‡»ï¼æ”¯æŒAï¼'], B: ['Bæ‰æ˜¯çœŸæ­£çš„å‹‡æ°”ï¼æ•¢äºä¸åŒï¼', 'æ™ºå‹‡åŒå…¨æ‰æ˜¯çœŸè‹±é›„ï¼Œé€‰Bï¼'] },
    cautious: { A: ['è™½ç„¶å†’é™©ï¼Œä½†Aæˆ–è®¸æ˜¯å¿…è¦çš„', 'ä¸¤å®³ç›¸æƒå–å…¶è½»ï¼Œæ”¯æŒA'], B: ['è°¨æ…èµ·è§ï¼ŒBæ›´å®‰å…¨', 'ç¨³æ‰ç¨³æ‰“ï¼ŒBæ˜¯ä¸Šç­–'] },
  };
  
  room.players.filter(p => p.isAI).forEach((ai, i) => {
    setTimeout(() => {
      const style = ai.style || 'analytical';
      const choice = Math.random() > 0.5 ? 'A' : 'B';
      const options = debates[style]?.[choice] || debates.analytical[choice];
      const text = options[Math.floor(Math.random() * options.length)];
      addChatMessage(ai, text, choice);
    }, (i + 1) * 3000 + Math.random() * 5000);
  });
}

function disconnect() {
  state = { provider: null, signer: null, contract: null, address: '', balance: '0' };
  player = { name: '', avatar: 'ğŸ®', registered: false };
  
  hide('networkBadge');
  hide('balanceDisplay');
  hide('addressDisplay');
  hide('disconnectBtn');
  hide('playerCard');
  hide('registerForm');
  hide('themeSection');
  show('connectSection');
  
  toast('å·²æ–­å¼€è¿æ¥', 'info');
}

// ç›‘å¬è´¦æˆ·å˜åŒ–
if (window.ethereum) {
  window.ethereum.on('accountsChanged', () => location.reload());
  window.ethereum.on('chainChanged', () => location.reload());
}

// è°ƒè¯•åŠŸèƒ½ - åœ¨æ§åˆ¶å°è¾“å…¥ debug() æŸ¥çœ‹å½“å‰çŠ¶æ€
window.debug = function() {
  console.log('========== è°ƒè¯•ä¿¡æ¯ ==========');
  console.log('State:', {
    hasProvider: !!state.provider,
    hasSigner: !!state.signer,
    hasContract: !!state.contract,
    contractAddress: state.contract?.target,
    userAddress: state.address,
    balance: state.balance
  });
  console.log('Player:', player);
  console.log('Room:', room);
  console.log('Game:', game);
  console.log('================================');
  return { state, player, room, game };
};

// å¿«é€Ÿé‡æ–°è¿æ¥åˆçº¦
window.reconnect = async function() {
  if (!window.ethereum) {
    console.error('MetaMaskæœªå®‰è£…');
    return;
  }
  try {
    state.provider = new ethers.BrowserProvider(window.ethereum);
    state.signer = await state.provider.getSigner();
    state.contract = new ethers.Contract(CONFIG.CONTRACT, CONTRACT_ABI, state.signer);
    console.log('é‡æ–°è¿æ¥æˆåŠŸï¼åˆçº¦åœ°å€:', state.contract.target);
    return true;
  } catch (e) {
    console.error('é‡æ–°è¿æ¥å¤±è´¥:', e);
    return false;
  }
};

console.log('å…±è¯†ç¼–å¹´å²å·²åŠ è½½ã€‚è°ƒè¯•å‘½ä»¤: debug() æŸ¥çœ‹çŠ¶æ€, reconnect() é‡æ–°è¿æ¥åˆçº¦');
</script>
</body>
</html>
