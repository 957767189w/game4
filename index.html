<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…±è¯†ç¼–å¹´å² | GenLayer</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#0a0a12,#12121f);color:#f0f0f5;min-height:100vh}
    .btn{padding:.7rem 1.4rem;border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:all .2s}
    .btn-primary{background:linear-gradient(135deg,#a78bfa,#f472b6);color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(167,139,250,0.4)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:1.5rem}
    .input{width:100%;padding:.8rem 1rem;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:1rem;outline:none}
    .input:focus{border-color:rgba(167,139,250,0.5)}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{animation:spin 1s linear infinite;display:inline-block}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// =============================================================================
// é…ç½® - ä½ çš„åˆçº¦åœ°å€
// =============================================================================
const CONFIG = {
  CONTRACT_ADDRESS: '0x4547e3E94C17AD9C0D826D63cDAB73F4b20040cF',
  RPC_URL: '/api/genlayer',
  POLL_INTERVAL: 3000
};

// æ•…äº‹æ•°æ®
const STORIES = {
  fantasy: { name: "é»‘é¾™è§‰é†’", icon: "ğŸ‰", rounds: [
    { ctx: "é»‘é¾™è‹é†’ï¼Œç‹å›½å±åœ¨æ—¦å¤•ã€‚", A: { text: "å‡ºå…µæ”»æ‰“é¾™ç©´", tag: "æ¿€è¿›" }, B: { text: "å¯»æ±‚ç²¾çµè”ç›Ÿ", tag: "å¤–äº¤" }},
    { ctx: "å±€åŠ¿å‘å±•", ctxA: "å†›é˜Ÿå‘ç°é¾™è›‹", ctxB: "ç²¾çµè¦æ±‚åœ£å‰‘", A: { text: "æ‘§æ¯é¾™è›‹", tag: "æ–©è‰é™¤æ ¹" }, B: { text: "ä¿æŠ¤é¾™è›‹", tag: "ç•™æœ‰ä½™åœ°" }},
    { ctx: "æˆ˜æ–—ç™½çƒ­åŒ–", ctxAA: "é»‘é¾™æš´æ€’", ctxAB: "å†…éƒ¨åˆ†è£‚", ctxBA: "ç‹¬è‡ªä½œæˆ˜", ctxBB: "ç²¾çµæ´å†›", A: { text: "ç¦å¿Œé­”æ³•", tag: "ç‰ºç‰²" }, B: { text: "æˆ˜ç•¥æ’¤é€€", tag: "ä¿å­˜å®åŠ›" }},
    { ctx: "è½¬æŠ˜ç‚¹", ctxA: "é»‘é¾™é‡ä¼¤", ctxB: "æ–°ç›Ÿå‹å‡ºç°", A: { text: "è¶èƒœè¿½å‡»", tag: "å†³æˆ˜" }, B: { text: "å’Œå¹³æ²Ÿé€š", tag: "å’Œè°ˆ" }},
    { ctx: "æœ€ç»ˆç« ", ctxA: "å†³æˆ˜æ—¶åˆ»", ctxB: "é»‘é¾™æ­ç¤ºçœŸç›¸", A: { text: "æ¶ˆç­é»‘é¾™", tag: "ç‰çŸ³ä¿±ç„š", end: "é»‘é¾™è¢«æ¶ˆç­ï¼Œç‹å›½åºŸå¢Ÿï¼Œå¼€å§‹é‡å»ºã€‚" }, B: { text: "ä¸é»‘é¾™ç»“ç›Ÿ", tag: "å…±å­˜", end: "äººé¾™ç›Ÿçº¦è¾¾æˆï¼Œæ–°æ—¶ä»£å¼€å¯ã€‚" }}
  ]},
  scifi: { name: "æœ«æ—¥æ–¹èˆŸ", icon: "ğŸš€", rounds: [
    { ctx: "å°è¡Œæ˜Ÿæ’åœ°çƒï¼Œåªèƒ½æ•‘ä¸€åŠäººã€‚", A: { text: "æŠ½ç­¾å†³å®š", tag: "å…¬å¹³" }, B: { text: "è¿½æŸ¥ä¿¡å·", tag: "å¸Œæœ›" }},
    { ctx: "å±æœºåŠ æ·±", ctxA: "è½é€‰è€…æš´åŠ¨", ctxB: "å¤–æ˜Ÿäººé‚€è¯·", A: { text: "æ­¦åŠ›é•‡å‹", tag: "ç§©åº" }, B: { text: "è°ˆåˆ¤ä¿®æ”¹", tag: "äººé“" }},
    { ctx: "å…³é”®æŠ‰æ‹©", ctxAA: "è¶…è½½å¤šæ•‘30%", ctxAB: "å…ˆé£é˜Ÿå¤±è”", ctxBA: "æç«¯åˆ†å­", ctxBB: "å†·å†»æŠ€æœ¯", A: { text: "æ¥å—é£é™©", tag: "èµŒåš" }, B: { text: "åŸè®¡åˆ’", tag: "ç¨³å¦¥" }},
    { ctx: "æ–°å‘ç°", ctxA: "å¯æ”¹å˜è½¨é“", ctxB: "å¤–æ˜Ÿäººæ¡ä»¶", A: { text: "æ”¹å˜è½¨é“", tag: "è‹±é›„" }, B: { text: "ç»§ç»­æ’¤ç¦»", tag: "è°¨æ…" }},
    { ctx: "æœ€åæ—¶åˆ»", ctxA: "èƒ½é‡ä¸å¤Ÿ", ctxB: "è¦æ±‚é”€æ¯æ ¸æ­¦", A: { text: "å…¨éƒ¨æŠ¼ä¸Š", tag: "èƒŒæ°´ä¸€æˆ˜", end: "å¥‡è¿¹ï¼å°è¡Œæ˜Ÿåç¦»ã€‚" }, B: { text: "æ¥å—æŸå¤±", tag: "åŠ¡å®", end: "ç¾éš¾ä½†äººç±»å­˜æ´»ã€‚" }}
  ]},
  mystery: { name: "é™ˆåºœç–‘æ¡ˆ", icon: "ğŸ”", rounds: [
    { ctx: "å¯Œè±ªé™ˆè€çˆ·è¢«æ¯’æ€å¯†å®¤ã€‚", A: { text: "æœæŸ¥ç°åœº", tag: "ç‰©è¯" }, B: { text: "å®¡é—®å«Œç–‘äºº", tag: "å¿ƒç†" }},
    { ctx: "çº¿ç´¢æµ®ç°", ctxA: "å‘ç°é—äº§ä¿¡ä»¶", ctxB: "ç®¡å®¶æ…Œå¼ ", A: { text: "è¿½æŸ¥é—äº§", tag: "é‡‘é’±" }, B: { text: "è°ƒæŸ¥æå…ˆç”Ÿ", tag: "å¤–äºº" }},
    { ctx: "æ·±å…¥", ctxAA: "å¤§å„¿å­èµŒå€º", ctxAB: "æµ·å¤–è´¦æˆ·", ctxBA: "æå…ˆç”Ÿç§ç”Ÿå­", ctxBB: "20å¹´å‰æ—§æ¡ˆ", A: { text: "éªŒè¯è¯è¯", tag: "è´¨ç–‘" }, B: { text: "è°ƒæŸ¥æ—§æ¡ˆ", tag: "è¿½æº¯" }},
    { ctx: "çœŸç›¸é€¼è¿‘", ctxA: "ä¼ªè¯æ‹†ç©¿", ctxB: "ç«ç¾æ˜¯çºµç«", A: { text: "å®¡é—®å…„å¦¹", tag: "å¯¹è´¨" }, B: { text: "è¿½æŸ¥æ¯’è¯", tag: "ç§‘å­¦" }},
    { ctx: "æœ€ç»ˆçœŸç›¸", ctxA: "é™ˆæœˆéäº²ç”Ÿ", ctxB: "ç®¡å®¶ç—…å‘", A: { text: "å…¬å¼€çœŸç›¸", tag: "æ­£ä¹‰", end: "çœŸç›¸å¤§ç™½ã€‚" }, B: { text: "ç§ä¸‹è§£å†³", tag: "ä»æ…ˆ", end: "çœŸç›¸æ©åŸ‹ã€‚" }}
  ]},
  political: { name: "å¤ºå«¡é£äº‘", icon: "ğŸ‘‘", rounds: [
    { ctx: "çš‡å¸é©¾å´©ï¼Œé—è¯ï¼šä¼ ç»™æœ€èƒ½ä»£è¡¨æ°‘å¿ƒè€…ã€‚", A: { text: "æ”¯æŒå¤ªå­", tag: "ä¿å®ˆ" }, B: { text: "å…¬å¼€é€‰æ‹”", tag: "é©æ–°" }},
    { ctx: "æƒåŠ›æ–—äº‰", ctxA: "äºŒçš‡å­è°‹å", ctxB: "ä¸‰çš‡å­è¢«è¯¬é™·", A: { text: "åˆ†åŒ–æ•Œäºº", tag: "æƒè°‹" }, B: { text: "è°ˆåˆ¤", tag: "å†’é™©" }},
    { ctx: "å±æœºå››ä¼", ctxAA: "å°†é¢†è¦å°èµ", ctxAB: "å¤ªåå¹•å", ctxBA: "æ¡ä»¶è‹›åˆ»", ctxBB: "å¤ªåå¹²æ”¿", A: { text: "ç­”åº”æ¡ä»¶", tag: "æƒå®œ" }, B: { text: "æ­éœ²é»‘æ‰‹", tag: "å›¢ç»“" }},
    { ctx: "å¤–æ•Œæ¥è¢­", ctxA: "æ¸¸ç‰§å¤§å†›", ctxB: "çš‡å­å’Œè§£", A: { text: "ä»¥æˆ˜å®šå¸", tag: "å†›åŠŸ" }, B: { text: "å…ˆé€‰å¸", tag: "ç¨³å®š" }},
    { ctx: "å°˜åŸƒè½å®š", ctxA: "å„æœ‰æˆ˜åŠŸ", ctxB: "é—è¯æŒ‡å‘ä½ ", A: { text: "ä¸‰ç‹å…±æ²»", tag: "åˆ›æ–°", end: "ä¸‰ç‹æ—¶ä»£ã€‚" }, B: { text: "åŠŸå‹‹å®šä½", tag: "å…¬å¹³", end: "äºŒçš‡å­ç™»åŸºã€‚" }}
  ]}
};

// GenLayer RPC
const GenLayer = {
  id: 0,
  async rpc(method, params = []) {
    this.id++;
    console.log(`[RPC] ${method}`, params);
    const res = await fetch(CONFIG.RPC_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jsonrpc: '2.0', method, params, id: this.id })
    });
    const data = await res.json();
    console.log(`[RPC] å“åº”:`, data);
    if (data.error) throw new Error(data.error.message || JSON.stringify(data.error));
    return data.result;
  },
  call(method, args = []) {
    return this.rpc('sim_call', [{ contract_address: CONFIG.CONTRACT_ADDRESS, method, args }]);
  }
};

// App
function App() {
  const [view, setView] = useState('home');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [player, setPlayer] = useState(null);
  const [address, setAddress] = useState('');
  const [rooms, setRooms] = useState([]);
  const [room, setRoom] = useState(null);
  const [gameState, setGameState] = useState(null);
  const [leaderboard, setLeaderboard] = useState([]);
  const pollRef = useRef(null);
  
  const genAddr = () => '0x' + [...Array(40)].map(() => Math.floor(Math.random()*16).toString(16)).join('');
  
  const startPoll = useCallback((roomId) => {
    if (pollRef.current) clearInterval(pollRef.current);
    pollRef.current = setInterval(async () => {
      try {
        const state = await GenLayer.call('get_game_state', [roomId]);
        if (state) {
          setGameState(state);
          setRoom(state.room);
          if (state.room?.status === 'playing' && view === 'room') setView('game');
          if (state.room?.status === 'finished') setView('result');
        }
      } catch (e) { console.error('è½®è¯¢é”™è¯¯:', e); }
    }, CONFIG.POLL_INTERVAL);
  }, [view]);
  
  const stopPoll = useCallback(() => { if (pollRef.current) { clearInterval(pollRef.current); pollRef.current = null; } }, []);
  useEffect(() => () => stopPoll(), [stopPoll]);
  
  const register = async (name) => {
    setLoading(true); setError('');
    try {
      const addr = genAddr();
      setAddress(addr);
      const r = await GenLayer.call('register_player', [name, 'ğŸ®']);
      if (r?.success) { setPlayer({ name, balance: r.balance || 100 }); setView('lobby'); loadRooms(); }
      else throw new Error(r?.error || 'æ³¨å†Œå¤±è´¥');
    } catch (e) { setError(e.message); }
    setLoading(false);
  };
  
  const loadRooms = async () => { try { setRooms(await GenLayer.call('list_rooms', []) || []); } catch (e) { console.error(e); } };
  const loadLB = async () => { try { setLeaderboard(await GenLayer.call('get_leaderboard', [20]) || []); } catch (e) { console.error(e); } };
  
  const createRoom = async (theme) => {
    setLoading(true); setError('');
    try {
      const r = await GenLayer.call('create_room', [theme]);
      if (r?.success) { setRoom(r.room); setPlayer(p => ({ ...p, balance: r.balance })); setView('room'); startPoll(r.room_id); }
      else throw new Error(r?.error || 'åˆ›å»ºå¤±è´¥');
    } catch (e) { setError(e.message); }
    setLoading(false);
  };
  
  const joinRoom = async (id) => {
    setLoading(true); setError('');
    try {
      const r = await GenLayer.call('join_room', [id]);
      if (r?.success) { setRoom(r.room); setPlayer(p => ({ ...p, balance: r.balance })); setView('room'); startPoll(id); }
      else throw new Error(r?.error || 'åŠ å…¥å¤±è´¥');
    } catch (e) { setError(e.message); }
    setLoading(false);
  };
  
  const startGame = async () => {
    setLoading(true);
    try { const r = await GenLayer.call('start_game', [room.id]); if (r?.success) { setRoom(r.room); setView('game'); } }
    catch (e) { setError(e.message); }
    setLoading(false);
  };
  
  const vote = async (choice) => {
    setLoading(true);
    try {
      const r = await GenLayer.call('submit_vote', [room.id, room.round, choice]);
      if (r?.all_voted) await GenLayer.call('finalize_round', [room.id]);
    } catch (e) { setError(e.message); }
    setLoading(false);
  };
  
  const getCtx = () => {
    if (!room || !gameState) return '';
    const rd = STORIES[room.theme]?.rounds[room.round - 1];
    if (!rd) return '';
    const path = gameState.path || [];
    if (room.round > 1 && path.length > 0) return rd[`ctx${path.slice(-2).join('')}`] || rd[`ctx${path[path.length-1]}`] || rd.ctx;
    return rd.ctx;
  };
  
  const getOpts = () => { const rd = STORIES[room?.theme]?.rounds[room?.round - 1]; return { A: rd?.A, B: rd?.B }; };

  // é¦–é¡µ
  if (view === 'home') return (
    <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '2rem' }}>
      <div style={{ maxWidth: '400px', width: '100%', textAlign: 'center' }}>
        <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>ğŸ“œ</div>
        <h1 style={{ fontSize: '2rem', background: 'linear-gradient(135deg,#a78bfa,#f472b6)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>å…±è¯†ç¼–å¹´å²</h1>
        <p style={{ color: '#888', margin: '0.5rem 0 2rem' }}>GenLayer é“¾ä¸Šå¤šäººåä½œæ¸¸æˆ</p>
        <div className="card">
          <h3 style={{ marginBottom: '1rem' }}>è¾“å…¥ä½ çš„åå­—</h3>
          <input className="input" placeholder="åå­—..." style={{ marginBottom: '1rem', textAlign: 'center' }} onKeyDown={e => e.key === 'Enter' && e.target.value.trim() && register(e.target.value.trim())} />
          {error && <p style={{ color: '#ef4444', marginBottom: '1rem', fontSize: '0.9rem' }}>{error}</p>}
          <button className="btn btn-primary" style={{ width: '100%' }} disabled={loading} onClick={e => { const i = e.target.parentElement.querySelector('input'); if (i.value.trim()) register(i.value.trim()); }}>
            {loading ? <span className="spin">â³</span> : 'è¿›å…¥æ¸¸æˆ â†’'}
          </button>
        </div>
        <p style={{ marginTop: '1.5rem', fontSize: '0.75rem', color: '#666' }}>åˆçº¦: {CONFIG.CONTRACT_ADDRESS.slice(0,10)}...</p>
      </div>
    </div>
  );
  
  // å¤§å…
  if (view === 'lobby') return (
    <div style={{ minHeight: '100vh', padding: '2rem' }}>
      <div style={{ maxWidth: '900px', margin: '0 auto' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
          <h1>ğŸ“œ å…±è¯†ç¼–å¹´å²</h1>
          <div>ğŸ® {player?.name} <span style={{ color: '#fbbf24' }}>ğŸ’° {player?.balance} GLT</span></div>
        </div>
        {error && <div style={{ background: 'rgba(239,68,68,0.1)', padding: '1rem', borderRadius: '8px', marginBottom: '1rem', color: '#ef4444' }}>{error}</div>}
        <h2 style={{ marginBottom: '1rem', color: '#a78bfa' }}>ğŸ® åˆ›å»ºæˆ¿é—´</h2>
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '1rem', marginBottom: '2rem' }}>
          {Object.entries(STORIES).map(([k, s]) => (
            <button key={k} className="card" style={{ textAlign: 'center', cursor: 'pointer' }} onClick={() => createRoom(k)} disabled={loading}>
              <div style={{ fontSize: '2rem' }}>{s.icon}</div>
              <div style={{ fontWeight: 600 }}>{s.name}</div>
              <div style={{ fontSize: '0.8rem', color: '#fbbf24' }}>ğŸ« 10 GLT</div>
            </button>
          ))}
        </div>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
          <h2 style={{ color: '#a78bfa' }}>ğŸšª åŠ å…¥æˆ¿é—´</h2>
          <button className="btn" style={{ background: 'rgba(255,255,255,0.1)' }} onClick={loadRooms}>ğŸ”„</button>
        </div>
        {rooms.length === 0 ? <div className="card" style={{ textAlign: 'center', color: '#666' }}>æš‚æ— æˆ¿é—´</div> : (
          <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
            {rooms.map(r => (
              <div key={r.id} className="card" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem' }}>
                <div>{STORIES[r.theme]?.icon} <b>{r.host}</b> <span style={{ color: '#888' }}>ğŸ‘¥ {r.player_count}/8</span></div>
                <button className="btn btn-primary" onClick={() => joinRoom(r.id)}>åŠ å…¥</button>
              </div>
            ))}
          </div>
        )}
        <h2 style={{ color: '#fbbf24', marginTop: '2rem', marginBottom: '1rem' }}>ğŸ† æ’è¡Œæ¦œ</h2>
        <button className="btn" style={{ background: 'rgba(255,255,255,0.1)', marginBottom: '1rem' }} onClick={loadLB}>åŠ è½½</button>
        {leaderboard.length > 0 && <div className="card">{leaderboard.slice(0,10).map((e, i) => (
          <div key={i} style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem 0' }}>
            <span style={{ color: i < 3 ? '#fbbf24' : '#888' }}>#{i+1} {e.name}</span>
            <span style={{ color: '#a78bfa' }}>{e.score} pts</span>
          </div>
        ))}</div>}
      </div>
    </div>
  );
  
  // æˆ¿é—´
  if (view === 'room' && room) {
    const s = STORIES[room.theme];
    const isHost = room.host === address;
    return (
      <div style={{ minHeight: '100vh', padding: '2rem' }}>
        <div style={{ maxWidth: '600px', margin: '0 auto' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
            <button className="btn" style={{ background: 'rgba(255,255,255,0.1)' }} onClick={() => { stopPoll(); setView('lobby'); }}>â† è¿”å›</button>
            <div>{s?.icon} <b>{s?.name}</b></div>
            <span style={{ color: '#666', fontSize: '0.8rem' }}>{room.id}</span>
          </div>
          <h3 style={{ color: '#888', marginBottom: '1rem' }}>ç©å®¶ ({room.players?.length || 0}/8)</h3>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '1rem', marginBottom: '2rem' }}>
            {(room.players || []).map(addr => (
              <div key={addr} className="card" style={{ textAlign: 'center', padding: '1rem' }}>
                <div style={{ fontSize: '2rem' }}>ğŸ®</div>
                <div style={{ fontSize: '0.85rem' }}>{room.player_names?.[addr] || addr.slice(-6)}</div>
                {addr === room.host && <div style={{ fontSize: '0.7rem', color: '#fbbf24' }}>æˆ¿ä¸»</div>}
              </div>
            ))}
          </div>
          {isHost ? (
            <button className="btn btn-primary" style={{ width: '100%', padding: '1rem' }} disabled={loading || (room.players?.length || 0) < 2} onClick={startGame}>
              {(room.players?.length || 0) < 2 ? 'ç­‰å¾…ç©å®¶...' : 'ğŸ® å¼€å§‹æ¸¸æˆ'}
            </button>
          ) : <p style={{ textAlign: 'center', color: '#888' }}>ç­‰å¾…æˆ¿ä¸»å¼€å§‹...</p>}
        </div>
      </div>
    );
  }
  
  // æ¸¸æˆ
  if (view === 'game' && room) {
    const s = STORIES[room.theme];
    const ctx = getCtx();
    const opts = getOpts();
    const myVote = gameState?.current_votes?.[address];
    const voteCount = Object.values(gameState?.current_votes || {}).length;
    const total = room.players?.length || 0;
    return (
      <div style={{ minHeight: '100vh', padding: '2rem' }}>
        <div style={{ maxWidth: '800px', margin: '0 auto' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem', padding: '1rem', background: 'rgba(0,0,0,0.3)', borderRadius: '12px' }}>
            <div>{s?.icon} <b>{s?.name}</b></div>
            <div>ç¬¬ <span style={{ color: '#a78bfa', fontWeight: 700 }}>{room.round}</span>/5 è½®</div>
            <div>æŠ•ç¥¨: <span style={{ color: '#4ade80' }}>{voteCount}</span>/{total}</div>
          </div>
          <div className="card" style={{ marginBottom: '1.5rem' }}>
            <h3 style={{ color: '#a78bfa', marginBottom: '1rem' }}>ğŸ“œ å‰§æƒ…</h3>
            {(gameState?.path || []).map((c, i) => <p key={i} style={{ color: '#4ade80', marginBottom: '0.3rem' }}>ç¬¬{i+1}è½®: {c}</p>)}
            <p style={{ color: '#fbbf24', marginTop: '1rem', fontSize: '1.1rem', lineHeight: 1.6 }}>{ctx}</p>
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
            {['A', 'B'].map(k => {
              const opt = opts[k]; if (!opt) return null;
              const color = k === 'A' ? '#ef4444' : '#3b82f6';
              const voted = myVote === k;
              return (
                <button key={k} className="card" style={{ textAlign: 'left', cursor: myVote ? 'default' : 'pointer', border: `2px solid ${voted ? color : 'rgba(255,255,255,0.08)'}`, background: voted ? `${color}20` : 'transparent' }} onClick={() => !myVote && !loading && vote(k)} disabled={loading || !!myVote}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.8rem' }}>
                    <span style={{ fontWeight: 700, fontSize: '1.2rem', color }}>{k}</span>
                    <span style={{ fontSize: '0.8rem', padding: '2px 8px', background: 'rgba(255,255,255,0.1)', borderRadius: '12px' }}>{opt.tag}</span>
                  </div>
                  <p style={{ lineHeight: 1.6 }}>{opt.text}</p>
                  {voted && <p style={{ color, marginTop: '0.8rem', fontWeight: 600 }}>âœ“ å·²æŠ•ç¥¨</p>}
                </button>
              );
            })}
          </div>
          {myVote && <p style={{ textAlign: 'center', marginTop: '1.5rem', color: '#888' }}>ç­‰å¾…å…¶ä»–ç©å®¶... ({voteCount}/{total})</p>}
        </div>
      </div>
    );
  }
  
  // ç»“æœ
  if (view === 'result' && room) return (
    <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '2rem' }}>
      <div className="card" style={{ maxWidth: '500px', textAlign: 'center' }}>
        <h1 style={{ color: '#fbbf24', marginBottom: '1.5rem' }}>ğŸ† æ¸¸æˆç»“æŸï¼</h1>
        <div style={{ marginBottom: '2rem' }}>
          {Object.entries(gameState?.scores || {}).sort((a,b) => b[1] - a[1]).map(([addr, score], i) => (
            <div key={addr} style={{ display: 'flex', justifyContent: 'space-between', padding: '0.5rem', background: i === 0 ? 'rgba(251,191,36,0.1)' : 'transparent', borderRadius: '8px' }}>
              <span>#{i+1} {room.player_names?.[addr] || addr.slice(-6)}</span>
              <span style={{ color: '#a78bfa' }}>{score} pts</span>
            </div>
          ))}
        </div>
        <button className="btn btn-primary" onClick={() => { stopPoll(); setView('lobby'); loadRooms(); }}>è¿”å›å¤§å…</button>
      </div>
    </div>
  );
  
  return <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><span className="spin" style={{ fontSize: '3rem' }}>â³</span></div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
