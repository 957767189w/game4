<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…±è¯†ç¼–å¹´å² - Consensus Chronicle</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh;
      color: #e8e8e8;
    }
    
    /* ========== é€šç”¨ç»„ä»¶ ========== */
    .container { max-width: 1000px; margin: 0 auto; padding: 2rem; }
    .hidden { display: none !important; }
    
    /* é’±åŒ…è¿æ¥æ  */
    .wallet-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 2rem;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      z-index: 100;
    }
    .wallet-bar .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
      color: #a78bfa;
    }
    .wallet-bar .wallet-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .wallet-bar .balance {
      color: #4ade80;
      font-weight: 600;
    }
    .wallet-bar .address {
      padding: 0.4rem 0.8rem;
      background: rgba(167,139,250,0.2);
      border-radius: 20px;
      font-family: monospace;
      font-size: 0.85rem;
    }
    .wallet-bar .connect-btn {
      padding: 0.5rem 1.2rem;
      background: linear-gradient(135deg, #a78bfa, #f472b6);
      border: none;
      border-radius: 20px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    .wallet-bar .disconnect-btn {
      padding: 0.5rem 1rem;
      background: rgba(239,68,68,0.2);
      border: 1px solid rgba(239,68,68,0.4);
      border-radius: 20px;
      color: #ef4444;
      font-size: 0.85rem;
      cursor: pointer;
    }
    
    /* åˆçº¦ä¿¡æ¯ */
    .contract-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(74,222,128,0.1);
      border: 1px solid rgba(74,222,128,0.3);
      border-radius: 8px;
      font-size: 0.85rem;
      margin-bottom: 1.5rem;
    }
    .contract-badge .dot {
      width: 8px;
      height: 8px;
      background: #4ade80;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Hero */
    .hero { text-align: center; margin: 4rem 0 2rem; }
    .hero-icon { font-size: 5rem; margin-bottom: 1rem; }
    .hero h1 {
      font-size: 3rem;
      font-weight: 800;
      background: linear-gradient(135deg, #a78bfa, #f472b6, #fb923c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }
    .hero .subtitle { color: #8b8b9e; letter-spacing: 0.3em; text-transform: uppercase; margin-bottom: 1rem; }
    .hero .desc { color: #a5a5b8; font-style: italic; }
    
    /* ç©å®¶ä¿¡æ¯å¡ */
    .player-card {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
      padding: 1.5rem 2rem;
      background: rgba(167,139,250,0.1);
      border: 1px solid rgba(167,139,250,0.3);
      border-radius: 16px;
      margin-bottom: 2rem;
    }
    .player-card .avatar { font-size: 3rem; }
    .player-card .info { text-align: left; }
    .player-card .name { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem; }
    .player-card .stats { display: flex; gap: 1.5rem; }
    .player-card .stat { display: flex; align-items: center; gap: 0.3rem; }
    .player-card .stat.balance { color: #4ade80; }
    .player-card .stat.exp { color: #fbbf24; }
    
    /* æ³¨å†Œè¡¨å• */
    .register-form {
      max-width: 400px;
      margin: 0 auto 2rem;
      padding: 2rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
    }
    .register-form h3 { margin-bottom: 1rem; color: #c4b5fd; }
    .register-form input {
      width: 100%;
      padding: 1rem;
      margin-bottom: 1rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
    }
    .register-form .avatars {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .register-form .avatar-btn {
      width: 50px;
      height: 50px;
      font-size: 1.8rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .register-form .avatar-btn:hover { background: rgba(255,255,255,0.1); }
    .register-form .avatar-btn.selected { border-color: #a78bfa; background: rgba(167,139,250,0.2); }
    .register-form .submit-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #a78bfa, #f472b6);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
    }
    .register-form .submit-btn:disabled {
      background: rgba(255,255,255,0.1);
      color: #6b6b7e;
      cursor: not-allowed;
    }
    .register-form .cost-info {
      margin-top: 1rem;
      padding: 0.8rem;
      background: rgba(251,191,36,0.1);
      border-radius: 8px;
      font-size: 0.9rem;
      color: #fbbf24;
      text-align: center;
    }
    
    /* ä¸»é¢˜é€‰æ‹© */
    .section-title { font-size: 1.5rem; color: #c4b5fd; margin-bottom: 1.5rem; text-align: center; }
    .themes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }
    .theme-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .theme-card:hover {
      transform: translateY(-5px);
      border-color: rgba(167,139,250,0.5);
    }
    .theme-card .icon { font-size: 3rem; margin-bottom: 1rem; }
    .theme-card .name { font-size: 1.2rem; font-weight: 600; color: #fff; }
    .theme-card .info { font-size: 0.85rem; color: #6b6b7e; margin-top: 0.5rem; }
    .theme-card .cost {
      margin-top: 0.8rem;
      padding: 0.3rem 0.8rem;
      background: rgba(251,191,36,0.2);
      border-radius: 20px;
      font-size: 0.8rem;
      color: #fbbf24;
    }
    
    /* æˆ¿é—´åˆ—è¡¨ */
    .rooms-section { margin-bottom: 3rem; }
    .rooms-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .room-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      transition: all 0.2s;
    }
    .room-item:hover { border-color: rgba(167,139,250,0.4); }
    .room-item .info { display: flex; align-items: center; gap: 1rem; }
    .room-item .theme-icon { font-size: 2rem; }
    .room-item .details h4 { font-size: 1.1rem; margin-bottom: 0.2rem; }
    .room-item .details .meta { font-size: 0.85rem; color: #8b8b9e; }
    .room-item .join-btn {
      padding: 0.6rem 1.5rem;
      background: linear-gradient(135deg, #a78bfa, #f472b6);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    .room-item .join-btn:disabled {
      background: rgba(255,255,255,0.1);
      color: #6b6b7e;
      cursor: not-allowed;
    }
    .no-rooms {
      text-align: center;
      padding: 3rem;
      color: #6b6b7e;
    }
    
    /* ========== æˆ¿é—´è§†å›¾ ========== */
    .room-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .room-header .back-btn {
      padding: 0.5rem 1rem;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: #a5a5b8;
      cursor: pointer;
    }
    .room-header .theme-info { display: flex; align-items: center; gap: 0.5rem; font-size: 1.3rem; }
    .room-header .theme-name { font-weight: 600; }
    .room-header .room-id { font-family: monospace; font-size: 0.9rem; color: #6b6b7e; }
    
    .players-section h3 { font-size: 1.1rem; color: #8b8b9e; margin-bottom: 1rem; }
    .players-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .player-slot {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.5rem 1rem;
      border-radius: 12px;
      position: relative;
    }
    .player-slot.filled {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .player-slot.filled.you {
      background: rgba(167,139,250,0.1);
      border-color: rgba(167,139,250,0.5);
    }
    .player-slot.empty {
      border: 1px dashed rgba(255,255,255,0.1);
      opacity: 0.4;
    }
    .player-slot .slot-avatar { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .player-slot .slot-name { font-size: 0.95rem; text-align: center; }
    .player-slot .badge {
      position: absolute;
      top: 0.5rem;
      font-size: 0.6rem;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
    }
    .player-slot .badge.host { right: 0.5rem; background: #fbbf24; color: #000; }
    
    .start-btn {
      width: 100%;
      padding: 1rem;
      font-size: 1.2rem;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }
    .start-btn.ready { background: linear-gradient(135deg, #a78bfa, #f472b6); color: #fff; }
    .start-btn.waiting { background: rgba(255,255,255,0.1); color: #6b6b7e; cursor: not-allowed; }
    
    .rules-box {
      margin-top: 2rem;
      padding: 1.5rem;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
    }
    .rules-box h4 { margin-bottom: 1rem; color: #c4b5fd; }
    .rules-box .rounds-preview {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .rules-box .round-item {
      text-align: center;
      padding: 0.5rem;
      background: rgba(167,139,250,0.1);
      border-radius: 8px;
    }
    .rules-box .round-item .num { font-size: 1.2rem; font-weight: 700; color: #a78bfa; }
    .rules-box .round-item .flow { font-size: 0.7rem; color: #8b8b9e; }
    .rules-box ul { list-style: none; color: #a5a5b8; font-size: 0.9rem; }
    .rules-box ul li { padding: 0.3rem 0; }

    /* ========== æ¸¸æˆè§†å›¾ ========== */
    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-top: 50px;
    }
    .round-info .label { font-size: 0.9rem; color: #8b8b9e; }
    .round-info .phase { font-size: 1.1rem; font-weight: 600; }
    .progress-dots { display: flex; gap: 0.5rem; }
    .progress-dots .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
    }
    .progress-dots .dot.completed { background: #4ade80; }
    .progress-dots .dot.current { background: #a78bfa; }
    .timer {
      font-size: 2.5rem;
      font-weight: 700;
      font-family: monospace;
      color: #a78bfa;
    }
    .timer.warning { color: #f87171; }
    .score-display .label { font-size: 0.85rem; color: #8b8b9e; }
    .score-display .value { font-size: 1.5rem; font-weight: 700; color: #fbbf24; }

    .game-content {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      height: calc(100vh - 130px);
      overflow: hidden;
    }
    .story-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-width: 0;
    }
    .story-scroll {
      flex: 1;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 1rem;
      overflow-y: auto;
    }
    .story-scroll h3 { color: #c4b5fd; margin-bottom: 1rem; font-size: 1rem; }
    .story-entry { padding: 0.6rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); line-height: 1.7; }
    .story-entry:last-child { border-bottom: none; }
    .story-entry.opening { color: #c4b5fd; font-style: italic; }
    .story-entry.context { color: #fbbf24; }
    .story-entry.context .badge {
      background: rgba(251,191,36,0.2);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      margin-right: 0.5rem;
    }
    .story-entry.choice { color: #4ade80; }
    .story-entry.consequence {
      color: #a5a5b8;
      padding-left: 1.5rem;
      border-left: 2px solid rgba(167,139,250,0.3);
    }

    .options-panel {
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      padding: 1rem;
    }
    .options-panel h4 { text-align: center; margin-bottom: 1rem; color: #fff; }
    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .option-card {
      padding: 1rem;
      border-radius: 10px;
      border: 2px solid;
      cursor: pointer;
      transition: all 0.3s;
    }
    .option-card.option-a { border-color: rgba(239,68,68,0.4); background: rgba(239,68,68,0.1); }
    .option-card.option-b { border-color: rgba(59,130,246,0.4); background: rgba(59,130,246,0.1); }
    .option-card.selected { transform: scale(1.02); }
    .option-card.selected.option-a { border-color: #ef4444; }
    .option-card.selected.option-b { border-color: #3b82f6; }
    .option-card .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
    .option-card .label { font-weight: 700; font-size: 1.1rem; }
    .option-card.option-a .label { color: #ef4444; }
    .option-card.option-b .label { color: #3b82f6; }
    .option-card .tag {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      color: #a5a5b8;
    }
    .option-card .text { line-height: 1.5; font-size: 0.9rem; color: #e8e8e8; }
    .option-card .votes { margin-top: 0.8rem; text-align: center; font-size: 1.2rem; font-weight: 600; color: #fbbf24; }

    .chat-panel {
      width: 320px;
      display: flex;
      flex-direction: column;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      overflow: hidden;
    }
    .players-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      padding: 0.8rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .player-tag {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.3rem 0.6rem;
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      font-size: 0.8rem;
      border: 1px solid transparent;
    }
    .player-tag.voted {
      background: rgba(74,222,128,0.2);
      border-color: rgba(74,222,128,0.4);
    }
    .player-tag .vote { color: #4ade80; font-weight: 700; }
    .messages-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.8rem;
    }
    .message { margin-bottom: 0.6rem; font-size: 0.85rem; }
    .message.system { color: #a78bfa; font-style: italic; padding: 0.3rem 0; }
    .message.chat {
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 0.5rem 0.8rem;
    }
    .message.chat .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.3rem;
    }
    .message.chat .sender { color: #fbbf24; font-weight: 600; }
    .message.chat .stance {
      font-size: 0.7rem;
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
    }
    .message.chat .stance.a { background: rgba(239,68,68,0.3); }
    .message.chat .stance.b { background: rgba(59,130,246,0.3); }
    .message.chat .content { color: #e8e8e8; }

    .chat-input {
      padding: 0.8rem;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .chat-input .input-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
    .chat-input input {
      flex: 1;
      padding: 0.6rem 0.8rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 0.85rem;
      outline: none;
    }
    .chat-input button {
      padding: 0.6rem 1rem;
      background: linear-gradient(135deg, #a78bfa, #f472b6);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    .quick-btns { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    .quick-btn {
      padding: 0.3rem 0.6rem;
      border-radius: 15px;
      font-size: 0.75rem;
      cursor: pointer;
      border: 1px solid;
    }
    .quick-btn.a { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); color: #ef4444; }
    .quick-btn.b { background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); color: #3b82f6; }
    .quick-btn.neutral { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); color: #a5a5b8; }

    .vote-prompt {
      padding: 1rem;
      text-align: center;
      background: rgba(167,139,250,0.1);
    }
    .vote-prompt p { color: #fbbf24; font-weight: 600; }

    .end-screen {
      background: linear-gradient(145deg, rgba(251,191,36,0.1), rgba(167,139,250,0.1));
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
    }
    .end-screen h2 { font-size: 1.8rem; margin-bottom: 1.5rem; color: #fbbf24; }
    .rankings { max-width: 400px; margin: 0 auto 1.5rem; }
    .rank-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.8rem;
      margin-bottom: 0.4rem;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
    }
    .rank-item.first {
      background: rgba(251,191,36,0.2);
      border: 1px solid rgba(251,191,36,0.3);
    }
    .rank-item .rank { font-weight: 700; width: 1.5rem; }
    .rank-item .rank.top { color: #fbbf24; }
    .rank-item .rank.normal { color: #6b6b7e; }
    .rank-item .avatar { font-size: 1.3rem; }
    .rank-item .name { flex: 1; color: #fff; }
    .rank-item .score { font-weight: 600; color: #a78bfa; }
    .back-btn {
      padding: 0.8rem 2rem;
      background: linear-gradient(135deg, #a78bfa, #f472b6);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }
    
    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      color: #8b8b9e;
    }
    .loading .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(167,139,250,0.3);
      border-top-color: #a78bfa;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      padding: 1rem 2rem;
      background: rgba(0,0,0,0.9);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      color: #fff;
      z-index: 1000;
      animation: fadeIn 0.3s;
    }
    .toast.error { border-color: rgba(239,68,68,0.5); }
    .toast.success { border-color: rgba(74,222,128,0.5); }
    @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } }
  </style>
</head>
<body>
  <!-- é’±åŒ…æ  -->
  <div class="wallet-bar">
    <div class="logo">ğŸ“œ å…±è¯†ç¼–å¹´å²</div>
    <div class="wallet-info" id="wallet-info">
      <button class="connect-btn" id="connect-btn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
    </div>
  </div>

  <!-- é¦–é¡µ -->
  <div id="home-view" class="container">
    <div class="hero">
      <div class="hero-icon">ğŸ“œ</div>
      <h1>å…±è¯†ç¼–å¹´å²</h1>
      <p class="subtitle">Consensus Chronicle</p>
      <p class="desc">å…±è¯†å¦‚ä½•å¡‘é€ å†å²ï¼Ÿä½ çš„é€‰æ‹©å°†æ”¹å†™å‘½è¿ã€‚</p>
    </div>
    
    <div style="text-align: center;">
      <div class="contract-badge">
        <span class="dot"></span>
        <span>åˆçº¦å·²éƒ¨ç½²: 0x4F5F...E186 (studionet)</span>
      </div>
    </div>
    
    <!-- æœªè¿æ¥é’±åŒ… -->
    <div id="not-connected" style="text-align: center; padding: 3rem;">
      <p style="color: #8b8b9e; margin-bottom: 1rem;">è¯·å…ˆè¿æ¥é’±åŒ…å¼€å§‹æ¸¸æˆ</p>
      <button class="connect-btn" onclick="connectWallet()" style="font-size: 1.2rem; padding: 1rem 2rem;">
        ğŸ”— è¿æ¥é’±åŒ…
      </button>
    </div>
    
    <!-- å·²è¿æ¥ä½†æœªæ³¨å†Œ -->
    <div id="not-registered" class="hidden">
      <div class="register-form">
        <h3>ğŸ‘¤ åˆ›å»ºè§’è‰²</h3>
        <input type="text" id="reg-name" placeholder="è¾“å…¥ä½ çš„åå­—..." maxlength="20">
        <p style="color: #8b8b9e; font-size: 0.9rem; margin-bottom: 0.5rem;">é€‰æ‹©å¤´åƒï¼š</p>
        <div class="avatars" id="avatar-selector"></div>
        <button class="submit-btn" id="register-btn" onclick="registerPlayer()">æ³¨å†Œå¹¶è·å¾— 100 GEN</button>
        <div class="cost-info">ğŸ é¦–æ¬¡æ³¨å†Œèµ é€ 100 GEN æ¸¸æˆå¸</div>
      </div>
    </div>
    
    <!-- å·²æ³¨å†Œ -->
    <div id="registered" class="hidden">
      <div class="player-card" id="player-card"></div>
      
      <h2 class="section-title">ğŸ® åˆ›å»ºæ–°æ¸¸æˆ</h2>
      <div class="themes-grid" id="themes-grid"></div>
      
      <div class="rooms-section">
        <h2 class="section-title">ğŸšª åŠ å…¥æˆ¿é—´</h2>
        <div id="rooms-list"></div>
      </div>
    </div>
  </div>

  <!-- æˆ¿é—´è§†å›¾ -->
  <div id="room-view" class="container hidden" style="margin-top: 60px;">
    <div class="room-header">
      <button class="back-btn" onclick="leaveRoom()">â† è¿”å›</button>
      <div class="theme-info">
        <span id="room-theme-icon"></span>
        <span class="theme-name" id="room-theme-name"></span>
      </div>
      <span class="room-id" id="room-id-display"></span>
    </div>
    
    <div class="players-section">
      <h3>ç©å®¶ (<span id="player-count">0</span>/8)</h3>
      <div class="players-grid" id="room-players-grid"></div>
    </div>
    
    <button id="start-game-btn" class="start-btn waiting" onclick="startGame()">ç­‰å¾…æ›´å¤šç©å®¶</button>
    
    <div class="rules-box">
      <h4>ğŸ“– æ¸¸æˆæµç¨‹</h4>
      <div class="rounds-preview">
        <div class="round-item"><div class="num">ç¬¬1è½®</div><div class="flow">è¾©è®ºâ†’æŠ•ç¥¨</div></div>
        <div class="round-item"><div class="num">ç¬¬2è½®</div><div class="flow">è¾©è®ºâ†’æŠ•ç¥¨</div></div>
        <div class="round-item"><div class="num">ç¬¬3è½®</div><div class="flow">è¾©è®ºâ†’æŠ•ç¥¨</div></div>
        <div class="round-item"><div class="num">ç¬¬4è½®</div><div class="flow">è¾©è®ºâ†’æŠ•ç¥¨</div></div>
        <div class="round-item"><div class="num">ç¬¬5è½®</div><div class="flow">è¾©è®ºâ†’æŠ•ç¥¨</div></div>
      </div>
      <ul>
        <li>ğŸ’¬ <b>è¾©è®ºé˜¶æ®µ</b>: 90ç§’å†…è¾“å…¥ä½ çš„è§‚ç‚¹ï¼Œè¯´æœå…¶ä»–ç©å®¶</li>
        <li>ğŸ—³ï¸ <b>æŠ•ç¥¨é˜¶æ®µ</b>: 30ç§’å†…é€‰æ‹©ä½ æ”¯æŒçš„é€‰é¡¹</li>
        <li>ğŸ“œ <b>æ•…äº‹å»¶ç»­</b>: è·èƒœé€‰é¡¹å†³å®šæ•…äº‹èµ°å‘</li>
        <li>ğŸ† <b>å¥–åŠ±</b>: æŠ•ç¥¨è·èƒœæ–¹ +20åˆ†ï¼Œæ¸¸æˆç»“æŸè·å¾— GEN å¥–åŠ±</li>
      </ul>
    </div>
  </div>

  <!-- æ¸¸æˆè§†å›¾ -->
  <div id="game-view" class="hidden">
    <div class="game-header">
      <div class="round-info">
        <div class="label">ç¬¬ <span id="current-round">1</span> / 5 è½®</div>
        <div class="phase" id="phase-text">ğŸ’¬ è¾©è®ºä¸­</div>
      </div>
      <div class="progress-dots" id="progress-dots"></div>
      <div class="timer" id="timer">1:30</div>
      <div class="score-display">
        <div class="label">æˆ‘çš„ç§¯åˆ†</div>
        <div class="value" id="my-score">0</div>
      </div>
    </div>
    
    <div class="game-content">
      <div class="story-panel">
        <div class="story-scroll" id="story-scroll"></div>
        <div class="options-panel" id="options-panel"></div>
        <div class="end-screen hidden" id="end-screen"></div>
      </div>
      
      <div class="chat-panel">
        <div class="players-bar" id="game-players-bar"></div>
        <div class="messages-list" id="messages-list"></div>
        <div class="chat-input" id="chat-input-area">
          <div class="input-row">
            <input type="text" id="chat-text" placeholder="è¾“å…¥ä½ çš„è§‚ç‚¹...">
            <button onclick="sendMessage()">å‘é€</button>
          </div>
          <div class="quick-btns">
            <button class="quick-btn a" onclick="quickMsg('A')">ğŸ…°ï¸ æ”¯æŒA</button>
            <button class="quick-btn b" onclick="quickMsg('B')">ğŸ…±ï¸ æ”¯æŒB</button>
            <button class="quick-btn neutral" onclick="quickMsg('N')">ğŸ’­ è§‚ç‚¹</button>
          </div>
        </div>
        <div class="vote-prompt hidden" id="vote-prompt">
          <p>â° è¯·åœ¨å·¦ä¾§é€‰æ‹©ä½ æ”¯æŒçš„é€‰é¡¹ï¼</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== é…ç½® ==========
    const CONTRACT_ADDRESS = '0x4F5F132ba540f1C685B0188D59990302903aE186';
    const API_URL = '/api/genlayer';
    const ENTRY_FEE = 10;
    
    const CONFIG = {
      ROOM_SIZE: { min: 2, max: 8 },
      DEBATE_DURATION: 90,
      VOTE_DURATION: 30,
      TOTAL_ROUNDS: 5,
    };

    const AVATARS = ['ğŸ®', 'âš”ï¸', 'ğŸ§™â€â™€ï¸', 'ğŸ¹', 'ğŸ›¡ï¸', 'ğŸ—¡ï¸', 'ğŸ”®', 'ğŸ‘‘', 'ğŸ‰', 'ğŸ¦…', 'ğŸº', 'ğŸ¦Š'];

    // ========== æ•…äº‹ç³»ç»Ÿ ==========
    const STORY_ARCS = {
      fantasy: {
        name: 'å¥‡å¹»å†’é™©',
        icon: 'ğŸ°',
        opening: 'å¤è€çš„é¢„è¨€ç»ˆäºåº”éªŒâ€”â€”æ²‰ç¡åƒå¹´çš„é»‘é¾™è‹é†’äº†ã€‚ç‹å›½å±åœ¨æ—¦å¤•ï¼Œå›½ç‹ç´§æ€¥å¬é›†äº†å„åœ°è‹±é›„å•†è®®å¯¹ç­–...',
        rounds: [
          { context: 'é»‘é¾™çš„å¨èƒè¿«åœ¨çœ‰ç«ï¼Œç‹å›½å¿…é¡»åšå‡ºç¬¬ä¸€ä¸ªå…³é”®å†³å®šã€‚',
            a: { text: 'ç«‹å³é›†ç»“å†›é˜Ÿï¼Œä¸»åŠ¨å‡ºå‡»é¾™å·¢ï¼Œåœ¨å®ƒå®Œå…¨è‹é†’å‰å°†å…¶æ¶ˆç­ã€‚', tag: 'å…ˆå‘åˆ¶äººÂ·æ¿€è¿›' },
            b: { text: 'æ´¾é£ä½¿è€…å¯»æ±‚ç²¾çµæ—çš„å¸®åŠ©ï¼Œä»–ä»¬æ›¾åœ¨åƒå¹´å‰å°å°è¿‡é»‘é¾™ã€‚', tag: 'å¯»æ±‚è”ç›ŸÂ·ç¨³å¥' } },
          { context: 'ä½ ä»¬çš„å†³å®šäº§ç”Ÿäº†è¿é”ååº”ï¼Œæ–°çš„å±æœºæµ®ç°...',
            a: { text: 'é‡‡å–æ›´æ¿€è¿›çš„è¡ŒåŠ¨ï¼Œä¸æƒœä¸€åˆ‡ä»£ä»·å®Œæˆç›®æ ‡ã€‚', tag: 'å­¤æ³¨ä¸€æ·Â·å†’é™©' },
            b: { text: 'å¯»æ‰¾æŠ˜ä¸­æ–¹æ¡ˆï¼Œåœ¨é£é™©å’Œæ”¶ç›Šä¹‹é—´å–å¾—å¹³è¡¡ã€‚', tag: 'ç¨³ä¸­æ±‚è¿›Â·è°¨æ…' } },
          { context: 'å±€åŠ¿æ„ˆå‘ç´§å¼ ï¼Œå„æ–¹åŠ¿åŠ›å¼€å§‹è§’åŠ›...',
            a: { text: 'ä½¿ç”¨ç¦å¿Œé­”æ³•ï¼Œç‰ºç‰²æ–½æ³•è€…çš„ç”Ÿå‘½æ¥é‡åˆ›é»‘é¾™ã€‚', tag: 'ç‰ºç‰²å°æˆ‘Â·æ‚²å£®' },
            b: { text: 'ä¸‹ä»¤æ’¤é€€ï¼Œä¿å­˜å®åŠ›ï¼Œç­‰å¾…æ›´å¥½çš„æ—¶æœºå†æˆ˜ã€‚', tag: 'ä»¥é€€ä¸ºè¿›Â·å¿è€' } },
          { context: 'æˆ˜å±€å‡ºç°è½¬æœºï¼Œä½†ä¹Ÿå¸¦æ¥äº†æ–°çš„æŠ‰æ‹©...',
            a: { text: 'è¶é»‘é¾™ç–—ä¼¤æœŸé—´å‘èµ·æ€»æ”»ï¼Œä¸€ä¸¾å°†å…¶æ¶ˆç­ã€‚', tag: 'ä¹˜èƒœè¿½å‡»Â·å†³ç»' },
            b: { text: 'å°è¯•ä¸å—ä¼¤çš„é»‘é¾™æ²Ÿé€šï¼Œå¯»æ‰¾å’Œå¹³å…±å­˜çš„å¯èƒ½ã€‚', tag: 'åŒ–æ•Œä¸ºå‹Â·ç†æƒ³' } },
          { context: 'æœ€ç»ˆå†³æˆ˜æ¥ä¸´ï¼Œå‘½è¿çš„å¤©å¹³ç­‰å¾…ç€ä½ ä»¬çš„å†³å®š...',
            a: { text: 'ä¸æƒœä¸€åˆ‡ä»£ä»·æ¶ˆç­é»‘é¾™ï¼Œå“ªæ€•ç‹å›½åŒ–ä¸ºç„¦åœŸä¹Ÿåœ¨æ‰€ä¸æƒœã€‚', tag: 'ç‰çŸ³ä¿±ç„šÂ·æç«¯' },
            b: { text: 'æ¥å—å‘½è¿çš„å®‰æ’ï¼Œä¸é»‘é¾™è¾¾æˆåè®®ï¼Œå…±åŒé¢å¯¹æœªæ¥çš„æŒ‘æˆ˜ã€‚', tag: 'æ¡æ‰‹è¨€å’ŒÂ·æ™ºæ…§' } },
        ],
      },
      scifi: {
        name: 'ç§‘å¹»æœªæ¥',
        icon: 'ğŸš€',
        opening: '2157å¹´ï¼Œç«æ˜Ÿæ®–æ°‘åœ°"æ–°å¸Œæœ›"æ”¶åˆ°äº†ä¸€æ®µæ¥è‡ªæ·±ç©ºçš„ç¥ç§˜ä¿¡å·ã€‚ç§‘å­¦å®¶ä»¬ç ´è¯‘åå‘ç°ï¼šè¿™æ˜¯ä¸€ä¸ªè­¦å‘Šâ€”â€”åœ°çƒå°†åœ¨100å¤©åè¢«å°è¡Œæ˜Ÿæ’å‡»...',
        rounds: [
          { context: 'æ¶ˆæ¯å…¬å¸ƒåï¼Œæ®–æ°‘åœ°é™·å…¥ææ…Œã€‚é¢†å¯¼å±‚å¿…é¡»ç«‹å³åšå‡ºå†³å®šã€‚',
            a: { text: 'ç«‹å³å¯åŠ¨"æ–¹èˆŸè®¡åˆ’"ï¼Œé€šè¿‡æŠ½ç­¾å†³å®šè°èƒ½ç™»ä¸Šé€ƒç”Ÿé£èˆ¹ã€‚', tag: 'å…¬å¹³æŠ½ç­¾Â·å†·é…·' },
            b: { text: 'é›†ä¸­æ‰€æœ‰èµ„æºç ”ç©¶ä¿¡å·æ¥æºï¼Œä¹Ÿè®¸é‚£é‡Œæœ‰æ‹¯æ•‘æ‰€æœ‰äººçš„ç­”æ¡ˆã€‚', tag: 'è¿½å¯»å¸Œæœ›Â·å†’é™©' } },
          { context: 'ç¬¬ä¸€ä¸ªå†³å®šçš„åæœå¼€å§‹æ˜¾ç°ï¼Œæ–°çš„é—®é¢˜æ¥è¸µè€Œè‡³...',
            a: { text: 'æˆæƒå®‰ä¿éƒ¨é˜Ÿä½¿ç”¨æ­¦åŠ›ï¼Œç¡®ä¿ç§©åºç¨³å®šã€‚', tag: 'é“è…•é•‡å‹Â·æ•ˆç‡' },
            b: { text: 'ä¸å„æ–¹è°ˆåˆ¤ï¼Œå°è¯•ä¿®æ”¹è®¡åˆ’è®©æ›´å¤šäººè·å¾—ç”Ÿå­˜æœºä¼šã€‚', tag: 'å¯»æ±‚å…±è¯†Â·äººé“' } },
          { context: 'èµ„æºæ—¥ç›Šç´§å¼ ï¼Œç¤¾ä¼šçŸ›ç›¾åŠ å‰§...',
            a: { text: 'æ¥å—è¶…è½½æ–¹æ¡ˆï¼Œç”¨60%çš„æˆåŠŸç‡æ¢å–æ›´å¤šäººçš„å¸Œæœ›ã€‚', tag: 'å†’é™©æ±‚å…¨Â·èµŒåš' },
            b: { text: 'ç»´æŒåŸè®¡åˆ’ï¼Œç¡®ä¿è‡³å°‘ä¸€åŠäººèƒ½å¤Ÿç¡®å®šå­˜æ´»ã€‚', tag: 'ç¨³å¦¥æ±‚å­˜Â·ç°å®' } },
          { context: 'æ„å¤–çš„å‘ç°å¸¦æ¥äº†æ–°çš„å¯èƒ½æ€§...',
            a: { text: 'å°è¯•æ”¹å˜å°è¡Œæ˜Ÿè½¨é“ï¼Œå³ä½¿å¤±è´¥ä¹Ÿå€¼å¾—ä¸€è¯•ã€‚', tag: 'é€†å¤©æ”¹å‘½Â·è‹±é›„' },
            b: { text: 'æŒ‰åŸè®¡åˆ’æ’¤ç¦»ï¼Œä¸è¦æŠŠæ‰€æœ‰é¸¡è›‹æ”¾åœ¨ä¸€ä¸ªç¯®å­é‡Œã€‚', tag: 'åˆ†æ•£é£é™©Â·è°¨æ…' } },
          { context: 'æœ€åçš„æ—¶åˆ»æ¥ä¸´ï¼Œäººç±»çš„å‘½è¿æ‚¬äºä¸€çº¿...',
            a: { text: 'æ”¾æ‰‹ä¸€æï¼Œç”¨å‰©ä½™èƒ½æºå†æ¨ä¸€æ¬¡ï¼Œè¦ä¹ˆå…¨èµ¢ï¼Œè¦ä¹ˆå…¨è¾“ã€‚', tag: 'èƒŒæ°´ä¸€æˆ˜Â·æé™' },
            b: { text: 'æ¥å—éƒ¨åˆ†æŸå¤±ï¼Œå¼€å§‹ç¾åé‡å»ºè®¡åˆ’ï¼Œäººç±»å°†æµ´ç«é‡ç”Ÿã€‚', tag: 'åŠ¡å®é¢å¯¹Â·é‡ç”Ÿ' } },
        ],
      },
      mystery: {
        name: 'æ‚¬ç–‘æ¨ç†',
        icon: 'ğŸ”',
        opening: 'æš´é£é›¨ä¹‹å¤œï¼Œå¯Œè±ªé™ˆå®¶çš„å®¶ä¸»é™ˆè€çˆ·åœ¨ä¹¦æˆ¿è¢«äººæ¯’æ€ã€‚å¤§é—¨ä»å†…åé”ï¼Œçª—æˆ·å®Œå¥½æ— æŸã€‚æ¯ä¸ªäººä¼¼ä¹éƒ½æœ‰å«Œç–‘ï¼Œæ¯ä¸ªäººéƒ½æœ‰ç§˜å¯†...',
        rounds: [
          { context: 'è­¦æ–¹å°é”äº†å®…é‚¸ï¼Œæ‰€æœ‰äººéƒ½ä¸èƒ½ç¦»å¼€ã€‚ä½œä¸ºè¢«é‚€è¯·æ¥çš„ä¾¦æ¢ï¼Œä½ å¿…é¡»å¼€å§‹è°ƒæŸ¥ã€‚',
            a: { text: 'é¦–å…ˆæœæŸ¥æ­»è€…çš„ä¹¦æˆ¿ï¼Œå¯»æ‰¾ç‰©è¯å’Œçº¿ç´¢ã€‚', tag: 'ç‰©è¯ä¼˜å…ˆÂ·ç³»ç»Ÿ' },
            b: { text: 'åˆ†åˆ«è¯¢é—®åœ¨åœºæ¯ä¸ªäººï¼Œè§‚å¯Ÿä»–ä»¬çš„ååº”å’Œæ¼æ´ã€‚', tag: 'å¯Ÿè¨€è§‚è‰²Â·ç›´è§‰' } },
          { context: 'åˆæ­¥è°ƒæŸ¥æ­ç¤ºäº†ä¸€äº›ä»¤äººä¸å®‰çš„å‘ç°...',
            a: { text: 'æ·±å…¥è°ƒæŸ¥é—äº§é—®é¢˜ï¼Œè¿½æŸ¥è°æ˜¯è¢«å‰¥å¤ºç»§æ‰¿æƒçš„äººã€‚', tag: 'è¿½è¸ªé‡‘é’±Â·ç°å®' },
            b: { text: 'è°ƒæŸ¥ç¥ç§˜å•†äººçš„èº«ä»½å’Œæ¥å†ï¼Œä»–çš„å‡ºç°å¤ªè¿‡å·§åˆã€‚', tag: 'è¿½æŸ¥å¤–äººÂ·æ€€ç–‘' } },
          { context: 'æ›´å¤šçš„ç§˜å¯†è¢«æ­å¼€ï¼Œæ¡ˆæƒ…å˜å¾—å¤æ‚...',
            a: { text: 'éªŒè¯è¯äººçš„è¯è¯ï¼Œæ‰¾å‡ºè°åœ¨è¯´è°ã€‚', tag: 'è´¨ç–‘è¯è¯Â·ç»†è‡´' },
            b: { text: 'è°ƒæŸ¥é™ˆå¹´æ—§æ¡ˆï¼Œä¹Ÿè®¸è¿‡å»çš„ç§˜å¯†èƒ½æ­ç¤ºç°åœ¨çš„çœŸç›¸ã€‚', tag: 'è¿½æº¯è¿‡å»Â·è€å¿ƒ' } },
          { context: 'çœŸç›¸é€æ¸æµ®å‡ºæ°´é¢ï¼Œä½†è¿˜æœ‰æœ€åçš„è°œå›¢...',
            a: { text: 'å¯¹å«Œç–‘äººè¿›è¡Œäº¤å‰å®¡é—®ï¼Œæ‰¾å‡ºè°åœ¨è¯´è°ã€‚', tag: 'æ­£é¢å¯¹è´¨Â·æ¿€çƒˆ' },
            b: { text: 'é‡æ–°æ£€éªŒæ¯’è¯æ¥æºï¼Œå‡¶å™¨å¾€å¾€èƒ½æŒ‡å‘çœŸå‡¶ã€‚', tag: 'ç§‘å­¦åˆ†æÂ·ä¸¥è°¨' } },
          { context: 'æ‰€æœ‰è¯æ®éƒ½å·²æ”¶é›†ï¼Œæ˜¯æ—¶å€™æ­ç¤ºçœŸç›¸äº†...',
            a: { text: 'å…¬å¼€æ‰€æœ‰çœŸç›¸ï¼Œè®©æ³•å¾‹æ¥è£å†³ï¼Œæ— è®ºç»“æœå¦‚ä½•ã€‚', tag: 'å…¬æ­£å®¡åˆ¤Â·æ³•æ²»' },
            b: { text: 'ç»™ç›¸å…³äººä¸€ä¸ªé€‰æ‹©çš„æœºä¼šï¼Œæœ‰äº›çœŸç›¸ä¹Ÿè®¸ä¸è¯¥è¢«å…¬å¼€ã€‚', tag: 'äººæƒ…è€ƒé‡Â·ç°è‰²' } },
        ],
      },
      political: {
        name: 'å®«å»·æƒè°‹',
        icon: 'ğŸ‘‘',
        opening: 'å¤§é½ç‹æœï¼Œæ°¸å®‰ä¸‰åå¹´ã€‚è€çš‡å¸é©¾å´©çš„æ¶ˆæ¯éœ‡æƒŠæœé‡ã€‚é—è¯ä¸­å´å‡ºç°äº†ä»¤äººè´¹è§£çš„å†…å®¹ï¼šçš‡ä½ä¸ä¼ ç»™ä¸‰ä½æˆå¹´çš‡å­ä¸­çš„ä»»ä½•ä¸€ä¸ª...',
        rounds: [
          { context: 'ä½œä¸ºå…ˆå¸ä¿¡ä»»çš„å†…é˜é¦–è¾…ï¼Œä½ å¿…é¡»åœ¨æ··ä¹±ä¸­ç»´æŒå±€é¢ã€‚',
            a: { text: 'æ”¯æŒå¤ªå­æŒ‰ä¼ ç»Ÿç»§ä½ï¼Œç»´æŠ¤å«¡é•¿å­ç»§æ‰¿åˆ¶åº¦çš„ç¨³å®šã€‚', tag: 'ä¼ ç»Ÿæ­£ç»ŸÂ·ä¿å®ˆ' },
            b: { text: 'æè®®ä¸‰ä½çš‡å­å„é™ˆæ–½æ”¿çº²é¢†ï¼Œç”±ç™¾å®˜å…¬è®®å†³å®šäººé€‰ã€‚', tag: 'å…¬è®®å†³é€‰Â·é©æ–°' } },
          { context: 'ä½ çš„å†³å®šå¼•å‘äº†è¿é”ååº”ï¼Œå±€åŠ¿æ„ˆå‘å¤æ‚...',
            a: { text: 'ç´§æ€¥è°ƒåŠ¨å¾¡æ—å†›å¸ƒé˜²ï¼ŒåŒæ—¶æ´¾å¯†ä½¿åˆ†åŒ–å¯¹æ–¹çš„åŒç›Ÿã€‚', tag: 'åˆ†åŒ–ç“¦è§£Â·æƒè°‹' },
            b: { text: 'ä¸»åŠ¨æ‰¾å¯¹æ–¹è°ˆåˆ¤ï¼Œäº†è§£ä»–ä»¬çš„è¯‰æ±‚ï¼Œå¯»æ‰¾å’Œå¹³è§£å†³çš„å¯èƒ½ã€‚', tag: 'å’Œè°ˆæ­¢å…µÂ·å†’é™©' } },
          { context: 'å¤–éƒ¨åŠ¿åŠ›å¼€å§‹ä»‹å…¥ï¼Œå®«å»·æ–—äº‰æ„ˆæ¼”æ„ˆçƒˆ...',
            a: { text: 'ç­”åº”å¯¹æ–¹çš„æ¡ä»¶ï¼Œä¸¤å®³ç›¸æƒå–å…¶è½»ï¼Œå…ˆç¨³ä½å±€é¢ã€‚', tag: 'æƒå®œä¹‹è®¡Â·å¦¥å' },
            b: { text: 'æ­éœ²é˜´è°‹ï¼Œè”åˆä¸‰ä½çš‡å­å…±åŒå¯¹æŠ—å¤–æˆšä¸“æƒã€‚', tag: 'å›¢ç»“æŠ—æ•ŒÂ·æ­£ä¹‰' } },
          { context: 'è¾¹ç–†ä¼ æ¥æ€¥æŠ¥ï¼šåŒ—æ–¹æ¸¸ç‰§æ°‘æ—å¤§å†›å‹å¢ƒï¼Œå†…å¿§å¤–æ‚£åŒæ—¶çˆ†å‘ã€‚',
            a: { text: 'å»ºè®®ä¸‰ä½çš‡å­äº²å¾åŒ—ç–†ï¼Œè°èƒ½å‡»é€€æ•Œå†›è°å°±æ˜¯æ–°å¸ã€‚', tag: 'ä»¥æˆ˜å®šå¸Â·é­„åŠ›' },
            b: { text: 'æè®®å…ˆé€‰å‡ºæ–°å¸å†åº”å¯¹å¤–æ•Œï¼Œå›½ä¸å¯ä¸€æ—¥æ— å›ã€‚', tag: 'å…ˆå†…åå¤–Â·ç¨³é‡' } },
          { context: 'åŒ—ç–†æˆ˜äº‹èƒ¶ç€ï¼Œæœ€ç»ˆçš„å†³å®šå°†å½±å“å¤§é½çš„æœªæ¥ç™¾å¹´ã€‚',
            a: { text: 'å»ºè®®ä¸‰ä½çš‡å­å…±åŒæ‰§æ”¿ï¼Œå»ºç«‹"ä¸‰ç‹è®®æ”¿"çš„æ–°åˆ¶åº¦ã€‚', tag: 'æƒåŠ›å…±äº«Â·å¼€åˆ›' },
            b: { text: 'æŒ‰å†›åŠŸå¤§å°æ’åºï¼Œç”±åŠŸåŠ³æœ€å¤§è€…ç»§æ‰¿çš‡ä½ã€‚', tag: 'åŠŸå‹‹å®šä½Â·å…¬å¹³' } },
        ],
      },
    };

    // ========== çŠ¶æ€ ==========
    let state = {
      wallet: { address: null, privateKey: null },
      player: null,
      currentView: 'home',
      room: null,
      players: [],
      round: 0,
      phase: 'waiting',
      timer: 0,
      story: [],
      storyPath: [],
      currentOptions: { a: null, b: null },
      votes: {},
      myVote: null,
      scores: {},
      messages: [],
      selectedAvatar: AVATARS[0],
    };
    
    let timerInterval = null;
    let pollInterval = null;

    // ========== å·¥å…·å‡½æ•° ==========
    function showToast(msg, type = 'info') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    async function callContract(method, params = [], needSign = false) {
      try {
        const body = { method, params };
        if (needSign && state.wallet.privateKey) {
          body.privateKey = state.wallet.privateKey;
        }
        
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        
        const data = await res.json();
        if (!data.success) throw new Error(data.error);
        return data.data;
      } catch (err) {
        console.error('Contract call failed:', err);
        throw err;
      }
    }

    // ========== é’±åŒ… ==========
    function connectWallet() {
      const privateKey = prompt('è¯·è¾“å…¥ä½ çš„ç§é’¥ (0xå¼€å¤´)ï¼š\n\nâš ï¸ ä»…ç”¨äºæµ‹è¯•ç½‘ï¼Œè¯·å‹¿è¾“å…¥ä¸»ç½‘ç§é’¥');
      if (!privateKey || !privateKey.startsWith('0x')) {
        showToast('æ— æ•ˆçš„ç§é’¥æ ¼å¼', 'error');
        return;
      }
      
      // ä»ç§é’¥æ¨å¯¼åœ°å€ (ç®€åŒ–ç‰ˆï¼Œå®é™…åº”ä½¿ç”¨ ethers.js)
      const address = '0x' + privateKey.slice(2, 42).toUpperCase();
      
      state.wallet.address = address;
      state.wallet.privateKey = privateKey;
      
      localStorage.setItem('wallet', JSON.stringify(state.wallet));
      
      showToast('é’±åŒ…å·²è¿æ¥', 'success');
      updateWalletUI();
      checkPlayerStatus();
    }

    function disconnectWallet() {
      state.wallet = { address: null, privateKey: null };
      state.player = null;
      localStorage.removeItem('wallet');
      updateWalletUI();
      showView('home');
    }

    function updateWalletUI() {
      const info = document.getElementById('wallet-info');
      
      if (state.wallet.address) {
        const shortAddr = state.wallet.address.slice(0, 6) + '...' + state.wallet.address.slice(-4);
        info.innerHTML = `
          <span class="balance" id="wallet-balance">-- GEN</span>
          <span class="address">${shortAddr}</span>
          <button class="disconnect-btn" onclick="disconnectWallet()">æ–­å¼€</button>
        `;
        document.getElementById('not-connected').classList.add('hidden');
      } else {
        info.innerHTML = `<button class="connect-btn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>`;
        document.getElementById('not-connected').classList.remove('hidden');
        document.getElementById('not-registered').classList.add('hidden');
        document.getElementById('registered').classList.add('hidden');
      }
    }

    // ========== ç©å®¶ ==========
    async function checkPlayerStatus() {
      if (!state.wallet.address) return;
      
      try {
        const result = await callContract('get_player', [state.wallet.address]);
        const data = typeof result === 'string' ? JSON.parse(result) : result;
        
        if (data.success && data.player) {
          state.player = data.player;
          showRegisteredUI();
        } else {
          showRegisterUI();
        }
      } catch (err) {
        console.error('Check player failed:', err);
        showRegisterUI();
      }
    }

    function showRegisterUI() {
      document.getElementById('not-connected').classList.add('hidden');
      document.getElementById('not-registered').classList.remove('hidden');
      document.getElementById('registered').classList.add('hidden');
      
      // æ¸²æŸ“å¤´åƒé€‰æ‹©
      const selector = document.getElementById('avatar-selector');
      selector.innerHTML = AVATARS.map(a => `
        <button class="avatar-btn ${a === state.selectedAvatar ? 'selected' : ''}" 
                onclick="selectAvatar('${a}')">${a}</button>
      `).join('');
    }

    function selectAvatar(avatar) {
      state.selectedAvatar = avatar;
      document.querySelectorAll('.avatar-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.textContent === avatar);
      });
    }

    async function registerPlayer() {
      const name = document.getElementById('reg-name').value.trim();
      if (!name) {
        showToast('è¯·è¾“å…¥åå­—', 'error');
        return;
      }
      
      const btn = document.getElementById('register-btn');
      btn.disabled = true;
      btn.textContent = 'æ³¨å†Œä¸­...';
      
      try {
        const result = await callContract('register_player', [name, state.selectedAvatar], true);
        const data = typeof result === 'string' ? JSON.parse(result) : result;
        
        if (data.success) {
          showToast('æ³¨å†ŒæˆåŠŸï¼è·å¾— 100 GEN', 'success');
          await checkPlayerStatus();
        } else {
          throw new Error(data.error || 'æ³¨å†Œå¤±è´¥');
        }
      } catch (err) {
        showToast('æ³¨å†Œå¤±è´¥: ' + err.message, 'error');
      }
      
      btn.disabled = false;
      btn.textContent = 'æ³¨å†Œå¹¶è·å¾— 100 GEN';
    }

    function showRegisteredUI() {
      document.getElementById('not-connected').classList.add('hidden');
      document.getElementById('not-registered').classList.add('hidden');
      document.getElementById('registered').classList.remove('hidden');
      
      // ç©å®¶å¡ç‰‡
      document.getElementById('player-card').innerHTML = `
        <span class="avatar">${state.player.avatar}</span>
        <div class="info">
          <div class="name">${state.player.name}</div>
          <div class="stats">
            <span class="stat balance">ğŸ’° ${state.player.balance} GEN</span>
            <span class="stat exp">â­ ${state.player.exp} EXP</span>
          </div>
        </div>
      `;
      
      // æ›´æ–°é’±åŒ…ä½™é¢
      const balanceEl = document.getElementById('wallet-balance');
      if (balanceEl) balanceEl.textContent = state.player.balance + ' GEN';
      
      // ä¸»é¢˜åˆ—è¡¨
      renderThemes();
      
      // æˆ¿é—´åˆ—è¡¨
      loadRooms();
    }

    // ========== ä¸»é¢˜ ==========
    function renderThemes() {
      const grid = document.getElementById('themes-grid');
      grid.innerHTML = Object.entries(STORY_ARCS).map(([key, arc]) => `
        <div class="theme-card" onclick="createRoom('${key}')">
          <span class="icon">${arc.icon}</span>
          <span class="name">${arc.name}</span>
          <span class="info">5è½®å²è¯—æ•…äº‹</span>
          <span class="cost">å…¥åœºè´¹: ${ENTRY_FEE} GEN</span>
        </div>
      `).join('');
    }

    // ========== æˆ¿é—´ ==========
    async function loadRooms() {
      const container = document.getElementById('rooms-list');
      container.innerHTML = '<div class="loading"><div class="spinner"></div>åŠ è½½ä¸­...</div>';
      
      try {
        const result = await callContract('list_rooms');
        const rooms = typeof result === 'string' ? JSON.parse(result) : result;
        
        if (!rooms || !rooms.success || !rooms.rooms || rooms.rooms.length === 0) {
          container.innerHTML = '<div class="no-rooms">æš‚æ— å¯åŠ å…¥çš„æˆ¿é—´ï¼Œåˆ›å»ºä¸€ä¸ªæ–°æ¸¸æˆå§ï¼</div>';
          return;
        }
        
        container.innerHTML = '<div class="rooms-list">' + rooms.rooms.map(room => `
          <div class="room-item">
            <div class="info">
              <span class="theme-icon">${STORY_ARCS[room.theme]?.icon || 'ğŸ®'}</span>
              <div class="details">
                <h4>${STORY_ARCS[room.theme]?.name || room.theme}</h4>
                <span class="meta">${room.players}/8 ç©å®¶ Â· ${room.id}</span>
              </div>
            </div>
            <button class="join-btn" onclick="joinRoom('${room.id}')" 
                    ${state.player?.balance < ENTRY_FEE ? 'disabled title="ä½™é¢ä¸è¶³"' : ''}>
              åŠ å…¥ (${ENTRY_FEE} GEN)
            </button>
          </div>
        `).join('') + '</div>';
      } catch (err) {
        container.innerHTML = '<div class="no-rooms">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
      }
    }

    async function createRoom(theme) {
      if (!state.player || state.player.balance < ENTRY_FEE) {
        showToast('ä½™é¢ä¸è¶³ï¼Œéœ€è¦ ' + ENTRY_FEE + ' GEN', 'error');
        return;
      }
      
      showToast('åˆ›å»ºæˆ¿é—´ä¸­...', 'info');
      
      try {
        const result = await callContract('create_room', [theme], true);
        const data = typeof result === 'string' ? JSON.parse(result) : result;
        
        if (data.success) {
          showToast('æˆ¿é—´åˆ›å»ºæˆåŠŸï¼', 'success');
          state.room = { id: data.room_id, theme, host: state.wallet.address };
          state.player.balance -= ENTRY_FEE;
          enterRoom(data.room_id, theme, true);
        } else {
          throw new Error(data.error || 'åˆ›å»ºå¤±è´¥');
        }
      } catch (err) {
        showToast('åˆ›å»ºå¤±è´¥: ' + err.message, 'error');
      }
    }

    async function joinRoom(roomId) {
      if (!state.player || state.player.balance < ENTRY_FEE) {
        showToast('ä½™é¢ä¸è¶³ï¼Œéœ€è¦ ' + ENTRY_FEE + ' GEN', 'error');
        return;
      }
      
      showToast('åŠ å…¥æˆ¿é—´ä¸­...', 'info');
      
      try {
        const result = await callContract('join_room', [roomId], true);
        const data = typeof result === 'string' ? JSON.parse(result) : result;
        
        if (data.success) {
          showToast('åŠ å…¥æˆåŠŸï¼', 'success');
          state.player.balance -= ENTRY_FEE;
          
          // è·å–æˆ¿é—´ä¿¡æ¯
          const roomResult = await callContract('get_room', [roomId]);
          const roomData = typeof roomResult === 'string' ? JSON.parse(roomResult) : roomResult;
          
          if (roomData.success && roomData.room) {
            enterRoom(roomId, roomData.room.theme, false);
          }
        } else {
          throw new Error(data.error || 'åŠ å…¥å¤±è´¥');
        }
      } catch (err) {
        showToast('åŠ å…¥å¤±è´¥: ' + err.message, 'error');
      }
    }

    function enterRoom(roomId, theme, isHost) {
      state.room = { id: roomId, theme, host: isHost ? state.wallet.address : null };
      state.players = [{ address: state.wallet.address, ...state.player }];
      
      showView('room');
      renderRoomView();
      
      // å¼€å§‹è½®è¯¢æˆ¿é—´çŠ¶æ€
      startRoomPolling();
    }

    function leaveRoom() {
      if (pollInterval) clearInterval(pollInterval);
      state.room = null;
      state.players = [];
      showView('home');
      checkPlayerStatus();
    }

    function startRoomPolling() {
      if (pollInterval) clearInterval(pollInterval);
      
      pollInterval = setInterval(async () => {
        if (!state.room) return;
        
        try {
          const result = await callContract('get_room', [state.room.id]);
          const data = typeof result === 'string' ? JSON.parse(result) : result;
          
          if (data.success && data.room) {
            const room = data.room;
            
            // æ›´æ–°ç©å®¶åˆ—è¡¨
            state.players = room.players.map(addr => ({
              address: addr,
              name: addr === state.wallet.address ? state.player.name : addr.slice(0, 8) + '...',
              avatar: addr === state.wallet.address ? state.player.avatar : 'ğŸ‘¤',
            }));
            
            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å¼€å§‹
            if (room.status === 'playing' && state.currentView === 'room') {
              clearInterval(pollInterval);
              startGameView(room);
            }
            
            renderRoomView();
          }
        } catch (err) {
          console.error('Poll error:', err);
        }
      }, 3000);
    }

    function renderRoomView() {
      if (!state.room) return;
      
      const arc = STORY_ARCS[state.room.theme];
      document.getElementById('room-theme-icon').textContent = arc?.icon || 'ğŸ®';
      document.getElementById('room-theme-name').textContent = arc?.name || state.room.theme;
      document.getElementById('room-id-display').textContent = state.room.id;
      document.getElementById('player-count').textContent = state.players.length;
      
      // ç©å®¶æ ¼å­
      const grid = document.getElementById('room-players-grid');
      let html = '';
      
      for (let i = 0; i < 8; i++) {
        const p = state.players[i];
        if (p) {
          const isYou = p.address === state.wallet.address;
          const isHost = p.address === state.room.host;
          html += `
            <div class="player-slot filled ${isYou ? 'you' : ''}">
              ${isHost ? '<span class="badge host">æˆ¿ä¸»</span>' : ''}
              <span class="slot-avatar">${p.avatar}</span>
              <span class="slot-name">${p.name}</span>
            </div>
          `;
        } else {
          html += `
            <div class="player-slot empty">
              <span class="slot-avatar">?</span>
              <span class="slot-name">ç­‰å¾…ä¸­...</span>
            </div>
          `;
        }
      }
      grid.innerHTML = html;
      
      // å¼€å§‹æŒ‰é’®
      const btn = document.getElementById('start-game-btn');
      const isHost = state.room.host === state.wallet.address;
      const canStart = state.players.length >= CONFIG.ROOM_SIZE.min;
      
      if (isHost) {
        btn.className = `start-btn ${canStart ? 'ready' : 'waiting'}`;
        btn.textContent = canStart ? 'ğŸ® å¼€å§‹æ¸¸æˆ' : `ç­‰å¾…æ›´å¤šç©å®¶ (${state.players.length}/${CONFIG.ROOM_SIZE.min})`;
        btn.disabled = !canStart;
      } else {
        btn.className = 'start-btn waiting';
        btn.textContent = 'ç­‰å¾…æˆ¿ä¸»å¼€å§‹...';
        btn.disabled = true;
      }
    }

    async function startGame() {
      if (!state.room || state.room.host !== state.wallet.address) return;
      if (state.players.length < CONFIG.ROOM_SIZE.min) {
        showToast('è‡³å°‘éœ€è¦ ' + CONFIG.ROOM_SIZE.min + ' åç©å®¶', 'error');
        return;
      }
      
      showToast('å¼€å§‹æ¸¸æˆ...', 'info');
      
      try {
        const result = await callContract('start_game', [state.room.id], true);
        const data = typeof result === 'string' ? JSON.parse(result) : result;
        
        if (data.success) {
          if (pollInterval) clearInterval(pollInterval);
          startGameView(data);
        } else {
          throw new Error(data.error || 'å¯åŠ¨å¤±è´¥');
        }
      } catch (err) {
        showToast('å¯åŠ¨å¤±è´¥: ' + err.message, 'error');
      }
    }

    // ========== æ¸¸æˆè§†å›¾ ==========
    function startGameView(roomData) {
      showView('game');
      
      state.round = 1;
      state.phase = 'debate';
      state.votes = {};
      state.myVote = null;
      state.story = [];
      state.storyPath = [];
      state.messages = [];
      
      // åˆå§‹åŒ–åˆ†æ•°
      state.scores = {};
      state.players.forEach(p => state.scores[p.address] = { influence: 0, debates: 0, wins: 0 });
      
      // æ˜¾ç¤ºå¼€åœº
      const arc = STORY_ARCS[state.room.theme];
      state.story.push({ text: arc.opening, type: 'opening', round: 0 });
      addSystemMessage(`ğŸ“– ${arc.name}å¼€å§‹äº†ï¼`);
      
      renderGame();
      
      setTimeout(() => startRound(1), 2000);
    }

    function startRound(r) {
      if (r > CONFIG.TOTAL_ROUNDS) return endGame();
      
      state.round = r;
      state.phase = 'debate';
      state.votes = {};
      state.myVote = null;
      
      const arc = STORY_ARCS[state.room.theme];
      const roundData = arc.rounds[r - 1];
      
      state.story.push({ text: roundData.context, type: 'context', round: r });
      state.currentOptions = { a: roundData.a, b: roundData.b };
      
      addSystemMessage(`ğŸ“– ç¬¬ ${r}/${CONFIG.TOTAL_ROUNDS} è½® - è¾©è®ºé˜¶æ®µå¼€å§‹`);
      renderGame();
      
      startTimer(CONFIG.DEBATE_DURATION, () => startVoting());
    }

    function startVoting() {
      state.phase = 'vote';
      addSystemMessage('ğŸ—³ï¸ æŠ•ç¥¨é˜¶æ®µå¼€å§‹ï¼è¯·é€‰æ‹©ä½ æ”¯æŒçš„é€‰é¡¹');
      renderGame();
      
      startTimer(CONFIG.VOTE_DURATION, () => submitVoteToChain());
    }

    async function submitVote(choice) {
      if (state.phase !== 'vote' || state.myVote) return;
      
      state.myVote = choice;
      state.votes[state.wallet.address] = choice;
      addSystemMessage(`ä½ æŠ•ç¥¨ç»™äº†é€‰é¡¹ ${choice}`);
      renderGame();
      
      // æäº¤åˆ°é“¾ä¸Š
      try {
        await callContract('vote', [state.room.id, choice], true);
      } catch (err) {
        console.error('Vote submit failed:', err);
      }
    }

    async function submitVoteToChain() {
      // å¦‚æœè¿˜æ²¡æŠ•ç¥¨ï¼ŒéšæœºæŠ•ä¸€ä¸ª
      if (!state.myVote) {
        const choice = Math.random() > 0.5 ? 'A' : 'B';
        await submitVote(choice);
      }
      
      // ç­‰å¾…é“¾ä¸Šç»“ç®—
      showToast('ç­‰å¾…æŠ•ç¥¨ç»“ç®—...', 'info');
      
      try {
        const result = await callContract('finalize_round', [state.room.id], true);
        const data = typeof result === 'string' ? JSON.parse(result) : result;
        
        calculateResult(data);
      } catch (err) {
        console.error('Finalize failed:', err);
        // æœ¬åœ°ç»“ç®—
        calculateResultLocal();
      }
    }

    function calculateResult(chainData) {
      state.phase = 'result';
      
      const winner = chainData?.winner || (state.votes[state.wallet.address] || 'A');
      const countA = chainData?.count_a || Object.values(state.votes).filter(v => v === 'A').length;
      const countB = chainData?.count_b || Object.values(state.votes).filter(v => v === 'B').length;
      
      // æ›´æ–°åˆ†æ•°
      Object.entries(state.votes).forEach(([addr, v]) => {
        if (v === winner && state.scores[addr]) {
          state.scores[addr].influence += 30;
          state.scores[addr].wins += 1;
        }
      });
      
      state.storyPath.push(winner);
      
      const winOpt = winner === 'A' ? state.currentOptions.a : state.currentOptions.b;
      state.story.push({ text: `ã€ä¼—äººé€‰æ‹©ã€‘${winOpt?.text}`, type: 'choice', round: state.round, winner });
      state.story.push({ text: `æ•…äº‹å› æ­¤å‘ç”Ÿäº†è½¬æŠ˜...`, type: 'consequence', round: state.round });
      
      addSystemMessage(`ğŸ“œ é€‰é¡¹ ${winner} è·èƒœï¼(${winner === 'A' ? countA : countB}ç¥¨)`);
      renderGame();
      
      if (state.round >= CONFIG.TOTAL_ROUNDS) {
        setTimeout(() => endGame(), 3000);
      } else {
        setTimeout(() => startRound(state.round + 1), 4000);
      }
    }

    function calculateResultLocal() {
      const voteCount = { A: 0, B: 0 };
      Object.values(state.votes).forEach(v => { if (v) voteCount[v]++; });
      const winner = voteCount.A >= voteCount.B ? 'A' : 'B';
      calculateResult({ winner, count_a: voteCount.A, count_b: voteCount.B });
    }

    function endGame() {
      state.phase = 'ended';
      if (timerInterval) clearInterval(timerInterval);
      addSystemMessage('ğŸ† ç¼–å¹´å²å®Œæˆï¼');
      renderGame();
    }

    // ========== è®¡æ—¶å™¨ ==========
    function startTimer(duration, onComplete) {
      if (timerInterval) clearInterval(timerInterval);
      state.timer = duration;
      renderTimer();
      
      timerInterval = setInterval(() => {
        state.timer--;
        renderTimer();
        if (state.timer <= 0) {
          clearInterval(timerInterval);
          onComplete();
        }
      }, 1000);
    }

    function renderTimer() {
      const el = document.getElementById('timer');
      if (!el) return;
      const m = Math.floor(state.timer / 60);
      const s = (state.timer % 60).toString().padStart(2, '0');
      el.textContent = state.phase === 'ended' || state.phase === 'result' ? '--:--' : `${m}:${s}`;
      el.className = state.timer <= 10 && state.phase !== 'ended' && state.phase !== 'result' ? 'timer warning' : 'timer';
    }

    // ========== æ¶ˆæ¯ ==========
    function addSystemMessage(text) {
      state.messages.push({ id: Date.now(), type: 'system', text });
      if (state.messages.length > 30) state.messages.shift();
    }

    function addChatMessage(sender, text, choice = null) {
      state.messages.push({ id: Date.now(), type: 'chat', sender, text, choice });
      if (state.messages.length > 30) state.messages.shift();
    }

    function sendMessage() {
      const input = document.getElementById('chat-text');
      const text = input.value.trim();
      if (!text || state.phase !== 'debate') return;
      
      const choice = text.includes('A') || text.includes('é€‰é¡¹A') ? 'A' : 
                     text.includes('B') || text.includes('é€‰é¡¹B') ? 'B' : null;
      
      addChatMessage({ name: state.player.name, avatar: state.player.avatar }, text, choice);
      input.value = '';
      
      state.scores[state.wallet.address].debates += 10;
      renderGame();
    }

    function quickMsg(type) {
      const input = document.getElementById('chat-text');
      if (type === 'A') input.value = 'æˆ‘æ”¯æŒé€‰é¡¹Aï¼Œå› ä¸º';
      else if (type === 'B') input.value = 'æˆ‘æ”¯æŒé€‰é¡¹Bï¼Œå› ä¸º';
      else input.value = 'æˆ‘è®¤ä¸ºæˆ‘ä»¬åº”è¯¥è€ƒè™‘';
      input.focus();
    }

    // ========== æ¸²æŸ“ ==========
    function showView(view) {
      document.getElementById('home-view').classList.add('hidden');
      document.getElementById('room-view').classList.add('hidden');
      document.getElementById('game-view').classList.add('hidden');
      document.getElementById(`${view}-view`).classList.remove('hidden');
      state.currentView = view;
    }

    function renderGame() {
      if (!state.room) return;
      
      document.getElementById('current-round').textContent = state.round;
      
      const phaseText = {
        debate: 'ğŸ’¬ è¾©è®ºä¸­',
        vote: 'ğŸ—³ï¸ æŠ•ç¥¨ä¸­',
        result: 'ğŸ“Š ç»“ç®—ä¸­',
        ended: 'ğŸ† å·²ç»“æŸ',
      };
      document.getElementById('phase-text').textContent = phaseText[state.phase] || '';
      
      // Progress dots
      let dots = '';
      for (let i = 1; i <= 5; i++) {
        const cls = i < state.round ? 'completed' : i === state.round ? 'current' : '';
        dots += `<div class="dot ${cls}"></div>`;
      }
      document.getElementById('progress-dots').innerHTML = dots;
      
      // Score
      const myScore = state.scores[state.wallet.address] || { influence: 0, debates: 0 };
      document.getElementById('my-score').textContent = myScore.influence + myScore.debates;
      
      // Story
      const arc = STORY_ARCS[state.room?.theme];
      document.getElementById('story-scroll').innerHTML = `<h3>ğŸ“œ ${arc?.name || ''} - æ•…äº‹è¿›ç¨‹</h3>` + 
        state.story.map(s => {
          if (s.type === 'opening') return `<div class="story-entry opening">${s.text}</div>`;
          if (s.type === 'context') return `<div class="story-entry context"><span class="badge">ç¬¬${s.round}è½®</span>${s.text}</div>`;
          if (s.type === 'choice') return `<div class="story-entry choice">${s.winner === 'A' ? 'ğŸ…°ï¸' : 'ğŸ…±ï¸'} ${s.text}</div>`;
          if (s.type === 'consequence') return `<div class="story-entry consequence">${s.text}</div>`;
          return '';
        }).join('');
      
      // Options
      const optionsPanel = document.getElementById('options-panel');
      const endScreen = document.getElementById('end-screen');
      
      if (state.phase === 'ended') {
        optionsPanel.classList.add('hidden');
        endScreen.classList.remove('hidden');
        
        const rankings = Object.entries(state.scores)
          .map(([addr, score]) => ({ 
            player: state.players.find(p => p.address === addr) || { name: addr.slice(0, 8), avatar: 'ğŸ‘¤' }, 
            total: score.influence + score.debates 
          }))
          .sort((a, b) => b.total - a.total);
        
        endScreen.innerHTML = `
          <h2>ğŸ† ç¼–å¹´å²å®Œæˆï¼</h2>
          <div class="rankings">
            ${rankings.map((r, i) => `
              <div class="rank-item ${i === 0 ? 'first' : ''}">
                <span class="rank ${i < 3 ? 'top' : 'normal'}">#${i + 1}</span>
                <span class="avatar">${r.player.avatar}</span>
                <span class="name">${r.player.name}</span>
                <span class="score">${r.total} pts</span>
              </div>
            `).join('')}
          </div>
          <button class="back-btn" onclick="backToHome()">è¿”å›å¤§å…</button>
        `;
      } else if ((state.phase === 'debate' || state.phase === 'vote') && state.currentOptions.a) {
        optionsPanel.classList.remove('hidden');
        endScreen.classList.add('hidden');
        
        const votesA = Object.values(state.votes).filter(v => v === 'A').length;
        const votesB = Object.values(state.votes).filter(v => v === 'B').length;
        
        optionsPanel.innerHTML = `
          <h4>âš”ï¸ æœ¬è½®æŠ‰æ‹©</h4>
          <div class="options-grid">
            <div class="option-card option-a ${state.myVote === 'A' ? 'selected' : ''}" onclick="submitVote('A')">
              <div class="header">
                <span class="label">é€‰é¡¹ A</span>
                <span class="tag">${state.currentOptions.a?.tag || ''}</span>
              </div>
              <p class="text">${state.currentOptions.a?.text || ''}</p>
              ${state.phase === 'vote' ? `<div class="votes">${votesA} ç¥¨</div>` : ''}
            </div>
            <div class="option-card option-b ${state.myVote === 'B' ? 'selected' : ''}" onclick="submitVote('B')">
              <div class="header">
                <span class="label">é€‰é¡¹ B</span>
                <span class="tag">${state.currentOptions.b?.tag || ''}</span>
              </div>
              <p class="text">${state.currentOptions.b?.text || ''}</p>
              ${state.phase === 'vote' ? `<div class="votes">${votesB} ç¥¨</div>` : ''}
            </div>
          </div>
        `;
      }
      
      // Players bar
      document.getElementById('game-players-bar').innerHTML = state.players.map(p => {
        const voted = state.votes[p.address];
        return `
          <div class="player-tag ${voted ? 'voted' : ''}">
            <span>${p.avatar}</span>
            <span>${p.name.slice(0, 4)}</span>
            ${voted ? `<span class="vote">${voted}</span>` : ''}
          </div>
        `;
      }).join('');
      
      // Messages
      const msgList = document.getElementById('messages-list');
      msgList.innerHTML = state.messages.map(msg => {
        if (msg.type === 'system') return `<div class="message system">${msg.text}</div>`;
        return `
          <div class="message chat">
            <div class="header">
              <span class="sender">${msg.sender?.avatar || ''} ${msg.sender?.name || ''}</span>
              ${msg.choice ? `<span class="stance ${msg.choice.toLowerCase()}">æ”¯æŒ${msg.choice}</span>` : ''}
            </div>
            <div class="content">${msg.text}</div>
          </div>
        `;
      }).join('');
      msgList.scrollTop = msgList.scrollHeight;
      
      // Chat input / vote prompt
      const chatInput = document.getElementById('chat-input-area');
      const votePrompt = document.getElementById('vote-prompt');
      if (state.phase === 'debate') {
        chatInput.classList.remove('hidden');
        votePrompt.classList.add('hidden');
      } else if (state.phase === 'vote' && !state.myVote) {
        chatInput.classList.add('hidden');
        votePrompt.classList.remove('hidden');
      } else {
        chatInput.classList.add('hidden');
        votePrompt.classList.add('hidden');
      }
    }

    function backToHome() {
      if (timerInterval) clearInterval(timerInterval);
      if (pollInterval) clearInterval(pollInterval);
      state.room = null;
      state.players = [];
      state.round = 0;
      state.phase = 'waiting';
      showView('home');
      checkPlayerStatus();
    }

    // ========== åˆå§‹åŒ– ==========
    function init() {
      // æ¢å¤é’±åŒ…
      const saved = localStorage.getItem('wallet');
      if (saved) {
        try {
          state.wallet = JSON.parse(saved);
        } catch {}
      }
      
      updateWalletUI();
      
      if (state.wallet.address) {
        checkPlayerStatus();
      }
      
      // ç»‘å®šå›è½¦å‘é€
      document.getElementById('chat-text')?.addEventListener('keydown', e => {
        if (e.key === 'Enter') sendMessage();
      });
      
      document.getElementById('reg-name')?.addEventListener('keydown', e => {
        if (e.key === 'Enter') registerPlayer();
      });
    }

    init();
  </script>
</body>
</html>
