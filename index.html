<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…±è¯†ç¼–å¹´å² - Consensus Chronicle</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh;
      color: #e8e8e8;
    }
    .container { max-width: 1000px; margin: 0 auto; padding: 2rem; }
    
    /* é¦–é¡µ */
    .hero { text-align: center; margin-bottom: 3rem; }
    .hero-icon { font-size: 5rem; margin-bottom: 1rem; }
    .hero h1 {
      font-size: 3rem;
      font-weight: 800;
      background: linear-gradient(135deg, #a78bfa, #f472b6, #fb923c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }
    .hero .subtitle { color: #8b8b9e; letter-spacing: 0.3em; text-transform: uppercase; margin-bottom: 1rem; }
    .hero .desc { color: #a5a5b8; font-style: italic; }
    
    /* è¾“å…¥æ¡† */
    .input-group { max-width: 400px; margin: 0 auto 2rem; }
    .input-group input {
      width: 100%;
      padding: 1rem 1.5rem;
      font-size: 1.2rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(167,139,250,0.3);
      border-radius: 12px;
      color: #fff;
      outline: none;
    }
    .input-group input:focus { border-color: rgba(167,139,250,0.6); }
    .input-hint { margin-top: 0.5rem; color: #6b6b7e; font-size: 0.9rem; text-align: center; }
    
    /* ç©å®¶ä¿¡æ¯ */
    .player-info {
      display: inline-flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 2rem;
      background: rgba(167,139,250,0.1);
      border-radius: 50px;
      border: 1px solid rgba(167,139,250,0.3);
      margin-bottom: 2rem;
    }
    .player-info .avatar { font-size: 2rem; }
    .player-info .name { font-size: 1.3rem; font-weight: 600; }
    .player-info .balance { color: #fbbf24; }
    
    /* ä¸»é¢˜é€‰æ‹© */
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }
    .theme-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .theme-card:hover {
      transform: translateY(-5px);
      border-color: rgba(167,139,250,0.5);
    }
    .theme-card .icon { font-size: 3rem; margin-bottom: 1rem; }
    .theme-card .name { font-size: 1.2rem; font-weight: 600; color: #fff; }
    .theme-card .rounds { font-size: 0.85rem; color: #6b6b7e; margin-top: 0.5rem; }
    
    /* æŒ‰é’® */
    .btn {
      padding: 0.8rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #a78bfa, #f472b6);
      color: #fff;
    }
    .btn-primary:hover { transform: scale(1.02); }
    .btn-primary:disabled {
      background: rgba(255,255,255,0.1);
      color: #6b6b7e;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: #a5a5b8;
    }
    
    /* æˆ¿é—´é¡µé¢ */
    .room-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .room-theme { display: flex; align-items: center; gap: 0.5rem; font-size: 1.3rem; }
    .room-id { font-size: 0.9rem; color: #6b6b7e; font-family: monospace; }
    
    .players-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .player-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.5rem 1rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      position: relative;
    }
    .player-card.me {
      background: rgba(167,139,250,0.1);
      border-color: rgba(167,139,250,0.5);
    }
    .player-card .avatar { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .player-card .badge {
      position: absolute;
      top: 0.5rem;
      font-size: 0.6rem;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
    }
    .player-card .badge.ai { left: 0.5rem; background: #3b82f6; }
    .player-card .badge.host { right: 0.5rem; background: #fbbf24; color: #000; }
    .player-card.empty {
      border-style: dashed;
      opacity: 0.4;
    }
    
    /* æ¸¸æˆé¡µé¢ */
    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .round-info { font-size: 0.9rem; color: #8b8b9e; }
    .phase-info { font-size: 1.1rem; font-weight: 600; }
    .timer {
      font-size: 2.5rem;
      font-weight: 700;
      font-family: monospace;
      color: #a78bfa;
    }
    .timer.warning { color: #f87171; }
    .score { text-align: right; }
    .score .label { font-size: 0.85rem; color: #8b8b9e; }
    .score .value { font-size: 1.5rem; font-weight: 700; color: #fbbf24; }
    
    .progress-dots {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .progress-dots .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
    }
    .progress-dots .dot.done { background: #4ade80; }
    .progress-dots .dot.current { background: #a78bfa; }
    
    .game-main {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      height: calc(100vh - 80px);
      overflow: hidden;
    }
    .story-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-width: 0;
    }
    .story-scroll {
      flex: 1;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 1rem;
      overflow-y: auto;
    }
    .story-scroll h3 { color: #c4b5fd; margin-bottom: 1rem; font-size: 1rem; }
    .story-item { padding: 0.6rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); line-height: 1.7; }
    .story-item:last-child { border-bottom: none; }
    .story-item.opening { color: #c4b5fd; font-style: italic; }
    .story-item.context { color: #fbbf24; }
    .story-item .round-tag {
      display: inline-block;
      background: rgba(251,191,36,0.2);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      margin-right: 0.5rem;
    }
    .story-item.choice { color: #4ade80; }
    .story-item.consequence {
      color: #a5a5b8;
      padding-left: 1.5rem;
      border-left: 2px solid rgba(167,139,250,0.3);
    }
    
    .options-panel {
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      padding: 1rem;
    }
    .options-panel h4 { text-align: center; margin-bottom: 1rem; color: #fff; }
    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .option-card {
      padding: 1rem;
      border-radius: 10px;
      border: 2px solid;
      cursor: pointer;
      transition: all 0.3s;
    }
    .option-card.a { border-color: rgba(239,68,68,0.4); background: rgba(239,68,68,0.1); }
    .option-card.b { border-color: rgba(59,130,246,0.4); background: rgba(59,130,246,0.1); }
    .option-card.selected { transform: scale(1.02); }
    .option-card.a.selected { border-color: #ef4444; }
    .option-card.b.selected { border-color: #3b82f6; }
    .option-card .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.8rem;
    }
    .option-card .label { font-weight: 700; font-size: 1.1rem; }
    .option-card.a .label { color: #ef4444; }
    .option-card.b .label { color: #3b82f6; }
    .option-card .tag {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      color: #a5a5b8;
    }
    .option-card .text { line-height: 1.5; font-size: 0.9rem; color: #e8e8e8; }
    .option-card .votes {
      margin-top: 0.8rem;
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
      color: #fbbf24;
    }
    
    .chat-panel {
      width: 320px;
      display: flex;
      flex-direction: column;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      overflow: hidden;
    }
    .chat-players {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      padding: 0.8rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .chat-player {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.3rem 0.6rem;
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      font-size: 0.8rem;
      border: 1px solid transparent;
    }
    .chat-player.voted {
      background: rgba(74,222,128,0.2);
      border-color: rgba(74,222,128,0.4);
    }
    .chat-player .vote { color: #4ade80; font-weight: 700; }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 0.8rem;
    }
    .chat-msg { margin-bottom: 0.6rem; font-size: 0.85rem; }
    .chat-msg.system { color: #a78bfa; font-style: italic; padding: 0.3rem 0; }
    .chat-msg.user {
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 0.5rem 0.8rem;
    }
    .chat-msg .sender { color: #fbbf24; font-weight: 600; margin-bottom: 0.3rem; }
    .chat-msg .stance {
      font-size: 0.7rem;
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      margin-left: 0.5rem;
    }
    .chat-msg .stance.a { background: rgba(239,68,68,0.3); }
    .chat-msg .stance.b { background: rgba(59,130,246,0.3); }
    .chat-input {
      padding: 0.8rem;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .chat-input-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
    .chat-input input {
      flex: 1;
      padding: 0.6rem 0.8rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 0.85rem;
      outline: none;
    }
    .chat-input button {
      padding: 0.6rem 1rem;
      background: linear-gradient(135deg, #a78bfa, #f472b6);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    .quick-btns { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    .quick-btn {
      padding: 0.3rem 0.6rem;
      border-radius: 15px;
      font-size: 0.75rem;
      cursor: pointer;
      border: 1px solid;
    }
    .quick-btn.a { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); color: #ef4444; }
    .quick-btn.b { background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); color: #3b82f6; }
    .quick-btn.neutral { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); color: #a5a5b8; }
    
    .vote-prompt {
      padding: 1rem;
      text-align: center;
      background: rgba(167,139,250,0.1);
      color: #fbbf24;
      font-weight: 600;
    }
    
    /* ç»“æŸé¡µé¢ */
    .end-panel {
      background: linear-gradient(145deg, rgba(251,191,36,0.1), rgba(167,139,250,0.1));
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
    }
    .end-panel h2 { font-size: 1.8rem; margin-bottom: 1.5rem; color: #fbbf24; }
    .rank-list { max-width: 400px; margin: 0 auto 1.5rem; }
    .rank-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.8rem;
      margin-bottom: 0.4rem;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
    }
    .rank-item.first {
      background: rgba(251,191,36,0.2);
      border: 1px solid rgba(251,191,36,0.3);
    }
    .rank-item .rank { font-weight: 700; width: 1.5rem; }
    .rank-item .rank.top { color: #fbbf24; }
    .rank-item .rank.normal { color: #6b6b7e; }
    .rank-item .avatar { font-size: 1.3rem; }
    .rank-item .name { flex: 1; color: #fff; }
    .rank-item .score { font-weight: 600; color: #a78bfa; }
    
    /* æ’è¡Œæ¦œ */
    .leaderboard {
      background: rgba(255,255,255,0.03);
      border-radius: 16px;
      padding: 1.5rem;
    }
    .leaderboard h3 {
      font-size: 1.3rem;
      color: #fbbf24;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .leaderboard-empty {
      color: #6b6b7e;
      text-align: center;
      padding: 2rem;
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 2rem;
      color: #a78bfa;
    }
    .loading::after {
      content: '';
      width: 20px;
      height: 20px;
      border: 2px solid #a78bfa;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* é’±åŒ…è®¾ç½® */
    .wallet-setup {
      max-width: 500px;
      margin: 2rem auto;
      padding: 1.5rem;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
    }
    .wallet-setup h3 { margin-bottom: 1rem; color: #c4b5fd; }
    .wallet-setup label { display: block; margin-bottom: 0.5rem; color: #8b8b9e; }
    .wallet-setup input {
      width: 100%;
      padding: 0.8rem;
      margin-bottom: 1rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #fff;
      outline: none;
    }
    .wallet-setup .warning {
      padding: 0.8rem;
      background: rgba(251,191,36,0.1);
      border: 1px solid rgba(251,191,36,0.3);
      border-radius: 8px;
      color: #fbbf24;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>

<!-- ========== é¦–é¡µ ========== -->
<div id="home-view" class="container">
  <div class="hero">
    <div class="hero-icon">ğŸ“œ</div>
    <h1>å…±è¯†ç¼–å¹´å²</h1>
    <p class="subtitle">Consensus Chronicle</p>
    <p class="desc">å…±è¯†å¦‚ä½•å¡‘é€ å†å²ï¼Ÿä½ çš„é€‰æ‹©å°†æ”¹å†™å‘½è¿ã€‚</p>
  </div>
  
  <!-- æœªç™»å½•çŠ¶æ€ -->
  <div id="login-section">
    <div class="input-group">
      <input type="text" id="player-name-input" placeholder="è¾“å…¥ä½ çš„åå­—å¼€å§‹å†’é™©...">
      <p class="input-hint">æŒ‰ Enter ç¡®è®¤</p>
    </div>
    
    <div class="wallet-setup">
      <h3>ğŸ”‘ é’±åŒ…è®¾ç½®ï¼ˆå¯é€‰ï¼‰</h3>
      <div class="warning">âš ï¸ ç§é’¥ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œä¸ä¼šä¸Šä¼ æœåŠ¡å™¨</div>
      <label>ç§é’¥ï¼ˆç”¨äºé“¾ä¸Šäº¤äº’ï¼‰ï¼š</label>
      <input type="password" id="private-key-input" placeholder="0x...ï¼ˆä¸å¡«åˆ™ä½¿ç”¨æœ¬åœ°æ¨¡å¼ï¼‰">
    </div>
  </div>
  
  <!-- å·²ç™»å½•çŠ¶æ€ -->
  <div id="logged-in-section" class="hidden" style="text-align: center;">
    <div class="player-info">
      <span class="avatar" id="my-avatar">ğŸ®</span>
      <span class="name" id="my-name"></span>
      <span class="balance">ğŸ’° <span id="my-balance">100</span> GLT</span>
    </div>
    
    <h2 style="font-size: 1.5rem; color: #c4b5fd; margin-bottom: 1.5rem;">é€‰æ‹©ä¸»é¢˜ï¼Œå¼€å¯å†’é™©</h2>
    <div class="theme-grid" id="theme-grid"></div>
    
    <div class="leaderboard">
      <h3>ğŸ† ç¼–å¹´å²æ’è¡Œæ¦œ</h3>
      <div id="leaderboard-content"></div>
    </div>
  </div>
</div>

<!-- ========== æˆ¿é—´é¡µé¢ ========== -->
<div id="room-view" class="container hidden">
  <div class="room-header">
    <button class="btn btn-secondary" onclick="goHome()">â† è¿”å›</button>
    <div class="room-theme">
      <span id="room-theme-icon"></span>
      <span id="room-theme-name"></span>
    </div>
    <span class="room-id" id="room-id-display"></span>
  </div>
  
  <h3 style="font-size: 1.1rem; color: #8b8b9e; margin-bottom: 1rem;">
    ç©å®¶ (<span id="player-count">0</span>/8)
  </h3>
  <div class="players-grid" id="players-grid"></div>
  
  <button id="start-game-btn" class="btn btn-primary" style="width: 100%;" onclick="startGame()" disabled>
    ç­‰å¾…æ›´å¤šç©å®¶ (0/2)
  </button>
  
  <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(255,255,255,0.03); border-radius: 12px;">
    <h4 style="margin-bottom: 1rem; color: #c4b5fd;">ğŸ“– æ¸¸æˆæµç¨‹</h4>
    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
      <div style="text-align: center; padding: 0.5rem; background: rgba(167,139,250,0.1); border-radius: 8px;">
        <div style="font-size: 1.2rem; font-weight: 700; color: #a78bfa;">ç¬¬1è½®</div>
        <div style="font-size: 0.7rem; color: #8b8b9e;">è¾©è®ºâ†’æŠ•ç¥¨</div>
      </div>
      <div style="text-align: center; padding: 0.5rem; background: rgba(167,139,250,0.1); border-radius: 8px;">
        <div style="font-size: 1.2rem; font-weight: 700; color: #a78bfa;">ç¬¬2è½®</div>
        <div style="font-size: 0.7rem; color: #8b8b9e;">è¾©è®ºâ†’æŠ•ç¥¨</div>
      </div>
      <div style="text-align: center; padding: 0.5rem; background: rgba(167,139,250,0.1); border-radius: 8px;">
        <div style="font-size: 1.2rem; font-weight: 700; color: #a78bfa;">ç¬¬3è½®</div>
        <div style="font-size: 0.7rem; color: #8b8b9e;">è¾©è®ºâ†’æŠ•ç¥¨</div>
      </div>
      <div style="text-align: center; padding: 0.5rem; background: rgba(167,139,250,0.1); border-radius: 8px;">
        <div style="font-size: 1.2rem; font-weight: 700; color: #a78bfa;">ç¬¬4è½®</div>
        <div style="font-size: 0.7rem; color: #8b8b9e;">è¾©è®ºâ†’æŠ•ç¥¨</div>
      </div>
      <div style="text-align: center; padding: 0.5rem; background: rgba(167,139,250,0.1); border-radius: 8px;">
        <div style="font-size: 1.2rem; font-weight: 700; color: #a78bfa;">ç¬¬5è½®</div>
        <div style="font-size: 0.7rem; color: #8b8b9e;">è¾©è®ºâ†’æŠ•ç¥¨</div>
      </div>
    </div>
    <ul style="list-style: none; color: #a5a5b8; font-size: 0.9rem;">
      <li style="padding: 0.3rem 0;">ğŸ’¬ <b>è¾©è®ºé˜¶æ®µ</b>: è¾“å…¥ä½ çš„è§‚ç‚¹ï¼Œè¯´æœå…¶ä»–ç©å®¶</li>
      <li style="padding: 0.3rem 0;">ğŸ—³ï¸ <b>æŠ•ç¥¨é˜¶æ®µ</b>: é€‰æ‹©ä½ æ”¯æŒçš„é€‰é¡¹</li>
      <li style="padding: 0.3rem 0;">ğŸ“œ <b>æ•…äº‹å»¶ç»­</b>: è·èƒœé€‰é¡¹å†³å®šæ•…äº‹èµ°å‘</li>
      <li style="padding: 0.3rem 0;">ğŸ† <b>æ’è¡Œæ¦œ</b>: æ ¹æ®è¾©è®ºå’ŒæŠ•ç¥¨è·å¾—ç§¯åˆ†</li>
    </ul>
  </div>
</div>

<!-- ========== æ¸¸æˆé¡µé¢ ========== -->
<div id="game-view" class="hidden">
  <div class="game-header">
    <div>
      <div class="round-info">ç¬¬ <span id="current-round">1</span> / 5 è½®</div>
      <div class="phase-info" id="phase-display">ğŸ’¬ è¾©è®ºä¸­</div>
    </div>
    <div class="progress-dots" id="progress-dots"></div>
    <div class="timer" id="timer-display">1:30</div>
    <div class="score">
      <div class="label">æˆ‘çš„ç§¯åˆ†</div>
      <div class="value" id="my-score">0</div>
    </div>
  </div>
  
  <div class="game-main">
    <!-- å·¦ä¾§ï¼šæ•…äº‹é¢æ¿ -->
    <div class="story-panel">
      <div class="story-scroll" id="story-scroll">
        <h3>ğŸ“œ <span id="story-theme-name">å¥‡å¹»å†’é™©</span> - æ•…äº‹è¿›ç¨‹</h3>
        <div id="story-content"></div>
      </div>
      
      <div class="options-panel" id="options-panel">
        <h4>âš”ï¸ æœ¬è½®æŠ‰æ‹©</h4>
        <div class="options-grid">
          <div class="option-card a" id="option-a" onclick="selectOption('A')">
            <div class="header">
              <span class="label">é€‰é¡¹ A</span>
              <span class="tag" id="tag-a"></span>
            </div>
            <p class="text" id="text-a"></p>
            <div class="votes hidden" id="votes-a">0 ç¥¨</div>
          </div>
          <div class="option-card b" id="option-b" onclick="selectOption('B')">
            <div class="header">
              <span class="label">é€‰é¡¹ B</span>
              <span class="tag" id="tag-b"></span>
            </div>
            <p class="text" id="text-b"></p>
            <div class="votes hidden" id="votes-b">0 ç¥¨</div>
          </div>
        </div>
      </div>
      
      <!-- ç»“æŸé¢æ¿ -->
      <div class="end-panel hidden" id="end-panel">
        <h2>ğŸ† ç¼–å¹´å²å®Œæˆï¼</h2>
        <div class="rank-list" id="final-ranks"></div>
        <button class="btn btn-primary" onclick="goHome()">è¿”å›å¤§å…</button>
      </div>
    </div>
    
    <!-- å³ä¾§ï¼šèŠå¤©é¢æ¿ -->
    <div class="chat-panel">
      <div class="chat-players" id="chat-players"></div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="chat-input" id="chat-input">
        <div class="chat-input-row">
          <input type="text" id="chat-text" placeholder="è¾“å…¥ä½ çš„è§‚ç‚¹... (æåŠAæˆ–Bè·å¾—ç«‹åœºæ ‡ç­¾)">
          <button onclick="sendChat()">å‘é€</button>
        </div>
        <div class="quick-btns">
          <button class="quick-btn a" onclick="quickChat('æˆ‘æ”¯æŒé€‰é¡¹Aï¼Œå› ä¸º')">ğŸ…°ï¸ æ”¯æŒA</button>
          <button class="quick-btn b" onclick="quickChat('æˆ‘æ”¯æŒé€‰é¡¹Bï¼Œå› ä¸º')">ğŸ…±ï¸ æ”¯æŒB</button>
          <button class="quick-btn neutral" onclick="quickChat('æˆ‘è®¤ä¸ºæˆ‘ä»¬åº”è¯¥è€ƒè™‘')">ğŸ’­ è§‚ç‚¹</button>
        </div>
      </div>
      <div class="vote-prompt hidden" id="vote-prompt">â° è¯·åœ¨å·¦ä¾§é€‰æ‹©ä½ æ”¯æŒçš„é€‰é¡¹ï¼</div>
    </div>
  </div>
</div>

<script>
// ========== æ•…äº‹æ•°æ® ==========
const STORY_ARCS = {
  fantasy: {
    name: 'å¥‡å¹»å†’é™©',
    icon: 'ğŸ°',
    opening: 'å¤è€çš„é¢„è¨€ç»ˆäºåº”éªŒâ€”â€”æ²‰ç¡åƒå¹´çš„é»‘é¾™è‹é†’äº†ã€‚ç‹å›½å±åœ¨æ—¦å¤•ï¼Œå›½ç‹ç´§æ€¥å¬é›†äº†å„åœ°è‹±é›„å•†è®®å¯¹ç­–...',
    rounds: [
      {
        context: 'é»‘é¾™çš„å¨èƒè¿«åœ¨çœ‰ç«ï¼Œç‹å›½å¿…é¡»åšå‡ºç¬¬ä¸€ä¸ªå…³é”®å†³å®šã€‚',
        a: { text: 'ç«‹å³é›†ç»“å†›é˜Ÿï¼Œä¸»åŠ¨å‡ºå‡»é¾™å·¢ï¼Œåœ¨å®ƒå®Œå…¨è‹é†’å‰å°†å…¶æ¶ˆç­ã€‚', tag: 'å…ˆå‘åˆ¶äººÂ·æ¿€è¿›', consequence: 'ç‹å›½å†›é˜Ÿå‘é¾™å·¢è¿›å‘ï¼Œä½†é€”ä¸­é­é‡äº†é¾™çš„çˆªç‰™ï¼ŒæŸå¤±æƒ¨é‡...' },
        b: { text: 'æ´¾é£ä½¿è€…å¯»æ±‚ç²¾çµæ—çš„å¸®åŠ©ï¼Œä»–ä»¬æ›¾åœ¨åƒå¹´å‰å°å°è¿‡é»‘é¾™ã€‚', tag: 'å¯»æ±‚è”ç›ŸÂ·ç¨³å¥', consequence: 'ä½¿è€…æˆåŠŸè”ç³»åˆ°äº†ç²¾çµæ—ï¼Œä½†ä»–ä»¬æå‡ºäº†è‹›åˆ»çš„æ¡ä»¶...' },
      },
      {
        contextA: 'å†›é˜ŸæŸå¤±æƒ¨é‡ï¼Œä½†å·²é€¼è¿‘é¾™å·¢ã€‚æ­¤æ—¶æ¢å­æ¥æŠ¥ï¼šé¾™å·¢å†…å‘ç°äº†é¾™è›‹ã€‚',
        contextB: 'ç²¾çµæ—è¦æ±‚äººç±»äº¤å‡ºåœ£å‰‘ä½œä¸ºä¿¡ä»»çš„è¯æ˜ï¼Œå¦åˆ™ä¸äºˆæ´åŠ©ã€‚',
        a: { text: 'æ‘§æ¯é¾™è›‹ï¼Œå½»åº•æ–­ç»é»‘é¾™ä¸€æ—çš„è¡€è„‰ï¼Œæ°¸é™¤åæ‚£ã€‚', tag: 'æ–©è‰é™¤æ ¹Â·æ®‹é…·', consequence: 'é¾™è›‹è¢«æ¯ï¼Œé»‘é¾™ç‹‚æ€’ï¼Œæˆ˜æ–—æ›´åŠ æƒ¨çƒˆ...' },
        b: { text: 'ä¿ç•™é¾™è›‹ï¼Œæˆ–è®¸å¯ä»¥ç”¨å®ƒä¸é»‘é¾™è°ˆåˆ¤ï¼Œæˆ–åŸ¹å…»ä¸€æ¡å‹å–„çš„é¾™ã€‚', tag: 'ç•™æœ‰ä½™åœ°Â·å†’é™©', consequence: 'é¾™è›‹è¢«ç§˜å¯†ä¿æŠ¤èµ·æ¥ï¼Œä½†æ¶ˆæ¯æ³„éœ²å¼•å‘äº†å†…éƒ¨åˆ†è£‚...' },
      },
      {
        context: 'å±€åŠ¿æ„ˆå‘ç´§å¼ ï¼Œæ‰€æœ‰äººéƒ½åœ¨ç­‰å¾…æœ€ç»ˆçš„å†³æ–­ã€‚',
        a: { text: 'ä½¿ç”¨ç¦å¿Œé­”æ³•ï¼Œç‰ºç‰²æ–½æ³•è€…çš„ç”Ÿå‘½æ¥é‡åˆ›é»‘é¾™ã€‚', tag: 'ç‰ºç‰²å°æˆ‘Â·æ‚²å£®', consequence: 'ç¦å¿Œé­”æ³•ç”Ÿæ•ˆï¼Œé»‘é¾™é‡ä¼¤å è½ï¼Œä½†ä»£ä»·æ˜¯æƒ¨é‡çš„...' },
        b: { text: 'ä¸‹ä»¤æ’¤é€€ï¼Œä¿å­˜å®åŠ›ï¼Œç­‰å¾…æ›´å¥½çš„æ—¶æœºå†æˆ˜ã€‚', tag: 'ä»¥é€€ä¸ºè¿›Â·å¿è€', consequence: 'å†›é˜Ÿæ’¤é€€åˆ°å®‰å…¨åœ°å¸¦ï¼Œä½†é»‘é¾™è¶æœºæ‘§æ¯äº†æ•°ä¸ªæ‘åº„...' },
      },
      {
        contextA: 'é»‘é¾™é‡ä¼¤åé€€å›å·¢ç©´ç–—ä¼¤ï¼Œä½†å®ƒçš„æ„¤æ€’ä½¿å¾—æ•´ä¸ªåŒºåŸŸéƒ½ç¬¼ç½©åœ¨æ­»äº¡æ°”æ¯ä¸­ã€‚',
        contextB: 'æ’¤é€€åï¼Œç‹å›½å¼€å§‹åæ€ç­–ç•¥ï¼Œæ°‘é—´å‡ºç°äº†å„ç§å£°éŸ³å’ŒåŠ¿åŠ›ã€‚',
        a: { text: 'è¶é»‘é¾™ç–—ä¼¤æœŸé—´å‘èµ·æ€»æ”»ï¼Œä¸€ä¸¾å°†å…¶æ¶ˆç­ã€‚', tag: 'ä¹˜èƒœè¿½å‡»Â·å†³ç»', consequence: 'æ€»æ”»å¼€å§‹ï¼Œè¿™å°†æ˜¯å†³å®šç‹å›½å‘½è¿çš„æœ€åä¸€æˆ˜...' },
        b: { text: 'å°è¯•ä¸å—ä¼¤çš„é»‘é¾™æ²Ÿé€šï¼Œå¯»æ‰¾å’Œå¹³å…±å­˜çš„å¯èƒ½ã€‚', tag: 'åŒ–æ•Œä¸ºå‹Â·ç†æƒ³', consequence: 'ä½¿è€…å†’æ­»æ¥è¿‘é»‘é¾™ï¼Œå‡ºä¹æ„æ–™åœ°ï¼Œé»‘é¾™æ„¿æ„å¯¹è¯...' },
      },
      {
        contextA: 'æœ€ç»ˆå†³æˆ˜ä¸­ï¼ŒåŒæ–¹éƒ½ä»˜å‡ºäº†æƒ¨é‡ä»£ä»·ï¼Œèƒœè´Ÿå³å°†æ­æ™“ã€‚',
        contextB: 'é»‘é¾™é€éœ²å®ƒè‹é†’æ˜¯å› ä¸ºæ„Ÿå—åˆ°äº†æ›´å¤§çš„å¨èƒâ€”â€”æ¥è‡ªæ·±æ¸Šçš„é‚ªç¥å³å°†é™ä¸´ã€‚',
        a: { text: 'ä¸æƒœä¸€åˆ‡ä»£ä»·æ¶ˆç­é»‘é¾™ï¼Œå“ªæ€•ç‹å›½åŒ–ä¸ºç„¦åœŸä¹Ÿåœ¨æ‰€ä¸æƒœã€‚', tag: 'ç‰çŸ³ä¿±ç„šÂ·æç«¯', ending: 'é»‘é¾™è¢«æ¶ˆç­ï¼Œä½†ç‹å›½ä¹Ÿå‡ ä¹åŒ–ä¸ºåºŸå¢Ÿã€‚å¹¸å­˜è€…å¼€å§‹äº†æ¼«é•¿çš„é‡å»ºä¹‹è·¯ï¼Œå†å²å°†é“­è®°è¿™åœºæƒ¨èƒœã€‚' },
        b: { text: 'æ¥å—å‘½è¿çš„å®‰æ’ï¼Œä¸é»‘é¾™è¾¾æˆåè®®ï¼Œå…±åŒé¢å¯¹æœªæ¥çš„æŒ‘æˆ˜ã€‚', tag: 'æ¡æ‰‹è¨€å’ŒÂ·æ™ºæ…§', ending: 'äººç±»ä¸é»‘é¾™è¾¾æˆäº†å‰æ‰€æœªæœ‰çš„ç›Ÿçº¦ï¼Œå…±åŒå®ˆæŠ¤è¿™ç‰‡å¤§é™†ã€‚ä¸€ä¸ªæ–°çš„æ—¶ä»£å°±æ­¤å¼€å¯ã€‚' },
      },
    ],
  },
  scifi: {
    name: 'ç§‘å¹»æœªæ¥',
    icon: 'ğŸš€',
    opening: '2157å¹´ï¼Œç«æ˜Ÿæ®–æ°‘åœ°"æ–°å¸Œæœ›"æ”¶åˆ°äº†ä¸€æ®µæ¥è‡ªæ·±ç©ºçš„ç¥ç§˜ä¿¡å·ã€‚ç§‘å­¦å®¶ä»¬ç ´è¯‘åå‘ç°ï¼šè¿™æ˜¯ä¸€ä¸ªè­¦å‘Šâ€”â€”åœ°çƒå°†åœ¨100å¤©åè¢«å°è¡Œæ˜Ÿæ’å‡»ã€‚ç„¶è€Œï¼Œæ®–æ°‘åœ°çš„èµ„æºåªå¤Ÿæ•‘ä¸€åŠäºº...',
    rounds: [
      {
        context: 'æ¶ˆæ¯å…¬å¸ƒåï¼Œæ®–æ°‘åœ°é™·å…¥ææ…Œã€‚é¢†å¯¼å±‚å¿…é¡»ç«‹å³åšå‡ºå†³å®šã€‚',
        a: { text: 'ç«‹å³å¯åŠ¨"æ–¹èˆŸè®¡åˆ’"ï¼Œé€šè¿‡æŠ½ç­¾å†³å®šè°èƒ½ç™»ä¸Šé€ƒç”Ÿé£èˆ¹ã€‚', tag: 'å…¬å¹³æŠ½ç­¾Â·å†·é…·', consequence: 'æŠ½ç­¾ç»“æœå…¬å¸ƒï¼Œè½é€‰è€…å¼€å§‹ç»æœ›åœ°æŠ—è®®ï¼Œå®‰ä¿éƒ¨é˜Ÿè¢«è¿«ä»‹å…¥...' },
        b: { text: 'é›†ä¸­æ‰€æœ‰èµ„æºç ”ç©¶ä¿¡å·æ¥æºï¼Œä¹Ÿè®¸é‚£é‡Œæœ‰æ‹¯æ•‘æ‰€æœ‰äººçš„ç­”æ¡ˆã€‚', tag: 'è¿½å¯»å¸Œæœ›Â·å†’é™©', consequence: 'ç ”ç©¶å›¢é˜Ÿå‘ç°ä¿¡å·æ¥è‡ªä¸€ä¸ªæœªçŸ¥æ–‡æ˜ï¼Œä»–ä»¬ä¼¼ä¹åœ¨é‚€è¯·äººç±»...' },
      },
      {
        contextA: 'æŠ—è®®æ¼”å˜ä¸ºæš´åŠ¨ï¼Œéƒ¨åˆ†è½é€‰è€…å é¢†äº†é£èˆ¹å‘å°„åŒºã€‚',
        contextB: 'æ·±å…¥åˆ†æä¿¡å·åï¼Œå‘ç°é‚£ä¸ªæ–‡æ˜åœ¨é‚€è¯·äººç±»å»ä¸€ä¸ªé¥è¿œçš„æ˜Ÿç³»ï¼Œä½†æ—…ç¨‹éœ€è¦500å¹´ã€‚',
        a: { text: 'æˆæƒå®‰ä¿éƒ¨é˜Ÿä½¿ç”¨æ­¦åŠ›ï¼Œç¡®ä¿æ–¹èˆŸè®¡åˆ’æŒ‰æ—¶æ‰§è¡Œã€‚', tag: 'é“è…•é•‡å‹Â·æ•ˆç‡', consequence: 'æš´åŠ¨è¢«é•‡å‹ï¼Œä½†è®¸å¤šäººåœ¨å†²çªä¸­ä¸§ç”Ÿï¼Œå¹¸å­˜è€…å¿ƒå­˜æ€¨æ¨...' },
        b: { text: 'ä¸æŠ—è®®è€…è°ˆåˆ¤ï¼Œå°è¯•ä¿®æ”¹è®¡åˆ’è®©æ›´å¤šäººè·å¾—ç”Ÿå­˜æœºä¼šã€‚', tag: 'å¯»æ±‚å…±è¯†Â·äººé“', consequence: 'è°ˆåˆ¤å–å¾—è¿›å±•ï¼Œå·¥ç¨‹å¸ˆæå‡ºå¯ä»¥è¶…è½½é£èˆ¹ï¼Œä½†é£é™©æå¤§...' },
      },
      {
        context: 'æ—¶é—´ç´§è¿«ï¼Œæ¯ä¸€ä¸ªå†³å®šéƒ½å¯èƒ½å½±å“äººç±»çš„å­˜äº¡ã€‚',
        a: { text: 'æ¥å—è¶…è½½æ–¹æ¡ˆï¼Œç”¨60%çš„æˆåŠŸç‡æ¢å–æ›´å¤šäººçš„å¸Œæœ›ã€‚', tag: 'å†’é™©æ±‚å…¨Â·èµŒåš', consequence: 'è¶…è½½æ–¹æ¡ˆå¯åŠ¨ï¼Œæ‰€æœ‰äººéƒ½åœ¨ç¥ˆç¥·å¥‡è¿¹å‘ç”Ÿ...' },
        b: { text: 'ç»´æŒåŸè®¡åˆ’ï¼Œç¡®ä¿è‡³å°‘ä¸€åŠäººèƒ½å¤Ÿç¡®å®šå­˜æ´»ã€‚', tag: 'ç¨³å¦¥æ±‚å­˜Â·ç°å®', consequence: 'åŸè®¡åˆ’ç»§ç»­æ‰§è¡Œï¼Œä½†ç¤¾ä¼šçš„è£‚ç—•å·²æ— æ³•å¼¥åˆ...' },
      },
      {
        contextA: 'é£èˆ¹èµ·é£å‰ï¼ŒAIç³»ç»Ÿæ£€æµ‹åˆ°ä¸€ä¸ªæƒŠäººçš„å¯èƒ½æ€§ï¼šå°è¡Œæ˜Ÿçš„è½¨é“å¯ä»¥è¢«äººä¸ºæ”¹å˜ã€‚',
        contextB: 'å‘å°„å‡†å¤‡å®Œæˆæ—¶ï¼Œå…ˆé£é˜Ÿçªç„¶ä¼ æ¥æ¶ˆæ¯ï¼šå¤–æ˜Ÿæ–‡æ˜å¯ä»¥æä¾›æŠ€æœ¯æ‘§æ¯å°è¡Œæ˜Ÿï¼Œä½†éœ€è¦äººç±»æ”¾å¼ƒæ­¦å™¨ã€‚',
        a: { text: 'å°è¯•æ”¹å˜å°è¡Œæ˜Ÿè½¨é“ï¼Œå³ä½¿å¤±è´¥ä¹Ÿå€¼å¾—ä¸€è¯•ã€‚', tag: 'é€†å¤©æ”¹å‘½Â·è‹±é›„', consequence: 'å…¨æ®–æ°‘åœ°çš„èƒ½æºè¢«é›†ä¸­ç”¨äºè¿™ä¸ªå¤§èƒ†çš„è®¡åˆ’...' },
        b: { text: 'æŒ‰åŸè®¡åˆ’æ’¤ç¦»ï¼Œä¸è¦æŠŠæ‰€æœ‰é¸¡è›‹æ”¾åœ¨ä¸€ä¸ªç¯®å­é‡Œã€‚', tag: 'åˆ†æ•£é£é™©Â·è°¨æ…', consequence: 'é£èˆ¹å¼€å§‹æ’¤ç¦»ï¼Œä½†ç•™ä¸‹çš„äººæ²¡æœ‰æ”¾å¼ƒå¸Œæœ›...' },
      },
      {
        contextA: 'æ”¹å˜è½¨é“çš„å°è¯•æ¶ˆè€—äº†80%çš„èƒ½æºï¼Œå°è¡Œæ˜Ÿåç§»äº†ï¼Œä½†ä¸å¤Ÿâ€”â€”å®ƒä»ä¼šæ“¦è¿‡åœ°çƒå¤§æ°”å±‚ï¼Œé€ æˆå·¨å¤§ç¾éš¾ã€‚',
        contextB: 'å¤–æ˜Ÿæ–‡æ˜çš„æŠ€æœ¯ç¡®å®æœ‰æ•ˆï¼Œä½†ä»–ä»¬è¦æ±‚äººç±»å¿…é¡»å…ˆé”€æ¯æ‰€æœ‰æ ¸æ­¦å™¨ä½œä¸º"å…¥ä¼šè´¹"ã€‚',
        a: { text: 'æ”¾æ‰‹ä¸€æï¼Œç”¨å‰©ä½™èƒ½æºå†æ¨ä¸€æ¬¡ï¼Œè¦ä¹ˆå…¨èµ¢ï¼Œè¦ä¹ˆå…¨è¾“ã€‚', tag: 'èƒŒæ°´ä¸€æˆ˜Â·æé™', ending: 'å¥‡è¿¹å‘ç”Ÿäº†ï¼å°è¡Œæ˜Ÿåœ¨æœ€åä¸€åˆ»åç¦»äº†æ’å‡»è½¨é“ã€‚äººç±»ç”¨å‹‡æ°”å’Œå›¢ç»“æˆ˜èƒœäº†å‘½è¿ï¼Œè¿™ä¸€å¤©è¢«æ°¸è¿œé“­è®°ä¸º"æ–°å¸Œæœ›æ—¥"ã€‚' },
        b: { text: 'æ¥å—éƒ¨åˆ†æŸå¤±ï¼Œå¼€å§‹ç¾åé‡å»ºè®¡åˆ’ï¼Œäººç±»å°†æµ´ç«é‡ç”Ÿã€‚', tag: 'åŠ¡å®é¢å¯¹Â·é‡ç”Ÿ', ending: 'å°è¡Œæ˜Ÿæ“¦è¿‡åœ°çƒï¼Œé€ æˆäº†ä¸¥é‡ä½†éæ¯ç­æ€§çš„ç¾éš¾ã€‚å¹¸å­˜çš„äººç±»å¼€å§‹äº†è‰°éš¾çš„é‡å»ºï¼Œä½†ä»–ä»¬çŸ¥é“ï¼Œåªè¦äººç±»è¿˜åœ¨ï¼Œå¸Œæœ›å°±åœ¨ã€‚' },
      },
    ],
  },
  mystery: {
    name: 'æ‚¬ç–‘æ¨ç†',
    icon: 'ğŸ”',
    opening: 'æš´é£é›¨ä¹‹å¤œï¼Œå¯Œè±ªé™ˆå®¶çš„å®¶ä¸»é™ˆè€çˆ·åœ¨ä¹¦æˆ¿è¢«äººæ¯’æ€ã€‚å¤§é—¨ä»å†…åé”ï¼Œçª—æˆ·å®Œå¥½æ— æŸã€‚åœ¨åœºçš„æœ‰ï¼šå¤§å„¿å­é™ˆæ˜ã€äºŒå¥³å„¿é™ˆæœˆã€ç®¡å®¶è€å¼ ã€å¥³ä»†å°èŠ³ï¼Œä»¥åŠåˆšåˆ°è®¿çš„ç¥ç§˜å•†äººæå…ˆç”Ÿã€‚æ¯ä¸ªäººä¼¼ä¹éƒ½æœ‰å«Œç–‘ï¼Œæ¯ä¸ªäººéƒ½æœ‰ç§˜å¯†...',
    rounds: [
      {
        context: 'è­¦æ–¹å°é”äº†å®…é‚¸ï¼Œæ‰€æœ‰äººéƒ½ä¸èƒ½ç¦»å¼€ã€‚ä½œä¸ºè¢«é‚€è¯·æ¥çš„ä¾¦æ¢ï¼Œä½ å¿…é¡»å¼€å§‹è°ƒæŸ¥ã€‚',
        a: { text: 'é¦–å…ˆæœæŸ¥æ­»è€…çš„ä¹¦æˆ¿ï¼Œå¯»æ‰¾ç‰©è¯å’Œçº¿ç´¢ã€‚', tag: 'ç‰©è¯ä¼˜å…ˆÂ·ç³»ç»Ÿ', consequence: 'åœ¨ä¹¦æˆ¿å‘ç°äº†ä¸€å°è¢«çƒ§æ¯ä¸€åŠçš„ä¿¡ä»¶ï¼Œéšçº¦å¯è§"èƒŒå›"å’Œ"é—äº§"å­—æ ·...' },
        b: { text: 'åˆ†åˆ«è¯¢é—®åœ¨åœºæ¯ä¸ªäººï¼Œè§‚å¯Ÿä»–ä»¬çš„ååº”å’Œæ¼æ´ã€‚', tag: 'å¯Ÿè¨€è§‚è‰²Â·ç›´è§‰', consequence: 'è¯¢é—®ä¸­å‘ç°ç®¡å®¶è€å¼ ç¥è‰²æ…Œå¼ ï¼Œè€Œé™ˆæœˆæåˆ°çˆ¶äº²æœ€è¿‘æ”¶åˆ°è¿‡å¨èƒä¿¡...' },
      },
      {
        contextA: 'ä¿¡ä»¶æ˜¾ç¤ºé™ˆè€çˆ·æ›¾æ‰“ç®—æ›´æ”¹é—å˜±ï¼Œå‰¥å¤ºæŸäººçš„ç»§æ‰¿æƒã€‚',
        contextB: 'è¿›ä¸€æ­¥è°ƒæŸ¥å‘ç°ï¼Œå¨èƒä¿¡æ¥è‡ªä¸€ä¸ªç¥ç§˜ç»„ç»‡ï¼Œè€Œæå…ˆç”Ÿä¼¼ä¹ä¸è¿™ä¸ªç»„ç»‡æœ‰å…³è”ã€‚',
        a: { text: 'æ·±å…¥è°ƒæŸ¥é—äº§é—®é¢˜ï¼Œè¿½æŸ¥è°æ˜¯è¢«å‰¥å¤ºç»§æ‰¿æƒçš„äººã€‚', tag: 'è¿½è¸ªé‡‘é’±Â·ç°å®', consequence: 'å‘ç°é™ˆæ˜æ¬ ä¸‹å·¨é¢èµŒå€ºï¼Œè€Œé™ˆæœˆä¸€ç›´åœ¨ç§˜å¯†èµ„åŠ©ä¸€ä¸ªæ…ˆå–„æœºæ„...' },
        b: { text: 'è°ƒæŸ¥æå…ˆç”Ÿçš„èº«ä»½å’Œæ¥å†ï¼Œä»–çš„å‡ºç°å¤ªè¿‡å·§åˆã€‚', tag: 'è¿½æŸ¥å¤–äººÂ·æ€€ç–‘', consequence: 'æå…ˆç”Ÿçš„èº«ä»½è¢«æ­éœ²ï¼šä»–æ˜¯é™ˆè€çˆ·å¤±æ•£å¤šå¹´çš„ç§ç”Ÿå­...' },
      },
      {
        context: 'æ¡ˆæƒ…è¶Šæ¥è¶Šå¤æ‚ï¼ŒçœŸç›¸ä¼¼ä¹å°±åœ¨çœ¼å‰å´åˆæ‰‘æœ”è¿·ç¦»ã€‚',
        a: { text: 'éªŒè¯å°èŠ³çš„è¯è¯ï¼Œå¥¹å¯èƒ½æ˜¯å…³é”®è¯äººï¼Œä¹Ÿå¯èƒ½æ˜¯åŒè°‹ã€‚', tag: 'è´¨ç–‘è¯è¯Â·ç»†è‡´', consequence: 'å‹åŠ›ä¹‹ä¸‹ï¼Œå°èŠ³å´©æºƒäº†ï¼Œæ‰¿è®¤é™ˆæ˜æ›¾å¨èƒå¥¹ä½œä¼ªè¯...' },
        b: { text: 'è°ƒæŸ¥é™ˆå¹´æ—§æ¡ˆï¼Œä¹Ÿè®¸è¿‡å»çš„ç§˜å¯†èƒ½æ­ç¤ºç°åœ¨çš„çœŸç›¸ã€‚', tag: 'è¿½æº¯è¿‡å»Â·è€å¿ƒ', consequence: 'æ—§æ¡ˆçš„çº¿ç´¢æŒ‡å‘20å¹´å‰çš„ä¸€åœºç«ç¾ï¼Œé™ˆè€çˆ·çš„åŸé…å¦»å­åœ¨é‚£åœºç«ç¾ä¸­èº«äº¡...' },
      },
      {
        contextA: 'ä¼ªè¯è¢«æ­ç©¿åï¼Œé™ˆæ˜çš„ä¸åœ¨åœºè¯æ˜å¤±æ•ˆã€‚ä½†ä»–åšç§°è‡ªå·±æ˜¯æ— è¾œçš„ï¼Œå¹¶æŒ‡æ§é™ˆæœˆæ‰æ˜¯å‡¶æ‰‹ã€‚',
        contextB: 'è°ƒæŸ¥å‘ç°ï¼Œé‚£åœºç«ç¾å¹¶éæ„å¤–ï¼Œè€Œæ˜¯äººä¸ºçºµç«ã€‚æ›´æƒŠäººçš„æ˜¯ï¼Œé™ˆè€çˆ·å¯èƒ½çŸ¥é“çœŸå‡¶æ˜¯è°ã€‚',
        a: { text: 'å¯¹é™ˆæ˜å’Œé™ˆæœˆè¿›è¡Œäº¤å‰å®¡é—®ï¼Œæ‰¾å‡ºè°åœ¨è¯´è°ã€‚', tag: 'æ­£é¢å¯¹è´¨Â·æ¿€çƒˆ', consequence: 'å®¡é—®ä¸­ï¼Œä¸€ä¸ªæƒŠå¤©ç§˜å¯†è¢«æ­å¼€ï¼šé™ˆæœˆä¸æ˜¯é™ˆè€çˆ·çš„äº²ç”Ÿå¥³å„¿...' },
        b: { text: 'é‡æ–°æ£€éªŒæ¯’è¯æ¥æºï¼Œå‡¶å™¨å¾€å¾€èƒ½æŒ‡å‘çœŸå‡¶ã€‚', tag: 'ç§‘å­¦åˆ†æÂ·ä¸¥è°¨', consequence: 'æ¯’è¯æˆåˆ†åˆ†ææ˜¾ç¤ºï¼Œè¿™ç§æ¯’è¯åªèƒ½ä»ä¸€ç§ç¨€æœ‰æ¤ç‰©ä¸­æå–ï¼Œè€Œç®¡å®¶è€å¼ çš„æˆ¿é—´é‡Œç§ç€è¿™ç§æ¤ç‰©...' },
      },
      {
        contextA: 'é™ˆæœˆçš„èº«ä¸–ç§˜å¯†æ­å¼€åï¼ŒçœŸç›¸é€æ¸æµ®å‡ºæ°´é¢ï¼šå¥¹æ˜¯20å¹´å‰ç«ç¾ä¸­"æ­»å»"çš„é‚£ä¸ªäººçš„å¥³å„¿ï¼Œè¢«é™ˆè€çˆ·ç§˜å¯†æ”¶å…»ã€‚',
        contextB: 'æ‰€æœ‰è¯æ®éƒ½æŒ‡å‘ç®¡å®¶è€å¼ ï¼Œä½†ä»–åœ¨è¢«å®¡é—®æ—¶çªç„¶å¿ƒè„ç—…å‘ä½œï¼Œç•™ä¸‹ä¸€å¥è¯ï¼š"çœŸç›¸...åœ¨èŠ±å›­çš„è€æ§æ ‘ä¸‹..."',
        a: { text: 'å…¬å¼€æ‰€æœ‰çœŸç›¸ï¼Œè®©æ³•å¾‹æ¥è£å†³ï¼Œæ— è®ºç»“æœå¦‚ä½•ã€‚', tag: 'å…¬æ­£å®¡åˆ¤Â·æ³•æ²»', ending: 'çœŸç›¸å¤§ç™½ï¼šç®¡å®¶è€å¼ æ˜¯20å¹´å‰é™ˆè€çˆ·åŸé…çš„æƒ…äººï¼Œç«ç¾æ˜¯ä»–ä»¬ä¸€èµ·ç­–åˆ’çš„ã€‚é™ˆè€çˆ·å‘ç°çœŸç›¸åæ‰“ç®—æ­å‘ä»–ï¼Œäºæ˜¯è€å¼ ç—›ä¸‹æ€æ‰‹ã€‚é™ˆæœˆå¾—çŸ¥è‡ªå·±çš„èº«ä¸–åé€‰æ‹©åŸè°…ï¼Œå¹¶ç”¨ç»§æ‰¿çš„é—äº§æˆç«‹äº†åŸºé‡‘ä¼šï¼Œå¸®åŠ©é‚£äº›åƒå¥¹ä¸€æ ·å¤±å»å®¶åº­çš„å­©å­ã€‚' },
        b: { text: 'ç»™ç›¸å…³äººä¸€ä¸ªé€‰æ‹©çš„æœºä¼šï¼Œæœ‰äº›çœŸç›¸ä¹Ÿè®¸ä¸è¯¥è¢«å…¬å¼€ã€‚', tag: 'äººæƒ…è€ƒé‡Â·ç°è‰²', ending: 'ä½ é€‰æ‹©äº†ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆï¼šè€å¼ çš„ç½ªè¡Œè¢«ä½è°ƒå¤„ç†ï¼Œå¯¹å¤–å®£å¸ƒé™ˆè€çˆ·æ­»äºæ„å¤–ã€‚é™ˆæ˜æˆ’æ‰äº†èµŒåšï¼Œé™ˆæœˆç»§ç»­å¥¹çš„æ…ˆå–„äº‹ä¸šï¼Œæå…ˆç”Ÿå¸¦ç€çˆ¶äº²çš„é—ç‰©ç¦»å¼€ã€‚æœ‰äº›çœŸç›¸è¢«æ°¸è¿œåŸ‹è‘¬ï¼Œä½†æ´»ç€çš„äººéƒ½æœ‰äº†æ–°çš„å¼€å§‹ã€‚' },
      },
    ],
  },
  political: {
    name: 'å®«å»·æƒè°‹',
    icon: 'ğŸ‘‘',
    opening: 'å¤§é½ç‹æœï¼Œæ°¸å®‰ä¸‰åå¹´ã€‚è€çš‡å¸é©¾å´©çš„æ¶ˆæ¯éœ‡æƒŠæœé‡ã€‚é—è¯ä¸­å´å‡ºç°äº†ä»¤äººè´¹è§£çš„å†…å®¹ï¼šçš‡ä½ä¸ä¼ ç»™ä¸‰ä½æˆå¹´çš‡å­ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œè€Œæ˜¯ç”±"æœ€èƒ½ä»£è¡¨æ°‘å¿ƒè€…"ç»§æ‰¿ã€‚ä¸€æ—¶é—´ï¼Œæœå ‚æš—æµæ¶ŒåŠ¨ï¼Œå„æ–¹åŠ¿åŠ›è ¢è ¢æ¬²åŠ¨...',
    rounds: [
      {
        context: 'ä½œä¸ºå…ˆå¸ä¿¡ä»»çš„å†…é˜é¦–è¾…ï¼Œä½ å¿…é¡»åœ¨æ··ä¹±ä¸­ç»´æŒå±€é¢ã€‚ä¸‰ä½çš‡å­å„æœ‰æ”¯æŒè€…ï¼šå¤ªå­ä»åšä½†æ‡¦å¼±ï¼ŒäºŒçš‡å­ç²¾æ˜ä½†æ®‹å¿ï¼Œä¸‰çš‡å­å¹´è½»ä½†é”æ„æ”¹é©ã€‚',
        a: { text: 'æ”¯æŒå¤ªå­æŒ‰ä¼ ç»Ÿç»§ä½ï¼Œç»´æŠ¤å«¡é•¿å­ç»§æ‰¿åˆ¶åº¦çš„ç¨³å®šã€‚', tag: 'ä¼ ç»Ÿæ­£ç»ŸÂ·ä¿å®ˆ', consequence: 'å¤ªå­è·å¾—ä½ çš„æ”¯æŒåä¿¡å¿ƒå¤§å¢ï¼Œä½†äºŒçš‡å­çš„æ”¯æŒè€…å¼€å§‹æš—ä¸­è”ç»œå†›æ–¹...' },
        b: { text: 'æè®®ä¸‰ä½çš‡å­å„é™ˆæ–½æ”¿çº²é¢†ï¼Œç”±ç™¾å®˜å…¬è®®å†³å®šäººé€‰ã€‚', tag: 'å…¬è®®å†³é€‰Â·é©æ–°', consequence: 'è¿™ä¸ªæè®®å¼•å‘è½©ç„¶å¤§æ³¢ï¼Œæ”¹é©æ´¾æ¬¢å‘¼ï¼Œä¿å®ˆæ´¾å¼ºçƒˆåå¯¹...' },
      },
      {
        contextA: 'äºŒçš‡å­å‹¾ç»“è¾¹ç–†å°†å†›ï¼Œå¯†è°‹èµ·å…µ"æ¸…å›ä¾§"ï¼Œå±€åŠ¿éª¤ç„¶ç´§å¼ ã€‚',
        contextB: 'å…¬è®®ä¹‹å‰ï¼Œæœ‰äººæ­å‘ä¸‰çš‡å­ä¸å¤–é‚¦ä½¿èŠ‚æœ‰ç§˜å¯†å¾€æ¥ï¼Œæ¶‰å«Œå–å›½ã€‚',
        a: { text: 'ç´§æ€¥è°ƒåŠ¨å¾¡æ—å†›å¸ƒé˜²ï¼ŒåŒæ—¶æ´¾å¯†ä½¿åˆ†åŒ–äºŒçš‡å­çš„åŒç›Ÿã€‚', tag: 'åˆ†åŒ–ç“¦è§£Â·æƒè°‹', consequence: 'ä½ çš„è®¡ç­–æˆåŠŸæ‹–å»¶äº†äºŒçš‡å­çš„è¡ŒåŠ¨ï¼Œä½†ä»–å¼€å§‹æ€€ç–‘å†…éƒ¨æœ‰äººèƒŒå›...' },
        b: { text: 'ä¸»åŠ¨æ‰¾äºŒçš‡å­è°ˆåˆ¤ï¼Œäº†è§£ä»–çš„è¯‰æ±‚ï¼Œå¯»æ‰¾å’Œå¹³è§£å†³çš„å¯èƒ½ã€‚', tag: 'å’Œè°ˆæ­¢å…µÂ·å†’é™©', consequence: 'äºŒçš‡å­æå‡ºæ¡ä»¶ï¼šä»–è¦å¤ªå­çš„ä½ç½®ï¼Œä½†æ‰¿è¯ºå–„å¾…å…„å¼Ÿ...' },
      },
      {
        context: 'å„æ–¹åŠ¿åŠ›é”™ç»¼å¤æ‚ï¼Œæ¯ä¸€æ­¥æ£‹éƒ½å…³ç³»åˆ°ç‹æœçš„æœªæ¥ã€‚',
        a: { text: 'ç­”åº”å°ä¾¯çš„æ¡ä»¶ï¼Œä¸¤å®³ç›¸æƒå–å…¶è½»ï¼Œå…ˆç¨³ä½å±€é¢ã€‚', tag: 'æƒå®œä¹‹è®¡Â·å¦¥å', consequence: 'å±€åŠ¿æš‚æ—¶ç¨³å®šï¼Œä½†ä½ çŸ¥é“è¿™åªæ˜¯å¼€å§‹ï¼Œæ›´å¤§çš„é£æš´è¿˜åœ¨åé¢...' },
        b: { text: 'æ­éœ²å¤ªåçš„é˜´è°‹ï¼Œè”åˆä¸‰ä½çš‡å­å…±åŒå¯¹æŠ—å¤–æˆšä¸“æƒã€‚', tag: 'å›¢ç»“æŠ—æ•ŒÂ·æ­£ä¹‰', consequence: 'ä½ çš„æ­éœ²è®©æœå ‚éœ‡åŠ¨ï¼Œä¸‰ä½çš‡å­ç ´å¤©è’åœ°ç«™åœ¨äº†ä¸€èµ·...' },
      },
      {
        contextA: 'å„æ–¹åŠ¿åŠ›æš‚æ—¶å¹³è¡¡ï¼Œä½†å‚¨ä½ä¹‹äº‰ä»æ‚¬è€Œæœªå†³ã€‚è¿™æ—¶è¾¹ç–†ä¼ æ¥æ€¥æŠ¥ï¼šåŒ—æ–¹æ¸¸ç‰§æ°‘æ—å¤§å†›å‹å¢ƒã€‚',
        contextB: 'å¤ªåè¢«è½¯ç¦ï¼Œå¤–æˆšåŠ¿åŠ›ç“¦è§£ã€‚ä½†åœ¨æ•´ç†å¤ªåå¯å®«æ—¶ï¼Œå‘ç°äº†å…ˆå¸çš„å¦ä¸€ä»½é—è¯...',
        a: { text: 'å»ºè®®ä¸‰ä½çš‡å­äº²å¾åŒ—ç–†ï¼Œè°èƒ½å‡»é€€æ•Œå†›è°å°±æ˜¯æ–°å¸ã€‚', tag: 'ä»¥æˆ˜å®šå¸Â·é­„åŠ›', consequence: 'ä¸‰ä½çš‡å­ç‡å†›åŒ—ä¸Šï¼Œè¿™åœºæˆ˜äº‰å°†å†³å®šå¤§é½çš„æœªæ¥...' },
        b: { text: 'æè®®å…ˆé€‰å‡ºæ–°å¸å†åº”å¯¹å¤–æ•Œï¼Œå›½ä¸å¯ä¸€æ—¥æ— å›ã€‚', tag: 'å…ˆå†…åå¤–Â·ç¨³é‡', consequence: 'åœ¨ä½ çš„ä¸»æŒä¸‹ï¼Œä¸€åœºå†³å®šæ€§çš„æœè®®å³å°†å¼€å§‹...' },
      },
      {
        contextA: 'åŒ—ç–†æˆ˜äº‹èƒ¶ç€ï¼Œå¤ªå­ä»å¾·æŠšæ°‘ï¼ŒäºŒçš‡å­å‹‡çŒ›ä½œæˆ˜ï¼Œä¸‰çš‡å­åå‹¤è°ƒåº¦æœ‰æ–¹ã€‚ä¸‰äººå„æœ‰åŠŸåŠ³ï¼Œéš¾åˆ†é«˜ä¸‹ã€‚',
        contextB: 'å…ˆå¸çš„çœŸæ­£é—è¯è¢«æ‰¾åˆ°ï¼Œä¸Šé¢å†™ç€ï¼šçš‡ä½ä¼ ç»™"èƒ½è®©ä¸‰ä¸ªå„¿å­å’Œç¦å…±å¤„è€…"ã€‚è¿™ä¸ªäºº...ç«Ÿç„¶æ˜¯ä½ ã€‚',
        a: { text: 'å»ºè®®ä¸‰ä½çš‡å­å…±åŒæ‰§æ”¿ï¼Œå»ºç«‹"ä¸‰ç‹è®®æ”¿"çš„æ–°åˆ¶åº¦ã€‚', tag: 'æƒåŠ›å…±äº«Â·å¼€åˆ›', ending: 'å¤§é½ç‹æœè¿›å…¥äº†å‰æ‰€æœªæœ‰çš„"ä¸‰ç‹æ—¶ä»£"ã€‚å¤ªå­ä¸»å†…æ”¿ï¼ŒäºŒçš‡å­æŒå†›äº‹ï¼Œä¸‰çš‡å­è´Ÿè´£æ”¹é©ã€‚è™½ç„¶äº‰åµä¸æ–­ï¼Œä½†åœ¨ä½ çš„è°ƒå’Œä¸‹ï¼Œè¿™ä¸ªåˆ¶åº¦ç«Ÿç„¶è¿è½¬äº†èµ·æ¥ã€‚äºŒåå¹´åï¼Œä½ åœ¨å›å¿†å½•ä¸­å†™é“ï¼š"æœ€å¥½çš„åˆ¶åº¦ä¸æ˜¯å®Œç¾çš„åˆ¶åº¦ï¼Œè€Œæ˜¯èƒ½è‡ªæˆ‘çº é”™çš„åˆ¶åº¦ã€‚"' },
        b: { text: 'æŒ‰å†›åŠŸå¤§å°æ’åºï¼Œç”±åŠŸåŠ³æœ€å¤§è€…ç»§æ‰¿çš‡ä½ã€‚', tag: 'åŠŸå‹‹å®šä½Â·å…¬å¹³', ending: 'äºŒçš‡å­å‡­å€Ÿæˆ˜åŠŸç™»åŸºï¼Œä½†ä»–æ²¡æœ‰è¾œè´Ÿä¿¡ä»»ã€‚åœ¨ä½æœŸé—´åŒ—å‡»æ¸¸ç‰§ã€å†…ä¿®æ”¿æ²»ï¼Œå¤§é½è¿æ¥äº†ä¸­å…´ã€‚ä¸‰çš‡å­è¢«å°ä¸ºæ”¹é©ç‰¹ä½¿ï¼Œå¤ªå­ä¸»ç®¡ç¤¼éƒ¨æ•™åŒ–ã€‚ä½ ä»¥ä¸ƒåé«˜é¾„è¾å®˜å½’éšæ—¶ï¼Œæ–°å¸äº²è‡ªé€è¡Œåé‡Œï¼Œè¯´ï¼š"æ²¡æœ‰é¦–è¾…å¤§äººï¼Œå°±æ²¡æœ‰ä»Šæ—¥çš„å¤§é½ã€‚"' },
      },
    ],
  },
};

// AI ç©å®¶
const AI_PLAYERS = [
  { id: 'ai_1', name: 'æ™ºè€…Â·è‰¾ä¸', avatar: 'ğŸ§™â€â™€ï¸', isAI: true, style: 'analytical' },
  { id: 'ai_2', name: 'å‹‡è€…Â·å‡¯æ©', avatar: 'âš”ï¸', isAI: true, style: 'bold' },
  { id: 'ai_3', name: 'å­¦è€…Â·è¯ºäºš', avatar: 'ğŸ“š', isAI: true, style: 'cautious' },
  { id: 'ai_4', name: 'å•†äººÂ·é©¬å¯', avatar: 'ğŸ’°', isAI: true, style: 'pragmatic' },
];

// AI è¾©è®ºç”Ÿæˆ
const AI_DEBATES = {
  analytical: { A: ['ä»é€»è¾‘ä¸Šåˆ†æï¼Œé€‰é¡¹Açš„æˆåŠŸç‡æ›´é«˜', 'æ•°æ®è¡¨æ˜ï¼Œæœæ–­è¡ŒåŠ¨å¾€å¾€æ•ˆæœæ›´å¥½'], B: ['ä»”ç»†åˆ†æåï¼ŒBçš„é•¿æœŸæ”¶ç›Šæ›´å¤§', 'ä»å†å²ç»éªŒçœ‹ï¼ŒBè¿™æ ·çš„é€‰æ‹©æ›´æ˜æ™º'] },
  bold: { A: ['å‹‡è€…ä¸æƒ§ï¼Aæ‰æ˜¯çœŸæ­£çš„è‹±é›„ä¹‹é€‰', 'æœæ–­å‡ºå‡»ï¼æ”¯æŒAï¼'], B: ['Bæ‰æ˜¯çœŸæ­£çš„å‹‡æ°”ï¼æ•¢äºä¸åŒï¼', 'æ™ºå‹‡åŒå…¨æ‰æ˜¯çœŸè‹±é›„ï¼Œé€‰Bï¼'] },
  cautious: { A: ['è™½ç„¶å†’é™©ï¼Œä½†Aæˆ–è®¸æ˜¯å¿…è¦çš„', 'ä¸¤å®³ç›¸æƒå–å…¶è½»ï¼Œæ”¯æŒA'], B: ['è°¨æ…èµ·è§ï¼ŒBæ›´å®‰å…¨', 'ç¨³æ‰ç¨³æ‰“ï¼ŒBæ˜¯ä¸Šç­–'] },
  pragmatic: { A: ['ä»åˆ©ç›Šè§’åº¦ï¼ŒAå›æŠ¥æ›´é«˜', 'æŠ•èµ„å›æŠ¥æ¯”æ¥çœ‹ï¼ŒAæ›´åˆ’ç®—'], B: ['Bçš„é£é™©æ›´å¯æ§', 'é•¿è¿œæ¥çœ‹ï¼ŒBæ”¶ç›Šæ›´ç¨³å®š'] },
};

// ========== æ¸¸æˆçŠ¶æ€ ==========
let state = {
  view: 'home',
  player: { id: `p_${Date.now()}`, name: '', avatar: 'ğŸ®', balance: 100 },
  privateKey: '',
  room: null,
  players: [],
  round: 0,
  phase: 'waiting',
  timer: 0,
  story: [],
  storyPath: [],
  currentOptions: { a: null, b: null },
  votes: {},
  myVote: null,
  scores: {},
  messages: [],
  leaderboard: [],
};

let timerInterval = null;

// ========== API è°ƒç”¨ ==========
async function callAPI(method, args = []) {
  // æœ¬åœ°æ¨¡å¼ï¼ˆæ— ç§é’¥ï¼‰
  if (!state.privateKey) {
    console.log('Local mode:', method, args);
    return { success: true, result: {} };
  }
  
  try {
    const res = await fetch('/api/genlayer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ method, args, privateKey: state.privateKey }),
    });
    return await res.json();
  } catch (err) {
    console.error('API Error:', err);
    return { success: false, error: err.message };
  }
}

// ========== åˆå§‹åŒ– ==========
function init() {
  // åŠ è½½æ’è¡Œæ¦œ
  try {
    const saved = localStorage.getItem('consensus_leaderboard');
    if (saved) state.leaderboard = JSON.parse(saved);
  } catch {}
  
  // æ¸²æŸ“ä¸»é¢˜
  const themeGrid = document.getElementById('theme-grid');
  themeGrid.innerHTML = Object.entries(STORY_ARCS).map(([key, arc]) => `
    <div class="theme-card" onclick="createRoom('${key}')">
      <span class="icon">${arc.icon}</span>
      <span class="name">${arc.name}</span>
      <span class="rounds">5è½®å²è¯—æ•…äº‹</span>
    </div>
  `).join('');
  
  // æ¸²æŸ“æ’è¡Œæ¦œ
  renderLeaderboard();
  
  // è¾“å…¥äº‹ä»¶
  document.getElementById('player-name-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.value.trim()) {
      login(e.target.value.trim());
    }
  });
  
  document.getElementById('chat-text').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendChat();
  });
}

function login(name) {
  state.player.name = name;
  state.privateKey = document.getElementById('private-key-input').value.trim();
  
  document.getElementById('my-name').textContent = name;
  document.getElementById('login-section').classList.add('hidden');
  document.getElementById('logged-in-section').classList.remove('hidden');
  
  // è°ƒç”¨é“¾ä¸Šæ³¨å†Œ
  callAPI('register_player', [name, state.player.avatar]);
}

function renderLeaderboard() {
  const content = document.getElementById('leaderboard-content');
  if (state.leaderboard.length === 0) {
    content.innerHTML = '<div class="leaderboard-empty">æš‚æ— è®°å½•ï¼Œæˆä¸ºç¬¬ä¸€ä¸ªç¼–å¹´å²ä½œè€…å§ï¼</div>';
  } else {
    content.innerHTML = state.leaderboard.slice(0, 10).map((entry, i) => `
      <div class="rank-item ${i === 0 ? 'first' : ''}">
        <span class="rank ${i < 3 ? 'top' : 'normal'}">#${i + 1}</span>
        <span class="avatar">${entry.avatar}</span>
        <span class="name">${entry.name}</span>
        <span class="score">${entry.score} pts</span>
      </div>
    `).join('');
  }
}

// ========== æˆ¿é—´é€»è¾‘ ==========
function createRoom(theme) {
  state.room = { id: `room_${Date.now()}`, theme, host: state.player.id };
  state.players = [state.player];
  state.story = [];
  state.storyPath = [];
  state.messages = [];
  
  showView('room');
  renderRoom();
  
  // AI åŠ å…¥
  const ais = [...AI_PLAYERS].sort(() => Math.random() - 0.5).slice(0, 3);
  let delay = 800;
  ais.forEach(ai => {
    setTimeout(() => {
      state.players.push(ai);
      addSystemMessage(`${ai.avatar} ${ai.name} åŠ å…¥äº†æˆ¿é—´`);
      renderRoom();
    }, delay);
    delay += Math.random() * 1500 + 500;
  });
  
  // è°ƒç”¨é“¾ä¸Šåˆ›å»ºæˆ¿é—´
  callAPI('create_room', [theme]);
}

function renderRoom() {
  const arc = STORY_ARCS[state.room.theme];
  document.getElementById('room-theme-icon').textContent = arc.icon;
  document.getElementById('room-theme-name').textContent = arc.name;
  document.getElementById('room-id-display').textContent = state.room.id.slice(-8);
  document.getElementById('player-count').textContent = state.players.length;
  
  const grid = document.getElementById('players-grid');
  let html = '';
  
  state.players.forEach(p => {
    html += `
      <div class="player-card ${p.id === state.player.id ? 'me' : ''}">
        ${p.isAI ? '<span class="badge ai">AI</span>' : ''}
        ${p.id === state.room.host ? '<span class="badge host">æˆ¿ä¸»</span>' : ''}
        <span class="avatar">${p.avatar}</span>
        <span>${p.name}</span>
      </div>
    `;
  });
  
  for (let i = state.players.length; i < 8; i++) {
    html += `<div class="player-card empty"><span class="avatar">?</span><span>ç­‰å¾…ä¸­...</span></div>`;
  }
  
  grid.innerHTML = html;
  
  const btn = document.getElementById('start-game-btn');
  if (state.players.length >= 2) {
    btn.disabled = false;
    btn.textContent = 'ğŸ® å¼€å§‹æ¸¸æˆ';
  } else {
    btn.disabled = true;
    btn.textContent = `ç­‰å¾…æ›´å¤šç©å®¶ (${state.players.length}/2)`;
  }
}

// ========== æ¸¸æˆé€»è¾‘ ==========
function startGame() {
  if (state.players.length < 2) return;
  
  showView('game');
  
  // åˆå§‹åŒ–åˆ†æ•°
  state.scores = {};
  state.players.forEach(p => state.scores[p.id] = 0);
  
  // æ˜¾ç¤ºå¼€åœºæ•…äº‹
  const arc = STORY_ARCS[state.room.theme];
  state.story = [{ text: arc.opening, type: 'opening' }];
  state.storyPath = [];
  
  document.getElementById('story-theme-name').textContent = arc.name;
  renderStory();
  
  addSystemMessage(`ğŸ“– ${arc.name}å¼€å§‹äº†ï¼`);
  
  // å¼€å§‹ç¬¬ä¸€è½®
  setTimeout(() => startRound(1), 2000);
}

function startRound(r) {
  if (r > 5) return endGame();
  
  state.round = r;
  state.phase = 'debate';
  state.votes = {};
  state.myVote = null;
  
  document.getElementById('current-round').textContent = r;
  document.getElementById('phase-display').textContent = 'ğŸ’¬ è¾©è®ºä¸­';
  renderProgressDots();
  
  // è·å–æœ¬è½®æ•°æ®
  const arc = STORY_ARCS[state.room.theme];
  const roundData = arc.rounds[r - 1];
  
  // é€‰æ‹©ä¸Šä¸‹æ–‡
  let context = roundData.context;
  if (r > 1 && state.storyPath.length > 0) {
    const pathKey = state.storyPath.slice(-2).join('');
    if (roundData[`context${pathKey}`]) {
      context = roundData[`context${pathKey}`];
    } else if (roundData[`context${state.storyPath[state.storyPath.length - 1]}`]) {
      context = roundData[`context${state.storyPath[state.storyPath.length - 1]}`];
    }
  }
  
  // æ·»åŠ æ•…äº‹
  state.story.push({ text: context, type: 'context', round: r });
  state.currentOptions = { a: roundData.a, b: roundData.b };
  
  renderStory();
  renderOptions();
  
  addSystemMessage(`ğŸ“– ç¬¬ ${r}/5 è½® - è¾©è®ºé˜¶æ®µå¼€å§‹`);
  
  // æ˜¾ç¤ºèŠå¤©è¾“å…¥
  document.getElementById('chat-input').classList.remove('hidden');
  document.getElementById('vote-prompt').classList.add('hidden');
  
  // å¼€å§‹è®¡æ—¶
  startTimer(90, () => startVoting());
  
  // AI è¾©è®º
  simulateAIDebate();
}

function startVoting() {
  state.phase = 'vote';
  document.getElementById('phase-display').textContent = 'ğŸ—³ï¸ æŠ•ç¥¨ä¸­';
  
  // æ˜¾ç¤ºæŠ•ç¥¨æ•°
  document.querySelectorAll('.option-card .votes').forEach(el => el.classList.remove('hidden'));
  
  // åˆ‡æ¢æç¤º
  document.getElementById('chat-input').classList.add('hidden');
  document.getElementById('vote-prompt').classList.remove('hidden');
  
  addSystemMessage('ğŸ—³ï¸ æŠ•ç¥¨é˜¶æ®µå¼€å§‹ï¼è¯·é€‰æ‹©ä½ æ”¯æŒçš„é€‰é¡¹');
  
  // AI æŠ•ç¥¨
  state.players.filter(p => p.isAI).forEach((ai, i) => {
    setTimeout(() => {
      const choice = Math.random() > 0.5 ? 'A' : 'B';
      state.votes[ai.id] = choice;
      renderChatPlayers();
      renderVotes();
    }, (i + 1) * 2000 + Math.random() * 2000);
  });
  
  startTimer(30, () => calculateResult());
}

function selectOption(choice) {
  if (state.phase !== 'vote' || state.myVote) return;
  
  state.myVote = choice;
  state.votes[state.player.id] = choice;
  
  document.getElementById(`option-${choice.toLowerCase()}`).classList.add('selected');
  
  addSystemMessage(`ä½ æŠ•ç¥¨ç»™äº†é€‰é¡¹ ${choice}`);
  renderChatPlayers();
  renderVotes();
  
  // è°ƒç”¨é“¾ä¸ŠæŠ•ç¥¨
  callAPI('submit_vote', [state.room.id, state.round, choice]);
}

function calculateResult() {
  state.phase = 'result';
  document.getElementById('phase-display').textContent = 'ğŸ“Š ç»“ç®—ä¸­';
  
  const countA = Object.values(state.votes).filter(v => v === 'A').length;
  const countB = Object.values(state.votes).filter(v => v === 'B').length;
  const winner = countA >= countB ? 'A' : 'B';
  
  // æ›´æ–°åˆ†æ•°
  Object.entries(state.votes).forEach(([id, v]) => {
    if (v === winner) {
      state.scores[id] = (state.scores[id] || 0) + 20;
    }
  });
  
  document.getElementById('my-score').textContent = state.scores[state.player.id] || 0;
  
  // æ›´æ–°æ•…äº‹
  state.storyPath.push(winner);
  const opt = winner === 'A' ? state.currentOptions.a : state.currentOptions.b;
  
  // è·å–ç»“æœæ–‡æœ¬
  let consequence = opt.consequence || '';
  if (state.storyPath.length > 1) {
    const prev = state.storyPath[state.storyPath.length - 2];
    if (opt[`consequenceFrom${prev}`]) {
      consequence = opt[`consequenceFrom${prev}`];
    }
  }
  if (state.round === 5 && opt.ending) {
    consequence = opt.ending;
  }
  
  state.story.push({ text: `ã€ä¼—äººé€‰æ‹©ã€‘${opt.text}`, type: 'choice', winner });
  state.story.push({ text: consequence, type: 'consequence' });
  
  renderStory();
  
  addSystemMessage(`ğŸ“œ é€‰é¡¹ ${winner} è·èƒœï¼(${winner === 'A' ? countA : countB}ç¥¨ vs ${winner === 'A' ? countB : countA}ç¥¨)`);
  
  // ä¸‹ä¸€è½®æˆ–ç»“æŸ
  if (state.round >= 5) {
    setTimeout(() => endGame(), 3000);
  } else {
    setTimeout(() => startRound(state.round + 1), 4000);
  }
}

function endGame() {
  state.phase = 'ended';
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  
  document.getElementById('timer-display').textContent = '--:--';
  document.getElementById('options-panel').classList.add('hidden');
  document.getElementById('end-panel').classList.remove('hidden');
  
  // æ’å
  const ranks = Object.entries(state.scores)
    .map(([id, score]) => ({ player: state.players.find(p => p.id === id), score }))
    .sort((a, b) => b.score - a.score);
  
  document.getElementById('final-ranks').innerHTML = ranks.map((r, i) => `
    <div class="rank-item ${i === 0 ? 'first' : ''}">
      <span class="rank ${i < 3 ? 'top' : 'normal'}">#${i + 1}</span>
      <span class="avatar">${r.player?.avatar}</span>
      <span class="name">${r.player?.name}</span>
      <span class="score">${r.score} pts</span>
    </div>
  `).join('');
  
  // æ›´æ–°æ’è¡Œæ¦œ
  const myScore = state.scores[state.player.id] || 0;
  state.leaderboard.push({
    name: state.player.name,
    avatar: state.player.avatar,
    score: myScore,
    theme: state.room.theme,
    date: new Date().toLocaleDateString(),
  });
  state.leaderboard.sort((a, b) => b.score - a.score);
  state.leaderboard = state.leaderboard.slice(0, 50);
  
  try {
    localStorage.setItem('consensus_leaderboard', JSON.stringify(state.leaderboard));
  } catch {}
  
  addSystemMessage('ğŸ† ç¼–å¹´å²å®Œæˆï¼');
}

// ========== è¾…åŠ©å‡½æ•° ==========
function startTimer(duration, onComplete) {
  if (timerInterval) clearInterval(timerInterval);
  
  state.timer = duration;
  updateTimerDisplay();
  
  timerInterval = setInterval(() => {
    state.timer--;
    updateTimerDisplay();
    
    if (state.timer <= 0) {
      clearInterval(timerInterval);
      timerInterval = null;
      onComplete();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const el = document.getElementById('timer-display');
  const mins = Math.floor(state.timer / 60);
  const secs = state.timer % 60;
  el.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
  el.classList.toggle('warning', state.timer <= 10);
}

function renderProgressDots() {
  const dots = document.getElementById('progress-dots');
  dots.innerHTML = [1, 2, 3, 4, 5].map(n => 
    `<div class="dot ${n < state.round ? 'done' : n === state.round ? 'current' : ''}"></div>`
  ).join('');
}

function renderStory() {
  const content = document.getElementById('story-content');
  content.innerHTML = state.story.map(s => {
    if (s.type === 'opening') return `<div class="story-item opening">${s.text}</div>`;
    if (s.type === 'context') return `<div class="story-item context"><span class="round-tag">ç¬¬${s.round}è½®</span>${s.text}</div>`;
    if (s.type === 'choice') return `<div class="story-item choice">${s.winner === 'A' ? 'ğŸ…°ï¸' : 'ğŸ…±ï¸'} ${s.text}</div>`;
    if (s.type === 'consequence') return `<div class="story-item consequence">${s.text}</div>`;
    return '';
  }).join('');
  
  const scroll = document.getElementById('story-scroll');
  scroll.scrollTop = scroll.scrollHeight;
}

function renderOptions() {
  const { a, b } = state.currentOptions;
  
  document.getElementById('tag-a').textContent = a?.tag || '';
  document.getElementById('text-a').textContent = a?.text || '';
  document.getElementById('tag-b').textContent = b?.tag || '';
  document.getElementById('text-b').textContent = b?.text || '';
  
  document.getElementById('option-a').classList.remove('selected');
  document.getElementById('option-b').classList.remove('selected');
  document.querySelectorAll('.option-card .votes').forEach(el => el.classList.add('hidden'));
}

function renderVotes() {
  const countA = Object.values(state.votes).filter(v => v === 'A').length;
  const countB = Object.values(state.votes).filter(v => v === 'B').length;
  
  document.getElementById('votes-a').textContent = `${countA} ç¥¨`;
  document.getElementById('votes-b').textContent = `${countB} ç¥¨`;
}

function renderChatPlayers() {
  const container = document.getElementById('chat-players');
  container.innerHTML = state.players.map(p => `
    <div class="chat-player ${state.votes[p.id] ? 'voted' : ''}">
      <span>${p.avatar}</span>
      <span>${p.name.slice(0, 4)}</span>
      ${state.votes[p.id] ? `<span class="vote">${state.votes[p.id]}</span>` : ''}
    </div>
  `).join('');
}

function simulateAIDebate() {
  state.players.filter(p => p.isAI).forEach((ai, i) => {
    setTimeout(() => {
      const choice = Math.random() > 0.5 ? 'A' : 'B';
      const debates = AI_DEBATES[ai.style]?.[choice] || AI_DEBATES.analytical[choice];
      const text = debates[Math.floor(Math.random() * debates.length)];
      addChatMessage(ai, text, choice);
    }, (i + 1) * 3000 + Math.random() * 5000);
  });
}

function addSystemMessage(text) {
  state.messages.push({ type: 'system', text, time: new Date().toLocaleTimeString() });
  renderMessages();
}

function addChatMessage(sender, text, choice = null) {
  state.messages.push({ type: 'user', sender, text, choice, time: new Date().toLocaleTimeString() });
  renderMessages();
}

function renderMessages() {
  const container = document.getElementById('chat-messages');
  const recent = state.messages.slice(-30);
  
  container.innerHTML = recent.map(msg => {
    if (msg.type === 'system') {
      return `<div class="chat-msg system">${msg.text}</div>`;
    }
    return `
      <div class="chat-msg user">
        <div class="sender">
          ${msg.sender?.avatar} ${msg.sender?.name}
          ${msg.choice ? `<span class="stance ${msg.choice.toLowerCase()}">${msg.choice}</span>` : ''}
        </div>
        <div>${msg.text}</div>
      </div>
    `;
  }).join('');
  
  container.scrollTop = container.scrollHeight;
}

function sendChat() {
  const input = document.getElementById('chat-text');
  const text = input.value.trim();
  if (!text || state.phase !== 'debate') return;
  
  const choice = text.includes('A') || text.includes('é€‰é¡¹A') ? 'A' : 
                 text.includes('B') || text.includes('é€‰é¡¹B') ? 'B' : null;
  
  addChatMessage(state.player, text, choice);
  input.value = '';
  
  // å¢åŠ è¾©è®ºåˆ†
  state.scores[state.player.id] = (state.scores[state.player.id] || 0) + 10;
  document.getElementById('my-score').textContent = state.scores[state.player.id];
}

function quickChat(text) {
  document.getElementById('chat-text').value = text;
  document.getElementById('chat-text').focus();
}

function showView(view) {
  state.view = view;
  document.getElementById('home-view').classList.toggle('hidden', view !== 'home');
  document.getElementById('room-view').classList.toggle('hidden', view !== 'room');
  document.getElementById('game-view').classList.toggle('hidden', view !== 'game');
}

function goHome() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  
  state.room = null;
  state.players = [];
  state.story = [];
  state.storyPath = [];
  state.messages = [];
  state.phase = 'waiting';
  
  document.getElementById('options-panel').classList.remove('hidden');
  document.getElementById('end-panel').classList.add('hidden');
  
  renderLeaderboard();
  showView('home');
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
