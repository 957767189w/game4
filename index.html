<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…±è¯†ç¼–å¹´å² - Consensus Chronicle</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/msgpack-lite@0.1.26/dist/msgpack.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%); min-height: 100vh; color: #e8e8e8; }
    .wallet-bar { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 1.5rem; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(167,139,250,0.2); }
    .logo { display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; font-weight: 600; }
    .wallet-info { display: flex; align-items: center; gap: 1rem; }
    .network-badge { padding: 0.3rem 0.8rem; background: rgba(74,222,128,0.2); border: 1px solid rgba(74,222,128,0.4); border-radius: 20px; font-size: 0.8rem; color: #4ade80; }
    .balance { color: #4ade80; font-weight: 600; }
    .address { font-family: monospace; color: #a5a5b8; font-size: 0.85rem; }
    .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #a78bfa, #f472b6); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(167,139,250,0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: #e8e8e8; border: 1px solid rgba(255,255,255,0.2); }
    .btn-danger { background: #ef4444; color: white; }
    .container { max-width: 1200px; margin: 0 auto; padding: 5rem 1.5rem 2rem; }
    .hidden { display: none !important; }
    .toast-container { position: fixed; top: 80px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; }
    .toast { padding: 1rem 1.5rem; border-radius: 8px; color: white; animation: slideIn 0.3s ease; max-width: 350px; }
    .toast.success { background: linear-gradient(135deg, #059669, #10b981); }
    .toast.error { background: linear-gradient(135deg, #dc2626, #ef4444); }
    .toast.info { background: linear-gradient(135deg, #2563eb, #3b82f6); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .hero { text-align: center; margin-bottom: 3rem; }
    .hero-icon { font-size: 5rem; margin-bottom: 1rem; }
    .hero h1 { font-size: 3rem; font-weight: 800; background: linear-gradient(135deg, #a78bfa, #f472b6, #fb923c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; }
    .hero .subtitle { color: #8b8b9e; letter-spacing: 0.3em; text-transform: uppercase; margin-bottom: 1rem; }
    .hero .desc { color: #a5a5b8; font-style: italic; }
    .contract-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(74,222,128,0.1); border: 1px solid rgba(74,222,128,0.3); border-radius: 20px; margin-top: 1rem; }
    .contract-badge .dot { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .connect-section { text-align: center; margin: 3rem 0; }
    .connect-btn { display: inline-flex; align-items: center; gap: 0.8rem; padding: 1rem 2rem; font-size: 1.1rem; }
    .player-card { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem; background: rgba(167,139,250,0.1); border: 1px solid rgba(167,139,250,0.3); border-radius: 12px; margin: 1.5rem auto; max-width: 400px; }
    .player-card .avatar { font-size: 2.5rem; }
    .player-card .name { font-size: 1.2rem; font-weight: 600; flex: 1; }
    .register-form { max-width: 500px; margin: 2rem auto; padding: 2rem; background: rgba(255,255,255,0.03); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); }
    .register-form h3 { text-align: center; margin-bottom: 1.5rem; color: #c4b5fd; }
    .register-form input { width: 100%; padding: 1rem; margin-bottom: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-size: 1rem; }
    .register-form input:focus { outline: none; border-color: rgba(167,139,250,0.5); }
    .avatar-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
    .avatar-option { padding: 0.8rem; text-align: center; font-size: 1.5rem; background: rgba(255,255,255,0.05); border: 2px solid transparent; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .avatar-option:hover { background: rgba(255,255,255,0.1); }
    .avatar-option.selected { border-color: #a78bfa; background: rgba(167,139,250,0.2); }
    .theme-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .theme-card { display: flex; flex-direction: column; align-items: center; padding: 2rem; background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; cursor: pointer; transition: all 0.3s; }
    .theme-card:hover { transform: translateY(-5px); border-color: rgba(167,139,250,0.5); }
    .theme-card .icon { font-size: 3rem; margin-bottom: 1rem; }
    .theme-card .name { font-size: 1.2rem; font-weight: 600; }
    .theme-card .desc { font-size: 0.85rem; color: #6b6b7e; margin-top: 0.5rem; }
    .room-list { margin-top: 2rem; }
    .room-list h3 { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; color: #c4b5fd; }
    .room-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; margin-bottom: 0.8rem; cursor: pointer; transition: all 0.2s; }
    .room-item:hover { background: rgba(255,255,255,0.05); border-color: rgba(167,139,250,0.3); }
    .room-item .theme-icon { font-size: 2rem; }
    .room-item .info { flex: 1; }
    .room-item .theme-name { font-weight: 600; }
    .room-item .host { font-size: 0.85rem; color: #8b8b9e; }
    .room-item .players { color: #4ade80; font-weight: 600; }
    .no-rooms { text-align: center; padding: 2rem; color: #6b6b7e; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(167,139,250,0.3); border-top-color: #a78bfa; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .room-view { max-width: 800px; margin: 0 auto; }
    .room-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .player-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
    .player-slot { display: flex; flex-direction: column; align-items: center; padding: 1.5rem 1rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; position: relative; }
    .player-slot.host { border-color: rgba(251,191,36,0.5); background: rgba(251,191,36,0.1); }
    .player-slot.ai { border-color: rgba(59,130,246,0.5); }
    .player-slot .avatar { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .player-slot .name { font-size: 0.95rem; text-align: center; }
    .player-slot .badge { position: absolute; top: 0.5rem; right: 0.5rem; font-size: 0.6rem; padding: 0.2rem 0.4rem; border-radius: 4px; }
    .badge-host { background: #fbbf24; color: #000; }
    .badge-ai { background: #3b82f6; color: #fff; }
    .empty-slot { opacity: 0.4; border-style: dashed; }
    .game-view { display: flex; flex-direction: column; height: calc(100vh - 60px); padding-top: 60px; }
    .game-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1); }
    .game-main { flex: 1; display: flex; gap: 1rem; padding: 1rem; overflow: hidden; }
    .story-panel { flex: 1; display: flex; flex-direction: column; gap: 1rem; min-width: 0; }
    .story-scroll { flex: 1; background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1rem; overflow-y: auto; }
    .story-scroll h3 { color: #c4b5fd; margin-bottom: 1rem; font-size: 1rem; }
    .story-item { padding: 0.6rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); line-height: 1.7; }
    .story-item:last-child { border-bottom: none; }
    .story-item.opening { color: #c4b5fd; font-style: italic; }
    .story-item.context { color: #fbbf24; }
    .story-item.choice { color: #4ade80; }
    .story-item.consequence { color: #a5a5b8; padding-left: 1.5rem; border-left: 2px solid rgba(167,139,250,0.3); }
    .round-badge { background: rgba(251,191,36,0.2); padding: 0.2rem 0.5rem; border-radius: 4px; margin-right: 0.5rem; }
    .options-panel { background: rgba(255,255,255,0.02); border-radius: 12px; padding: 1rem; }
    .options-panel h4 { text-align: center; margin-bottom: 1rem; }
    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .option-card { padding: 1rem; border-radius: 10px; cursor: pointer; transition: all 0.3s; }
    .option-card.option-a { border: 2px solid rgba(239,68,68,0.4); background: rgba(239,68,68,0.1); }
    .option-card.option-b { border: 2px solid rgba(59,130,246,0.4); background: rgba(59,130,246,0.1); }
    .option-card.selected { transform: scale(1.02); }
    .option-card.option-a.selected { border-color: #ef4444; }
    .option-card.option-b.selected { border-color: #3b82f6; }
    .option-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
    .option-label { font-weight: 700; font-size: 1.1rem; }
    .option-label.label-a { color: #ef4444; }
    .option-label.label-b { color: #3b82f6; }
    .option-tag { font-size: 0.75rem; padding: 0.2rem 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px; color: #a5a5b8; }
    .option-text { line-height: 1.5; font-size: 0.9rem; }
    .vote-count { margin-top: 0.8rem; text-align: center; font-size: 1.2rem; font-weight: 600; color: #fbbf24; }
    .chat-panel { width: 320px; display: flex; flex-direction: column; background: rgba(0,0,0,0.2); border-radius: 12px; overflow: hidden; }
    .chat-players { display: flex; flex-wrap: wrap; gap: 0.4rem; padding: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .chat-player { display: flex; align-items: center; gap: 0.3rem; padding: 0.3rem 0.6rem; background: rgba(255,255,255,0.05); border-radius: 15px; font-size: 0.8rem; }
    .chat-player.voted { background: rgba(74,222,128,0.2); border: 1px solid rgba(74,222,128,0.4); }
    .chat-player .vote-badge { color: #4ade80; font-weight: 700; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 0.8rem; }
    .chat-msg { margin-bottom: 0.6rem; font-size: 0.85rem; }
    .chat-msg.system { color: #a78bfa; font-style: italic; padding: 0.3rem 0; }
    .chat-msg.player { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 0.5rem 0.8rem; }
    .chat-msg .sender { color: #fbbf24; font-weight: 600; margin-bottom: 0.3rem; display: flex; justify-content: space-between; align-items: center; }
    .chat-msg .stance { font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 4px; }
    .chat-msg .stance.stance-a { background: rgba(239,68,68,0.3); }
    .chat-msg .stance.stance-b { background: rgba(59,130,246,0.3); }
    .chat-input { padding: 0.8rem; border-top: 1px solid rgba(255,255,255,0.05); }
    .chat-input-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
    .chat-input input { flex: 1; padding: 0.6rem 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 0.85rem; }
    .chat-input input:focus { outline: none; border-color: rgba(167,139,250,0.5); }
    .quick-btns { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    .quick-btn { padding: 0.3rem 0.6rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; color: #a5a5b8; font-size: 0.75rem; cursor: pointer; }
    .quick-btn:hover { background: rgba(255,255,255,0.1); }
    .quick-btn.btn-a { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); color: #ef4444; }
    .quick-btn.btn-b { background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); color: #3b82f6; }
    .vote-prompt { padding: 1rem; text-align: center; background: rgba(167,139,250,0.1); }
    .vote-prompt p { color: #fbbf24; font-weight: 600; }
    .timer { font-size: 2.5rem; font-weight: 700; font-family: monospace; }
    .timer.warning { color: #f87171; }
    .timer.normal { color: #a78bfa; }
    .progress-dots { display: flex; align-items: center; gap: 0.5rem; }
    .progress-dot { width: 12px; height: 12px; border-radius: 50%; }
    .progress-dot.done { background: #4ade80; }
    .progress-dot.current { background: #a78bfa; }
    .progress-dot.pending { background: rgba(255,255,255,0.2); }
    .phase-badge { font-size: 1.1rem; font-weight: 600; }
    .score-display { text-align: right; }
    .score-label { font-size: 0.85rem; color: #8b8b9e; }
    .score-value { font-size: 1.5rem; font-weight: 700; color: #fbbf24; }
    .end-panel { background: linear-gradient(145deg, rgba(251,191,36,0.1), rgba(167,139,250,0.1)); border-radius: 12px; padding: 2rem; text-align: center; }
    .end-panel h2 { font-size: 1.8rem; margin-bottom: 1.5rem; color: #fbbf24; }
    .ranking-list { max-width: 400px; margin: 0 auto 1.5rem; }
    .ranking-item { display: flex; align-items: center; gap: 0.8rem; padding: 0.8rem; margin-bottom: 0.4rem; background: rgba(255,255,255,0.03); border-radius: 8px; }
    .ranking-item.first { background: rgba(251,191,36,0.2); border: 1px solid rgba(251,191,36,0.3); }
    .ranking-item .rank { font-weight: 700; width: 1.5rem; }
    .ranking-item .rank.top { color: #fbbf24; }
    .ranking-item .avatar { font-size: 1.3rem; }
    .ranking-item .name { flex: 1; }
    .ranking-item .points { font-weight: 600; color: #a78bfa; }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>
  <div class="wallet-bar">
    <div class="logo">ğŸ“œ å…±è¯†ç¼–å¹´å²</div>
    <div class="wallet-info">
      <span class="network-badge" id="networkBadge">GenLayer Testnet</span>
      <span class="balance" id="balanceDisplay">0.0000 GEN</span>
      <span class="address" id="addressDisplay"></span>
      <button class="btn btn-danger hidden" id="disconnectBtn" onclick="disconnect()">æ–­å¼€</button>
    </div>
  </div>
  <div class="container" id="homePage">
    <div class="hero">
      <div class="hero-icon">ğŸ“œ</div>
      <h1>å…±è¯†ç¼–å¹´å²</h1>
      <p class="subtitle">CONSENSUS CHRONICLE</p>
      <p class="desc">å…±è¯†å¦‚ä½•å¡‘é€ å†å²ï¼Ÿä½ çš„é€‰æ‹©å°†æ”¹å†™å‘½è¿ã€‚</p>
      <div class="contract-badge"><span class="dot"></span><span>åˆçº¦: 0x4F5F...aE186</span></div>
    </div>
    <div class="connect-section" id="connectSection">
      <button class="btn btn-primary connect-btn" onclick="connectWallet()">ğŸ¦Š è¿æ¥ MetaMask</button>
      <p style="margin-top: 1rem; color: #6b6b7e; font-size: 0.9rem;">éœ€è¦å®‰è£… MetaMask é’±åŒ…</p>
    </div>
    <div id="playerCard" class="player-card hidden">
      <span class="avatar" id="playerAvatar">ğŸ®</span>
      <span class="name" id="playerName"></span>
      <span class="balance" id="playerBalance" style="color: #4ade80;">0 GEN</span>
    </div>
    <div id="registerForm" class="register-form hidden">
      <h3>ğŸ­ åˆ›å»ºä½ çš„è§’è‰²</h3>
      <input type="text" id="registerName" placeholder="è¾“å…¥ä½ çš„åå­—..." maxlength="20">
      <div class="avatar-grid" id="avatarGrid"></div>
      <button class="btn btn-primary" style="width: 100%;" onclick="registerPlayer()">ç¡®è®¤æ³¨å†Œ</button>
    </div>
    <div id="themeSection" class="hidden">
      <h2 style="text-align: center; margin-bottom: 1.5rem; color: #c4b5fd;">é€‰æ‹©ä¸»é¢˜ï¼Œå¼€å¯å†’é™©</h2>
      <div class="theme-grid" id="themeGrid"></div>
      <div class="room-list">
        <h3>ğŸšª å¯åŠ å…¥çš„æˆ¿é—´ <button class="btn btn-secondary" style="margin-left: auto; padding: 0.3rem 0.8rem; font-size: 0.8rem;" onclick="loadRooms()">åˆ·æ–°</button></h3>
        <div id="roomList"><div class="no-rooms">åŠ è½½ä¸­...</div></div>
      </div>
    </div>
  </div>
  <div id="roomPage" class="container room-view hidden">
    <div class="room-header">
      <button class="btn btn-secondary" onclick="leaveRoom()">â† è¿”å›</button>
      <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 1.3rem;">
        <span id="roomThemeIcon">ğŸ°</span>
        <span id="roomThemeName" style="font-weight: 600;"></span>
      </div>
      <span id="roomId" style="font-size: 0.9rem; color: #6b6b7e; font-family: monospace;"></span>
    </div>
    <h3 style="margin-bottom: 1rem; color: #8b8b9e;">ç©å®¶ (<span id="playerCount">0</span>/8)</h3>
    <div class="player-grid" id="playerGrid"></div>
    <button id="startGameBtn" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.2rem;" onclick="startGame()">ğŸ® å¼€å§‹æ¸¸æˆ</button>
    <p id="waitingMsg" style="text-align: center; color: #6b6b7e; margin-top: 1rem;"></p>
  </div>
  <div id="gameView" class="game-view hidden">
    <div class="game-header">
      <div>
        <div style="font-size: 0.9rem; color: #8b8b9e;">ç¬¬ <span id="roundNum">1</span> / 5 è½®</div>
        <div class="phase-badge" id="phaseBadge">ğŸ’¬ è¾©è®ºä¸­</div>
      </div>
      <div class="progress-dots" id="progressDots"></div>
      <div class="timer normal" id="timerDisplay">1:30</div>
      <div class="score-display">
        <div class="score-label">æˆ‘çš„ç§¯åˆ†</div>
        <div class="score-value" id="myScore">0</div>
      </div>
    </div>
    <div class="game-main">
      <div class="story-panel">
        <div class="story-scroll" id="storyScroll"></div>
        <div class="options-panel" id="optionsPanel"></div>
      </div>
      <div class="chat-panel">
        <div class="chat-players" id="chatPlayers"></div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input" id="chatInput"></div>
      </div>
    </div>
  </div>
<script>
const CONFIG = {
  CHAIN_ID: '0xa2c4',
  RPC_URL: 'https://studio-rpc.genlayer.com',
  CONTRACT: '0x4F5F132ba540f1C685B0188D59990302903aE186',
  ROOM_SIZE: { min: 2, max: 8 },
  DEBATE_DURATION: 90,
  VOTE_DURATION: 30,
  TOTAL_ROUNDS: 5,
};

// GenLayer Calldataç¼–ç 
function encodeCalldata(method, args = []) {
  const data = msgpack.encode({ method, args });
  return '0x' + Array.from(new Uint8Array(data)).map(b => b.toString(16).padStart(2, '0')).join('');
}

function decodeCalldata(hex) {
  if (!hex || hex === '0x' || hex.length < 4) return null;
  try {
    const bytes = new Uint8Array(hex.slice(2).match(/.{1,2}/g).map(b => parseInt(b, 16)));
    return msgpack.decode(bytes);
  } catch (e) { return null; }
}

async function glRead(method, args = []) {
  const data = encodeCalldata(method, args);
  console.log(`[GL READ] ${method}`, args);
  const res = await fetch(CONFIG.RPC_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      jsonrpc: '2.0', method: 'gen_call', id: Date.now(),
      params: [{ Type: 'read', Data: data, from: state.address || '0x0000000000000000000000000000000000000000', to: CONFIG.CONTRACT, gas: '0x7A120', value: '0x0' }]
    })
  });
  const json = await res.json();
  console.log(`[GL READ RESULT]`, json);
  if (json.error) throw new Error(json.error.message);
  return decodeCalldata(json.result);
}

async function glWrite(method, args = []) {
  const data = encodeCalldata(method, args);
  console.log(`[GL WRITE] ${method}`, args);
  const txHash = await window.ethereum.request({
    method: 'eth_sendTransaction',
    params: [{ from: state.address, to: CONFIG.CONTRACT, data, gas: '0x7A120', value: '0x0' }]
  });
  console.log(`[GL TX]`, txHash);
  return txHash;
}

async function glWaitTx(txHash, timeout = 60) {
  for (let i = 0; i < timeout; i++) {
    await new Promise(r => setTimeout(r, 1000));
    try {
      const res = await fetch(CONFIG.RPC_URL, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ jsonrpc: '2.0', method: 'gen_getTransactionReceipt', params: [{ txId: txHash }], id: Date.now() })
      });
      const json = await res.json();
      if (json.result && json.result.status >= 5) return json.result;
    } catch (e) {}
  }
  return null;
}

const STORY_ARCS = {
  fantasy: { name: 'å¥‡å¹»å†’é™©', icon: 'ğŸ°', opening: 'å¤è€çš„é¢„è¨€ç»ˆäºåº”éªŒâ€”â€”æ²‰ç¡åƒå¹´çš„é»‘é¾™è‹é†’äº†ã€‚ç‹å›½å±åœ¨æ—¦å¤•ï¼Œå›½ç‹ç´§æ€¥å¬é›†äº†å„åœ°è‹±é›„å•†è®®å¯¹ç­–...', rounds: [
    { context: 'é»‘é¾™çš„å¨èƒè¿«åœ¨çœ‰ç«ï¼Œç‹å›½å¿…é¡»åšå‡ºç¬¬ä¸€ä¸ªå…³é”®å†³å®šã€‚', a: { text: 'ç«‹å³é›†ç»“å†›é˜Ÿï¼Œä¸»åŠ¨å‡ºå‡»é¾™å·¢ã€‚', tag: 'å…ˆå‘åˆ¶äºº', consequence: 'å†›é˜Ÿå‘é¾™å·¢è¿›å‘ï¼ŒæŸå¤±æƒ¨é‡...' }, b: { text: 'æ´¾é£ä½¿è€…å¯»æ±‚ç²¾çµæ—çš„å¸®åŠ©ã€‚', tag: 'å¯»æ±‚è”ç›Ÿ', consequence: 'ä½¿è€…è”ç³»åˆ°ç²¾çµæ—ï¼Œä½†æ¡ä»¶è‹›åˆ»...' }},
    { context: 'å±€åŠ¿ç´§å¼ ï¼Œéœ€è¦åšå‡ºè‰°éš¾æŠ‰æ‹©ã€‚', a: { text: 'é‡‡å–æ¿€è¿›ç­–ç•¥ï¼Œä¸æƒœä»£ä»·ã€‚', tag: 'æ¿€è¿›', consequence: 'ä»£ä»·æƒ¨é‡ï¼Œä½†æœ‰è¿›å±•...' }, b: { text: 'é‡‡å–ç¨³å¦¥ç­–ç•¥ï¼Œä¿å­˜å®åŠ›ã€‚', tag: 'ç¨³å¥', consequence: 'å®åŠ›ä¿å­˜ï¼Œä½†æ—¶æœºæµé€...' }},
    { context: 'å…³é”®æ—¶åˆ»åˆ°æ¥ã€‚', a: { text: 'å­¤æ³¨ä¸€æ·ï¼Œæ”¾æ‰‹ä¸€æã€‚', tag: 'å†’é™©', consequence: 'å‘½è¿çš„å¤©å¹³å¼€å§‹å€¾æ–œ...' }, b: { text: 'è°¨æ…è¡Œäº‹ï¼Œç­‰å¾…æ—¶æœºã€‚', tag: 'è°¨æ…', consequence: 'æ—¶æœºç»ˆäºå‡ºç°...' }},
    { context: 'æœ€ç»ˆå¯¹å†³å‰çš„æŠ‰æ‹©ã€‚', a: { text: 'å‘èµ·æ€»æ”»ï¼Œå†³ä¸€æ­»æˆ˜ã€‚', tag: 'å†³æˆ˜', consequence: 'æœ€ç»ˆä¹‹æˆ˜å¼€å§‹...' }, b: { text: 'å°è¯•è°ˆåˆ¤ï¼Œå¯»æ±‚å’Œå¹³ã€‚', tag: 'å’Œå¹³', consequence: 'æ„å¤–çš„è½¬æœºå‡ºç°...' }},
    { context: 'å‘½è¿çš„æœ€ç»ˆå®¡åˆ¤ã€‚', a: { text: 'ä¸æƒœä¸€åˆ‡ä»£ä»·å–èƒœã€‚', tag: 'æç«¯', ending: 'æƒ¨èƒœï¼ç‹å›½åŒ–ä¸ºåºŸå¢Ÿï¼Œä½†é»‘é¾™è¢«æ¶ˆç­äº†ã€‚' }, b: { text: 'æ¥å—å‘½è¿ï¼Œå¯»æ±‚å…±å­˜ã€‚', tag: 'æ™ºæ…§', ending: 'äººç±»ä¸é»‘é¾™è¾¾æˆç›Ÿçº¦ï¼Œæ–°æ—¶ä»£å¼€å¯ï¼' }}
  ]},
  scifi: { name: 'ç§‘å¹»æœªæ¥', icon: 'ğŸš€', opening: '2157å¹´ï¼Œç«æ˜Ÿæ®–æ°‘åœ°æ”¶åˆ°ç¥ç§˜ä¿¡å·ï¼šåœ°çƒå°†åœ¨100å¤©åè¢«å°è¡Œæ˜Ÿæ’å‡»ã€‚èµ„æºåªå¤Ÿæ•‘ä¸€åŠäºº...', rounds: [
    { context: 'æ¶ˆæ¯å…¬å¸ƒåï¼Œæ®–æ°‘åœ°é™·å…¥ææ…Œã€‚', a: { text: 'å¯åŠ¨æ–¹èˆŸè®¡åˆ’ï¼ŒæŠ½ç­¾å†³å®šã€‚', tag: 'å…¬å¹³', consequence: 'æŠ½ç­¾ç»“æœå¼•å‘æŠ—è®®...' }, b: { text: 'é›†ä¸­èµ„æºç ”ç©¶ä¿¡å·æ¥æºã€‚', tag: 'æ¢ç´¢', consequence: 'å‘ç°ä¿¡å·æ¥è‡ªæœªçŸ¥æ–‡æ˜...' }},
    { context: 'å±€åŠ¿æ¶åŒ–ã€‚', a: { text: 'ä½¿ç”¨æ­¦åŠ›ç»´æŒç§©åºã€‚', tag: 'å¼ºç¡¬', consequence: 'ç§©åºæš‚æ—¶ç¨³å®š...' }, b: { text: 'ä¸å„æ–¹è°ˆåˆ¤ã€‚', tag: 'åå•†', consequence: 'è¾¾æˆåˆæ­¥å…±è¯†...' }},
    { context: 'å…³é”®æŠ€æœ¯çªç ´ã€‚', a: { text: 'å†’é™©é‡‡ç”¨æ–°æ–¹æ¡ˆã€‚', tag: 'å†’é™©', consequence: 'æˆåŠŸç‡ä¸‹é™ï¼Œä½†å¸Œæœ›å¢åŠ ...' }, b: { text: 'åšæŒåŸè®¡åˆ’ã€‚', tag: 'ç¨³å¦¥', consequence: 'è®¡åˆ’æ¨è¿›...' }},
    { context: 'å‘å°„å‰çš„æœ€åå†³å®šã€‚', a: { text: 'å°è¯•æ”¹å˜å°è¡Œæ˜Ÿè½¨é“ã€‚', tag: 'é€†å¤©', consequence: 'èµ„æºæŠ•å…¥æœ€åä¸€æ...' }, b: { text: 'æŒ‰è®¡åˆ’æ’¤ç¦»ã€‚', tag: 'åˆ†æ•£', consequence: 'æ’¤ç¦»å¼€å§‹...' }},
    { context: 'æœ€ç»ˆæ—¶åˆ»ã€‚', a: { text: 'æ”¾æ‰‹ä¸€æã€‚', tag: 'æé™', ending: 'å¥‡è¿¹å‘ç”Ÿï¼å°è¡Œæ˜Ÿåç¦»è½¨é“ï¼Œäººç±»è·æ•‘ï¼' }, b: { text: 'æ¥å—ç°å®ã€‚', tag: 'é‡ç”Ÿ', ending: 'è™½æœ‰æŸå¤±ï¼Œä½†äººç±»æ–‡æ˜å»¶ç»­ã€‚' }}
  ]},
  mystery: { name: 'æ‚¬ç–‘æ¨ç†', icon: 'ğŸ”', opening: 'æš´é£é›¨ä¹‹å¤œï¼Œå¯Œè±ªé™ˆè€çˆ·åœ¨ä¹¦æˆ¿è¢«æ¯’æ€ã€‚å¤§é—¨åé”ï¼Œçª—æˆ·å®Œå¥½ã€‚åœ¨åœºäº”äººï¼Œè°æ˜¯å‡¶æ‰‹ï¼Ÿ', rounds: [
    { context: 'ä½œä¸ºä¾¦æ¢ï¼Œä½ å¿…é¡»å¼€å§‹è°ƒæŸ¥ã€‚', a: { text: 'æœæŸ¥ä¹¦æˆ¿ï¼Œå¯»æ‰¾ç‰©è¯ã€‚', tag: 'ç‰©è¯', consequence: 'å‘ç°åŠå°è¢«çƒ§çš„ä¿¡ä»¶...' }, b: { text: 'è¯¢é—®åœ¨åœºæ¯ä¸ªäººã€‚', tag: 'é—®è¯¢', consequence: 'å‘ç°ç®¡å®¶ç¥è‰²æ…Œå¼ ...' }},
    { context: 'çº¿ç´¢æŒ‡å‘å¤šä¸ªæ–¹å‘ã€‚', a: { text: 'æ·±å…¥è°ƒæŸ¥é—äº§é—®é¢˜ã€‚', tag: 'é‡‘é’±', consequence: 'å‘ç°å¤§å„¿å­æ¬ ä¸‹å·¨å€º...' }, b: { text: 'è°ƒæŸ¥ç¥ç§˜å•†äººã€‚', tag: 'èº«ä»½', consequence: 'å•†äººç«Ÿæ˜¯å¤±æ•£çš„ç§ç”Ÿå­...' }},
    { context: 'å«Œç–‘äººèŒƒå›´ç¼©å°ã€‚', a: { text: 'éªŒè¯ç®¡å®¶çš„è¯è¯ã€‚', tag: 'è´¨ç–‘', consequence: 'è¯è¯å‡ºç°æ¼æ´...' }, b: { text: 'è°ƒæŸ¥é™ˆå¹´æ—§æ¡ˆã€‚', tag: 'è¿‡å»', consequence: '20å¹´å‰çš„ç«ç¾å¦æœ‰éšæƒ…...' }},
    { context: 'çœŸç›¸å³å°†æµ®å‡ºæ°´é¢ã€‚', a: { text: 'å¯¹å«Œç–‘äººäº¤å‰å®¡é—®ã€‚', tag: 'å¯¹è´¨', consequence: 'æƒŠäººç§˜å¯†è¢«æ­å¼€...' }, b: { text: 'é‡æ–°æ£€éªŒæ¯’è¯æ¥æºã€‚', tag: 'ç§‘å­¦', consequence: 'æ¯’è¯æŒ‡å‘ç‰¹å®šäººç‰©...' }},
    { context: 'æœ€ç»ˆå®¡åˆ¤ã€‚', a: { text: 'å…¬å¼€æ‰€æœ‰çœŸç›¸ã€‚', tag: 'æ³•æ²»', ending: 'çœŸç›¸å¤§ç™½ï¼Œæ­£ä¹‰å¾—åˆ°ä¼¸å¼ ã€‚' }, b: { text: 'ç»™äºˆé€‰æ‹©æœºä¼šã€‚', tag: 'ç°è‰²', ending: 'éƒ¨åˆ†çœŸç›¸è¢«åŸ‹è‘¬ï¼Œä½†æ´»ç€çš„äººéƒ½æœ‰äº†æ–°å¼€å§‹ã€‚' }}
  ]},
  political: { name: 'å®«å»·æƒè°‹', icon: 'ğŸ‘‘', opening: 'å¤§é½ç‹æœï¼Œè€çš‡å¸é©¾å´©ã€‚é—è¯ä»¤äººè´¹è§£ï¼šçš‡ä½ä¼ ç»™"æœ€èƒ½ä»£è¡¨æ°‘å¿ƒè€…"ã€‚ä¸‰ä½çš‡å­å„æœ‰æ”¯æŒè€…...', rounds: [
    { context: 'ä½œä¸ºå†…é˜é¦–è¾…ï¼Œä½ å¿…é¡»ç»´æŒå±€é¢ã€‚', a: { text: 'æ”¯æŒå¤ªå­æŒ‰ä¼ ç»Ÿç»§ä½ã€‚', tag: 'æ­£ç»Ÿ', consequence: 'å¤ªå­è·å¾—æ”¯æŒï¼Œä½†äºŒçš‡å­ä¸æ»¡...' }, b: { text: 'æè®®ä¸‰ä½çš‡å­å…¬è®®å†³é€‰ã€‚', tag: 'é©æ–°', consequence: 'æ”¹é©æ´¾æ¬¢å‘¼ï¼Œä¿å®ˆæ´¾åå¯¹...' }},
    { context: 'å®«å»·æš—æµæ¶ŒåŠ¨ã€‚', a: { text: 'è°ƒåŠ¨å¾¡æ—å†›å¸ƒé˜²ã€‚', tag: 'æƒè°‹', consequence: 'è®¡ç­–æš‚æ—¶å¥æ•ˆ...' }, b: { text: 'ä¸»åŠ¨ä¸å¯¹æ‰‹è°ˆåˆ¤ã€‚', tag: 'å’Œè°ˆ', consequence: 'å¯¹æ–¹æå‡ºè‹›åˆ»æ¡ä»¶...' }},
    { context: 'å±æœºå››ä¼ã€‚', a: { text: 'æš‚æ—¶å¦¥åã€‚', tag: 'å¦¥å', consequence: 'å±€åŠ¿æš‚ç¨³...' }, b: { text: 'æ­éœ²é˜´è°‹ã€‚', tag: 'æ­£ä¹‰', consequence: 'ä¸‰ä½çš‡å­ç«™åœ¨ä¸€èµ·...' }},
    { context: 'è¾¹ç–†å‘Šæ€¥ã€‚', a: { text: 'ä¸‰ä½çš‡å­äº²å¾ã€‚', tag: 'æˆ˜åŠŸ', consequence: 'åŒ—ç–†æˆ˜äº‹èƒ¶ç€...' }, b: { text: 'å…ˆé€‰æ–°å¸å†åº”å¯¹å¤–æ•Œã€‚', tag: 'ç¨³é‡', consequence: 'æœè®®å³å°†å¼€å§‹...' }},
    { context: 'æœ€ç»ˆå†³æ–­ã€‚', a: { text: 'å»ºç«‹ä¸‰ç‹è®®æ”¿æ–°åˆ¶åº¦ã€‚', tag: 'å…±äº«', ending: 'å¤§é½è¿›å…¥"ä¸‰ç‹æ—¶ä»£"ï¼Œè¿è½¬è‰¯å¥½ã€‚' }, b: { text: 'æŒ‰å†›åŠŸæ’åºç»§ä½ã€‚', tag: 'å…¬å¹³', ending: 'äºŒçš‡å­å‡­æˆ˜åŠŸç™»åŸºï¼Œå¤§é½ä¸­å…´ã€‚' }}
  ]}
};

const AVATARS = ['ğŸ®', 'âš”ï¸', 'ğŸ›¡ï¸', 'ğŸ”®', 'ğŸ“š', 'ğŸ­', 'ğŸª', 'ğŸ¯', 'ğŸ¹', 'âš¡', 'ğŸŒŸ', 'ğŸ”¥'];
const AI_PLAYERS = [
  { id: 'ai_1', name: 'æ™ºè€…Â·è‰¾ä¸', avatar: 'ğŸ§™â€â™€ï¸', isAI: true, style: 'analytical' },
  { id: 'ai_2', name: 'å‹‡è€…Â·å‡¯æ©', avatar: 'âš”ï¸', isAI: true, style: 'bold' },
  { id: 'ai_3', name: 'å­¦è€…Â·è¯ºäºš', avatar: 'ğŸ“š', isAI: true, style: 'cautious' },
  { id: 'ai_4', name: 'å•†äººÂ·é©¬å¯', avatar: 'ğŸ’°', isAI: true, style: 'pragmatic' },
  { id: 'ai_5', name: 'è¯—äººÂ·æœˆå', avatar: 'ğŸ­', isAI: true, style: 'romantic' },
];

const state = { address: null, balance: '0', connected: false };
const player = { name: '', avatar: 'ğŸ®', registered: false };
const room = { id: null, theme: null, host: null, players: [] };
const game = { round: 0, phase: 'waiting', timer: 0, story: [], path: [], votes: {}, myVote: null, scores: {}, messages: [], options: { a: null, b: null } };
let timerInterval = null;

const $ = id => document.getElementById(id);
const show = id => $(id)?.classList.remove('hidden');
const hide = id => $(id)?.classList.add('hidden');

function toast(msg, type = 'info') {
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  $('toastContainer').appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

function formatTime(s) { return `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`; }

async function connectWallet() {
  if (!window.ethereum) { toast('è¯·å®‰è£…MetaMaské’±åŒ…', 'error'); return; }
  try {
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    if (!accounts.length) throw new Error('æœªè·å–åˆ°è´¦æˆ·');
    state.address = accounts[0];
    try {
      await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CONFIG.CHAIN_ID }] });
    } catch (e) {
      if (e.code === 4902) {
        await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: CONFIG.CHAIN_ID, chainName: 'GenLayer Testnet', rpcUrls: [CONFIG.RPC_URL], nativeCurrency: { name: 'GEN', symbol: 'GEN', decimals: 18 } }] });
      }
    }
    const balanceHex = await window.ethereum.request({ method: 'eth_getBalance', params: [state.address, 'latest'] });
    state.balance = (parseInt(balanceHex, 16) / 1e18).toFixed(4);
    state.connected = true;
    $('balanceDisplay').textContent = state.balance + ' GEN';
    $('addressDisplay').textContent = state.address.slice(0, 6) + '...' + state.address.slice(-4);
    show('disconnectBtn');
    hide('connectSection');
    toast('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
    await checkPlayerStatus();
  } catch (err) {
    console.error('è¿æ¥å¤±è´¥:', err);
    toast('è¿æ¥å¤±è´¥: ' + (err.message || 'è¯·é‡è¯•'), 'error');
  }
}

function disconnect() {
  state.address = null; state.connected = false; player.name = ''; player.registered = false;
  hide('disconnectBtn'); hide('playerCard'); hide('themeSection'); hide('registerForm'); show('connectSection');
  $('addressDisplay').textContent = ''; $('balanceDisplay').textContent = '0.0000 GEN';
  toast('å·²æ–­å¼€è¿æ¥', 'info');
}

async function checkPlayerStatus() {
  try {
    const result = await glRead('get_player', [state.address]);
    if (result && result.name) {
      player.name = result.name; player.avatar = result.avatar || 'ğŸ®'; player.registered = true;
      showPlayerCard(); showThemeSection(); loadRooms(); return;
    }
  } catch (e) { console.warn('æ£€æŸ¥ç©å®¶çŠ¶æ€å¤±è´¥:', e); }
  show('registerForm'); initAvatarGrid();
}

function initAvatarGrid() {
  $('avatarGrid').innerHTML = AVATARS.map((a, i) => `<div class="avatar-option ${i === 0 ? 'selected' : ''}" onclick="selectAvatar(this, '${a}')">${a}</div>`).join('');
  player.avatar = AVATARS[0];
}

function selectAvatar(el, avatar) {
  document.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected'); player.avatar = avatar;
}

async function registerPlayer() {
  const name = $('registerName').value.trim();
  if (!name) { toast('è¯·è¾“å…¥åå­—ï¼', 'error'); return; }
  const btn = document.querySelector('#registerForm button');
  btn.disabled = true; btn.textContent = 'è¯·ç¡®è®¤äº¤æ˜“...';
  try {
    toast('è¯·åœ¨MetaMaskä¸­ç¡®è®¤äº¤æ˜“...', 'info');
    const txHash = await glWrite('register_player', [name, player.avatar]);
    toast('äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info'); btn.textContent = 'ç­‰å¾…ç¡®è®¤...';
    await glWaitTx(txHash);
    player.name = name; player.registered = true;
    hide('registerForm'); showPlayerCard(); showThemeSection(); loadRooms();
    toast('æ³¨å†ŒæˆåŠŸï¼', 'success');
  } catch (err) {
    toast(err.code === 4001 ? 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“' : 'æ³¨å†Œå¤±è´¥: ' + err.message, 'error');
  } finally { btn.disabled = false; btn.textContent = 'ç¡®è®¤æ³¨å†Œ'; }
}

function showPlayerCard() {
  $('playerAvatar').textContent = player.avatar; $('playerName').textContent = player.name;
  $('playerBalance').textContent = state.balance + ' GEN'; show('playerCard');
}

function showThemeSection() {
  $('themeGrid').innerHTML = Object.entries(STORY_ARCS).map(([key, arc]) => `<div class="theme-card" onclick="createRoom('${key}')"><span class="icon">${arc.icon}</span><span class="name">${arc.name}</span><span class="desc">5è½®å²è¯—æ•…äº‹</span></div>`).join('');
  show('themeSection');
}

async function loadRooms() {
  const list = $('roomList');
  list.innerHTML = '<div class="no-rooms"><span class="loading"></span> åŠ è½½ä¸­...</div>';
  try {
    const result = await glRead('list_rooms', []);
    const rooms = Array.isArray(result) ? result : [];
    if (!rooms.length) { list.innerHTML = '<div class="no-rooms">æš‚æ— æˆ¿é—´ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div>'; return; }
    list.innerHTML = rooms.map(r => `<div class="room-item" onclick="joinRoom(${r.id})"><span class="theme-icon">${STORY_ARCS[r.theme]?.icon || 'ğŸ®'}</span><div class="info"><div class="theme-name">${STORY_ARCS[r.theme]?.name || r.theme}</div><div class="host">æˆ¿ä¸»: ${r.host_name || r.host?.slice(0,8)}</div></div><span class="players">${r.player_count || 1}/8</span><button class="btn btn-primary" style="padding: 0.4rem 1rem;">åŠ å…¥</button></div>`).join('');
  } catch (err) { list.innerHTML = '<div class="no-rooms">æš‚æ— æˆ¿é—´ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</div>'; }
}

async function createRoom(theme) {
  try {
    toast('è¯·ç¡®è®¤äº¤æ˜“åˆ›å»ºæˆ¿é—´...', 'info');
    const txHash = await glWrite('create_room', [theme]);
    toast('ç­‰å¾…ç¡®è®¤...', 'info'); await glWaitTx(txHash);
  } catch (err) { if (err.code === 4001) { toast('ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“', 'error'); return; } }
  room.id = Date.now(); room.theme = theme; room.host = state.address;
  room.players = [{ id: state.address, name: player.name, avatar: player.avatar, isHost: true }];
  toast('æˆ¿é—´åˆ›å»ºæˆåŠŸï¼', 'success'); showRoomPage(); setTimeout(addAIPlayers, 1000);
}

async function joinRoom(roomId) {
  try { await glWrite('join_room', [roomId]); } catch (err) {}
  room.id = roomId; room.theme = 'fantasy';
  room.players = [{ id: state.address, name: player.name, avatar: player.avatar }];
  toast('åŠ å…¥æˆåŠŸï¼', 'success'); showRoomPage(); setTimeout(addAIPlayers, 500);
}

function addAIPlayers() {
  const shuffled = [...AI_PLAYERS].sort(() => Math.random() - 0.5);
  shuffled.slice(0, Math.floor(Math.random() * 2) + 2).forEach((ai, i) => {
    setTimeout(() => {
      if (room.players.length < CONFIG.ROOM_SIZE.max) {
        room.players.push(ai); updateRoomUI(); addSystemMessage(`${ai.avatar} ${ai.name} åŠ å…¥äº†æˆ¿é—´`);
      }
    }, (i + 1) * 800);
  });
}

function showRoomPage() { hide('homePage'); show('roomPage'); updateRoomUI(); }

function updateRoomUI() {
  const arc = STORY_ARCS[room.theme];
  $('roomThemeIcon').textContent = arc?.icon || 'ğŸ®';
  $('roomThemeName').textContent = arc?.name || room.theme;
  $('roomId').textContent = '#' + String(room.id).slice(-6);
  $('playerCount').textContent = room.players.length;
  const grid = $('playerGrid'); const slots = [];
  room.players.forEach(p => {
    const isHost = p.id === room.host || p.isHost;
    slots.push(`<div class="player-slot ${isHost ? 'host' : ''} ${p.isAI ? 'ai' : ''}"><span class="avatar">${p.avatar}</span><span class="name">${p.name}</span>${isHost ? '<span class="badge badge-host">æˆ¿ä¸»</span>' : ''}${p.isAI ? '<span class="badge badge-ai">AI</span>' : ''}</div>`);
  });
  for (let i = room.players.length; i < CONFIG.ROOM_SIZE.max; i++) slots.push(`<div class="player-slot empty-slot"><span class="avatar">?</span><span class="name">ç­‰å¾…ä¸­...</span></div>`);
  grid.innerHTML = slots.join('');
  const isHost = room.host === state.address || room.players[0]?.id === state.address;
  const canStart = room.players.length >= CONFIG.ROOM_SIZE.min;
  $('startGameBtn').style.display = isHost ? 'block' : 'none';
  $('startGameBtn').disabled = !canStart;
  $('waitingMsg').textContent = isHost ? (canStart ? '' : `ç­‰å¾…æ›´å¤šç©å®¶ (${room.players.length}/${CONFIG.ROOM_SIZE.min})`) : 'ç­‰å¾…æˆ¿ä¸»å¼€å§‹æ¸¸æˆ...';
}

function leaveRoom() { hide('roomPage'); show('homePage'); room.id = null; room.players = []; loadRooms(); }

function startGame() {
  if (room.players.length < CONFIG.ROOM_SIZE.min) { toast(`è‡³å°‘éœ€è¦ ${CONFIG.ROOM_SIZE.min} åç©å®¶`, 'error'); return; }
  game.round = 0; game.phase = 'waiting'; game.story = []; game.path = []; game.votes = {}; game.myVote = null; game.messages = []; game.scores = {};
  room.players.forEach(p => { game.scores[p.id] = { influence: 0, debates: 0, wins: 0 }; });
  const arc = STORY_ARCS[room.theme];
  game.story.push({ text: arc.opening, type: 'opening', round: 0 });
  hide('homePage'); hide('roomPage'); show('gameView');
  updateGameUI(); addSystemMessage(`ğŸ“– ${arc.name}å¼€å§‹äº†ï¼`);
  setTimeout(() => startRound(1), 2000);
}

function startRound(r) {
  if (r > CONFIG.TOTAL_ROUNDS) { endGame(); return; }
  game.round = r; game.phase = 'debate'; game.votes = {}; game.myVote = null;
  const arc = STORY_ARCS[room.theme]; const roundData = arc.rounds[r - 1];
  game.story.push({ text: roundData.context, type: 'context', round: r });
  game.options = { a: roundData.a, b: roundData.b };
  addSystemMessage(`ğŸ“– ç¬¬ ${r}/${CONFIG.TOTAL_ROUNDS} è½® - è¾©è®ºé˜¶æ®µå¼€å§‹`);
  updateGameUI(); startTimer(CONFIG.DEBATE_DURATION, () => startVoting());
  simulateAIDebate();
}

function startVoting() {
  game.phase = 'vote'; game.timer = CONFIG.VOTE_DURATION;
  addSystemMessage('ğŸ—³ï¸ æŠ•ç¥¨é˜¶æ®µå¼€å§‹ï¼è¯·é€‰æ‹©ä½ æ”¯æŒçš„é€‰é¡¹'); updateGameUI();
  room.players.filter(p => p.isAI).forEach((ai, i) => {
    setTimeout(() => { game.votes[ai.id] = Math.random() > 0.5 ? 'A' : 'B'; updateGameUI(); }, (i + 1) * 2000 + Math.random() * 3000);
  });
  startTimer(CONFIG.VOTE_DURATION, () => calculateResult());
}

function calculateResult() {
  game.phase = 'result'; clearInterval(timerInterval);
  const voteCount = { A: 0, B: 0 }; Object.values(game.votes).forEach(v => { if (v) voteCount[v]++; });
  const total = voteCount.A + voteCount.B;
  const winner = total === 0 ? (Math.random() > 0.5 ? 'A' : 'B') : (voteCount.A >= voteCount.B ? 'A' : 'B');
  Object.entries(game.votes).forEach(([id, v]) => { if (v === winner && game.scores[id]) { game.scores[id].influence += 30; game.scores[id].wins++; } });
  game.path.push(winner);
  const opt = winner === 'A' ? game.options.a : game.options.b;
  let consequence = opt.consequence || opt.ending || '';
  game.story.push({ text: `ã€ä¼—äººé€‰æ‹©ã€‘${opt.text}`, type: 'choice', round: game.round, winner });
  game.story.push({ text: consequence, type: 'consequence', round: game.round });
  addSystemMessage(`ğŸ“œ é€‰é¡¹ ${winner} è·èƒœï¼(${voteCount[winner]}ç¥¨ vs ${voteCount[winner === 'A' ? 'B' : 'A']}ç¥¨)`);
  updateGameUI();
  if (game.round >= CONFIG.TOTAL_ROUNDS) setTimeout(endGame, 3000); else setTimeout(() => startRound(game.round + 1), 4000);
}

function endGame() { game.phase = 'ended'; clearInterval(timerInterval); addSystemMessage('ğŸ† ç¼–å¹´å²å®Œæˆï¼'); updateGameUI(); }

function startTimer(duration, onComplete) {
  clearInterval(timerInterval); game.timer = duration; updateGameUI();
  timerInterval = setInterval(() => { game.timer--; updateGameUI(); if (game.timer <= 0) { clearInterval(timerInterval); onComplete(); } }, 1000);
}

function simulateAIDebate() {
  const debates = {
    analytical: { A: ['ä»é€»è¾‘ä¸Šåˆ†æï¼ŒAçš„æˆåŠŸç‡æ›´é«˜'], B: ['ä»”ç»†åˆ†æåï¼ŒBçš„é•¿æœŸæ”¶ç›Šæ›´å¤§'] },
    bold: { A: ['å‹‡è€…ä¸æƒ§ï¼Aæ‰æ˜¯çœŸæ­£çš„è‹±é›„ä¹‹é€‰'], B: ['Bæ‰æ˜¯çœŸæ­£çš„å‹‡æ°”ï¼'] },
    cautious: { A: ['è™½ç„¶å†’é™©ï¼Œä½†Aæˆ–è®¸æ˜¯å¿…è¦çš„'], B: ['è°¨æ…èµ·è§ï¼ŒBæ›´å®‰å…¨'] },
    pragmatic: { A: ['ä»åˆ©ç›Šè§’åº¦ï¼ŒAå›æŠ¥æ›´é«˜'], B: ['Bçš„é£é™©æ›´å¯æ§'] },
    romantic: { A: ['Aæœ‰ç§æ‚²å£®çš„ç¾æ„Ÿ'], B: ['Bä»£è¡¨ç€å¸Œæœ›ä¸å¯èƒ½'] }
  };
  room.players.filter(p => p.isAI).forEach((ai, i) => {
    setTimeout(() => {
      const choice = Math.random() > 0.5 ? 'A' : 'B';
      const text = debates[ai.style]?.[choice]?.[0] || 'æˆ‘æ”¯æŒ' + choice;
      addChatMessage(ai, text, choice);
    }, (i + 1) * 3000 + Math.random() * 5000);
  });
}

function addSystemMessage(text) { game.messages.push({ id: Date.now(), type: 'system', text }); if (game.messages.length > 30) game.messages.shift(); updateChatUI(); }
function addChatMessage(sender, text, choice = null) { game.messages.push({ id: Date.now(), type: 'chat', sender, text, choice }); if (game.messages.length > 30) game.messages.shift(); updateChatUI(); }

function submitDebate() {
  const input = document.querySelector('#chatInput input');
  if (!input || !input.value.trim() || game.phase !== 'debate') return;
  const text = input.value.trim();
  const choice = text.includes('A') ? 'A' : text.includes('B') ? 'B' : null;
  addChatMessage({ name: player.name, avatar: player.avatar }, text, choice);
  input.value = '';
  if (game.scores[state.address]) game.scores[state.address].debates += 10;
  updateGameUI();
}

function submitVote(choice) {
  if (game.phase !== 'vote' || game.myVote) return;
  game.myVote = choice; game.votes[state.address] = choice;
  addSystemMessage(`ä½ æŠ•ç¥¨ç»™äº†é€‰é¡¹ ${choice}`); updateGameUI();
}

function setQuickMessage(text) { const input = document.querySelector('#chatInput input'); if (input) input.value = text; }

function updateGameUI() {
  $('roundNum').textContent = game.round;
  $('phaseBadge').textContent = game.phase === 'debate' ? 'ğŸ’¬ è¾©è®ºä¸­' : game.phase === 'vote' ? 'ğŸ—³ï¸ æŠ•ç¥¨ä¸­' : game.phase === 'result' ? 'ğŸ“Š ç»“ç®—ä¸­' : 'ğŸ† å·²ç»“æŸ';
  const timerEl = $('timerDisplay');
  timerEl.textContent = game.phase === 'ended' || game.phase === 'result' ? '--:--' : formatTime(game.timer);
  timerEl.className = `timer ${game.timer <= 10 && game.phase !== 'ended' ? 'warning' : 'normal'}`;
  $('progressDots').innerHTML = [1,2,3,4,5].map(n => `<div class="progress-dot ${n < game.round ? 'done' : n === game.round ? 'current' : 'pending'}"></div>`).join('');
  const myScore = game.scores[state.address] || { influence: 0, debates: 0 };
  $('myScore').textContent = myScore.influence + myScore.debates;
  const storyScroll = $('storyScroll');
  storyScroll.innerHTML = `<h3>ğŸ“œ ${STORY_ARCS[room.theme]?.name || ''} - æ•…äº‹è¿›ç¨‹</h3>` + game.story.map(s => `<div class="story-item ${s.type}">${s.type === 'context' ? `<span class="round-badge">ç¬¬${s.round}è½®</span>` : ''}${s.type === 'choice' ? `${s.winner === 'A' ? 'ğŸ…°ï¸' : 'ğŸ…±ï¸'} ` : ''}${s.text}</div>`).join('');
  storyScroll.scrollTop = storyScroll.scrollHeight;
  const optionsPanel = $('optionsPanel');
  if ((game.phase === 'debate' || game.phase === 'vote') && game.options.a) {
    const votesA = Object.values(game.votes).filter(v => v === 'A').length;
    const votesB = Object.values(game.votes).filter(v => v === 'B').length;
    optionsPanel.innerHTML = `<h4>âš”ï¸ æœ¬è½®æŠ‰æ‹©</h4><div class="options-grid"><div class="option-card option-a ${game.myVote === 'A' ? 'selected' : ''}" onclick="submitVote('A')"><div class="option-header"><span class="option-label label-a">é€‰é¡¹ A</span><span class="option-tag">${game.options.a.tag}</span></div><p class="option-text">${game.options.a.text}</p>${game.phase === 'vote' ? `<div class="vote-count">${votesA} ç¥¨</div>` : ''}</div><div class="option-card option-b ${game.myVote === 'B' ? 'selected' : ''}" onclick="submitVote('B')"><div class="option-header"><span class="option-label label-b">é€‰é¡¹ B</span><span class="option-tag">${game.options.b.tag}</span></div><p class="option-text">${game.options.b.text}</p>${game.phase === 'vote' ? `<div class="vote-count">${votesB} ç¥¨</div>` : ''}</div></div>`;
  } else if (game.phase === 'ended') {
    const rankings = Object.entries(game.scores).map(([id, score]) => ({ player: room.players.find(p => p.id === id), total: score.influence + score.debates })).sort((a, b) => b.total - a.total);
    optionsPanel.innerHTML = `<div class="end-panel"><h2>ğŸ† ç¼–å¹´å²å®Œæˆï¼</h2><div class="ranking-list">${rankings.map((r, i) => `<div class="ranking-item ${i === 0 ? 'first' : ''}"><span class="rank ${i < 3 ? 'top' : ''}">#${i + 1}</span><span class="avatar">${r.player?.avatar || 'ğŸ®'}</span><span class="name">${r.player?.name || 'æœªçŸ¥'}</span><span class="points">${r.total} pts</span></div>`).join('')}</div><button class="btn btn-primary" onclick="returnToLobby()">è¿”å›å¤§å…</button></div>`;
  } else { optionsPanel.innerHTML = ''; }
  updateChatUI();
}

function updateChatUI() {
  $('chatPlayers').innerHTML = room.players.map(p => `<div class="chat-player ${game.votes[p.id] ? 'voted' : ''}"><span>${p.avatar}</span><span style="max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${p.name}</span>${game.votes[p.id] ? `<span class="vote-badge">${game.votes[p.id]}</span>` : ''}</div>`).join('');
  const messagesEl = $('chatMessages');
  messagesEl.innerHTML = game.messages.map(msg => msg.type === 'system' ? `<div class="chat-msg system">${msg.text}</div>` : `<div class="chat-msg player"><div class="sender">${msg.sender?.avatar || 'ğŸ®'} ${msg.sender?.name || 'åŒ¿å'}${msg.choice ? `<span class="stance stance-${msg.choice.toLowerCase()}">æ”¯æŒ${msg.choice}</span>` : ''}</div><div>${msg.text}</div></div>`).join('');
  messagesEl.scrollTop = messagesEl.scrollHeight;
  const chatInput = $('chatInput');
  if (game.phase === 'debate') {
    chatInput.innerHTML = `<div class="chat-input-row"><input type="text" placeholder="è¾“å…¥ä½ çš„è§‚ç‚¹..." onkeydown="if(event.key==='Enter')submitDebate()"><button class="btn btn-primary" onclick="submitDebate()">å‘é€</button></div><div class="quick-btns"><button class="quick-btn btn-a" onclick="setQuickMessage('æˆ‘æ”¯æŒé€‰é¡¹Aï¼Œå› ä¸º')">ğŸ…°ï¸ æ”¯æŒA</button><button class="quick-btn btn-b" onclick="setQuickMessage('æˆ‘æ”¯æŒé€‰é¡¹Bï¼Œå› ä¸º')">ğŸ…±ï¸ æ”¯æŒB</button><button class="quick-btn" onclick="setQuickMessage('æˆ‘è®¤ä¸ºæˆ‘ä»¬åº”è¯¥è€ƒè™‘')">ğŸ’­ è§‚ç‚¹</button></div>`;
  } else if (game.phase === 'vote' && !game.myVote) {
    chatInput.innerHTML = `<div class="vote-prompt"><p>â° è¯·åœ¨å·¦ä¾§é€‰æ‹©ä½ æ”¯æŒçš„é€‰é¡¹ï¼</p></div>`;
  } else { chatInput.innerHTML = ''; }
}

function returnToLobby() { clearInterval(timerInterval); hide('gameView'); show('homePage'); room.id = null; room.players = []; game.round = 0; game.phase = 'waiting'; game.story = []; game.messages = []; loadRooms(); }

if (window.ethereum) {
  window.ethereum.on('accountsChanged', accounts => { if (accounts.length === 0) disconnect(); else location.reload(); });
  window.ethereum.on('chainChanged', () => location.reload());
}
</script>
</body>
</html>
